<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"e-x.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="PS：要转载请注明出处，本人版权所有。 PS: 这个只是基于《我自己》的理解，如果和你的原则及想法相冲突，请谅解，勿喷。  环境说明   无 前言    在https:&#x2F;&#x2F;blog.csdn.net&#x2F;u011728480&#x2F;article&#x2F;details&#x2F;79609493文中，我已经实现了从一个可旋转的相机中采图进行360度的全景拼接。但是最近，又接到了一个任务是关于从三个不同相机（同型号）采集">
<meta property="og:type" content="article">
<meta property="og:title" content="关于全景（360）图片拼接的方法（Opencv3.0 Stitcher）----续（一）">
<meta property="og:url" content="https://e-x.top/2018/05/22/blog_idx_063/index.html">
<meta property="og:site_name" content="Sky&#39;s Blogs">
<meta property="og:description" content="PS：要转载请注明出处，本人版权所有。 PS: 这个只是基于《我自己》的理解，如果和你的原则及想法相冲突，请谅解，勿喷。  环境说明   无 前言    在https:&#x2F;&#x2F;blog.csdn.net&#x2F;u011728480&#x2F;article&#x2F;details&#x2F;79609493文中，我已经实现了从一个可旋转的相机中采图进行360度的全景拼接。但是最近，又接到了一个任务是关于从三个不同相机（同型号）采集">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_063/img.png">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg">
<meta property="article:published_time" content="2018-05-22T07:31:47.000Z">
<meta property="article:modified_time" content="2024-05-18T11:06:02.588Z">
<meta property="article:author" content="Sky">
<meta property="article:tag" content="opencv">
<meta property="article:tag" content="全景">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_063/img.png">


<link rel="canonical" href="https://e-x.top/2018/05/22/blog_idx_063/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://e-x.top/2018/05/22/blog_idx_063/","path":"2018/05/22/blog_idx_063/","title":"关于全景（360）图片拼接的方法（Opencv3.0 Stitcher）----续（一）"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>关于全景（360）图片拼接的方法（Opencv3.0 Stitcher）----续（一） | Sky's Blogs</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  




<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8677552300382028"
     crossorigin="anonymous"></script>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Sky's Blogs</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A normal star</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E"><span class="nav-number">1.</span> <span class="nav-text">环境说明</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number"></span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Stitcher-%E5%A4%A7%E8%87%B4%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%EF%BC%88%E4%B8%BB%E8%A6%81%E6%A0%B9%E6%8D%AE%E7%BD%91%E4%B8%8A%E7%9A%84%E8%B5%84%E6%96%99%E7%BB%93%E5%90%88%E5%85%B6%E5%AE%98%E6%96%B9%E7%9A%84%E4%BE%8B%E5%AD%90%E6%9D%A5%E5%88%86%E6%9E%90%EF%BC%89"><span class="nav-number"></span> <span class="nav-text">Stitcher 大致工作原理（主要根据网上的资料结合其官方的例子来分析）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%8D%E8%83%BD%E6%8B%BC%E6%8E%A5%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="nav-number"></span> <span class="nav-text">不能拼接的原因</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="nav-number"></span> <span class="nav-text">解决思路</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="nav-number"></span> <span class="nav-text">后记</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-number"></span> <span class="nav-text">参考文献</span></a></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Sky</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">92</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">222</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/05/22/blog_idx_063/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="关于全景（360）图片拼接的方法（Opencv3.0 Stitcher）----续（一） | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          关于全景（360）图片拼接的方法（Opencv3.0 Stitcher）----续（一）
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-05-22 15:31:47" itemprop="dateCreated datePublished" datetime="2018-05-22T15:31:47+08:00">2018-05-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/" itemprop="url" rel="index"><span itemprop="name">计算机视觉</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">数据结构与算法</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>15 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 16:52:37
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=063） 
&emsp;&emsp;本文发布于 2018-05-22 15:31:47，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=063） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  在<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011728480/article/details/79609493%E6%96%87%E4%B8%AD%EF%BC%8C%E6%88%91%E5%B7%B2%E7%BB%8F%E5%AE%9E%E7%8E%B0%E4%BA%86%E4%BB%8E%E4%B8%80%E4%B8%AA%E5%8F%AF%E6%97%8B%E8%BD%AC%E7%9A%84%E7%9B%B8%E6%9C%BA%E4%B8%AD%E9%87%87%E5%9B%BE%E8%BF%9B%E8%A1%8C360%E5%BA%A6%E7%9A%84%E5%85%A8%E6%99%AF%E6%8B%BC%E6%8E%A5%E3%80%82%E4%BD%86%E6%98%AF%E6%9C%80%E8%BF%91%EF%BC%8C%E5%8F%88%E6%8E%A5%E5%88%B0%E4%BA%86%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E6%98%AF%E5%85%B3%E4%BA%8E%E4%BB%8E%E4%B8%89%E4%B8%AA%E4%B8%8D%E5%90%8C%E7%9B%B8%E6%9C%BA%EF%BC%88%E5%90%8C%E5%9E%8B%E5%8F%B7%EF%BC%89%E9%87%87%E9%9B%86%E5%9B%BE%E5%83%8F%E8%BF%9B%E8%A1%8C%E6%8B%BC%E6%8E%A5%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%97%B6%E5%80%99%E5%B0%B1%E5%87%BA%E7%8E%B0%E4%BA%86%E4%B8%80%E4%B8%AA%E8%AE%A9%E6%88%91%E5%B4%A9%E6%BA%83%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C99.99999999999999999999999999%25%E9%83%BD%E6%8B%BC%E6%8E%A5%E4%B8%8D%E4%B8%8A%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%97%B6%E5%80%99%EF%BC%8C%E5%B0%B1%E9%9C%80%E8%A6%81%E6%88%91%E4%BB%AC%E6%8E%A2%E7%B4%A2%E4%B8%8E%E5%8F%91%E7%8E%B0%E4%B8%80%E4%B8%8B">https://blog.csdn.net/u011728480/article/details/79609493文中，我已经实现了从一个可旋转的相机中采图进行360度的全景拼接。但是最近，又接到了一个任务是关于从三个不同相机（同型号）采集图像进行拼接，这个时候就出现了一个让我崩溃的问题，99.99999999999999999999999999%都拼接不上，这个时候，就需要我们探索与发现一下</a> Stitcher的工作原理，看能不能找到相关的解决办法或者出现这些问题的原因。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Stitcher-大致工作原理（主要根据网上的资料结合其官方的例子来分析）">Stitcher 大致工作原理（主要根据网上的资料结合其官方的例子来分析）</h3>
<hr>
<ol>
<li class="lvl-4">
<p>首先就是通过算法找特征点</p>
</li>
<li class="lvl-3">
<p>其次就是计算图片之间的特征点的匹配程度</p>
</li>
<li class="lvl-3">
<p>… …（这里的省略号的原因是我也没有太懂后面的流程）</p>
</li>
<li class="lvl-3">
<p>拼接</p>
</li>
</ol>
<p>opencv  example :stitching_detailed.cpp(<a target="_blank" rel="noopener" href="https://github.com/opencv/opencv/blob/master/samples/cpp/stitching_detailed.cpp">https://github.com/opencv/opencv/blob/master/samples/cpp/stitching_detailed.cpp</a>)</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*M///////////////////////////////////////////////////////////////////////////////////////
//
//  IMPORTANT: READ BEFORE DOWNLOADING, COPYING, INSTALLING OR USING.
//
//  By downloading, copying, installing or using the software you agree to this license.
//  If you do not agree to this license, do not download, install,
//  copy or use the software.
//
//
//                          License Agreement
//                For Open Source Computer Vision Library
//
// Copyright (C) 2000-2008, Intel Corporation, all rights reserved.
// Copyright (C) 2009, Willow Garage Inc., all rights reserved.
// Third party copyrights are property of their respective owners.
//
// Redistribution and use in source and binary forms, with or without modification,
// are permitted provided that the following conditions are met:
//
//   * Redistribution's of source code must retain the above copyright notice,
//     this list of conditions and the following disclaimer.
//
//   * Redistribution's in binary form must reproduce the above copyright notice,
//     this list of conditions and the following disclaimer in the documentation
//     and/or other materials provided with the distribution.
//
//   * The name of the copyright holders may not be used to endorse or promote products
//     derived from this software without specific prior written permission.
//
// This software is provided by the copyright holders and contributors "as is" and
// any express or implied warranties, including, but not limited to, the implied
// warranties of merchantability and fitness for a particular purpose are disclaimed.
// In no event shall the Intel Corporation or contributors be liable for any direct,
// indirect, incidental, special, exemplary, or consequential damages
// (including, but not limited to, procurement of substitute goods or services;
// loss of use, data, or profits; or business interruption) however caused
// and on any theory of liability, whether in contract, strict liability,
// or tort (including negligence or otherwise) arising in any way out of
// the use of this software, even if advised of the possibility of such damage.
//
//
//M*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/opencv_modules.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/core/utility.hpp></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/imgcodecs.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/highgui.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/autocalib.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/blenders.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/timelapsers.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/camera.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/exposure_compensate.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/matchers.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/motion_estimators.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/seam_finders.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/warpers.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/warpers.hpp"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENABLE_LOG</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG</span><span class="token expression"><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> msg</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGLN</span><span class="token expression"><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> msg <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token double-colon punctuation">::</span>detail<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    cout <span class="token operator">&lt;&lt;</span>
        <span class="token string">"Rotation model images stitcher.\n\n"</span>
        <span class="token string">"stitching_detailed img1 img2 [...imgN] [flags]\n\n"</span>
        <span class="token string">"Flags:\n"</span>
        <span class="token string">"  --preview\n"</span>
        <span class="token string">"      Run stitching in the preview mode. Works faster than usual mode,\n"</span>
        <span class="token string">"      but output image will have lower resolution.\n"</span>
        <span class="token string">"  --try_cuda (yes|no)\n"</span>
        <span class="token string">"      Try to use CUDA. The default value is 'no'. All default values\n"</span>
        <span class="token string">"      are for CPU mode.\n"</span>
        <span class="token string">"\nMotion Estimation Flags:\n"</span>
        <span class="token string">"  --work_megapix &lt;float>\n"</span>
        <span class="token string">"      Resolution for image registration step. The default is 0.6 Mpx.\n"</span>
        <span class="token string">"  --features (surf|orb)\n"</span>
        <span class="token string">"      Type of features used for images matching. The default is surf.\n"</span>
        <span class="token string">"  --matcher (homography|affine)\n"</span>
        <span class="token string">"      Matcher used for pairwise image matching.\n"</span>
        <span class="token string">"  --estimator (homography|affine)\n"</span>
        <span class="token string">"      Type of estimator used for transformation estimation.\n"</span>
        <span class="token string">"  --match_conf &lt;float>\n"</span>
        <span class="token string">"      Confidence for feature matching step. The default is 0.65 for surf and 0.3 for orb.\n"</span>
        <span class="token string">"  --conf_thresh &lt;float>\n"</span>
        <span class="token string">"      Threshold for two images are from the same panorama confidence.\n"</span>
        <span class="token string">"      The default is 1.0.\n"</span>
        <span class="token string">"  --ba (no|reproj|ray|affine)\n"</span>
        <span class="token string">"      Bundle adjustment cost function. The default is ray.\n"</span>
        <span class="token string">"  --ba_refine_mask (mask)\n"</span>
        <span class="token string">"      Set refinement mask for bundle adjustment. It looks like 'x_xxx',\n"</span>
        <span class="token string">"      where 'x' means refine respective parameter and '_' means don't\n"</span>
        <span class="token string">"      refine one, and has the following format:\n"</span>
        <span class="token string">"      &lt;fx>&lt;skew>&lt;ppx>&lt;aspect>&lt;ppy>. The default mask is 'xxxxx'. If bundle\n"</span>
        <span class="token string">"      adjustment doesn't support estimation of selected parameter then\n"</span>
        <span class="token string">"      the respective flag is ignored.\n"</span>
        <span class="token string">"  --wave_correct (no|horiz|vert)\n"</span>
        <span class="token string">"      Perform wave effect correction. The default is 'horiz'.\n"</span>
        <span class="token string">"  --save_graph &lt;file_name>\n"</span>
        <span class="token string">"      Save matches graph represented in DOT language to &lt;file_name> file.\n"</span>
        <span class="token string">"      Labels description: Nm is number of matches, Ni is number of inliers,\n"</span>
        <span class="token string">"      C is confidence.\n"</span>
        <span class="token string">"\nCompositing Flags:\n"</span>
        <span class="token string">"  --warp (affine|plane|cylindrical|spherical|fisheye|stereographic|compressedPlaneA2B1|compressedPlaneA1.5B1|compressedPlanePortraitA2B1|compressedPlanePortraitA1.5B1|paniniA2B1|paniniA1.5B1|paniniPortraitA2B1|paniniPortraitA1.5B1|mercator|transverseMercator)\n"</span>
        <span class="token string">"      Warp surface type. The default is 'spherical'.\n"</span>
        <span class="token string">"  --seam_megapix &lt;float>\n"</span>
        <span class="token string">"      Resolution for seam estimation step. The default is 0.1 Mpx.\n"</span>
        <span class="token string">"  --seam (no|voronoi|gc_color|gc_colorgrad)\n"</span>
        <span class="token string">"      Seam estimation method. The default is 'gc_color'.\n"</span>
        <span class="token string">"  --compose_megapix &lt;float>\n"</span>
        <span class="token string">"      Resolution for compositing step. Use -1 for original resolution.\n"</span>
        <span class="token string">"      The default is -1.\n"</span>
        <span class="token string">"  --expos_comp (no|gain|gain_blocks)\n"</span>
        <span class="token string">"      Exposure compensation method. The default is 'gain_blocks'.\n"</span>
        <span class="token string">"  --blend (no|feather|multiband)\n"</span>
        <span class="token string">"      Blending method. The default is 'multiband'.\n"</span>
        <span class="token string">"  --blend_strength &lt;float>\n"</span>
        <span class="token string">"      Blending strength from [0,100] range. The default is 5.\n"</span>
        <span class="token string">"  --output &lt;result_img>\n"</span>
        <span class="token string">"      The default is 'result.jpg'.\n"</span>
        <span class="token string">"  --timelapse (as_is|crop) \n"</span>
        <span class="token string">"      Output warped images separately as frames of a time lapse movie, with 'fixed_' prepended to input file names.\n"</span>
        <span class="token string">"  --rangewidth &lt;int>\n"</span>
        <span class="token string">"      uses range_width to limit number of images to match with.\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">// Default command line args</span>
vector<span class="token operator">&lt;</span>String<span class="token operator">></span> img_names<span class="token punctuation">;</span>
<span class="token keyword">bool</span> preview <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span> try_cuda <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> work_megapix <span class="token operator">=</span> <span class="token number">0.6</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> seam_megapix <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> compose_megapix <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> conf_thresh <span class="token operator">=</span> <span class="token number">1.f</span><span class="token punctuation">;</span>
string features_type <span class="token operator">=</span> <span class="token string">"surf"</span><span class="token punctuation">;</span>
string matcher_type <span class="token operator">=</span> <span class="token string">"homography"</span><span class="token punctuation">;</span>
string estimator_type <span class="token operator">=</span> <span class="token string">"homography"</span><span class="token punctuation">;</span>
string ba_cost_func <span class="token operator">=</span> <span class="token string">"ray"</span><span class="token punctuation">;</span>
string ba_refine_mask <span class="token operator">=</span> <span class="token string">"xxxxx"</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span> do_wave_correct <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
WaveCorrectKind wave_correct <span class="token operator">=</span> detail<span class="token double-colon punctuation">::</span>WAVE_CORRECT_HORIZ<span class="token punctuation">;</span>
<span class="token keyword">bool</span> save_graph <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>string save_graph_to<span class="token punctuation">;</span>
string warp_type <span class="token operator">=</span> <span class="token string">"spherical"</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> expos_comp_type <span class="token operator">=</span> ExposureCompensator<span class="token double-colon punctuation">::</span>GAIN_BLOCKS<span class="token punctuation">;</span>
<span class="token keyword">float</span> match_conf <span class="token operator">=</span> <span class="token number">0.3f</span><span class="token punctuation">;</span>
string seam_find_type <span class="token operator">=</span> <span class="token string">"gc_color"</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> blend_type <span class="token operator">=</span> Blender<span class="token double-colon punctuation">::</span>MULTI_BAND<span class="token punctuation">;</span>
<span class="token keyword">int</span> timelapse_type <span class="token operator">=</span> Timelapser<span class="token double-colon punctuation">::</span>AS_IS<span class="token punctuation">;</span>
<span class="token keyword">float</span> blend_strength <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
string result_name <span class="token operator">=</span> <span class="token string">"result.jpg"</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span> timelapse <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> range_width <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>


<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">parseCmdArgs</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--help"</span> <span class="token operator">||</span> <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"/?"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--preview"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            preview <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--try_cuda"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"no"</span><span class="token punctuation">)</span>
                try_cuda <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"yes"</span><span class="token punctuation">)</span>
                try_cuda <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad --try_cuda flag value\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--work_megapix"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            work_megapix <span class="token operator">=</span> <span class="token function">atof</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--seam_megapix"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            seam_megapix <span class="token operator">=</span> <span class="token function">atof</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--compose_megapix"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            compose_megapix <span class="token operator">=</span> <span class="token function">atof</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--result"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            result_name <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--features"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            features_type <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>features_type <span class="token operator">==</span> <span class="token string">"orb"</span><span class="token punctuation">)</span>
                match_conf <span class="token operator">=</span> <span class="token number">0.3f</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--matcher"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"homography"</span> <span class="token operator">||</span> <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"affine"</span><span class="token punctuation">)</span>
                matcher_type <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad --matcher flag value\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--estimator"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"homography"</span> <span class="token operator">||</span> <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"affine"</span><span class="token punctuation">)</span>
                estimator_type <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad --estimator flag value\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--match_conf"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            match_conf <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">atof</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--conf_thresh"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            conf_thresh <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">atof</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--ba"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            ba_cost_func <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--ba_refine_mask"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            ba_refine_mask <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_refine_mask<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">5</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Incorrect refinement mask length.\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--wave_correct"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"no"</span><span class="token punctuation">)</span>
                do_wave_correct <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"horiz"</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                do_wave_correct <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                wave_correct <span class="token operator">=</span> detail<span class="token double-colon punctuation">::</span>WAVE_CORRECT_HORIZ<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"vert"</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                do_wave_correct <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                wave_correct <span class="token operator">=</span> detail<span class="token double-colon punctuation">::</span>WAVE_CORRECT_VERT<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad --wave_correct flag value\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--save_graph"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            save_graph <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            save_graph_to <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--warp"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            warp_type <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--expos_comp"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"no"</span><span class="token punctuation">)</span>
                expos_comp_type <span class="token operator">=</span> ExposureCompensator<span class="token double-colon punctuation">::</span>NO<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"gain"</span><span class="token punctuation">)</span>
                expos_comp_type <span class="token operator">=</span> ExposureCompensator<span class="token double-colon punctuation">::</span>GAIN<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"gain_blocks"</span><span class="token punctuation">)</span>
                expos_comp_type <span class="token operator">=</span> ExposureCompensator<span class="token double-colon punctuation">::</span>GAIN_BLOCKS<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad exposure compensation method\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--seam"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"no"</span> <span class="token operator">||</span>
                <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"voronoi"</span> <span class="token operator">||</span>
                <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"gc_color"</span> <span class="token operator">||</span>
                <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"gc_colorgrad"</span> <span class="token operator">||</span>
                <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"dp_color"</span> <span class="token operator">||</span>
                <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"dp_colorgrad"</span><span class="token punctuation">)</span>
                seam_find_type <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad seam finding method\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--blend"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"no"</span><span class="token punctuation">)</span>
                blend_type <span class="token operator">=</span> Blender<span class="token double-colon punctuation">::</span>NO<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"feather"</span><span class="token punctuation">)</span>
                blend_type <span class="token operator">=</span> Blender<span class="token double-colon punctuation">::</span>FEATHER<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"multiband"</span><span class="token punctuation">)</span>
                blend_type <span class="token operator">=</span> Blender<span class="token double-colon punctuation">::</span>MULTI_BAND<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad blending method\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--timelapse"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            timelapse <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"as_is"</span><span class="token punctuation">)</span>
                timelapse_type <span class="token operator">=</span> Timelapser<span class="token double-colon punctuation">::</span>AS_IS<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"crop"</span><span class="token punctuation">)</span>
                timelapse_type <span class="token operator">=</span> Timelapser<span class="token double-colon punctuation">::</span>CROP<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad timelapse method\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--rangewidth"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            range_width <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--blend_strength"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            blend_strength <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">atof</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--output"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            result_name <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
            img_names<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>preview<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        compose_megapix <span class="token operator">=</span> <span class="token number">0.6</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOG</span></span>
    int64 app_start_time <span class="token operator">=</span> <span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">setBreakOnError</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token keyword">int</span> retval <span class="token operator">=</span> <span class="token function">parseCmdArgs</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
        <span class="token keyword">return</span> retval<span class="token punctuation">;</span>

    <span class="token comment">// Check if have enough images</span>
    <span class="token keyword">int</span> num_images <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>img_names<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_images <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Need more images"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">double</span> work_scale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> seam_scale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> compose_scale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> is_work_scale_set <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> is_seam_scale_set <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> is_compose_scale_set <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Finding features..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOG</span></span>
    int64 t <span class="token operator">=</span> <span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    Ptr<span class="token operator">&lt;</span>FeaturesFinder<span class="token operator">></span> finder<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>features_type <span class="token operator">==</span> <span class="token string">"surf"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_OPENCV_XFEATURES2D</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>try_cuda <span class="token operator">&amp;&amp;</span> cuda<span class="token double-colon punctuation">::</span><span class="token function">getCudaEnabledDeviceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>SurfFeaturesFinderGpu<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>SurfFeaturesFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>features_type <span class="token operator">==</span> <span class="token string">"orb"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>OrbFeaturesFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Unknown 2D features type: '"</span> <span class="token operator">&lt;&lt;</span> features_type <span class="token operator">&lt;&lt;</span> <span class="token string">"'.\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    Mat full_img<span class="token punctuation">,</span> img<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>ImageFeatures<span class="token operator">></span> <span class="token function">features</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Mat<span class="token operator">></span> <span class="token function">images</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Size<span class="token operator">></span> <span class="token function">full_img_sizes</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> seam_work_aspect <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_images<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        full_img <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>img_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        full_img_sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> full_img<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>full_img<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Can't open image "</span> <span class="token operator">&lt;&lt;</span> img_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>work_megapix <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            img <span class="token operator">=</span> full_img<span class="token punctuation">;</span>
            work_scale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            is_work_scale_set <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_work_scale_set<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                work_scale <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>work_megapix <span class="token operator">*</span> <span class="token number">1e6</span> <span class="token operator">/</span> full_img<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                is_work_scale_set <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">resize</span><span class="token punctuation">(</span>full_img<span class="token punctuation">,</span> img<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> work_scale<span class="token punctuation">,</span> work_scale<span class="token punctuation">,</span> INTER_LINEAR_EXACT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_seam_scale_set<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            seam_scale <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>seam_megapix <span class="token operator">*</span> <span class="token number">1e6</span> <span class="token operator">/</span> full_img<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            seam_work_aspect <span class="token operator">=</span> seam_scale <span class="token operator">/</span> work_scale<span class="token punctuation">;</span>
            is_seam_scale_set <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token punctuation">(</span><span class="token operator">*</span>finder<span class="token punctuation">)</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> features<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        features<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>img_idx <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Features in image #"</span> <span class="token operator">&lt;&lt;</span> i<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span> <span class="token operator">&lt;&lt;</span> features<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>keypoints<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">resize</span><span class="token punctuation">(</span>full_img<span class="token punctuation">,</span> img<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seam_scale<span class="token punctuation">,</span> seam_scale<span class="token punctuation">,</span> INTER_LINEAR_EXACT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        images<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    finder<span class="token operator">-></span><span class="token function">collectGarbage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    full_img<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    img<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Finding features, time: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" sec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOG</span><span class="token punctuation">(</span><span class="token string">"Pairwise matching"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOG</span></span>
    t <span class="token operator">=</span> <span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    vector<span class="token operator">&lt;</span>MatchesInfo<span class="token operator">></span> pairwise_matches<span class="token punctuation">;</span>
    Ptr<span class="token operator">&lt;</span>FeaturesMatcher<span class="token operator">></span> matcher<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher_type <span class="token operator">==</span> <span class="token string">"affine"</span><span class="token punctuation">)</span>
        matcher <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>AffineBestOf2NearestMatcher<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> try_cuda<span class="token punctuation">,</span> match_conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>range_width<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        matcher <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>BestOf2NearestMatcher<span class="token operator">></span></span></span><span class="token punctuation">(</span>try_cuda<span class="token punctuation">,</span> match_conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        matcher <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>BestOf2NearestRangeMatcher<span class="token operator">></span></span></span><span class="token punctuation">(</span>range_width<span class="token punctuation">,</span> try_cuda<span class="token punctuation">,</span> match_conf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>matcher<span class="token punctuation">)</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> pairwise_matches<span class="token punctuation">)</span><span class="token punctuation">;</span>
    matcher<span class="token operator">-></span><span class="token function">collectGarbage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Pairwise matching, time: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" sec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check if we should save matches graph</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>save_graph<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Saving matches graph..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ofstream <span class="token function">f</span><span class="token punctuation">(</span>save_graph_to<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f <span class="token operator">&lt;&lt;</span> <span class="token function">matchesGraphAsString</span><span class="token punctuation">(</span>img_names<span class="token punctuation">,</span> pairwise_matches<span class="token punctuation">,</span> conf_thresh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Leave only images we are sure are from the same panorama</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> indices <span class="token operator">=</span> <span class="token function">leaveBiggestComponent</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> pairwise_matches<span class="token punctuation">,</span> conf_thresh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Mat<span class="token operator">></span> img_subset<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>String<span class="token operator">></span> img_names_subset<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Size<span class="token operator">></span> full_img_sizes_subset<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> indices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        img_names_subset<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>img_names<span class="token punctuation">[</span>indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        img_subset<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>images<span class="token punctuation">[</span>indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        full_img_sizes_subset<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>full_img_sizes<span class="token punctuation">[</span>indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    images <span class="token operator">=</span> img_subset<span class="token punctuation">;</span>
    img_names <span class="token operator">=</span> img_names_subset<span class="token punctuation">;</span>
    full_img_sizes <span class="token operator">=</span> full_img_sizes_subset<span class="token punctuation">;</span>

    <span class="token comment">// Check if we still have enough images</span>
    num_images <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>img_names<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_images <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Need more images"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    Ptr<span class="token operator">&lt;</span>Estimator<span class="token operator">></span> estimator<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>estimator_type <span class="token operator">==</span> <span class="token string">"affine"</span><span class="token punctuation">)</span>
        estimator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>AffineBasedEstimator<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        estimator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>HomographyBasedEstimator<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    vector<span class="token operator">&lt;</span>CameraParams<span class="token operator">></span> cameras<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>estimator<span class="token punctuation">)</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> pairwise_matches<span class="token punctuation">,</span> cameras<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Homography estimation failed.\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cameras<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        Mat R<span class="token punctuation">;</span>
        cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>R<span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R <span class="token operator">=</span> R<span class="token punctuation">;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Initial camera intrinsics #"</span> <span class="token operator">&lt;&lt;</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token string">":\nK:\n"</span> <span class="token operator">&lt;&lt;</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">K</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\nR:\n"</span> <span class="token operator">&lt;&lt;</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    Ptr<span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>BundleAdjusterBase<span class="token operator">></span> adjuster<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_cost_func <span class="token operator">==</span> <span class="token string">"reproj"</span><span class="token punctuation">)</span> adjuster <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>BundleAdjusterReproj<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_cost_func <span class="token operator">==</span> <span class="token string">"ray"</span><span class="token punctuation">)</span> adjuster <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>BundleAdjusterRay<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_cost_func <span class="token operator">==</span> <span class="token string">"affine"</span><span class="token punctuation">)</span> adjuster <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>BundleAdjusterAffinePartial<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_cost_func <span class="token operator">==</span> <span class="token string">"no"</span><span class="token punctuation">)</span> adjuster <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>NoBundleAdjuster<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Unknown bundle adjustment cost function: '"</span> <span class="token operator">&lt;&lt;</span> ba_cost_func <span class="token operator">&lt;&lt;</span> <span class="token string">"'.\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    adjuster<span class="token operator">-></span><span class="token function">setConfThresh</span><span class="token punctuation">(</span>conf_thresh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat_<span class="token operator">&lt;</span>uchar<span class="token operator">></span> refine_mask <span class="token operator">=</span> <span class="token class-name">Mat</span><span class="token double-colon punctuation">::</span><span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> CV_8U<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_refine_mask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'x'</span><span class="token punctuation">)</span> <span class="token function">refine_mask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_refine_mask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'x'</span><span class="token punctuation">)</span> <span class="token function">refine_mask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_refine_mask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'x'</span><span class="token punctuation">)</span> <span class="token function">refine_mask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_refine_mask<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'x'</span><span class="token punctuation">)</span> <span class="token function">refine_mask</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_refine_mask<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'x'</span><span class="token punctuation">)</span> <span class="token function">refine_mask</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    adjuster<span class="token operator">-></span><span class="token function">setRefinementMask</span><span class="token punctuation">(</span>refine_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>adjuster<span class="token punctuation">)</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> pairwise_matches<span class="token punctuation">,</span> cameras<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Camera parameters adjusting failed.\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Find median focal length</span>

    vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> focals<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cameras<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Camera #"</span> <span class="token operator">&lt;&lt;</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token string">":\nK:\n"</span> <span class="token operator">&lt;&lt;</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">K</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\nR:\n"</span> <span class="token operator">&lt;&lt;</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">)</span><span class="token punctuation">;</span>
        focals<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>focal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">sort</span><span class="token punctuation">(</span>focals<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> focals<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> warped_image_scale<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>focals<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        warped_image_scale <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>focals<span class="token punctuation">[</span>focals<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        warped_image_scale <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>focals<span class="token punctuation">[</span>focals<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> focals<span class="token punctuation">[</span>focals<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>do_wave_correct<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        vector<span class="token operator">&lt;</span>Mat<span class="token operator">></span> rmats<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cameras<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            rmats<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">waveCorrect</span><span class="token punctuation">(</span>rmats<span class="token punctuation">,</span> wave_correct<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cameras<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R <span class="token operator">=</span> rmats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Warping images (auxiliary)... "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOG</span></span>
    t <span class="token operator">=</span> <span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    vector<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">corners</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>UMat<span class="token operator">></span> <span class="token function">masks_warped</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>UMat<span class="token operator">></span> <span class="token function">images_warped</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Size<span class="token operator">></span> <span class="token function">sizes</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>UMat<span class="token operator">></span> <span class="token function">masks</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Preapre images masks</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_images<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        masks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CV_8U<span class="token punctuation">)</span><span class="token punctuation">;</span>
        masks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span><span class="token class-name">Scalar</span><span class="token double-colon punctuation">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Warp images and their masks</span>

    Ptr<span class="token operator">&lt;</span>WarperCreator<span class="token operator">></span> warper_creator<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_OPENCV_CUDAWARPING</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>try_cuda <span class="token operator">&amp;&amp;</span> cuda<span class="token double-colon punctuation">::</span><span class="token function">getCudaEnabledDeviceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"plane"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>PlaneWarperGpu<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"cylindrical"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CylindricalWarperGpu<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"spherical"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>SphericalWarperGpu<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"plane"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>PlaneWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"affine"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>AffineWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"cylindrical"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CylindricalWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"spherical"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>SphericalWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"fisheye"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>FisheyeWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"stereographic"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>StereographicWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"compressedPlaneA2B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CompressedRectilinearWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">2.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"compressedPlaneA1.5B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CompressedRectilinearWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">1.5f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"compressedPlanePortraitA2B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CompressedRectilinearPortraitWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">2.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"compressedPlanePortraitA1.5B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CompressedRectilinearPortraitWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">1.5f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"paniniA2B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>PaniniWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">2.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"paniniA1.5B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>PaniniWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">1.5f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"paniniPortraitA2B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>PaniniPortraitWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">2.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"paniniPortraitA1.5B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>PaniniPortraitWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">1.5f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"mercator"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>MercatorWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"transverseMercator"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>TransverseMercatorWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>warper_creator<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Can't create the following warper '"</span> <span class="token operator">&lt;&lt;</span> warp_type <span class="token operator">&lt;&lt;</span> <span class="token string">"'\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    Ptr<span class="token operator">&lt;</span>RotationWarper<span class="token operator">></span> warper <span class="token operator">=</span> warper_creator<span class="token operator">-></span><span class="token function">create</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>warped_image_scale <span class="token operator">*</span> seam_work_aspect<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_images<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        Mat_<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span> K<span class="token punctuation">;</span>
        cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">K</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> swa <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>seam_work_aspect<span class="token punctuation">;</span>
        <span class="token function">K</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*=</span> swa<span class="token punctuation">;</span> <span class="token function">K</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*=</span> swa<span class="token punctuation">;</span>
        <span class="token function">K</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*=</span> swa<span class="token punctuation">;</span> <span class="token function">K</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*=</span> swa<span class="token punctuation">;</span>

        corners<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> warper<span class="token operator">-></span><span class="token function">warp</span><span class="token punctuation">(</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> K<span class="token punctuation">,</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> INTER_LINEAR<span class="token punctuation">,</span> BORDER_REFLECT<span class="token punctuation">,</span> images_warped<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> images_warped<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        warper<span class="token operator">-></span><span class="token function">warp</span><span class="token punctuation">(</span>masks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> K<span class="token punctuation">,</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> INTER_NEAREST<span class="token punctuation">,</span> BORDER_CONSTANT<span class="token punctuation">,</span> masks_warped<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    vector<span class="token operator">&lt;</span>UMat<span class="token operator">></span> <span class="token function">images_warped_f</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_images<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        images_warped<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>images_warped_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Warping images, time: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" sec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Ptr<span class="token operator">&lt;</span>ExposureCompensator<span class="token operator">></span> compensator <span class="token operator">=</span> <span class="token class-name">ExposureCompensator</span><span class="token double-colon punctuation">::</span><span class="token function">createDefault</span><span class="token punctuation">(</span>expos_comp_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    compensator<span class="token operator">-></span><span class="token function">feed</span><span class="token punctuation">(</span>corners<span class="token punctuation">,</span> images_warped<span class="token punctuation">,</span> masks_warped<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Ptr<span class="token operator">&lt;</span>SeamFinder<span class="token operator">></span> seam_finder<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>seam_find_type <span class="token operator">==</span> <span class="token string">"no"</span><span class="token punctuation">)</span>
        seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>NoSeamFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seam_find_type <span class="token operator">==</span> <span class="token string">"voronoi"</span><span class="token punctuation">)</span>
        seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>VoronoiSeamFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seam_find_type <span class="token operator">==</span> <span class="token string">"gc_color"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_OPENCV_CUDALEGACY</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>try_cuda <span class="token operator">&amp;&amp;</span> cuda<span class="token double-colon punctuation">::</span><span class="token function">getCudaEnabledDeviceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>GraphCutSeamFinderGpu<span class="token operator">></span></span></span><span class="token punctuation">(</span>GraphCutSeamFinderBase<span class="token double-colon punctuation">::</span>COST_COLOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>GraphCutSeamFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span>GraphCutSeamFinderBase<span class="token double-colon punctuation">::</span>COST_COLOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seam_find_type <span class="token operator">==</span> <span class="token string">"gc_colorgrad"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_OPENCV_CUDALEGACY</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>try_cuda <span class="token operator">&amp;&amp;</span> cuda<span class="token double-colon punctuation">::</span><span class="token function">getCudaEnabledDeviceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>GraphCutSeamFinderGpu<span class="token operator">></span></span></span><span class="token punctuation">(</span>GraphCutSeamFinderBase<span class="token double-colon punctuation">::</span>COST_COLOR_GRAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>GraphCutSeamFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span>GraphCutSeamFinderBase<span class="token double-colon punctuation">::</span>COST_COLOR_GRAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seam_find_type <span class="token operator">==</span> <span class="token string">"dp_color"</span><span class="token punctuation">)</span>
        seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>DpSeamFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span>DpSeamFinder<span class="token double-colon punctuation">::</span>COLOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seam_find_type <span class="token operator">==</span> <span class="token string">"dp_colorgrad"</span><span class="token punctuation">)</span>
        seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>DpSeamFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span>DpSeamFinder<span class="token double-colon punctuation">::</span>COLOR_GRAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>seam_finder<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Can't create the following seam finder '"</span> <span class="token operator">&lt;&lt;</span> seam_find_type <span class="token operator">&lt;&lt;</span> <span class="token string">"'\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    seam_finder<span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span>images_warped_f<span class="token punctuation">,</span> corners<span class="token punctuation">,</span> masks_warped<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Release unused memory</span>
    images<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    images_warped<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    images_warped_f<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    masks<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Compositing..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOG</span></span>
    t <span class="token operator">=</span> <span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    Mat img_warped<span class="token punctuation">,</span> img_warped_s<span class="token punctuation">;</span>
    Mat dilated_mask<span class="token punctuation">,</span> seam_mask<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> mask_warped<span class="token punctuation">;</span>
    Ptr<span class="token operator">&lt;</span>Blender<span class="token operator">></span> blender<span class="token punctuation">;</span>
    Ptr<span class="token operator">&lt;</span>Timelapser<span class="token operator">></span> timelapser<span class="token punctuation">;</span>
    <span class="token comment">//double compose_seam_aspect = 1;</span>
    <span class="token keyword">double</span> compose_work_aspect <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> img_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> img_idx <span class="token operator">&lt;</span> num_images<span class="token punctuation">;</span> <span class="token operator">++</span>img_idx<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Compositing image #"</span> <span class="token operator">&lt;&lt;</span> indices<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Read image and resize it if necessary</span>
        full_img <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>img_names<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_compose_scale_set<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>compose_megapix <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                compose_scale <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>compose_megapix <span class="token operator">*</span> <span class="token number">1e6</span> <span class="token operator">/</span> full_img<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            is_compose_scale_set <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token comment">// Compute relative scales</span>
            <span class="token comment">//compose_seam_aspect = compose_scale / seam_scale;</span>
            compose_work_aspect <span class="token operator">=</span> compose_scale <span class="token operator">/</span> work_scale<span class="token punctuation">;</span>

            <span class="token comment">// Update warped image scale</span>
            warped_image_scale <span class="token operator">*=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>compose_work_aspect<span class="token punctuation">)</span><span class="token punctuation">;</span>
            warper <span class="token operator">=</span> warper_creator<span class="token operator">-></span><span class="token function">create</span><span class="token punctuation">(</span>warped_image_scale<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Update corners and sizes</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_images<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token comment">// Update intrinsics</span>
                cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>focal <span class="token operator">*=</span> compose_work_aspect<span class="token punctuation">;</span>
                cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ppx <span class="token operator">*=</span> compose_work_aspect<span class="token punctuation">;</span>
                cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ppy <span class="token operator">*=</span> compose_work_aspect<span class="token punctuation">;</span>

                <span class="token comment">// Update corner and size</span>
                Size sz <span class="token operator">=</span> full_img_sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">abs</span><span class="token punctuation">(</span>compose_scale <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1e-1</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    sz<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token function">cvRound</span><span class="token punctuation">(</span>full_img_sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>width <span class="token operator">*</span> compose_scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sz<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token function">cvRound</span><span class="token punctuation">(</span>full_img_sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>height <span class="token operator">*</span> compose_scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                Mat K<span class="token punctuation">;</span>
                cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">K</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Rect roi <span class="token operator">=</span> warper<span class="token operator">-></span><span class="token function">warpRoi</span><span class="token punctuation">(</span>sz<span class="token punctuation">,</span> K<span class="token punctuation">,</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">)</span><span class="token punctuation">;</span>
                corners<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> roi<span class="token punctuation">.</span><span class="token function">tl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> roi<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>compose_scale <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1e-1</span><span class="token punctuation">)</span>
            <span class="token function">resize</span><span class="token punctuation">(</span>full_img<span class="token punctuation">,</span> img<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> compose_scale<span class="token punctuation">,</span> compose_scale<span class="token punctuation">,</span> INTER_LINEAR_EXACT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            img <span class="token operator">=</span> full_img<span class="token punctuation">;</span>
        full_img<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Size img_size <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Mat K<span class="token punctuation">;</span>
        cameras<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">K</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Warp the current image</span>
        warper<span class="token operator">-></span><span class="token function">warp</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> K<span class="token punctuation">,</span> cameras<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> INTER_LINEAR<span class="token punctuation">,</span> BORDER_REFLECT<span class="token punctuation">,</span> img_warped<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Warp the current image mask</span>
        mask<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>img_size<span class="token punctuation">,</span> CV_8U<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mask<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span><span class="token class-name">Scalar</span><span class="token double-colon punctuation">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        warper<span class="token operator">-></span><span class="token function">warp</span><span class="token punctuation">(</span>mask<span class="token punctuation">,</span> K<span class="token punctuation">,</span> cameras<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> INTER_NEAREST<span class="token punctuation">,</span> BORDER_CONSTANT<span class="token punctuation">,</span> mask_warped<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Compensate exposure</span>
        compensator<span class="token operator">-></span><span class="token function">apply</span><span class="token punctuation">(</span>img_idx<span class="token punctuation">,</span> corners<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> img_warped<span class="token punctuation">,</span> mask_warped<span class="token punctuation">)</span><span class="token punctuation">;</span>

        img_warped<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>img_warped_s<span class="token punctuation">,</span> CV_16S<span class="token punctuation">)</span><span class="token punctuation">;</span>
        img_warped<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mask<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">dilate</span><span class="token punctuation">(</span>masks_warped<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> dilated_mask<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resize</span><span class="token punctuation">(</span>dilated_mask<span class="token punctuation">,</span> seam_mask<span class="token punctuation">,</span> mask_warped<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> INTER_LINEAR_EXACT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mask_warped <span class="token operator">=</span> seam_mask <span class="token operator">&amp;</span> mask_warped<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>blender <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>timelapse<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            blender <span class="token operator">=</span> <span class="token class-name">Blender</span><span class="token double-colon punctuation">::</span><span class="token function">createDefault</span><span class="token punctuation">(</span>blend_type<span class="token punctuation">,</span> try_cuda<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Size dst_sz <span class="token operator">=</span> <span class="token function">resultRoi</span><span class="token punctuation">(</span>corners<span class="token punctuation">,</span> sizes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span> blend_width <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>dst_sz<span class="token punctuation">.</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> blend_strength <span class="token operator">/</span> <span class="token number">100.f</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>blend_width <span class="token operator">&lt;</span> <span class="token number">1.f</span><span class="token punctuation">)</span>
                blender <span class="token operator">=</span> <span class="token class-name">Blender</span><span class="token double-colon punctuation">::</span><span class="token function">createDefault</span><span class="token punctuation">(</span>Blender<span class="token double-colon punctuation">::</span>NO<span class="token punctuation">,</span> try_cuda<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>blend_type <span class="token operator">==</span> Blender<span class="token double-colon punctuation">::</span>MULTI_BAND<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                MultiBandBlender<span class="token operator">*</span> mb <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>MultiBandBlender<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>blender<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mb<span class="token operator">-></span><span class="token function">setNumBands</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token function">log</span><span class="token punctuation">(</span>blend_width<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Multi-band blender, number of bands: "</span> <span class="token operator">&lt;&lt;</span> mb<span class="token operator">-></span><span class="token function">numBands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>blend_type <span class="token operator">==</span> Blender<span class="token double-colon punctuation">::</span>FEATHER<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                FeatherBlender<span class="token operator">*</span> fb <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>FeatherBlender<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>blender<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fb<span class="token operator">-></span><span class="token function">setSharpness</span><span class="token punctuation">(</span><span class="token number">1.f</span><span class="token operator">/</span>blend_width<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Feather blender, sharpness: "</span> <span class="token operator">&lt;&lt;</span> fb<span class="token operator">-></span><span class="token function">sharpness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            blender<span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span>corners<span class="token punctuation">,</span> sizes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timelapser <span class="token operator">&amp;&amp;</span> timelapse<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            timelapser <span class="token operator">=</span> <span class="token class-name">Timelapser</span><span class="token double-colon punctuation">::</span><span class="token function">createDefault</span><span class="token punctuation">(</span>timelapse_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            timelapser<span class="token operator">-></span><span class="token function">initialize</span><span class="token punctuation">(</span>corners<span class="token punctuation">,</span> sizes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Blend the current image</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timelapse<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            timelapser<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span>img_warped_s<span class="token punctuation">,</span> <span class="token class-name">Mat</span><span class="token double-colon punctuation">::</span><span class="token function">ones</span><span class="token punctuation">(</span>img_warped_s<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CV_8UC1<span class="token punctuation">)</span><span class="token punctuation">,</span> corners<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String fixedFileName<span class="token punctuation">;</span>
            size_t pos_s <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>img_names<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find_last_of</span><span class="token punctuation">(</span><span class="token string">"/\\"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pos_s <span class="token operator">==</span> String<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                fixedFileName <span class="token operator">=</span> <span class="token string">"fixed_"</span> <span class="token operator">+</span> img_names<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                fixedFileName <span class="token operator">=</span> <span class="token string">"fixed_"</span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span>img_names<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>pos_s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span>img_names<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> pos_s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">imwrite</span><span class="token punctuation">(</span>fixedFileName<span class="token punctuation">,</span> timelapser<span class="token operator">-></span><span class="token function">getDst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            blender<span class="token operator">-></span><span class="token function">feed</span><span class="token punctuation">(</span>img_warped_s<span class="token punctuation">,</span> mask_warped<span class="token punctuation">,</span> corners<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timelapse<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        Mat result<span class="token punctuation">,</span> result_mask<span class="token punctuation">;</span>
        blender<span class="token operator">-></span><span class="token function">blend</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> result_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Compositing, time: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" sec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">imwrite</span><span class="token punctuation">(</span>result_name<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Finished, total time: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> app_start_time<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" sec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="不能拼接的原因">不能拼接的原因</h5>
<p>  从上面的流程我们可知，如果要拼接成功，则首要条件是保证图片间图像重叠部分的特征点重合（匹配）的地方比较多。我们分析例子可知，特征点提取用的是SURF算法，我查阅资料可知：我认为，SURF算法主要提取的是一些突出点，比如轮廓边缘，角点。也就是说，特征点出现位置，一般都在有形状的地方或者形状变化明显的地方。</p>
<p>  而我拼接不成功的原因是，我图像中大部分区域都为纯白色的天花板，导致整体特征点比较少，图像重叠部分的特征点也较少，导致其匹配特征点的时候失败了。而我，改变了几个相机之间的固定视角后，总算是Stitcher类的默认算法都能拼接了。</p>
<br/>
<br/>
<h5 id="解决思路">解决思路</h5>
<p>  用上面例子的提取特征点的源码，然后把每张图的特征点画出来，观察一下特征点的情况，根据实际情况分析和调整。</p>
<p>  例如下图：经过实验发现，Stitcher算法要拼接成功的要素是图间的重叠部分的特征点 重叠度和重叠数量要达到一个阈值才行。（此图就是用上面的源码，提取特征，并在原图上把图画出来）</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_063/img.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  opencv关于图像拼接的东西基本上整个原理都在例子中的cpp中，需要的时候，可以对此cpp文件结合网上大多数资料进行分析。</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/opencv/" rel="tag"># opencv</a>
              <a href="/tags/%E5%85%A8%E6%99%AF/" rel="tag"># 全景</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2018/05/15/blog_idx_062/" rel="prev" title="NVIDIA Jestson TX2 配置cuda以及cudnn的坑 ( JetPack-L4T 、Error: downloading update lock、TX2,TX1,TK1相关资源信息)">
                  <i class="fa fa-angle-left"></i> NVIDIA Jestson TX2 配置cuda以及cudnn的坑 ( JetPack-L4T 、Error: downloading update lock、TX2,TX1,TK1相关资源信息)
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2018/05/28/blog_idx_064/" rel="next" title="HISI3520DV300 折腾记录(三)之《终篇》">
                  HISI3520DV300 折腾记录(三)之《终篇》 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Sky</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">286k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">17:19</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":250,"hOffset":50,"vOffset":5},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
</html>
