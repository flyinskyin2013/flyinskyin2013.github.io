<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"e-x.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="PS：要转载请注明出处，本人版权所有。 PS: 这个只是基于《我自己》的理解，如果和你的原则及想法相冲突，请谅解，勿喷。  环境说明   本文所有实例环境为：win10+py35 序    我们有个任务，需要在C里面调用pycaffe的算法来做相关的检测。（不要问我为啥不直接用caffe的c接口，因为后面还要调tensorflow和pytorch，导致了算法组为了统(偷)一（懒），就直接怼了一">
<meta property="og:type" content="article">
<meta property="og:title" content="C++ 调用 Python 总结(一)">
<meta property="og:url" content="https://e-x.top/2020/01/09/blog_idx_091/index.html">
<meta property="og:site_name" content="Sky&#39;s Blogs">
<meta property="og:description" content="PS：要转载请注明出处，本人版权所有。 PS: 这个只是基于《我自己》的理解，如果和你的原则及想法相冲突，请谅解，勿喷。  环境说明   本文所有实例环境为：win10+py35 序    我们有个任务，需要在C里面调用pycaffe的算法来做相关的检测。（不要问我为啥不直接用caffe的c接口，因为后面还要调tensorflow和pytorch，导致了算法组为了统(偷)一（懒），就直接怼了一">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/com.png">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/run.png">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/pyobj1.png">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/pyobj2.png">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/eg.png">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg">
<meta property="article:published_time" content="2020-01-09T10:39:55.000Z">
<meta property="article:modified_time" content="2024-05-18T11:06:02.631Z">
<meta property="article:author" content="Sky">
<meta property="article:tag" content="CPP">
<meta property="article:tag" content="深度学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/com.png">


<link rel="canonical" href="https://e-x.top/2020/01/09/blog_idx_091/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://e-x.top/2020/01/09/blog_idx_091/","path":"2020/01/09/blog_idx_091/","title":"C++ 调用 Python 总结(一)"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>C++ 调用 Python 总结(一) | Sky's Blogs</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8677552300382028"
     crossorigin="anonymous"></script>


  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Sky's Blogs</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A normal star</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>
<div class="custom-middle-nav animated fadeInDown">
  <div class="custom-nav-item">
    <a href="/archives/"><i class="fa fa-archive"></i> 日志历程</a>
  </div>
  <div class="custom-nav-item">
    <a href="/categories/"><i class="fa fa-th"></i> 全部分类</a>
  </div>
  <div class="custom-nav-item">
    <a href="/tags/"><i class="fa fa-tags"></i> 热门标签</a>
  </div>
  <div class="custom-nav-item">
    <a href="javascript:;" class="my-search-btn"><i class="fa fa-search"></i> 本站搜索</a>
  </div>
</div>


<script>
// 使用脚本手动触发 NexT 的搜索弹窗
document.addEventListener('DOMContentLoaded', () => {
  const customBtn = document.querySelector('.my-search-btn');
  customBtn.addEventListener('click', (e) => {
    e.preventDefault();
    // 找到 NexT 原生的那个搜索触发按钮并模拟点击
    const originalBtn = document.querySelector('.site-nav-right .popup-trigger');
    if (originalBtn) {
      originalBtn.click();
    } else {
      // 如果原生的没找到，尝试直接调用 NexT 的 Search 内部变量（针对某些版本）
      if (typeof CONFIG.local_search !== 'undefined') {
        // 尝试手动激活弹窗
        document.querySelector('.search-pop-overlay').style.display = 'block';
        document.body.style.overflow = 'hidden';
        document.querySelector('.search-input').focus();
      }
    }
  });
});
</script>
</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sky"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Sky</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">92</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">222</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/flyinskyin2013" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;flyinskyin2013" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
<div id="days" style="margin-top: 10px; font-size: 13px; color: #555;"></div>
<script>
  function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("01/07/2014 00:00:00"); // 这里改成你建站的时间
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
    secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
    e_daysold=timeold/msPerDay
    daysold=Math.floor(e_daysold);
    document.getElementById("days").innerHTML="本站已运行 "+daysold+" 天";
  }
  show_date_time();
</script>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2020/01/09/blog_idx_091/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="C++ 调用 Python 总结(一) | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          C++ 调用 Python 总结(一)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-01-09 18:39:55" itemprop="dateCreated datePublished" datetime="2020-01-09T18:39:55+08:00">2020-01-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-30 23:43:18
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=091） 
&emsp;&emsp;本文发布于 2020-01-09 18:39:55，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=091） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  本文所有实例环境为：win10+py35</p>
<h3 id="序">序</h3>
<hr>
<p>  我们有个任务，需要在C<ins>里面调用pycaffe的算法来做相关的检测。（不要问我为啥不直接用caffe的c</ins>接口，因为后面还要调tensorflow和pytorch，导致了算法组为了统(偷)一（懒），就直接怼了一个pycaffe）。</p>
<p>  我还是第一次遇到这类问题，我去查了查，还真的有相关的内容，真的是存在即合理。</p>
<p>  本文大部分内容都是主要参考python官方手册，其次也看了网络上的一些资料，我这里做了一些汇总和衍生。(官方手册<a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/c-api/index.html">https://docs.python.org/zh-cn/3/c-api/index.html</a>)</p>
<p>  阅读本文需要一定的c++基本‘’姿势‘’和了解一些最最最简单的py‘’姿势‘’。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Python-C-Hello-World">Python C Hello World</h3>
<hr>
<p>  先来一个全世界通用的例子。(没做异常处理)</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span><span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//</span></span>
<span class="token comment">/*
Note Since Python may define some pre-processor definitions which affect the standard headers on some systems, you must include Python.h before any standard headers are included.
It is recommended to always define PY_SSIZE_T_CLEAN before including Python.h. See Parsing arguments and building values for a description of this macro.
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PY_SSIZE_T_CLEAN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Python.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token comment">//This function works like Py_Initialize() if initsigs is 1. </span>
    <span class="token comment">//If initsigs is 0, it skips initialization registration of signal handlers, which might be useful when Python is embedded.</span>
    <span class="token function">Py_InitializeEx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"print('hello world.')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_WIN32 <span class="token operator">||</span> _WIN64</span></span>

    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">__linux__ <span class="token operator">||</span> __linux</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//    </span></span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  编译，设定python的头文件和库文件路径。（注意python的库名字），我这里是在win上做的演示，实际是部署到linux.相关结果如图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/com.png" alt="rep_img"/></center>
    </div>
</div>    
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/run.png" alt="rep_img"/></center>
    </div>
</div>   
<br/>
<br/>
<br/>
<br/>
<h3 id="Python-C-常用接口">Python C 常用接口</h3>
<hr>
<br/>
<br/>
<h5 id="python-基本数据类型对象">python 基本数据类型对象</h5>
<p>  更加详细的，请查看官方doc中关于Py_BuildValue()接口的描述。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">    PyObject <span class="token operator">*</span> func_name <span class="token operator">=</span> <span class="token function">Py_BuildValue</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">,</span><span class="token string">"test_add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    PyObject <span class="token operator">*</span> arg1 <span class="token operator">=</span> <span class="token function">Py_BuildValue</span><span class="token punctuation">(</span><span class="token string">"l"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
```  

<span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">></span>

##### python 序列或者容器对象
<span class="token operator">&amp;</span>emsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>emsp<span class="token punctuation">;</span>更多内容，详见官方doc
```cpp
<span class="token comment">//tuple</span>
PyObject<span class="token operator">*</span> <span class="token function">PyTuple_New</span><span class="token punctuation">(</span>Py_ssize_t len<span class="token punctuation">)</span>
<span class="token comment">//Return value: New reference.</span>
<span class="token comment">//Return a new tuple object of size len, or NULL on failure.</span>

PyObject<span class="token operator">*</span> <span class="token function">PyTuple_GetItem</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>p<span class="token punctuation">,</span> Py_ssize_t pos<span class="token punctuation">)</span>
<span class="token comment">//Return value: Borrowed reference.</span>
<span class="token comment">//Return the object at position pos in the tuple pointed to by p. If pos is out of bounds, return NULL and set an IndexError exception.</span>

<span class="token keyword">int</span> <span class="token function">PyTuple_SetItem</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>p<span class="token punctuation">,</span> Py_ssize_t pos<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>o<span class="token punctuation">)</span>
<span class="token comment">//Insert a reference to object o at position pos of the tuple pointed to by p. Return 0 on success. If pos is out of bounds, return -1 and set an IndexError exception.</span>
<span class="token comment">//list</span>
<span class="token comment">//原理同tuple</span>
PyObject<span class="token operator">*</span> <span class="token function">PyList_New</span><span class="token punctuation">(</span>Py_ssize_t len<span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">PyList_SetItem</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>list<span class="token punctuation">,</span> Py_ssize_t index<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>item<span class="token punctuation">)</span>
PyObject<span class="token operator">*</span> <span class="token function">PyList_GetItem</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>list<span class="token punctuation">,</span> Py_ssize_t index<span class="token punctuation">)</span>
<span class="token comment">//dict</span>
<span class="token comment">//原理同tuple</span>
PyObject<span class="token operator">*</span> <span class="token function">PyDict_New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">PyDict_SetItem</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>p<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>key<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>val<span class="token punctuation">)</span>
PyObject<span class="token operator">*</span> <span class="token function">PyDict_GetItem</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>p<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>key<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  对于这些python中的数据类型对象，都有相关的c api来创建、操作，更多的内容可以查看官方doc。这部分内容较简单，不做示例。</p>
<br/>
<br/>
<h5 id="python-模块对象">python 模块对象</h5>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">PyObject<span class="token operator">*</span> <span class="token function">PyImport_ImportModuleEx</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>globals<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>locals<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>fromlist<span class="token punctuation">)</span>
<span class="token comment">/*
Return value: New reference.
Import a module. This is best described by referring to the built-in Python function __import__().

The return value is a new reference to the imported module or top-level package, or NULL with an exception set on failure. Like for __import__(), the return value when a submodule of a package was requested is normally the top-level package, unless a non-empty fromlist was given.

Failing imports remove incomplete module objects, like with PyImport_ImportModule().
*/</span>
PyObject<span class="token operator">*</span> <span class="token function">PyModule_GetDict</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token keyword">module</span><span class="token punctuation">)</span>
<span class="token comment">/*
Return value: Borrowed reference.
Return the dictionary object that implements module's namespace; this object is the same as the __dict__ attribute of the module object. If module is not a module object (or a subtype of a module object), SystemError is raised and NULL is returned.

It is recommended extensions use other PyModule_*() and PyObject_*() functions rather than directly manipulate a module's __dict__.
*/</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  这些api主要是导入python模块，类似关键字import，同时返回模块的属性dict。这些属性包含当前命名空间下的：全局变量，全局函数，类等等。</p>
<br/>
<br/>
<h5 id="python-callable-object-python-class-object-python-object-function">python callable object , python class object, python object function</h5>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*
Return value: New reference.
Call a callable Python object callable, with arguments given by the tuple args. If no arguments are needed, then args can be NULL.

Return the result of the call on success, or raise an exception and return NULL on failure.

This is the equivalent of the Python expression: callable(*args).
*/</span>
PyObject<span class="token operator">*</span> <span class="token function">PyObject_CallObject</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>callable<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>args<span class="token punctuation">)</span>


<span class="token comment">/*
Return value: New reference.
Return a new instance method object, with func being any callable object func is the function that will be called when the instance method is called.
*/</span>
PyObject<span class="token operator">*</span> <span class="token function">PyInstanceMethod_New</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>func<span class="token punctuation">)</span>

<span class="token comment">//call obj.func</span>
PyObject<span class="token operator">*</span> <span class="token function">PyObject_CallMethod</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>obj<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
PyObject<span class="token operator">*</span> <span class="token function">PyObject_CallMethodObjArgs</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>obj<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="PyObject-对象">PyObject 对象</h3>
<hr>
<p>  这个对象是pythonc c api 所有对象的wrapper，有许许多多需要注意的事项，其中最重要的就是其内存管理问题。详细细节参考官方doc，这里给出最重要的几条我遇到的结论：</p>
<ol>
<li class="lvl-3">
<p>pyobject 是依靠引用计数来管理对象的。</p>
</li>
<li class="lvl-3">
<p>pyobject 的创建者需要对这个obj负责，创建者可以传递，存储，和调用 Py_DECREF()</p>
</li>
<li class="lvl-3">
<p>python c api 都有关于pyobject的处理说明，比如：借用，新建。如下图。</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/pyobj1.png" alt="rep_img"/></center>
    </div>
</div>   
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/pyobj2.png" alt="rep_img"/></center>
    </div>
</div>   
<p><front color = red size = 4>本章特别重要，有兴趣的去看官方文档。当你乱用Py_INCREF和Py_DECREF时，你写的程序会在调用Py_Finalize时崩溃，这个时候，你需要看下文，去看看你哪个地方用错了。（<a target="_blank" rel="noopener" href="https://docs.python.org/3.8/extending/extending.html#ownership-rules%EF%BC%89">https://docs.python.org/3.8/extending/extending.html#ownership-rules）</a></front></p>
<br/>
<br/>
<br/>
<br/>
<h3 id="实例">实例</h3>
<hr>
<p>  上一个实例来展示本文所有内容。</p>
<p>  这是我要调用的python module</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''
'''</span>
<span class="token decorator annotation punctuation">@Description</span><span class="token punctuation">:</span> 
<span class="token decorator annotation punctuation">@Author</span><span class="token punctuation">:</span> Sky
<span class="token decorator annotation punctuation">@Date</span><span class="token punctuation">:</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">:</span><span class="token number">29</span>
<span class="token decorator annotation punctuation">@LastEditors</span>  <span class="token punctuation">:</span> Sky
<span class="token decorator annotation punctuation">@LastEditTime</span> <span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">09</span> <span class="token number">18</span><span class="token punctuation">:</span><span class="token number">04</span><span class="token punctuation">:</span><span class="token number">41</span>
<span class="token decorator annotation punctuation">@FilePath</span><span class="token punctuation">:</span> \Test_C_Call_Python\py_modules\py_normal_test<span class="token punctuation">.</span>py
<span class="token string">''</span>'
<span class="token keyword">import</span> sys

<span class="token keyword">class</span> <span class="token class-name">TestPythonNormal</span><span class="token punctuation">:</span>
    cls_attr <span class="token operator">=</span> <span class="token string">'I am cls attr'</span>
    <span class="token comment"># def __new__(class_ins):</span>
    <span class="token comment">#     print('call TestPythonNormal.__new__')</span>
    <span class="token comment">#     return class_ins</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'call TestPythonNormal.__init__'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>obj_attr <span class="token operator">=</span> <span class="token string">'I am obj attr'</span>

    <span class="token keyword">def</span> <span class="token function">test_add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"a = "</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"b = "</span><span class="token punctuation">,</span>  b<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"a + b = "</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span>


g_num <span class="token operator">=</span> <span class="token number">22222</span>
g_str <span class="token operator">=</span> <span class="token string">'hello f***'</span>

<span class="token keyword">def</span> <span class="token function">g_func</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"g_func arg = "</span><span class="token punctuation">,</span> a <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    test <span class="token operator">=</span> TestPythonNormal<span class="token punctuation">(</span><span class="token punctuation">)</span>
    test<span class="token punctuation">.</span>test_add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>TestPythonNormal<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>
    <span class="token comment"># print(TestPythonNormal.__dir__(test))</span>


<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*
 * @Description: 
 * @Author: Sky
 * @Date: 2020-01-09 11:26:28
 * @LastEditors  : Sky
 * @LastEditTime : 2020-01-09 18:21:53
 * @FilePath: \Test_C_Call_Python\test_tmp.cpp
 * @Github: 
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span><span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PY_SSIZE_T_CLEAN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Python.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token comment">//This function works like Py_Initialize() if initsigs is 1. </span>
    <span class="token comment">//If initsigs is 0, it skips initialization registration of signal handlers, which might be useful when Python is embedded.</span>
    <span class="token function">Py_InitializeEx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"print('hello world.')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//add path of module-py_normal_test to sys.path</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"import sys"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"import numpy as np"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"sys.path.append('E://TestDir//Test_C_Call_Python//py_modules')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"print(sys.path)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//import </span>
    <span class="token comment">//Return value: New reference.</span>
    PyObject <span class="token operator">*</span> p_module <span class="token operator">=</span> <span class="token function">PyImport_ImportModuleEx</span><span class="token punctuation">(</span><span class="token string">"py_normal_test"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//import module</span>

    <span class="token comment">//get module attr, they are g_var, g_func, class and so on.</span>
    <span class="token comment">//Return value: Borrowed reference.</span>
    PyObject <span class="token operator">*</span> p_dict_mo <span class="token operator">=</span> <span class="token function">PyModule_GetDict</span><span class="token punctuation">(</span>p_module<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//get module's all attr</span>
    <span class="token comment">//Return value: Borrowed reference.</span>
    PyObject <span class="token operator">*</span> p_module_g_num <span class="token operator">=</span> <span class="token function">PyDict_GetItemString</span><span class="token punctuation">(</span>p_dict_mo<span class="token punctuation">,</span> <span class="token string">"g_num"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// global var</span>

    PyObject <span class="token operator">*</span> p_module_cls <span class="token operator">=</span> <span class="token function">PyDict_GetItemString</span><span class="token punctuation">(</span>p_dict_mo<span class="token punctuation">,</span> <span class="token string">"TestPythonNormal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//class</span>

    PyObject <span class="token operator">*</span> p_module_g_func <span class="token operator">=</span> <span class="token function">PyDict_GetItemString</span><span class="token punctuation">(</span>p_dict_mo<span class="token punctuation">,</span> <span class="token string">"g_func"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// global function</span>

    <span class="token comment">//print g_var</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"g_num is "</span><span class="token operator">&lt;&lt;</span><span class="token function">PyLong_AsLong</span><span class="token punctuation">(</span>p_module_g_num<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token comment">//call g_func</span>
    <span class="token comment">//Return value: New reference.</span>
    PyObject <span class="token operator">*</span> arg_tuple <span class="token operator">=</span> <span class="token function">PyTuple_New</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyTuple_SetItem</span><span class="token punctuation">(</span>arg_tuple<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p_module_g_num<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//prepare arg</span>
    <span class="token function">PyObject_CallObject</span><span class="token punctuation">(</span>p_module_g_func<span class="token punctuation">,</span> arg_tuple<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//call g_func</span>
    

    <span class="token comment">//instance a class</span>
    <span class="token comment">//Return value: New reference.</span>
    PyObject <span class="token operator">*</span> p_cls_instance <span class="token operator">=</span> <span class="token function">PyInstanceMethod_New</span><span class="token punctuation">(</span>p_module_cls<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//call builtin.__new__, new a instance</span>
    <span class="token comment">//Return value: New reference.</span>
    p_cls_instance <span class="token operator">=</span> <span class="token function">PyObject_CallObject</span><span class="token punctuation">(</span>p_cls_instance<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//call __init__,construct function,return None</span>
    <span class="token comment">// Py_XDECREF(p_none);</span>

    <span class="token comment">//print class-var</span>
    <span class="token comment">//Return value: New reference.</span>
    <span class="token comment">//PyObject* PyObject_GetAttrString(PyObject *o, const char *attr_name)</span>
    PyObject <span class="token operator">*</span> cls_attr <span class="token operator">=</span> <span class="token function">PyObject_GetAttrString</span><span class="token punctuation">(</span>p_module_cls<span class="token punctuation">,</span> <span class="token string">"cls_attr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"cls_attr is "</span><span class="token operator">&lt;&lt;</span><span class="token function">PyUnicode_AsUTF8</span><span class="token punctuation">(</span>cls_attr<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    
    <span class="token comment">//print obj.var</span>
    PyObject <span class="token operator">*</span> obj_attr <span class="token operator">=</span> <span class="token function">PyObject_GetAttrString</span><span class="token punctuation">(</span>p_cls_instance<span class="token punctuation">,</span> <span class="token string">"obj_attr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"obj_attr is "</span><span class="token operator">&lt;&lt;</span><span class="token function">PyUnicode_AsUTF8</span><span class="token punctuation">(</span>obj_attr<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token comment">//call obj.func</span>
    <span class="token comment">//Way0: This is the equivalent of the Python expression: obj.name(arg1, arg2, ...).</span>
    <span class="token comment">//Return value: New reference.Return value: New reference.</span>
    PyObject <span class="token operator">*</span> ret0 <span class="token operator">=</span> <span class="token function">PyObject_CallMethod</span><span class="token punctuation">(</span>p_cls_instance<span class="token punctuation">,</span> <span class="token string">"test_add"</span><span class="token punctuation">,</span> <span class="token string">"ii"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//test_add(self, 10, 10)</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"call obj.func, Way0 ret =  "</span><span class="token operator">&lt;&lt;</span><span class="token function">PyLong_AsLong</span><span class="token punctuation">(</span>ret0<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    
    <span class="token comment">//Return value: New reference.</span>
    PyObject <span class="token operator">*</span> func_name <span class="token operator">=</span> <span class="token function">Py_BuildValue</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">,</span><span class="token string">"test_add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>
    PyObject <span class="token operator">*</span> arg1 <span class="token operator">=</span> <span class="token function">Py_BuildValue</span><span class="token punctuation">(</span><span class="token string">"l"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    PyObject <span class="token operator">*</span> arg2 <span class="token operator">=</span> <span class="token function">Py_BuildValue</span><span class="token punctuation">(</span><span class="token string">"l"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//Return value: New reference.</span>
    PyObject <span class="token operator">*</span> ret1 <span class="token operator">=</span> <span class="token function">PyObject_CallMethodObjArgs</span><span class="token punctuation">(</span>p_cls_instance<span class="token punctuation">,</span> func_name<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span>  <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//test_add(self, 3, 3)</span>
    <span class="token function">PyErr_PrintEx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"call obj.func, Way1 ret =  "</span><span class="token operator">&lt;&lt;</span><span class="token function">PyLong_AsLong</span><span class="token punctuation">(</span>ret1<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        
    



    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>ret1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>func_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>ret0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>obj_attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>cls_attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>p_cls_instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>p_module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//Py_XDECREF(ret0);</span>

    <span class="token function">Py_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_WIN32 <span class="token operator">||</span> _WIN64</span></span>

    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">__linux__ <span class="token operator">||</span> __linux</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//    </span></span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  效果：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/eg.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  以下的内容希望重点关注：</p>
<font color = red size = 4>
<ol>
<li class="lvl-3">
<p>其实这个看起来是很简单的，如果有一定的c++基础，整个流程就是导入模块，获取模块中的属性，这些属性包括函数，全局变量，类等等。</p>
</li>
<li class="lvl-3">
<p>操作全局的函数和变量</p>
</li>
<li class="lvl-3">
<p>这里最难的还是对于python class 的操作，第1点中获取的类属性是一个callable object，这个时候需要实例化class(这里调用了builtin的__new__，而不是class中重载的__new__)，然后需要手动调用__init__方法。到此，class的实例化完成</p>
</li>
<li class="lvl-3">
<p>通过api获取class的属性，就是class的变量</p>
</li>
<li class="lvl-3">
<p>通过api调用object method，传入obj和函数名，包括参数，直接调用即可，主要某些api要关注self这个参数。</p>
</li>
</ol>
</font>
<br/>
<br/>
<br/>
<br/>
<h3 id="调试常用手段">调试常用手段</h3>
<hr>
<ol>
<li class="lvl-3">
<p>如果Py_Finalize()调用时，崩溃了，请检查自己的Py_INCREF和Py_DECREF各个引用增减是否正确。</p>
</li>
<li class="lvl-3">
<p>如果某些python c api调用失败了，可以尝试使用 PyErr_PrintEx(1);</p>
</li>
</ol>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CPP/" rel="tag"># CPP</a>
              <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" rel="tag"># 深度学习</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/12/20/blog_idx_090/" rel="prev" title="软件开发、持续集成（CI）、持续交付(CD)、持续部署（CD） 和 版本管理(Version Control) 的理解和思考">
                  <i class="fa fa-angle-left"></i> 软件开发、持续集成（CI）、持续交付(CD)、持续部署（CD） 和 版本管理(Version Control) 的理解和思考
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/03/12/blog_idx_092/" rel="next" title="undefined symbol: PyFPE_jbuf 问题分析并处理">
                  undefined symbol: PyFPE_jbuf 问题分析并处理 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Sky</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">286k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">17:19</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":250,"hOffset":50,"vOffset":5},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
</html>
