<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"e-x.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="PS：要转载请注明出处，本人版权所有。 PS: 这个只是基于《我自己》的理解，如果和你的原则及想法相冲突，请谅解，勿喷。  环境说明   高通865 android盒子   Hexagon_SDK   前言    由于业务需求，我们需要展示高通865的cpu&#x2F;gpu&#x2F;dsp的使用率，其中cpu&#x2F;gpu是非常简单的。但是对于dsp来说，我找了许久，才发现了一点点端倪，下面就是这一部分成果。">
<meta property="og:type" content="article">
<meta property="og:title" content="高通cDSP简单编程例子（实现查询高通cDSP使用率、签名），RK3588 npu使用率查询">
<meta property="og:url" content="https://e-x.top/2022/07/31/blog_idx_117/index.html">
<meta property="og:site_name" content="Sky&#39;s Blogs">
<meta property="og:description" content="PS：要转载请注明出处，本人版权所有。 PS: 这个只是基于《我自己》的理解，如果和你的原则及想法相冲突，请谅解，勿喷。  环境说明   高通865 android盒子   Hexagon_SDK   前言    由于业务需求，我们需要展示高通865的cpu&#x2F;gpu&#x2F;dsp的使用率，其中cpu&#x2F;gpu是非常简单的。但是对于dsp来说，我找了许久，才发现了一点点端倪，下面就是这一部分成果。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_117/dsp_info.png">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_117/perf.png">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_117/dsp_usage_info.png">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_117/dsp_result.png">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_117/rknpu_usage.png">
<meta property="og:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg">
<meta property="article:published_time" content="2022-07-31T10:11:00.000Z">
<meta property="article:modified_time" content="2024-05-18T11:06:02.665Z">
<meta property="article:author" content="Sky">
<meta property="article:tag" content="cdsp">
<meta property="article:tag" content="qcom">
<meta property="article:tag" content="rk3588">
<meta property="article:tag" content="npu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_117/dsp_info.png">


<link rel="canonical" href="https://e-x.top/2022/07/31/blog_idx_117/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://e-x.top/2022/07/31/blog_idx_117/","path":"2022/07/31/blog_idx_117/","title":"高通cDSP简单编程例子（实现查询高通cDSP使用率、签名），RK3588 npu使用率查询"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>高通cDSP简单编程例子（实现查询高通cDSP使用率、签名），RK3588 npu使用率查询 | Sky's Blogs</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  




<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8677552300382028"
     crossorigin="anonymous"></script>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Sky's Blogs</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A normal star</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E"><span class="nav-number">1.</span> <span class="nav-text">环境说明</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number"></span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AB%98%E9%80%9AcDSP%E4%BD%BF%E7%94%A8%E7%8E%87%E6%9F%A5%E8%AF%A2"><span class="nav-number"></span> <span class="nav-text">高通cDSP使用率查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E9%AB%98%E9%80%9Adsp-sdk"><span class="nav-number"></span> <span class="nav-text">安装高通dsp sdk</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%AB%98%E9%80%9AcDSP%E4%BD%BF%E7%94%A8%E7%8E%87%E6%9F%A5%E8%AF%A2%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="nav-number"></span> <span class="nav-text">高通cDSP使用率查询原理分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%AB%98%E9%80%9AcDSP%E7%BC%96%E7%A8%8B"><span class="nav-number"></span> <span class="nav-text">高通cDSP编程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%AB%98%E9%80%9AcDSP%E7%A8%8B%E5%BA%8F%E9%83%A8%E7%BD%B2%E5%8F%8A%E7%AD%BE%E5%90%8D"><span class="nav-number"></span> <span class="nav-text">高通cDSP程序部署及签名</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RK3588-NPU%E4%BD%BF%E7%94%A8%E7%8E%87%E6%9F%A5%E8%AF%A2"><span class="nav-number"></span> <span class="nav-text">RK3588 NPU使用率查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="nav-number"></span> <span class="nav-text">后记</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-number"></span> <span class="nav-text">参考文献</span></a></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Sky</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">92</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">222</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2022/07/31/blog_idx_117/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="高通cDSP简单编程例子（实现查询高通cDSP使用率、签名），RK3588 npu使用率查询 | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          高通cDSP简单编程例子（实现查询高通cDSP使用率、签名），RK3588 npu使用率查询
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-31 18:11:00" itemprop="dateCreated datePublished" datetime="2022-07-31T18:11:00+08:00">2022-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/C-CPP/android/" itemprop="url" rel="index"><span itemprop="name">android</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-08-14 20:46:57
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=117） 
&emsp;&emsp;本文发布于 2022-07-31 18:11:29  （BlogID=117） 
-->
<h6 id="环境说明">环境说明</h6>
<ul class="lvl-0">
<li class="lvl-2">
<p>高通865 android盒子</p>
</li>
<li class="lvl-2">
<p>Hexagon_SDK</p>
</li>
</ul>
<h3 id="前言">前言</h3>
<hr>
<p>  由于业务需求，我们需要展示高通865的cpu/gpu/dsp的使用率，其中cpu/gpu是非常简单的。但是对于dsp来说，我找了许久，才发现了一点点端倪，下面就是这一部分成果。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="高通cDSP使用率查询">高通cDSP使用率查询</h3>
<hr>
<p>  要实现高通dsp使用率的查询，我们最开始查询到的一点资料是一个sysmon tools，这个工具在高通的sdk中，这个工具可以查看相关的利用率，所以我们按照这个方向走下去。</p>
<br/>
<br/>
<h5 id="安装高通dsp-sdk">安装高通dsp sdk</h5>
<p>  去此网站下载sdk并安装（<a target="_blank" rel="noopener" href="https://developer.qualcomm.com/software/hexagon-dsp-sdk/tools%EF%BC%89">https://developer.qualcomm.com/software/hexagon-dsp-sdk/tools）</a> 。注意，安装需要java环境，请自备。</p>
<p>  然后我们需要检查我们的环境配置。</p>
<p>  参考SDK目录中Hexagon_SDK/3.5.4/docs/calculator_c++.html，然后进入Hexagon_SDK\3.5.4\examples\common\calculator_c++目录，编译生成target文件及模拟文件。然后安装教程，将计算器例子拷贝到设备相关目录进行运行，成功得到计算结果。这代表环境配置正确。</p>
<p>  注意：这里可能会有很多问题，多看文档，多对比。特别是设备对应的dsp工具链选对，详情参考：Hexagon_SDK/3.5.4/docs/feature_matrix.html。</p>
<p>  在这一步的计算器例子执行完成之后，基本上，我们应该知道生成的文件有3个，一个是android adb 可执行文件，一个是可执行文件对应的ndk库。一个是ndk库对应的dsp调用so。它们之间的关系是执行可执行文件，查找对应的符号，然后通过fastrpc调用dsp对应的符号，并得到结果。详情参考：Hexagon_SDK/3.5.4/docs/APIs_FastRPC.html#FastRPC%20architecture</p>
<br/>
<br/>
<h5 id="高通cDSP使用率查询原理分析">高通cDSP使用率查询原理分析</h5>
<p>  在Hexagon_SDK\3.5.4\tools\utils\sysmon，当我把sysMon_DSP_Profiler_V2.apk安装到系统后，终于看到了cDSP使用率查询的一丝方法。从图中可知，我们得到了dsp的当前工作频率，以及当前的使用率。但是我的需求是制作一个小工具，能够直接打印出core utilization，所以需要想其他办法。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_117/dsp_info.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  当我了解到这些内容后，就得把目标放在高通sdk里面的perf相关内容里面，我查询了相关api和文档后（Hexagon_SDK/3.5.4/docs/APIs_DSP%20Clk%20&amp;%20Rsrc%20Mgmt.html），发现了两个相关的内容，DSP Power and Performance Management 以及 HAP PMU framework。但是这个时候，我还是没有办法知道官方的工具里面显示的使用率是怎么算的。最开始：根据文档Hexagon_SDK/3.5.4/docs/images/Hexagon_Document_Bundle.pdf 第9章 processor event symbols，我以为直接用COMMITTED_PKT_ANY及COMMITTED_PKT_SMT就能计算出使用率，但是经过我的分析，怎么算都对不上，这个时候我又把重心转向官方的分析工具，官方的分析工具能够保存数据，然后用官方的其他的工具来后处理之后进行分析，看看能否从这里找到一些相关信息。</p>
<p>  再次使用官方工具分析dsp信息然后保存相关的数据文件，然后dump到windows上，得到sysmon_CDSP.bin，用工具分析。在Hexagon_SDK\3.5.4\tools\utils\sysmon\parser_win_v2 目录有两个工具，一个是解析工具，一个是生成html报告，我们按照官方的方法生成html报告,如下图。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_117/perf.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  我们打开生成的html报告，我在报告中总算查看到了QDSP6 Utilization和QDSP6 Core performance ，如下图。通过阅读相关含义，了解到了官方app中的core utilization的计算方法。其计算方法为：使用率=（总执行次数/当前频率(hz) * 采样时间(s)）* 100。原理解释：总执行次数除以当前频率下满载运行次数，得到使用率。这里的总执行次数由HAP_perf_get_pcycles来得到,当前运行频率由HAP_power_get得到。到此，整个技术上的链条打通了，现在开始编写小程序。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_117/dsp_usage_info.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<h5 id="高通cDSP编程">高通cDSP编程</h5>
<p>  首先，直接复制一个calculator_c++官方例子工程来作为模板，根据我了解到的资料，直接选取makefile作为作为编译手段。通过编写dsp的小程序，然后得到我们的使用率。下面是重要api的展示。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
* Data type to retrieve power values from the ADSP
* @param type				-	Identifies the type to retrieve.
* @param max_mips			-	Max mips supported
* @param max_bus_bw			-	Max bus bw supported
* @param client_class		-	Current client class
* @param clkFreqHz			-	Current core CPU frequency
* @param aggregateAVSMpps	-	Aggregate AVS Mpps used by audio and voice
* @param dcvsEnabled		-	Indicates if dcvs is enabled / disabled.
*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	HAP_Power_response_type type<span class="token punctuation">;</span>
	<span class="token keyword">union</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_mips<span class="token punctuation">;</span>
		uint64 max_bus_bw<span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> client_class<span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> clkFreqHz<span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> aggregateAVSMpps<span class="token punctuation">;</span>
		boolean dcvsEnabled<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> HAP_power_response_t<span class="token punctuation">;</span>

<span class="token comment">/**
* Method to retrieve power values from the ADSP
* @param context	-	Ignored
* @param request	-	Response.
*/</span>
<span class="token keyword">int</span> <span class="token function">HAP_power_get</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> context<span class="token punctuation">,</span> HAP_power_response_t<span class="token operator">*</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token comment">/* 
  HAP_perf_get_pcycles 
   
  Gets the current 64-bit processor cycle count
   
  The processor cycle count is the current number of processor cycles executed
  since the Hexagon processor was last reset.
 
  Note that this counter stops incrementing whenever the DSP enters a low-power
  state (such as clock gating), as opposed to the qtimer, which increments 
  regardless of the DSP power state.

	
  Returns:
  Integer -- Current count of Hexagon processor cycle count.
*/</span>
uint64 <span class="token function">HAP_perf_get_pcycles</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  对于我们编写dsp小程序来说，有一个值得注意的地方，这些api虽然我们是在android ndk程序里面调用的，但是我们仅仅是在android ndk侧找到符号，然后通过fastrpc将参数发给dsp端，dsp端调用对应的api后，将结果返回给android ndk端。此部分重点参考前文环境配置部分，对于新手来说，很难理解或者说适应这个东西。</p>
<br/>
<br/>
<h5 id="高通cDSP程序部署及签名">高通cDSP程序部署及签名</h5>
<p>  由于高通的cDSP程序调用方式比较特殊，我们应该按照官方Hexagon_SDK/3.5.4/docs/calculator_c++.html例子中推荐的部署方式，如果需要自定义部署，请参考环境变量DSP_LIBRARY_PATH。也就是拷贝android侧文件到对应目录，拷贝dsp侧目录到对应目录。</p>
<p>  此外，当你真的自定义程序并部署使用的时候，会遇到签名问题。在开发阶段，我们都是使用testsign,具体详情参考：Hexagon_SDK/3.5.4/docs/Tools_Signing.html，就是按照官方方法生成一个对应的testsign-xxxx.so的文件，此文件包含了当前设备的id，能够让运行在当前设备上的程序免签。但是这种方法只能够用于调试，对于大规模使用，需要采取另外的部署方式，一种是联系厂家，提供批量签名工具，另外就是使用 Unsigned PD 功能（Unsigned PD is a sandboxed low-rights process that allows the signature-free modules to run on the cDSP.）。Unsigned PD可以让一些低权程序运行在dsp上，主要还是被用于神经网络推理。但是就是这个Unsigned PD也是不是那么好用的，这里直接copy小米mace框架里面的so和代码，在执行任何dsp api之前调用hexnn_controller_request_unsigned_pd（<a target="_blank" rel="noopener" href="https://github.com/XiaoMi/mace/blob/fa72958a647be9457cf0a19d2f1195205a4b1a58/mace/runtimes/hexagon/dsp/hexagon_dsp_wrapper.cc%EF%BC%89">https://github.com/XiaoMi/mace/blob/fa72958a647be9457cf0a19d2f1195205a4b1a58/mace/runtimes/hexagon/dsp/hexagon_dsp_wrapper.cc）</a> 。 这里不得不感叹一句，这些厂家的py关系真好。</p>
<p>  当所有部署完毕之后，执行dsp程序得到如下图结果：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_117/dsp_result.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<br/>
<br/>
<h3 id="RK3588-NPU使用率查询">RK3588 NPU使用率查询</h3>
<hr>
<p>  题外话，最近RK的npu使用率查询方法官方也提供了，在3588上，只用npu驱动为0.72+就可以。结果如下图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_117/rknpu_usage.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  这里关于dsp编程来说，我这里可以说仅仅是一个小demo，这个部分最有价值的还是计算加速部分，一些重要的向量运算，这次我没有这个需求就不去关注了。</p>
<p>  但是换句话说，有了这一部分的经验后，后面哪怕是学习一些深入的东西，也是有一点基础在的。</p>
<h3 id="参考文献">参考文献</h3>
<p>[1]Qualcomm.Hexagon SDK 3.5.4 Doc<br>
[2]RockChip.Rockchip_RKNPU_User_Guide_RKNN_API_V1.3.0_CN</p>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/><font color="red" size="7">如某些图片无法查看，请尝试开启外网</font><br/></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/cdsp/" rel="tag"># cdsp</a>
              <a href="/tags/qcom/" rel="tag"># qcom</a>
              <a href="/tags/rk3588/" rel="tag"># rk3588</a>
              <a href="/tags/npu/" rel="tag"># npu</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/07/03/blog_idx_116/" rel="prev" title="jvm jni 及 pvm pybind11 大批量数据传输及优化">
                  <i class="fa fa-angle-left"></i> jvm jni 及 pvm pybind11 大批量数据传输及优化
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/07/02/blog_idx_121/" rel="next" title="Linux 图形栈从入门到放弃 --- Linux 图形相关概念简介">
                  Linux 图形栈从入门到放弃 --- Linux 图形相关概念简介 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Sky</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">286k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">17:19</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":250,"hOffset":50,"vOffset":5},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
</html>
