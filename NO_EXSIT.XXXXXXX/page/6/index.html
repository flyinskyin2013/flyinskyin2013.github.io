<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"e-x.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Sky&#39;s Blogs">
<meta property="og:url" content="https://e-x.top/NO_EXSIT.XXXXXXX/page/6/index.html">
<meta property="og:site_name" content="Sky&#39;s Blogs">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Sky">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://e-x.top/NO_EXSIT.XXXXXXX/page/6/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"NO_EXSIT.XXXXXXX/page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Sky's Blogs</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  




<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8677552300382028"
     crossorigin="anonymous"></script>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Sky's Blogs</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A normal star</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Sky</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">92</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">222</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2019/09/02/blog_idx_088/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/09/02/blog_idx_088/" class="post-title-link" itemprop="url">数与计算机 （编码、原码、反码、补码、移码、IEEE 754、定点数、浮点数）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-09-02 17:19:42" itemprop="dateCreated datePublished" datetime="2019-09-02T17:19:42+08:00">2019-09-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%B8%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">常识</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%B8%E8%AF%86/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-30 23:12:27
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=088） 
&emsp;&emsp;本文发布于 2019-09-02 17:19:42，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=088） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  ubuntu 18.04</p>
<p>  Linux 4.15.0-54-generic #58-Ubuntu SMP Mon Jun 24 10:55:24 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</p>
<h3 id="起因">起因</h3>
<hr>
<p>  有些时候，在测试深度学习的模型的时候，特别是模型出问题，或者其他乱七八糟的原因，你会发现某些层的某些特征会出现INF和NAN(特别是转换模型)。说实话，这两个一个是无穷大，一个是不是数字，我们都知道这个的意思，但是怎么出现的，可能都忘了。</p>
<p>  我如果没有记错的话，数在计算机中的表示是来至于《计算机组成原理》，其中介绍了很多很多的有趣的原理。但是我出校后，这些理论知识很少和实际联系起来，趁着这次机会，我准备结合我们平常写的代码，理一理计算机中数的这个问题。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="符号">符号</h3>
<hr>
<p>  在计算机里面，除了指令，就是数值或者符号（统一的说就是数值，因为数值和符号有映射关系，这就是符号编码），我也不知道这样说对不对。</p>
<p>  本文主要是说的是数值。对于符号来说，符号涉及到编码问题，有兴趣的可以去了解了解，我们常见的编码就是ascii，utf-8, unicode，gbk，big5等等，这些编码涉及到符号显示的问题。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="数值">数值</h3>
<hr>
<p>  数值大致有两类表示法，一类是定点数，一类是浮点数。</p>
<p>  计算机中，对于整数来说，就是定点数表示法（这里对于整数的说法我也不太确定对不对，相关资料也没有查到明确的说法，但是我理解的是整数就是定点数表示法中，小数点在最右边），对于实数来说，就是浮点数表示法。</p>
<br/>
<br/>
<h5 id="整数">整数</h5>
<p>  在计算机中，在说明整数的定点数表示之前，还得说几个书上的理论：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>原码：原码就是十进制转换为二进制。</p>
</li>
<li class="lvl-2">
<p>反码：原码取反。</p>
</li>
<li class="lvl-2">
<p>补码：反码+1。（注意：如果是符号数，反码和补码运算不影响符号位。）</p>
</li>
</ul>
<p>  在计算机中，正整数的补码反码原码一样，负整数的补码是原码取反加1。</p>
<p>  对于整数来说，可以分为有符号还是无符号的整数。</p>
<p>  无符号数，是正整数，所以在计算机中是补码表示，且就是其十进制转换为二进制。</p>
<p>  有符号整数，如果是正整数，计算机中补码表示，且就是其十进制转换为二进制（补码原码一样），如果是负整数，在计算机中表示，且就是其十进制转换为二进制，取补码。</p>
<br/>
<br/>
<h5 id="实数">实数</h5>
<p>  在计算机中，在说明浮点数表示法之前，还得说两个理论：移码：N-M转换为二进制，M为偏移数。</p>
<p>  二进制浮点数：整数部分直接转换为二进制（除2逆序取余），小数部分逼近求和（乘2正序取整）。（更详细的百度随便找个教程即可，我这里只是简单写一下）</p>
<p>  规范化二进制浮点数：小数点前只有一个1。</p>
<p>  IEEE 754：IEEE根据一些历史因素，定制的大部分通用的浮点数表示方法。以单精度浮点数为例，31位表示符号位，23-30位表示exponent（偏移数是M，指数为E.），0-22表示base(底数为B)，表示的浮点数为：B*(2^(E-M))</p>
<p>  IEEE 754有很多特殊值，也有一些溢出规则和约等于规则，一般来说，除非你要做科学运算，平常你是遇不到的，简单了解一下即可。</p>
<p>  IEEE 754规定的特殊值：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/ieee_sp.png" alt="rep_img"/></center>
    </div>
</div>    
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/ieee_fmt.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  注意：其实浮点数还有其他的一些异常计算及表示，详细的请查看ieee 754 chapter7</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="实例分析">实例分析</h3>
<hr>
<p>  上面扯了半天，大家都看烦了，其实都是一些书本上的知识整理。</p>
<p>  下面是实例源文件。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc <span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

<span class="token comment">//integer</span>
	<span class="token keyword">char</span> A <span class="token operator">=</span> <span class="token number">0xF1</span><span class="token punctuation">;</span><span class="token comment">//A = -15; size(A) = 1;mem=[1]111 0001(complement); mem=[1]000 1111(true form)</span>
	<span class="token keyword">short</span> B <span class="token operator">=</span> <span class="token number">0xF111</span><span class="token punctuation">;</span><span class="token comment">//B= -3823; size(B) = 2; mem = [1]111 0001 / 0001 0001 (complement); mem=[1]000 1110 / 1110 1111(true form)</span>
	<span class="token keyword">int</span> C <span class="token operator">=</span> <span class="token number">0xF1111111</span><span class="token punctuation">;</span><span class="token comment">//C = -250539759; size(C) = 4; mem = [1]111 0001 / 0001 0001 / 0001 0001 / 0001 0001 (complement); mem=[1]000 1110 / 1110 1110 / 1110 1110 / 1110 1111 (true form)</span>
	<span class="token keyword">long</span> D <span class="token operator">=</span> <span class="token number">0xF1111111</span><span class="token punctuation">;</span><span class="token comment">//D = -250539759(size(D)=4), 4044427537(size(D)=8); size(D) = 4; mem = [1]111 0001 / 0001 0001 / 0001 0001 / 0001 0001 (complement); mem=[1]000 1110 / 1110 1110 / 1110 1110 / 1110 1111 (true form)(Sizeof(D) may be 4 or 8, it decided by compiler)</span>
	<span class="token keyword">long</span> <span class="token keyword">long</span> E <span class="token operator">=</span> <span class="token number">0xF111111111111111</span><span class="token punctuation">;</span><span class="token comment">//E = -1076060070966390511; size(E) = 8; mem = [1]111 0001 / 0001 0001 / 0001 0001 / 0001 0001 / 0001 0001 / 0001 0001 / 0001 0001 / 0001 0001 (complement); mem=[1]000 1110 / 1110 1110 / 1110 1110 / 1110 1110 / 1110 1110 / 1110 1110 / 1110 1110 / 1110 1111 (true form)</span>

	<span class="token comment">//overflow int</span>
	<span class="token keyword">int</span> C1 <span class="token operator">=</span> <span class="token number">0xF1111111FF</span><span class="token punctuation">;</span><span class="token comment">//drop highest byte(0xF1), it decided by compiler</span>

	<span class="token comment">//overflow long long</span>
	<span class="token keyword">long</span> <span class="token keyword">long</span> E1 <span class="token operator">=</span> <span class="token number">0xF111111111111111FF</span><span class="token punctuation">;</span><span class="token comment">//drop highest byte(0xF1), it decided by compiler</span>



<span class="token comment">//float, IEEE 754.</span>
<span class="token comment">/*	
single-precision float
bits: [31] is signed bit, (30~23) is exponent, &#123;22~0&#125; is base

double-precision float
bits: [63] is signed bit, (62~52) is exponent, &#123;51~0&#125; is base
*/</span>
	<span class="token keyword">float</span> F <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//size(F)=4, mem=[1](100 0001 / 0)&#123;010 0000 / 0000 0000 / 0000 0000&#125;, [] is signed bit. () is exponent, &#123;&#125; is normalized base.(single-precision)</span>
	<span class="token keyword">double</span> G <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//size(G)=8, mem=[0](100 0000 / 0010) &#123;0100 / 0000 0000 / 0000 0000 / 0000 0000 / 0000 0000 / 0000 0000 / 0000 0000&#125;, [] is signed bit. () is exponent, &#123;&#125; is normalized base.(double-precision)</span>

	<span class="token keyword">int</span> tmp_buf <span class="token operator">=</span> <span class="token number">0x00800001</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> F_normalized_min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>F_normalized_min<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>F_normalized_min<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//size(F)=4</span>
	<span class="token keyword">float</span> F_normalized_zero <span class="token operator">=</span> F_normalized_min <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//-1</span>


	<span class="token keyword">float</span> F_normalized_max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	tmp_buf <span class="token operator">=</span> <span class="token number">0x7F7FFFFF</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>F_normalized_max<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>F_normalized_max<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//size(F)=4</span>
	<span class="token keyword">float</span> F_normalized_infinity <span class="token operator">=</span> F_normalized_max <span class="token operator">*</span> F_normalized_max<span class="token punctuation">;</span> <span class="token comment">//inf</span>
	
	<span class="token keyword">float</span> F_normalized_nan <span class="token operator">=</span> F_normalized_infinity <span class="token operator">/</span> F_normalized_infinity<span class="token punctuation">;</span><span class="token comment">//nan</span>

	<span class="token comment">//some fun value</span>
	<span class="token keyword">float</span> F_fun_01 <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> F_fun_02 <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> F_fun_03 <span class="token operator">=</span> <span class="token number">0.3</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> F_fun_04 <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> F_fun_05 <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> F_fun_06 <span class="token operator">=</span> <span class="token number">0.6</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> F_fun_07 <span class="token operator">=</span> <span class="token number">0.7</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> F_fun_08 <span class="token operator">=</span> <span class="token number">0.8</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> F_fun_09 <span class="token operator">=</span> <span class="token number">0.9</span><span class="token punctuation">;</span>

	<span class="token keyword">float</span> F_denormalized_min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	tmp_buf <span class="token operator">=</span> <span class="token number">0x00000001</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>F_denormalized_min<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>F_denormalized_min<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//size(F)=4</span>
	<span class="token keyword">float</span> F_denormalized_max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	tmp_buf <span class="token operator">=</span> <span class="token number">0x007FFFFF</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>F_denormalized_max<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>F_denormalized_max<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//size(F)=4</span>




	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="整数分析">整数分析</h5>
<p>  有符号负整数：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/int1.png" alt="rep_img"/></center>
    </div>
</div>    
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/int2.png" alt="rep_img"/></center>
    </div>
</div>    
<p>（注意，x86，小端）</p>
<p>  无符号整数、有符号正整数，就是直接10进制转换为二进制。</p>
<br/>
<br/>
<h5 id="浮点数分析">浮点数分析</h5>
<p>  规范化浮点数：（数值：规范化浮点数最小正数）</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/f1.png" alt="rep_img"/></center>
    </div>
</div>   
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/f2.png" alt="rep_img"/></center>
    </div>
</div>   
<p>（数值：规范化浮点数最大正数）</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/f3.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/f4.png" alt="rep_img"/></center>
    </div>
</div>  
（数值：非规范化浮点数最小正数）
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/f5.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/f6.png" alt="rep_img"/></center>
    </div>
</div>  
（数值：非规范化浮点数最大正数）
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/f7.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/f8.png" alt="rep_img"/></center>
    </div>
</div>  
<p>浮点数异常计算：（数值：NAN）</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/f9.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/f10.png" alt="rep_img"/></center>
    </div>
</div>  
<p>（数值：INF）</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/f11.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/f12.png" alt="rep_img"/></center>
    </div>
</div>  
<br/>
<br/>
<br/>
<br/>
<h3 id="一些有趣的浮点数">一些有趣的浮点数</h3>
<hr>
<p>  看了上边后，计算机关于浮点数的的存储其实是很离散的（很不靠谱），也就是说，很多浮点数计算机根本表示不出来（计算机只能够存储，实数数轴上极少部分的数），为什么呢？如果你要是了解了上面关于10进制浮点数转2进制浮点数，那么你可能已经猜到了原因。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/sp_f1.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/sp_f2.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  下面我以0.1位例，分析一下，为啥会出现这样的问题。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_088/sp_f3.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  0.1在计算机中表示为：</p>
<pre class="line-numbers language-none"><code class="language-none">mem&#x3D;[0](011 1101&#x2F; 1)&#123;100 1100&#x2F; 1100 1100&#x2F; 1100 1100&#125;, [] is signed bit. () is exponent, &#123;&#125; is normalized base.(single-precision)

E&#x3D;123
M&#x3D;127
B&#x3D;1.100 1100&#x2F; 1100 1100&#x2F; 1100 1100

F_fun_01 &#x3D; B*2(^-4) &#x3D; 0.0001100 1100&#x2F; 1100 1100&#x2F; 1100 1100 &#x3D; 2^(-4) + 2^(-5) + 2^(-8) + 2^(-9) + 2^(-12) + 2^(-13) + 2^(-16) + 2^(-17) + 2^(-20) + 2^(-21) + 2^(-24) + 2^(-25) <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  正是因为在内存中表示的是这样的，所以这里打印出来的值看到不是0.1，而是0.1+。那么大家可能会疑惑，如果0.1都有误差，那计算的时候，不是炸了吗？其实不然，还记得c语言中一句话吗？float的精度为小数点后6位，为啥是6位，而不是10位，8位呢？其实原因就是来至于这里，计算机中，某些小数位后虽然还有值，但是不是有效的，但是这些值影响数值的舍进（类似与四舍五入的约等于，建议大致了解，知道有这个事情即可）。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  总结</p>
<p>  计算机里面，数的表示，就浮点数最难，但是只需要了解了大致的原理，你就会觉得非常简单。</p>
<p>  其实对于计算机来说，数值的表示很弱的，离表示整个数轴差的远。</p>
<p>  在计算机里面，数值有很多边界条件，比如溢出、异常运算、异常值，只是我们平常很少遇到，所以遗忘了。</p>
<p>  同时也可以说明，其实计算机仅仅是个机器，只会冰冷的加载指令和数，并执行，只是我们的前辈们为我们做了很多事情，隔离了很多细节和底层，让我们觉得这些东西可有可无，极大的便利人们使用计算机。这样有好处也有坏处。</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2019/08/24/blog_idx_087/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/24/blog_idx_087/" class="post-title-link" itemprop="url">TX2 核心板 GPIO、IO扩展器、拨码开关、LED灯 使用总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-24 11:48:24" itemprop="dateCreated datePublished" datetime="2019-08-24T11:48:24+08:00">2019-08-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%B8%B8%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">常识</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%B8%B8%E8%AF%86/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-30 22:51:45
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=087） 
&emsp;&emsp;本文发布于 2019-08-24 11:48:24，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=087） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="起因">起因</h3>
<hr>
<p>  我们有个项目，做了一个基于TX2核心板的硬件板卡，这个板卡除了做相关算法的检测之外，还得提供一些控制LED啊、通过拨码开关这些来设置一些内容的小功能，你说气不气，这些小功能还必须要实现。如果LED和拨码开关直接挂载到tx2的gpio上的话，就没有必要写本文了，没意义，因为只要学过嵌入式的人，给他一个板子，再差劲，读取和设置一个gpio的高低电平总会吧。如果不会，建议还多学学嵌入式基础知识(从单片机玩起来，先裸奔，再上OS)。</p>
<p>  这里我们知道，其实对于芯片来说，引脚是非常珍贵的，如果芯片所需要实现的功能复杂，那么通用的io管脚异常珍贵，这里就出现了一个种器件，叫做IO扩展器（所实话，我都不知道这样翻译对不对），从名字可知，就是较少的引脚扩展出更多的引脚，本文就是用两个引脚扩展出了16个引脚。</p>
<p>  TX2上,由于使用了Linux，读取和设置gpio也是非常简单的，直接打开相关的gpio设备，读写即可。不要问我为啥要用linux，不用其他os，或者直接裸机控制，我只能够回答曰：我是想啊，可是我实力不允许啊，什么caffe、opencv、ncnn、cuda等等堆到其他系统或者裸机下，我着实能力不够，弄不过去，关键还麻烦。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="IO扩展器">IO扩展器</h3>
<hr>
<br/>
<br/>
<h5 id="IO扩展器原理简介">IO扩展器原理简介</h5>
<p>  其实本文的核心就是IO扩展器，这个器件由于我玩的板子少，见识少，我是第一次见到这种器件。下图就是这种器件在tx2手册里面的推荐使用方法。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_087/io.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  这种器件就是通过某种总线，然后扩展出尽可能多的io口。这里的这个器件通过I2C总线，扩展出16个io口。</p>
<p>  这里我们可以看到：SCL和SDA是I2C通信总线，A0和A1是可编程配置I2C从器件地址。（这里不懂也没关系，就是这个器件的地址可以编程设置，至于为啥要有这个地址，可以简单理解为一个总线挂载多个设备，某一时刻总线只能为其中一个设备提供服务，这些设备的区分就是通过地址来完成的。）</p>
<p>  P00-P17是扩展出来的IO口。</p>
<p>  知道以上足够了，没学过的也足够了。</p>
<p>  这个器件的特性是：通过I2C协议操作他的寄存器，他有8个8位寄存器，0-1寄存器是INPUT用，2-3寄存器是OUTPUT用，4-5好像是优先级裁决，6-7是配置寄存器，就是配置IO口是输出还是输入，如果接触过单片机、stm32这种的GPIO程序的话，是很好理解的。（手动滑稽，我出了校门就没接触过了）</p>
<p>  不要问下图的是什么器件（问就是不知道，手动滑稽），这只是举个例子，这个io扩展器的寄存器分配以及功能就是这样的。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_087/io_r0.png" alt="rep_img"/></center>
    </div>
</div>   
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_087/io_r1.png" alt="rep_img"/></center>
    </div>
</div> 
<br/>
<br/>
<h5 id="IO扩展器编程操作—shell-command">IO扩展器编程操作—shell command</h5>
<p>  首先这个器件是通过I2C协议操作的，不用关心I2C是什么，他们你可以类比为HTTP。那么Linux上怎么通过I2C操作这个器件呢？</p>
<p>  首先，Linux上有一组工具：i2c-tool，它可以读取所有芯片的i2c bus上挂载的芯片，设置和读取寄存器等等，拿来做测试或者封装一个程序都是不错的。TX2的ubuntu16.04是自带这个工具的，他的详细用法大家去百度，我不造轮子了。</p>
<p>  在Ubuntu里面操作I2C是非常简单的，你不需要关心I2C的具体传输规定，不用管时序这些烦人的事情。</p>
<p>  首先我们先用工具来测试，美滋滋：</p>
<p>  还记得上文我提了这个IO扩展器的从地址的事情吗？由于我的A0和A1都是接的低电平，在这里我的器件地址是0x74，怎么来的，看下图。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_087/io_addr.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  然后通过i2cdetect查看我们器件的位置（0x74）（注意，这个命令需要传入一个I2C总线序号，我这里是0，也就是说你要知道你这个IO扩展器挂载到哪个总线上的，这和SCL和SDL接线有关，有兴趣的可以去翻一翻手册就知道了，UU代表有人在占用这个设备）</p>
<p>  shell:&gt;i2cdetect -y -r -a 0</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_087/sh0.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  i2cdump可以通过标准i2c协议探测出所有的寄存器的值，下图8个寄存器的值就的出来了，分别对应上面的寄存器说明。XX代表没有这个寄存器。</p>
<p>  shell:&gt;i2cdump -f -y  0 0x74</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_087/sh1.png" alt="rep_img"/></center>
    </div>
</div>
<p>  然后：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>i2cset -f -y i2c_bus_num slave_addr reg_num value 设置寄存器值</p>
</li>
<li class="lvl-2">
<p>i2cget -f -y i2c_bus_num slave_addr reg_num 获取寄存器值</p>
</li>
</ul>
<p>  其实通过上面的操作就可以完成整个io扩展器的操作，我们可以通过程序执行shell命令的方式设置和操作值。</p>
<br/>
<br/>
<h5 id="IO扩展器编程操作—syscall">IO扩展器编程操作—syscall</h5>
<p>  实际上，linux做了很多东西，我们可以用标准的linux sys-api来完成以上内容，其实这些api就是i2ctool使用的部分。</p>
<p>  下面不墨迹，直接给出led操作的接口，有需要的参考吧。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">open_led_device</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> i2c_bus_num<span class="token punctuation">,</span> <span class="token keyword">int</span> slave_addr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>i2c_bus_num<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//打开i2c总线</span>

        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open i2c bus error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> I2C_SLAVE_FORCE<span class="token punctuation">,</span> DEVICE_I2C_ADDR<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//设置从器件地址，这里使用I2C_SLAVE_FORCE进行强行设置，那么这个设备忙</span>

        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"set device slave addr error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token function">write_led_register</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> LED_REG1_CFG_ADDR<span class="token punctuation">,</span> LED_REG1_CFG_VAL<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//设置写寄存器值，这两个宏和你的硬件连线有关。这里不给出。</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"init pin for output-mode failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> fd<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">read_led_register</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> reg_addr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>read_val<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//读寄存器</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reg_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//write reg addr ,从器件地址通过open接口设置好后，先写入要读的reg地址</span>

        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"set reg addr error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> read_val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//read data，等待i2c返回刚刚要查询的reg值</span>

        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read reg error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">write_led_register</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">char</span> reg_addr<span class="token punctuation">,</span> <span class="token keyword">char</span> data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//写寄存器</span>

    <span class="token keyword">char</span> tmp_buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>


    tmp_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span>  reg_addr<span class="token punctuation">;</span><span class="token comment">//reg 地址</span>
    tmp_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span><span class="token comment">//reg 值</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> tmp_buf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//write data</span>

        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write data error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">close_led_device</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//关闭</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="LED灯">LED灯</h3>
<hr>
<p>  此处省略XXX字。</p>
<p>  相信每个人都知道，常规情况下，在LED灯的两边加电源正极和负极，灯就能亮。在电路设计上，一般来说，LED灯的一端都是和电源正极或者负极是连接好的，另一端和GPIO口接上。如果GPIO输出的电压和另一端电压逻辑一致（比如都是高电平、都是低电平），灯就不亮，反之就亮。</p>
<p>  <font color = red size = 3>注意：这段话是有毛病的，但是一般人这样理解就行了（不了解电子电路的就看到这就行了）。对于懂的人，这里多说一句，这里还有一个三极管做开关作用，也是就说LED灯两端都接在电源正负极，中间有个三极管开关。</font></p>
<br/>
<br/>
<br/>
<br/>
<h3 id="拨码开关">拨码开关</h3>
<hr>
<p>  这种器件，又是另外一种新奇的东西了，感觉我这两年写的“祖传屎山“太多了，现在看到各种硬件器件都是眼前一亮的感觉。</p>
<p>  就是类似下图这种。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_087/sw1.png" alt="rep_img"/></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_087/sw2.png" alt="rep_img"/></center>
    </div>
</div>
<p>  其作用是：</p>
<p>  你可以人为的按这个±号按钮，设置数字，这个数字会反应到电路上，从而芯片可以读取你设置的数字。说白了，你的系统中有个数字参数，你可以通过这种器件进行手动设置，通过驱动程序，就可以更改这个系统参数，是不是 so 简单。</p>
<p>  这里简单说明一下电路是怎么反应出对应的数字的：</p>
<p>  我就举个栗子，下图是个例子拨码开关（手动滑稽，这里多说一句，上图的拨码开关，是4个拨码开关合在一起的，下图的这个输出编码是一个拨码开关的）</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_087/sw_code.png" alt="rep_img"/></center>
    </div>
</div>
<p>  这里可以简单理解为：</p>
<p>  一个拨码开关有5个引脚，一个引脚是C，接GND或者VCC，其他4个是编码引脚，是需要接GPIO，并去取编码的。</p>
<p>  其实很简单：</p>
<p>  例如：C端我接VCC，1248默认值为0，那么数字1，1号引脚接通，那么8421io口输出二进制就是0001，转换为10进制，就是1.</p>
<p>  然后写个程序读取这4个脚的值，转换一下，就OK。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2019/06/15/blog_idx_086/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/15/blog_idx_086/" class="post-title-link" itemprop="url">HiSi 3516CV500 NNIE(Neural Network Inference Engine) 摸鱼记录(3) ---真机调试（实例分析）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-15 18:08:34" itemprop="dateCreated datePublished" datetime="2019-06-15T18:08:34+08:00">2019-06-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/DL/" itemprop="url" rel="index"><span itemprop="name">DL</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/DL/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">数据结构与算法</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-30 22:38:44
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=086） 
&emsp;&emsp;本文发布于 2019-06-15 18:08:34，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=086） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="背景">背景</h3>
<hr>
<p>  本文建立前两篇的文章基础之上：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>《HiSi 3516CV500 NNIE(Neural Network Inference Engine) 摸鱼记录(1) — 环境搭建》<br>
<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011728480/article/details/91125581">https://blog.csdn.net/u011728480/article/details/91125581</a></p>
</li>
<li class="lvl-2">
<p>《HiSi 3516CV500 NNIE(Neural Network Inference Engine) 摸鱼记录(2) — 模型生成及模型仿真(实例分析)》<br>
<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011728480/article/details/91294917">https://blog.csdn.net/u011728480/article/details/91294917</a></p>
</li>
</ul>
<p>  本文将会以一个实例来进行分析。hisi svp sdk的基础之上。同时本文也是本系列文章的终章。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="NNIE-使用流程（其实就是读其sdk文档）">NNIE 使用流程（其实就是读其sdk文档）</h3>
<hr>
<br/>
<br/>
<h5 id="hisi-svp-整体框架">hisi svp 整体框架</h5>
<pre class="line-numbers language-none"><code class="language-none">vision app
--------------------
mpi(MPP Program Interface)
--------------------
driver(ko)
--------------------
nnie（hardware）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  从上述框架来说，我们要自己用的内容就是vision app 、mpi、以及nnie api</p>
<p>  vision app就是做图像数据的准备以及结果处理，mpi做mmz内存分配（海思特有的内存空间），nnie做forward。</p>
<br/>
<br/>
<h5 id="相关api-简介">相关api 简介</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
* mpp System init
*/</span>
<span class="token function">HI_MPI_SYS_Exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">HI_MPI_VB_Exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//设置MPP 视频缓存 池 属性 。</span>
<span class="token function">HI_MPI_VB_SetConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">HI_MPI_VB_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">HI_MPI_SYS_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//load model</span>
<span class="token comment">//在mmz中分配一部分内存来存放model</span>
<span class="token function">HI_MPI_SYS_MmzAlloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//从mmz内存中解析模型</span>
<span class="token function">HI_MPI_SVP_NNIE_LoadModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//NNIE  Param  Init</span>

<span class="token comment">//forward prepare</span>
<span class="token comment">//------------------------根据model的配置，为每一段（这里你可以简单理解为层）的forward ctrl param , src Blob, dst Blob.也就是初始化SVP_NNIE_FORWARD_CTRL_S[]，SVP_NNIE_FORWARD_WITHBBOX_CTRL_S[]，SVP_SRC_BLOB_S[]，SVP_DST_BLOB_S[]数组元素的值。</span>
<span class="token function">HI_MPI_SVP_NNIE_GetTskBufSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//获取给定网络任务 各段 辅助内存</span>
<span class="token function">HI_MPI_SVP_NNIE_AddTskBuf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//记录TskBuf 地址 信息</span>

<span class="token comment">//----------------给第一层送入预处理好的图片到SVP_SRC_BLOB_S</span>

<span class="token function">HI_MPI_SYS_MmzFlushCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//刷新内存</span>
<span class="token function">HI_MPI_SVP_NNIE_Forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//forward</span>
<span class="token function">HI_MPI_SVP_NNIE_Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//查询forward任务是否完成</span>
<span class="token function">HI_MPI_SYS_MmzFlushCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//刷新内存</span>


<span class="token comment">//---------------解析HI_MPI_SVP_NNIE_Forward的参数astDst[]，得到网络的最终输出</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  各种类型的forward其实hisi都已经有各个例子可以参考的。上面的总结也是我从它的例子中剥离出来的。我这里也想吐槽一下，hisi例子写的很好，就是封装的层数太多了，反而让人感觉很不爽。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="NNIE-开发实例流程（其实就是参考其sample）">NNIE 开发实例流程（其实就是参考其sample）</h3>
<hr>
<br/>
<br/>
<h5 id="魔改hisi-sample">魔改hisi sample</h5>
<p>  在hisi sdk中，提供了多种网络的例子，这里以我的cnn 分类网络为例。根据前文可以得到inst 的wk模型。以及一个预处理好的图片bin文件。</p>
<p>  找到目标文件，smp/a7_linux/mpp/sample/svp/nnie/sample/sample_nnie.c，直接复制void SAMPLE_SVP_NNIE_Cnn(void)为我的函数，修改图片bin路径和wk路径。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_086/path.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  作为新手，不建议去看其他的，直接改最后一部分，打印最后一层输出，直接和仿真的值进行对比。当然你熟悉后就必须自己一点点看懂，不然出错没有办法纠正。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_086/print.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  我这里给个demo参考例子。结果打印：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_086/print_out.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  仿真以及caffe输出值对比最后一层：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_086/cmp.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  可以发现确实是对应上了，这就证明了这个网络至少跑出来的大方向是没问题了，剩下的就是自己组织优化的问题了。</p>
<br/>
<br/>
<h5 id="注意">注意</h5>
<p>  如果出现最后输出对应不上，先去检查图像输入对不对，也就是srcBlob的第一层是不是一样的，70%都是这里出问题了。</p>
<p>  其次再去看打印的方式对不对。</p>
<p>  最后看整个nnie器件你使用对不对。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>   总结</p>
<p>   要完成这个事情，需要对深度学习，嵌入式编程有一定基础才行。一般来说，都是算法出模型，嵌入式的人做这个事情，当然有兴趣的话都一起做也行。这里我想说的是这是一个学科交叉的事情，单单了解一个方向的知识都不行的。所以，一定要多沟通，才能够干好这个事情。</p>
<p>   其实这也是嵌入式方向的人的一个契机，当你了解一些基本的深度学习知识，而且又掌握嵌入式相关的内容，肯定是非常不错的，毕竟这是一个非常有趣的事情。</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2019/06/08/blog_idx_085/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/08/blog_idx_085/" class="post-title-link" itemprop="url">HiSi 3516CV500 NNIE(Neural Network Inference Engine) 摸鱼记录(2) --- 模型生成及模型仿真(实例分析)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-08 10:44:29" itemprop="dateCreated datePublished" datetime="2019-06-08T10:44:29+08:00">2019-06-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/DL/" itemprop="url" rel="index"><span itemprop="name">DL</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/DL/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">数据结构与算法</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-30 22:30:08
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=085） 
&emsp;&emsp;本文发布于 2019-06-08 10:44:29，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=085） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="背景">背景</h3>
<hr>
<p>  本文建立在上文环境配置的基础上继续。(上文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011728480/article/details/91125581">https://blog.csdn.net/u011728480/article/details/91125581</a>)</p>
<p>  本文将会以一个实例来进行分析。同时本文的教程都是建立在《HiSVP 开发指南.pdf》基础上的。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="NNIE-模型生成">NNIE 模型生成</h3>
<hr>
<br/>
<br/>
<h5 id="NNIE-新建工程">NNIE 新建工程</h5>
<p>  File 新建NNIE工程，选择MinGW GCC 空工程即可。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_new.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<h5 id="NNIE-Mapper-配置文件建立">NNIE Mapper 配置文件建立</h5>
<p>  File 新建nnie mapper配置文件，如下图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_map.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  双击这个mapper文件，你可以进入配置页面，如下图，其相关的参数和选项要按照《HiSVP 开发指南.pdf》的NNIE mapper配置文件参数详解。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_map_cfg.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  这里有几个地方要注意一下：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>is_simulation 是生成功能仿真或者指令仿真模型。指令仿真模型就是最终到板子上的模型。</p>
</li>
<li class="lvl-2">
<p>batch_num 对于forward来说，一般都是一张图像，这里选1就行了。</p>
</li>
<li class="lvl-2">
<p>sparse_rate 先0不影响正常输出。</p>
</li>
<li class="lvl-2">
<p>data_type 这里你一定要去看文档说明，弄清楚你的网络需要输入的是什么数据类型，有些在网络里面做了归一化，这里选U8，如果网络前面做归一化，这里就要选S32，其他类型，看文档。</p>
</li>
</ul>
<br/>
<br/>
<h5 id="NNIE-模型生成-2">NNIE 模型生成</h5>
<p>  在把NNIE Mapper配置配好了后，点击如下图的按钮即可生成对应的wk文件。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_gen.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  我这里就根据is_simulation生成了两种模型，功能仿真模型输出内容多。指令仿真模型输出基本保持和板子上是一致的。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_wk.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<h5 id="NNIE-模型仿真工程搭建">NNIE 模型仿真工程搭建</h5>
<p>  这里，我们就不要做重复造轮子的工作，直接导入官方sample_simulator，然后在其基础上魔改就行了。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_sim.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<h5 id="魔改切入点">魔改切入点</h5>
<p>  在src目录，打开main.cpp，简单分析一波，根据我的网络特点，直接选择分类网络例子(svpsampleclassification.cpp)，复制为我的cpp和hpp。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_demo.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  其核心调用在仿真里面就两个函数:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>HI_MPI_SVP_NNIE_Forward  网络forward</p>
</li>
<li class="lvl-2">
<p>HI_MPI_SVP_NNIE_Query forward状态查询</p>
</li>
</ul>
<p>  其余的都是在准备数据和查看数据。这里你可以参考svpsampleclassification.cpp进行简化魔改即可。</p>
<p>  需要注意的是：HI_MPI_SVP_NNIE_Forward  的api参考文档中，有关于输入和输出数据的规格说明，别弄错了。</p>
<p>  魔改好了，直接打印出最后一层的输出。</p>
<br/>
<br/>
<h5 id="每一层的数据保存">每一层的数据保存</h5>
<p>  这种方法适用于后续的向量对比，用于查看你生成的模型对不对。在sim_out的目录下有一个nnie_sim.ini配置文件，里面可以设置一些不错的参数。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_layer.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  双击后，可以界面设置：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_layer_cfg.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  这里必须勾上第一个，第二个建议勾上，这样跑的快点。第一个勾上后，会输出每一层的输出。</p>
<p>  然后运行你魔改的程序，在sim_out下会出现如下图的内容（我这里我两种模型的仿真都做过了，所以有两种每一层网络的输出）：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_layer_out.png" alt="rep_img"/></center>
    </div>
</div>  
<br/>
<br/>
<br/>
<br/>
<h3 id="网络标准输出">网络标准输出</h3>
<hr>
<p>  点这个，配置参数，然后输出你的caffe模型的每一层数据，用作后续的向量分析。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_vec0.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_vec1.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  这里没什么注意的，自己配置好相关的内容即可。</p>
<p>  这里执行后会在output dir 输出每一层caffe模型的forward输出</p>
<p>  如下图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_vec2.png" alt="rep_img"/></center>
    </div>
</div>  
<br/>
<br/>
<br/>
<br/>
<h3 id="向量对比">向量对比</h3>
<hr>
<p>  向量对比有什么作用，相比经常接触这方面的人会有感受，就是指你的模型输出对不对。比如：caffe 的输出，nnie的输出到底能否对上，hisi提供了这样的一个工具。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_vec_cmp.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  一个选择caffe输出，一个选择仿真输出。对比即可。双击可以查看每一层的所有输出数据，这里我就直接看最后一层。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_vec_cmp1.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_085/ruyi_vec_cmp2.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  从最后一层的数据对比来看，基本偏差不大，因为后续还要继续对数据进行处理。这样的话，就证明了我的nnie模型至少现在看来没什么问题了。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  注意事项</p>
<p>  如果你的输出和标准caffe输出差的非常远，有70%的可能性是你输入数据不一致导致的，你要和算法他们详细沟通，并打印输入数据，经过实际对比，看看哪里有什么问题。</p>
<p>  不一致的原因很多，一般来说就是图像通道对不上，预处理不一致等等。</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2019/06/07/blog_idx_084/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/07/blog_idx_084/" class="post-title-link" itemprop="url">HiSi 3516CV500 NNIE(Neural Network Inference Engine) 摸鱼记录(1) --- 环境搭建</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-07 11:22:00" itemprop="dateCreated datePublished" datetime="2019-06-07T11:22:00+08:00">2019-06-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/DL/" itemprop="url" rel="index"><span itemprop="name">DL</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/DL/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">数据结构与算法</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-30 22:12:52
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=084） 
&emsp;&emsp;本文发布于 2019-06-07 11:22:00，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=084） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="背景">背景</h3>
<hr>
<p>  深度学习的爆发期已经到了瓶颈了，为啥这样说，因为没有突破性的理论进展，都是靠着网络更深、更广，算力更强大来做相应的功能。至少在我的世界观里面是这样的，虽然这样的认知可能会有局限性，或者说是错误的。</p>
<p>  现在深度学习的方向已经不是以前的泡沫鼓吹了，而是落地，踏踏实实的把实验室的东西转换为实际对社会有用的东西，这才是深度学习的现在的实际情况。</p>
<p>  要做相关的落地，在大部分应用场景来说，是不能够直接弄台服务器+GPU的方式来做相关的计算的，这样部署维护和成本都是一个很大的问题，现在其实大部分的场景需要的是低成本、小型化。就现在来看，其实就是移动手机平台和其他嵌入式板子平台是一个主流的方向。比如，手机端的：换脸啊、表情啊、化妆啊等等；板卡端的：依托于人脸识别的广告机啊、闸机啊等等。这里面的核心就是要在这些小型设备上做相关的算法运算。</p>
<p>  在这些小型设备上做运算，有一个问题就是算力的问题，这些小型设备功耗低、算力低，很可能就是算法表现比较差。还好，很多大佬在很久以前就考虑到这些问题了，出了很多硬件加速的东西。如：Nvidia的TX TK系列、瑞芯微的RK系列、HiSi的Hi3559，Hi3519，Hi3516系列以及其他的Android手机SOC里面带的相关的NPU等等。</p>
<p>  所以，为了把HiSi平台的相关深度学习硬件加速功能用起来，我们得把HiSi的NNIE利用起来完成这个功能。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="NNIE简介">NNIE简介</h3>
<hr>
<p>  NNIE是 Neural Network Inference Engine 的 简 称 是 海思 媒体 S oC 中 专门针对神经网络特别是深度学习卷积神经网络进行加速处理的硬件单元。----- 摘自hisi sdk svp部分《HiSVP开发指南.pdf》</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="NNIE-工作流程简介">NNIE 工作流程简介</h3>
<hr>
<p>  海思提供了一个NNIE Mapper的工具（Linux ， Win都有）。由于NNIE只支持Caffe框架，我们需要的是把Caffe的模型转换为NNIE可以使用的模型。</p>
<p>  在我们转换的时候，需要我们提供一个NNIE转换的配置文件，然后根据配置文件把相关的caffe模型转换为NNIE的模型。然后我们在板子上加载这个模型，调用相关的API就可以完成这个网络的加速计算。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="NNIE-环境搭建">NNIE 环境搭建</h3>
<hr>
<p>  工欲善其事必先利其器。NNIE最开始接触的时候，我觉得贼难受，觉得很难。但是当你把环境配置好了，你就会觉得事半功倍，很舒服。</p>
<p>  以下内容，我都是按照HISI SDK的SVP部分的《HI SVP开发指南.pdf》做的，只是由于时效性的原因，有些内容需要做一定的改变适应才行。</p>
<p>  我这里根据我的摸鱼经验，我建议萌新第一步，先把RuyiStudio配置起来，这里面带了所有和NNIE开发的工具。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="RuyiStudio-简介">RuyiStudio 简介</h3>
<hr>
<p>  以下是RuyiStudio官方介绍：</p>
<p>  RuyiStudio 集成 windows 版 的 NNIE mapper 和 仿真库， 具有 生成 NNIE wk 功能、 仿真NNIE 功能，同时 具有 代码 编辑、编译、调试、执行 功能 、 网络拓扑显示、目标检测画框、 向量 相似度 对比、 调试 定位 信息获取等功能 。</p>
<br/>
<br/>
<h5 id="RuyiStudio-MinGW安装">RuyiStudio ----- MinGW安装</h5>
<p>  这里我建议选择手动安装，下载MinGW的对应版本，解压到一个无中文路径的目录下。然后下载对应MinGW的msys，解压到MinGW的根目录下。这里直接按照文档给的内容走即可。这一步无明显的坑。</p>
<br/>
<br/>
<h5 id="RuyiStudio-Python-3-5-与CAFFE安装">RuyiStudio ----- Python 3.5 与CAFFE安装</h5>
<p>  这一步是最坑的一步。所以这步我会一一按照文档介绍说明。</p>
<p>  这一步必须按照手动配置方式，一键脚本配置，我建议有能力的小伙伴使用，纠错有难度。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>按照文档把RUYI_PYTHON_PATH环境变量添加到系统。ruyi_env_setup-2.0.28所在目录定义为PREFIX, 这里添加的值为PREFIX/python35;PREFIX/python35/Scripts;PREFIX/python35/Library/bin。这里没什么坑，就是别有中文路径就好。</p>
</li>
<li class="lvl-2">
<p>然后把RUYI_PYTHON_PATH的值添加到PATH环境变量中去。没坑这里，注意按照文档整就行了。</p>
</li>
<li class="lvl-2">
<p>ruyi_env_setup-2.0.28所在目录定义为PREFIX，把PREFIX/python35\Lib\site-packages\caffe\python添加到PYTHONPATH的环境变量中去。</p>
</li>
<li class="lvl-2">
<p>进入ruyi_env_setup-2.0.28\python_bat目录，双击运行setup_download_python.bat。一般来说，你会报错的，因为anaconda的清华源已经被干掉了，不排除以后恢复的可能性，所以，这里又需要把清华源替换为anaconda的官方源。注意：把：setup_download_python.bat中的所有<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/anaconda%E8%BF%9E%E6%8E%A5%E6%9B%BF%E6%8D%A2%E4%B8%BAhttps://repo.anaconda.com/%E3%80%82">https://mirrors.tuna.tsinghua.edu.cn/anaconda连接替换为https://repo.anaconda.com/。</a>列如：<br>
<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/win-64/certifi-2016.2.28-py35_0.tar.bz2">https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/win-64/certifi-2016.2.28-py35_0.tar.bz2</a>  替换后是 <a target="_blank" rel="noopener" href="https://repo.anaconda.com/pkgs/free/win-64/certifi-2016.2.28-py35_0.tar.bz2">https://repo.anaconda.com/pkgs/free/win-64/certifi-2016.2.28-py35_0.tar.bz2</a> 。这里改完了，你可以双击这个脚本setup_download_python.bat下载相关的库，这里建议开代理下载，很慢，真的。如果你以为这样就完了吗？那是不可能的。当你上述脚本执行完后，其中有9个是下载失败的。他们的连接特征如下：<br>
<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/win-64/jpeg-9b-vc14_2.tar.bz2">https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/win-64/jpeg-9b-vc14_2.tar.bz2</a><br>
来至于anaconda/cloud部分的。都不得行，so，得去官方源找对应的9个内容，我把链接地址贴到下面，可能你们需要的版本不是下面连接所示，但是你可以访问那个页面，那个页面包含所有的版本，选择对应的版本即可，<br>
<a target="_blank" rel="noopener" href="https://anaconda.org/conda-forge/jpeg/9b/download/win-64/jpeg-9b-vc14_2.tar.bz2">https://anaconda.org/conda-forge/jpeg/9b/download/win-64/jpeg-9b-vc14_2.tar.bz2</a><br>
<a target="_blank" rel="noopener" href="https://anaconda.org/conda-forge/libpng/1.6.34/download/win-64/libpng-1.6.34-vc14_0.tar.bz2">https://anaconda.org/conda-forge/libpng/1.6.34/download/win-64/libpng-1.6.34-vc14_0.tar.bz2</a><br>
<a target="_blank" rel="noopener" href="https://anaconda.org/conda-forge/libtiff/4.0.9/download/win-64/libtiff-4.0.9-vc14_0.tar.bz2">https://anaconda.org/conda-forge/libtiff/4.0.9/download/win-64/libtiff-4.0.9-vc14_0.tar.bz2</a><br>
<a target="_blank" rel="noopener" href="https://repo.anaconda.com/cloud/conda-forge/win-64/zlib-1.2.11-vc14_0.tar.bz2">https://repo.anaconda.com/cloud/conda-forge/win-64/zlib-1.2.11-vc14_0.tar.bz2</a><br>
<a target="_blank" rel="noopener" href="https://anaconda.org/conda-forge/tk/8.5.19/download/win-64/tk-8.5.19-vc14_1.tar.bz2">https://anaconda.org/conda-forge/tk/8.5.19/download/win-64/tk-8.5.19-vc14_1.tar.bz2</a><br>
<a target="_blank" rel="noopener" href="https://anaconda.org/conda-forge/openssl/1.0.2n/download/win-64/openssl-1.0.2n-vc14_0.tar.bz2">https://anaconda.org/conda-forge/openssl/1.0.2n/download/win-64/openssl-1.0.2n-vc14_0.tar.bz2</a><br>
<a target="_blank" rel="noopener" href="https://anaconda.org/conda-forge/icu/58.2/download/win-64/icu-58.2-vc14_0.tar.bz2">https://anaconda.org/conda-forge/icu/58.2/download/win-64/icu-58.2-vc14_0.tar.bz2</a><br>
<a target="_blank" rel="noopener" href="https://anaconda.org/conda-forge/qt/5.6.2/download/win-64/qt-5.6.2-vc14_1.tar.bz2">https://anaconda.org/conda-forge/qt/5.6.2/download/win-64/qt-5.6.2-vc14_1.tar.bz2</a><br>
<a target="_blank" rel="noopener" href="https://anaconda.org/conda-forge/protobuf/3.5.1/download/win-64/protobuf-3.5.1-py35_vc14_0.tar.bz2">https://anaconda.org/conda-forge/protobuf/3.5.1/download/win-64/protobuf-3.5.1-py35_vc14_0.tar.bz2</a><br>
如果以上所需的内容版本发生了变动，那么访问<a target="_blank" rel="noopener" href="https://anaconda.org/conda-forge/%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%8E%BB%E6%9F%A5%E6%89%BE%E9%9C%80%E8%A6%81%E5%8C%85%E7%9A%84%E5%85%B3%E9%94%AE%E5%AD%97%EF%BC%8C%E9%80%89%E6%8B%A9%E5%AF%B9%E5%BA%94%E7%89%88%E6%9C%AC%E5%8D%B3%E5%8F%AF%EF%BC%8C%E5%A6%82%EF%BC%9Ajpeg">https://anaconda.org/conda-forge/，直接去查找需要包的关键字，选择对应版本即可，如：jpeg</a> ，搜索了后，选择	排名第一的conda-forge / jpeg 9c源，然后进去选择对应版本下载即可。这个网站有点卡，建议代理。如下图：</p>
</li>
</ul>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_084/conda.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  所有的内容下载好了 ，开始下一步。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>把上面下载的包放到ruyi_env_setup-2.0.28\python35目录下，并全部解压到ruyi_env_setup-2.0.28\python35目录。</p>
</li>
<li class="lvl-2">
<p>把ruyi_env_setup-2.0.28 目录下的caffe.zip 放到ruyi_env_setup-2.0.28\python35\Lib\site-packages下解压。</p>
</li>
<li class="lvl-2">
<p>把opencv_python-3.4.0.12-cp35-cp35m-win_amd64.whl放到ruyi_env_setup-2.0.28\python35\Lib\site-packages ,然后在ruyi_env_setup-2.0.28\python35\Lib\site-packages目录，执行pip install opencv_python-3.4.0.12-cp35-cp35m-win_amd64.whl安装opencv</p>
</li>
</ul>
<br/>
<br/>
<h5 id="RuyiStudio-2-0-28-zip-解压运行">RuyiStudio-2.0.28.zip 解压运行</h5>
<p>  打开RuyiStudio.exe得到如下的界面，常用的几个点就如图所示，至于怎么完成后续工作。请看后续文章。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_084/ruyi.png" alt="rep_img"/></center>
    </div>
</div>   
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2019/04/28/blog_idx_083/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/28/blog_idx_083/" class="post-title-link" itemprop="url">一种OSD 简单实现 (文字反色---opencv、字体切换---freetype2(中文、空格))</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-28 17:08:59" itemprop="dateCreated datePublished" datetime="2019-04-28T17:08:59+08:00">2019-04-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/" itemprop="url" rel="index"><span itemprop="name">计算机视觉</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-30 22:02:43
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=083） 
&emsp;&emsp;本文发布于 2019-04-28 17:08:59，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=083） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="背景">背景</h3>
<hr>
<p>   某机器视觉项目中，往往会在一些图片上显示一些算法结果或者一些其他的文字信息来增强算法可视化或者提示演示效果。说白了，就是需要在图片上的某位置显示文字。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="OSD简介">OSD简介</h3>
<hr>
<p>  这里的OSD是on screen display的简写，翻译过来就是在&quot;屏幕&quot;上的显示。这里的&quot;屏幕”是指在一副画面。所以，osd可以理解为在一副画面上叠加信息。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="文字反色和字体切换">文字反色和字体切换</h3>
<hr>
<p>  文字反色：顾名思义就是根据一些条件（背景图的情况），让文字变为和之前相反的颜色。列如：黑和白。</p>
<p>  字体切换：字体这个东西，就是一个字显示出来是什么样子的。列如楷体、草书、宋体等等。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="平均灰度和freetype2">平均灰度和freetype2</h3>
<hr>
<p>  平均灰度：就是用opencv计算对应字体的bitmap位置的图像数据进行平均灰度计算。主要是判断这一块图像数据的亮度情况，如果过亮（白），就黑色，如果过黑，就白色。</p>
<p>  freetype2：这是一个开源的加载各种标准字体格式的开源框架，你可以根据你传入的字，得到对应字的bitmap。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="python-实例（c-版用到项目中了，就不发了，非常类似）">python 实例（c++版用到项目中了，就不发了，非常类似）</h3>
<hr>
<p>  这里我就不分析了，简单注释一下，说明一下思路即可，大致就这个样子就可以实现我想要的功能。这里我强烈建议：如果做验证类的代码，python用起来是要快点，操作很方便。</p>
<p>  思路：</p>
<ol>
<li class="lvl-3">
<p>得到想要的文字的字体的bitmap</p>
</li>
<li class="lvl-3">
<p>根据输入的起始位置和当前第几个字符的信息，计算出当前字要显示到对应图像坐标中的哪个块。</p>
</li>
<li class="lvl-3">
<p>把对应的块截出来形成一个小图像，并计算平均灰度。</p>
</li>
<li class="lvl-3">
<p>根据灰度值来决定显示黑色还是白色，主要是利用了色差，使人更显目的知道显示了什么。</p>
</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> freetype <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> math
<span class="token keyword">import</span> numpy
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

<span class="token comment">#return bgr mat and gray mat</span>
<span class="token keyword">def</span> <span class="token function">GetBGRAndGrayImg</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#BGR</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    img_gray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img<span class="token punctuation">,</span> img_gray

<span class="token comment">#初始化freetype2字库</span>
freetype_face <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token keyword">def</span> <span class="token function">InitFreeType</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> freetype_face
    freetype_face <span class="token operator">=</span> Face<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token comment">#设置字库你要获取的文字大小，这里的大小是一个近似值（离已有尺寸最近的尺寸）。字库里面的每个字可能存在多种尺寸。</span>
<span class="token keyword">def</span> <span class="token function">SetFreeTypeCharPixelSize</span><span class="token punctuation">(</span>pixel_w<span class="token punctuation">,</span> pixel_h<span class="token punctuation">)</span><span class="token punctuation">:</span>
    freetype_face<span class="token punctuation">.</span>set_pixel_sizes<span class="token punctuation">(</span> pixel_w<span class="token punctuation">,</span> pixel_h <span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token comment">#设置字体旋转</span>
<span class="token keyword">def</span> <span class="token function">SetFreeTypeCharRotate</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">:</span>
    matrix <span class="token operator">=</span> Matrix<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x10000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x10000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x10000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    freetype_face<span class="token punctuation">.</span>set_transform<span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> Vector<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>

<span class="token comment">#return a matrix of char, white pixel is actual font， black pixel is background of font</span>
<span class="token keyword">def</span> <span class="token function">GetCharMatrixFromFont</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">:</span>
    freetype_face<span class="token punctuation">.</span>load_char<span class="token punctuation">(</span>char<span class="token punctuation">)</span>
    bitmap <span class="token operator">=</span> freetype_face<span class="token punctuation">.</span>glyph<span class="token punctuation">.</span>bitmap
    <span class="token keyword">return</span> numpy<span class="token punctuation">.</span>array<span class="token punctuation">(</span>bitmap<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>bitmap<span class="token punctuation">.</span>rows<span class="token punctuation">,</span> bitmap<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">,</span> bitmap<span class="token punctuation">.</span>width<span class="token punctuation">,</span> bitmap<span class="token punctuation">.</span>rows

<span class="token comment"># 下面就是根据传入的位置，文字，然后计算每个文字bitmap的矩阵对应的实际图像对应位置的区域平均灰度，决定显示什么颜色，然后进行像素替换即可。注意：这里的用的第一个字所在的下边界作为对齐的标准线。</span>
<span class="token keyword">def</span> <span class="token function">GetOSDImg</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> img_g<span class="token punctuation">,</span> text<span class="token punctuation">,</span> start_pos<span class="token punctuation">,</span> interval<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    next_char_pos_x <span class="token operator">=</span> start_pos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    cur_pos_x <span class="token operator">=</span> start_pos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    next_char_pos_y <span class="token operator">=</span> start_pos<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    cur_pos_y <span class="token operator">=</span> start_pos<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    baseline_y <span class="token operator">=</span>  start_pos<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> text_i<span class="token punctuation">,</span> text_e <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
        char_array<span class="token punctuation">,</span> char_width<span class="token punctuation">,</span> char_height <span class="token operator">=</span> GetCharMatrixFromFont<span class="token punctuation">(</span>text_e<span class="token punctuation">)</span>
        <span class="token comment">#caculate gray</span>
        <span class="token comment">#截出对应位置的小图像</span>
        gray_matrix <span class="token operator">=</span> img_g<span class="token punctuation">[</span>next_char_pos_x<span class="token punctuation">:</span>next_char_pos_x <span class="token operator">+</span> char_width<span class="token punctuation">,</span> next_char_pos_y<span class="token punctuation">:</span>next_char_pos_y<span class="token operator">+</span>char_height<span class="token punctuation">]</span>
        <span class="token comment">#计算平均灰度</span>
        gray_matrix_mean <span class="token operator">=</span> gray_matrix<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> text_i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            baseline_y <span class="token operator">+=</span> char_height

        cur_pos_y <span class="token operator">=</span> baseline_y<span class="token operator">-</span>char_height

        <span class="token keyword">for</span> h<span class="token punctuation">,</span> h_e <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>char_array<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> w<span class="token punctuation">,</span> w_e <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>h_e<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> w_e <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    <span class="token keyword">continue</span>
                <span class="token keyword">if</span> gray_matrix_mean <span class="token operator">></span> <span class="token number">128</span><span class="token punctuation">:</span>
                    <span class="token comment">#RGB</span>
                    img<span class="token punctuation">[</span> cur_pos_y <span class="token operator">+</span> h<span class="token punctuation">,</span> cur_pos_x <span class="token operator">+</span> w <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>

                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token comment">#RGB</span>
                    img<span class="token punctuation">[</span> cur_pos_y <span class="token operator">+</span> h<span class="token punctuation">,</span> cur_pos_x <span class="token operator">+</span> w <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span>


        <span class="token comment">#caculate next char position</span>
        cur_pos_x <span class="token operator">+=</span> char_width <span class="token operator">+</span> interval
        <span class="token comment">#cur_pos_y += char_height</span>
        next_char_pos_x <span class="token operator">+=</span> char_width
        next_char_pos_y <span class="token operator">+=</span> char_height
    <span class="token keyword">return</span> img
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>

    img_t<span class="token punctuation">,</span> img_g_t <span class="token operator">=</span> GetBGRAndGrayImg<span class="token punctuation">(</span><span class="token string">"test.jpg"</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img_t<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">352</span><span class="token punctuation">,</span> <span class="token number">288</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_AREA<span class="token punctuation">)</span>
    img_g <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img_g_t<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">352</span><span class="token punctuation">,</span> <span class="token number">288</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_AREA<span class="token punctuation">)</span>

    InitFreeType<span class="token punctuation">(</span><span class="token string">'mmm.ttf'</span><span class="token punctuation">)</span>
    <span class="token comment"># SetFreeTypeCharPixelSize(10, 10)</span>
    freetype_face<span class="token punctuation">.</span>set_char_size<span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    SetFreeTypeCharRotate<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    osd_img <span class="token operator">=</span> GetOSDImg<span class="token punctuation">(</span>img<span class="token punctuation">,</span> img_g<span class="token punctuation">,</span> <span class="token string">"km/habcdefg你好吗？"</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token comment">#plt.imshow(osd_img)</span>
    <span class="token comment">#osd_img = osd_img.reshape(288, 352, 3)[:, :, (2, 1, 0)]</span>

    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'osd'</span><span class="token punctuation">,</span> osd_img<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># plt.imshow(osd_img)</span>
    plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token comment">#</span>
    <span class="token comment"># # First pass to compute bbox</span>
    <span class="token comment"># width, height, baseline = 0, 0, 0</span>
    <span class="token comment"># previous = 0</span>
    <span class="token comment"># for i, c in enumerate(text):</span>
    <span class="token comment">#     face.load_char(c)</span>
    <span class="token comment">#     bitmap = slot.bitmap</span>
    <span class="token comment">#     height = max(height,</span>
    <span class="token comment">#                  bitmap.rows + max(0,-(slot.bitmap_top-bitmap.rows)))</span>
    <span class="token comment">#     baseline = max(baseline, max(0,-(slot.bitmap_top-bitmap.rows)))</span>
    <span class="token comment">#     kerning = face.get_kerning(previous, c)</span>
    <span class="token comment">#     width += (slot.advance.x >> 6) + (kerning.x >> 6)</span>
    <span class="token comment">#     previous = c</span>
    <span class="token comment">#</span>
    <span class="token comment"># Z = numpy.zeros((height,37), dtype=numpy.ubyte)</span>
    <span class="token comment"># print(Z.shape)</span>
    <span class="token comment"># # Second pass for actual rendering</span>
    <span class="token comment"># x, y = 0, 0</span>
    <span class="token comment"># previous = 0</span>
    <span class="token comment"># for c in text:</span>
    <span class="token comment">#     face.load_char(c)</span>
    <span class="token comment">#     bitmap = slot.bitmap</span>
    <span class="token comment">#     top = slot.bitmap_top</span>
    <span class="token comment">#     left = slot.bitmap_left</span>
    <span class="token comment">#     w,h = bitmap.width, bitmap.rows</span>
    <span class="token comment">#     y = height-baseline-top</span>
    <span class="token comment">#     kerning = face.get_kerning(previous, c)</span>
    <span class="token comment">#     x += (kerning.x >> 6)</span>
    <span class="token comment">#     print(x, y ,h, w)</span>
    <span class="token comment">#     Z[y:y+h,x:x+w] += numpy.array(bitmap.buffer, dtype='ubyte').reshape(h,w)</span>
    <span class="token comment">#     x += (slot.advance.x >> 6)</span>
    <span class="token comment">#     previous = c</span>
    <span class="token comment"># print(Z.shape)</span>
    <span class="token comment"># img = cv2.imread("test.jpg")</span>
    <span class="token comment"># img_g = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span>
    <span class="token comment">#</span>
    <span class="token comment"># array = np.array(img)</span>
    <span class="token comment"># #RGB</span>
    <span class="token comment"># array = array.reshape(520, 520, 3)[:, :, (2, 1, 0)]</span>
    <span class="token comment">#</span>
    <span class="token comment"># print(array)</span>
    <span class="token comment">#</span>
    <span class="token comment"># array_g = np.array(img_g)</span>
    <span class="token comment"># array_g = array_g.reshape(520, 520)</span>
    <span class="token comment">#</span>
    <span class="token comment"># print(array_g.shape)</span>
    <span class="token comment"># x = 250</span>
    <span class="token comment"># y = 250</span>
    <span class="token comment">#</span>
    <span class="token comment"># front_matrix = array_g[x: x + Z.shape[0], y: y+Z.shape[1] ]</span>
    <span class="token comment"># front_matrix_mean = front_matrix.mean()</span>
    <span class="token comment"># print(front_matrix_mean)</span>
    <span class="token comment"># for h, h_e in enumerate(Z):</span>
    <span class="token comment">#     for w, w_e in enumerate(h_e):</span>
    <span class="token comment">#         if w_e == 0:</span>
    <span class="token comment">#             continue</span>
    <span class="token comment">#         if front_matrix_mean > 128:</span>
    <span class="token comment">#             #R</span>
    <span class="token comment">#             array[ x + w, y + h , 0] = 0</span>
    <span class="token comment">#             #G</span>
    <span class="token comment">#             array[ x + w, y + h, 1 ] = 0</span>
    <span class="token comment">#             #B</span>
    <span class="token comment">#             array[ x + w, y + h , 2] = 0</span>
    <span class="token comment">#         else:</span>
    <span class="token comment">#             #R</span>
    <span class="token comment">#             array[ x + w, y + h , 0] = 255</span>
    <span class="token comment">#             #G</span>
    <span class="token comment">#             array[ x + w, y + h, 1 ] = 255</span>
    <span class="token comment">#             #B</span>
    <span class="token comment">#             array[ x + w, y + h , 2] = 255</span>
    <span class="token comment">#</span>
    <span class="token comment"># # plt.figure(figsize=(10, 10*Z.shape[0]/float(Z.shape[1])))</span>
    <span class="token comment"># plt.imshow(array)</span>
    <span class="token comment"># plt.xticks([]), plt.yticks([])</span>
    <span class="token comment"># plt.show()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="结果">结果</h5>
<p>  实际测试结果：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_083/osd.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  字体文件打开后：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_083/front.png" alt="rep_img"/></center>
    </div>
</div>   
<br/>
<br/>
<br/>
<br/>
<h3 id="2019-7-1更新—关于C-版本中，中文支持和空格问题">2019/7/1更新—关于C++版本中，中文支持和空格问题</h3>
<hr>
<br/>
<br/>
<h5 id="中文问题">中文问题</h5>
<p>  设定freetype 为unicode解码</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">FT_Select_Charmap</span><span class="token punctuation">(</span>ft_face<span class="token punctuation">,</span>FT_ENCODING_UNICODE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>  用wchar_t来代替char,std::wstring 代替 std::string 。用这个wchar_t作为index去freetype查字形。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>wstring tmp_str <span class="token operator">=</span> L<span class="token string">"Fu*k You!!!    \x20星星"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> tmp <span class="token operator">=</span> L<span class="token string">"Fu*k You!!!    \x20星星"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="空格问题">空格问题</h5>
<p>  我发现空格在freetype中查出来是空的。长宽为0，所以需要特殊处理空格。适当的增加x轴偏移代替空格即可。</p>
<br/>
<br/>
<h5 id="解决以上问题后效果">解决以上问题后效果</h5>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_083/ch.png" alt="rep_img"/></center>
    </div>
</div>   
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2019/03/18/blog_idx_082/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/03/18/blog_idx_082/" class="post-title-link" itemprop="url">linux kernel 中进程间描述符的传递方法及原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-03-18 15:09:28" itemprop="dateCreated datePublished" datetime="2019-03-18T15:09:28+08:00">2019-03-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux%E5%BC%80%E5%8F%91/%E5%B8%B8%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">常识</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-31 10:22:44
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=082） 
&emsp;&emsp;本文发布于 2019-03-18 15:09:28，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=082） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="背景">背景</h3>
<p>  为啥我会去找这方面的资料总结？因为我写了一篇另外的文章:《Android匿名共享内存(Anonymous Shared Memory) — 瞎折腾记录 (驱动程序篇)》(<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011728480/article/details/88420467">https://blog.csdn.net/u011728480/article/details/88420467</a>)，写着写着到了最后，其技术核心就是描述符的进程间传递，导致了我必须得去了解这方面的大致原理。</p>
<p>  本文也是作为那篇文章的后续补充吧。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="技术大致原理">技术大致原理</h3>
<hr>
<p>  这里为啥要用“大致”一词，因为还有另外一种比较特殊的传递描述符的方法，文后将会详细说明。</p>
<p>  描述符 定义大致可以描述为：一个进程空间中，用一个正整数来代表一个已经被此进程打开的文件，我们可以根据这个正整数来操作这个打开文件。从这里我们可以知道，这个正整数是属于这个进程的，换句话说：不同的进程打开同一个文件的描述符是可能一样的值。</p>
<p>  此外这里有一个关于linux 虚拟文件系统的知识需要我们知道，一个是struct node 一个是struct file。在内核中，维护了一个所有打开文件的struct file表，这个代表着这个文件当前的操作状态等等。这个struct file指向了struct node，struct node 代表的是实际数据在存储介质上的哪个位置。换句简单的话来说就是：A和B两个进程打开了同一个文件，那么内核中就会存在一个struct file的变量指向这个打开的文件，对于AB两个进程来说，都会得到一个值可能不一致的描述符，但是这两个不同的描述符指向了内核中保存的同一个struct file变量。</p>
<p>  经过上面的说明，我们可以知道的是，至少传递描述符的其中一种原理就是根据当前进程fd找到内核中的struct file，然后在目标进程中申请一个未使用的描述符，然后把这个申请的描述符和这个struct file 关联起来即可。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="基于kernel内核态的描述符传输">基于kernel内核态的描述符传输</h3>
<hr>
<p>  在上面的原理分析中，其中根据当前进程的描述符得到当前的已经打开文件的struct file 变量，以及其他操作，这些手段都只能够在内核态实现。所以合理的方案是开发一个linux 驱动(android里面就是通过binder驱动)，让这个描述符的传递通过一个驱动来完成。这样就可以利用内核态的相关接口来完成我们的事情。下面通过示例的源码来分析一波：</p>
<br/>
<br/>
<h5 id="通过fd获取struct-file-变量">通过fd获取struct file 变量</h5>
<p>  这里我在网上查到的有两种方案（肯定还有其他方案，因为工作在内核态）：一是通过运行进程的pid和fd。二是通过内核态的文件系统提供的fget（struct file *fget(unsigned int fd)）</p>
<p>  第一种方案：</p>
<p>  进程有一个进程控制块，进程控制块中放着一个当前进程打开的描述符表，这个表指向了具体的struct file。</p>
<p>  linux kernel ： kernel/pid.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
通过以下接口：用pid得到struct pid 
*/</span>
<span class="token keyword">struct</span> <span class="token class-name">pid</span> <span class="token operator">*</span><span class="token function">find_get_pid</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> nr<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">pid</span> <span class="token operator">*</span>pid<span class="token punctuation">;</span>

	<span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	pid <span class="token operator">=</span> <span class="token function">get_pid</span><span class="token punctuation">(</span><span class="token function">find_vpid</span><span class="token punctuation">(</span>nr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> pid<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/*
通过以下接口，得到进程的控制块：struct task_struct.  (PIDTYPE_PID)
*/</span>
<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token function">pid_task</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pid</span> <span class="token operator">*</span>pid<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">pid_type</span> type<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">struct</span> <span class="token class-name">hlist_node</span> <span class="token operator">*</span>first<span class="token punctuation">;</span>
		first <span class="token operator">=</span> <span class="token function">rcu_dereference_check</span><span class="token punctuation">(</span><span class="token function">hlist_first_rcu</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token operator">-></span>tasks<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					      <span class="token function">lockdep_tasklist_lock_is_held</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>first<span class="token punctuation">)</span>
			result <span class="token operator">=</span> <span class="token function">hlist_entry</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">task_struct</span><span class="token punctuation">,</span> pids<span class="token punctuation">[</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//struct task_struct的files域指向一个struct files_struct结构体。</span>
<span class="token comment">//struct files_struct的fdt域指向了一个struct fdtable。</span>
<span class="token comment">//struct fdtable的fd域指向了一个已经打开的struct file 数组，通过当前描述符来作为索引。</span>
<span class="token keyword">int</span> cur_pid<span class="token punctuation">;</span>
<span class="token keyword">int</span> cur_fd<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">pid</span> <span class="token operator">*</span> tmp_pid <span class="token operator">=</span> <span class="token function">find_get_pid</span><span class="token punctuation">(</span>cur_pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span> cur_task <span class="token operator">=</span> <span class="token function">pid_task</span><span class="token punctuation">(</span>tmp_pid <span class="token punctuation">,</span> PIDTYPE_PID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">files_struct</span> <span class="token operator">*</span> cur_file_struct <span class="token operator">=</span> cur_task<span class="token operator">-></span>files<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> cur_file <span class="token operator">=</span> cur_file_struct<span class="token operator">-></span>fdt<span class="token operator">-></span>fd<span class="token punctuation">[</span>cur_fd<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  第二种方案：</p>
<p>  内核态的文件系统提供了一个更简洁的方案：</p>
<p>  linuxkernel: fs/file.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token function">fget</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token function">__fget</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> FMODE_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="给目标进程获取一个未使用的描述符">给目标进程获取一个未使用的描述符</h5>
<p>  linuxkernel:fs/open.c或者fs/file.c（我这里有两个内核，linux kernel和android kernel），位置不一致是kernel版本不一致，了解一下就行了。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">get_unused_fd_flags</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token function">__alloc_fd</span><span class="token punctuation">(</span>current<span class="token operator">-></span>files<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">rlimit</span><span class="token punctuation">(</span>RLIMIT_NOFILE<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="把我们获取的未使用的描述符和我们获取的struct-file-关联起来">把我们获取的未使用的描述符和我们获取的struct file 关联起来</h5>
<p>  linuxkernel:fs/open.c或者fs/file.c（我这里有两个内核，linux kernel和android kernel），位置不一致是kernel版本不一致，了解一下就行了。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> fastcall <span class="token function">fd_install</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> file<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">files_struct</span> <span class="token operator">*</span>files <span class="token operator">=</span> current<span class="token operator">-></span>files<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">fdtable</span> <span class="token operator">*</span>fdt<span class="token punctuation">;</span>
	<span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>files<span class="token operator">-></span>file_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	fdt <span class="token operator">=</span> <span class="token function">files_fdtable</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">BUG_ON</span><span class="token punctuation">(</span>fdt<span class="token operator">-></span>fd<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">rcu_assign_pointer</span><span class="token punctuation">(</span>fdt<span class="token operator">-></span>fd<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>files<span class="token operator">-></span>file_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="基于用户态的描述符传输">基于用户态的描述符传输</h3>
<hr>
<p>  这个是在AUPE中发现的。貌似以前设计内核的人就预留了这个功能，利用unix的本地socket的一个特殊功能即可。这里用到的调用是以下两个：</p>
<p>  就是建立一个本地socket(AF_LOCAL,AF_UNIX)，然后通过以下两个接口的特殊功能即可完成描述符的特殊转换。这里我不做过多介绍，有兴趣的看文后的实例。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span> <span class="token function">sendmsg</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">msghdr</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> <span class="token function">recvmsg</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">msghdr</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="实例分析">实例分析</h3>
<hr>
<br/>
<br/>
<h5 id="用户态实例">用户态实例</h5>
<p>  userspace_way1_send.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/un.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span>          <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span> addr<span class="token punctuation">,</span> addr1<span class="token punctuation">;</span>

	<span class="token keyword">int</span> fd<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_LOCAL<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"tmp.tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr1<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	addr<span class="token punctuation">.</span>sun_family <span class="token operator">=</span> AF_LOCAL<span class="token punctuation">;</span>

	<span class="token function">strncpy</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sun_path<span class="token punctuation">,</span> <span class="token string">"tmp.tmp"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sun_path<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token class-name">socklen_t</span> addr_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> addr<span class="token punctuation">,</span> addr_len <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>	
	<span class="token punctuation">&#125;</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>


	<span class="token class-name">socklen_t</span> addr1_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">int</span> ret_fd<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span> ret_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr1_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token keyword">int</span> open_file_fd<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>open_file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">char</span> file_content <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x00</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> read_bytes_num <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>open_file_fd<span class="token punctuation">,</span> file_content<span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read file content: %s\n"</span><span class="token punctuation">,</span> file_content<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token keyword">char</span> <span class="token operator">*</span> flags <span class="token operator">=</span> <span class="token string">"@!@"</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">iovec</span> iov <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	
		<span class="token punctuation">.</span>iov_base <span class="token operator">=</span> flags<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token number">3</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	
	<span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
		
		<span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> cm<span class="token punctuation">;</span>
		<span class="token keyword">char</span> control<span class="token punctuation">[</span><span class="token function">CMSG_SPACE</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token punctuation">&#125;</span>control_un<span class="token punctuation">;</span>


	<span class="token keyword">struct</span> <span class="token class-name">msghdr</span> msg <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
		
		<span class="token punctuation">.</span>msg_name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>msg_namelen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>msg_iov <span class="token operator">=</span> <span class="token operator">&amp;</span>iov<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>msg_iovlen <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>msg_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>msg_control <span class="token operator">=</span> control_un<span class="token punctuation">.</span>control<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>msg_controllen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>control_un<span class="token punctuation">.</span>control<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	
	<span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> <span class="token operator">*</span>cmsg <span class="token operator">=</span> <span class="token function">CMSG_FIRSTHDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

	cmsg<span class="token operator">-></span>cmsg_len <span class="token operator">=</span> <span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cmsg<span class="token operator">-></span>cmsg_level <span class="token operator">=</span> SOL_SOCKET<span class="token punctuation">;</span>
	cmsg<span class="token operator">-></span>cmsg_type <span class="token operator">=</span> SCM_RIGHTS<span class="token punctuation">;</span>

	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">CMSG_DATA</span><span class="token punctuation">(</span>cmsg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> open_file_fd<span class="token punctuation">;</span>


	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">sendmsg</span><span class="token punctuation">(</span>ret_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"sendmsg()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>open_file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  userspace_way1_recv.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/un.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span>          <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span> addr<span class="token punctuation">,</span> addr1<span class="token punctuation">;</span>
	
	<span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	addr<span class="token punctuation">.</span>sun_family <span class="token operator">=</span> AF_LOCAL<span class="token punctuation">;</span>

	<span class="token function">strncpy</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sun_path<span class="token punctuation">,</span> <span class="token string">"tmp.tmp"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sun_path<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token class-name">socklen_t</span> addr_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	
	<span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_LOCAL<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> fd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket() error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>	
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">int</span> con_ret <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> addr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> con_ret <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect() error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//char * flags = "@!@";</span>
	<span class="token keyword">char</span>  flags<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">iovec</span> iov <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	
		<span class="token punctuation">.</span>iov_base <span class="token operator">=</span> flags<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token number">3</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	
	<span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
		
		<span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> cm<span class="token punctuation">;</span>
		<span class="token keyword">char</span> control<span class="token punctuation">[</span><span class="token function">CMSG_SPACE</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token punctuation">&#125;</span>control_un<span class="token punctuation">;</span>


	<span class="token keyword">struct</span> <span class="token class-name">msghdr</span> msg <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
		
		<span class="token punctuation">.</span>msg_name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>msg_namelen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>msg_iov <span class="token operator">=</span> <span class="token operator">&amp;</span>iov<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>msg_iovlen <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>msg_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>msg_control <span class="token operator">=</span> control_un<span class="token punctuation">.</span>control<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>msg_controllen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>control_un<span class="token punctuation">.</span>control<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">cmsghdr</span> <span class="token operator">*</span>cmsg <span class="token operator">=</span> <span class="token function">CMSG_FIRSTHDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

	cmsg<span class="token operator">-></span>cmsg_len <span class="token operator">=</span> <span class="token function">CMSG_LEN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cmsg<span class="token operator">-></span>cmsg_level <span class="token operator">=</span> SOL_SOCKET<span class="token punctuation">;</span>
	cmsg<span class="token operator">-></span>cmsg_type <span class="token operator">=</span> SCM_RIGHTS<span class="token punctuation">;</span>

	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">CMSG_DATA</span><span class="token punctuation">(</span>cmsg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	


	<span class="token keyword">int</span> ret_recv<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span>  <span class="token operator">></span> <span class="token punctuation">(</span>ret_recv <span class="token operator">=</span> <span class="token function">recvmsg</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recvmsg()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">int</span> open_file_fd <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">CMSG_DATA</span><span class="token punctuation">(</span>cmsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>open_file_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> ret <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"lseek()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>	



	<span class="token keyword">char</span> file_content <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x00</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> read_bytes_num<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>read_bytes_num <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>open_file_fd<span class="token punctuation">,</span> file_content<span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">==</span> read_bytes_num <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read EOF\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>




	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read file content: %s, fd is %d \n"</span><span class="token punctuation">,</span> file_content<span class="token punctuation">,</span> open_file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>



	



	
	<span class="token function">close</span><span class="token punctuation">(</span>open_file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  运行截图：(send_way1 发送，recv_way1接收，注意文件指针的重置，否则接收者打印的内容为空)</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_082/socket.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<h5 id="内核态实例">内核态实例</h5>
<p>  建立一个trans_fd_drv驱动，然后操作驱动完成不同进程间描述符的转换。</p>
<p>  测试环境：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>Ubuntu 18.04</p>
</li>
<li class="lvl-2">
<p>Linux 4.15.0-46-generic #49-Ubuntu SMP Wed Feb 6 09:33:07 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</p>
</li>
</ul>
<p>  驱动源码</p>
<p>  transmisson_fd_driver.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span> <span class="token comment">//struct cdev</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span><span class="token comment">//struct file_operations </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/file.h></span></span>


<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span> ptr_cur_class<span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">cdev</span>  _cur_cdev<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token class-name">dev_t</span> _cur_dev<span class="token punctuation">;</span> 



<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> ptr_trans_file <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>



<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">drv_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">drv_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>



<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">drv_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	<span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token comment">//get data</span>

			<span class="token keyword">int</span> get_fd <span class="token operator">=</span> arg<span class="token punctuation">;</span>

			ptr_trans_file <span class="token operator">=</span> <span class="token function">fget</span><span class="token punctuation">(</span>get_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>		
		<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token comment">//set data</span>
			
			<span class="token keyword">int</span> unused_fd <span class="token operator">=</span> <span class="token function">get_unused_fd_flags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fd_install</span><span class="token punctuation">(</span>unused_fd<span class="token punctuation">,</span> ptr_trans_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">__put_user</span><span class="token punctuation">(</span>unused_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"drv_ioctl cmd error ......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>


	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open  <span class="token operator">=</span> drv_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> drv_release<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> drv_ioctl
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 


<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">trans_fd_drv_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span> 

    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"trans_fd_drv initing ......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//void cdev_init(struct cdev *p, const struct file_operations *p);　</span>
    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_cur_cdev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//int alloc_chrdev_region(dev_t *dev, unsigned baseminor, unsigned count, const char *name);</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_cur_dev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"trans_fd_drv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> ret <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"alloc_chrdev_region error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token comment">//int cdev_add(struct cdev *p, dev_t dev, unsigned count);</span>
    <span class="token class-name">dev_t</span> major <span class="token operator">=</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>_cur_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_cur_cdev<span class="token punctuation">,</span> _cur_dev<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> ret <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	
	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"cdev_add error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    ptr_cur_class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"trans_fd_drv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">device_create</span><span class="token punctuation">(</span>ptr_cur_class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> _cur_dev<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"trans_fd_drv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>


<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">trans_fd_drv_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

	<span class="token comment">//void device_destroy(struct class *cls, dev_t devt);</span>
	<span class="token function">device_destroy</span><span class="token punctuation">(</span>ptr_cur_class<span class="token punctuation">,</span> _cur_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//void class_destroy(struct class *cls); </span>
	<span class="token function">class_destroy</span><span class="token punctuation">(</span>ptr_cur_class<span class="token punctuation">)</span><span class="token punctuation">;</span>  

	
    <span class="token comment">//get command and pid</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"trans_fd_drv exiting ......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//void unregister_chrdev_region(dev_t from, unsigned count);</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>_cur_dev<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//void cdev_del(struct cdev *p);</span>
    <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_cur_cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>trans_fd_drv_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>trans_fd_drv_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  操作驱动源码</p>
<p>  send_fd_from_drv.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	
	<span class="token keyword">int</span> fd<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/trans_fd_drv"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">int</span> show_file_fd<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>show_file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">char</span> file_content <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x00</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> read_bytes_num <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>show_file_fd<span class="token punctuation">,</span> file_content<span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read file content: %s\n"</span><span class="token punctuation">,</span> file_content<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> show_file_fd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>show_file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  recv_fd_from_drv.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	
	<span class="token keyword">int</span> fd<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/trans_fd_drv"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">int</span> show_file_fd<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>show_file_fd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>


	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>show_file_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> ret <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"lseek()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>	


	<span class="token keyword">char</span> file_content <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x00</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> read_bytes_num <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>show_file_fd<span class="token punctuation">,</span> file_content<span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read file content: %s\n"</span><span class="token punctuation">,</span> file_content<span class="token punctuation">)</span><span class="token punctuation">;</span>



	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>show_file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  测试截图</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_082/drv.png" alt="rep_img"/></center>
    </div>
</div>    
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_082/drv_send.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  总结</p>
<ol>
<li class="lvl-3">
<p>使自己对用户态和内核态的理解更加的深刻。</p>
</li>
<li class="lvl-3">
<p>通过实现一个驱动的方式来直接操作内核态内容，这是一个不错的idea。</p>
</li>
<li class="lvl-3">
<p>我发现，很多时候只有亲自动手来试试，才能实际体会到成就感。</p>
</li>
<li class="lvl-3">
<p>不折腾，怎么能够进步。</p>
</li>
</ol>
<p>  注意：这里关于描述符的转换可以是任意描述符，不一定要是文件描述符（网络描述符等等都可以转换，因为linux的设计原则是：一切皆是文件。有vfs的存在，很多操作都被接口化了。）。</p>
<p>  如果有需求：本文所有测试代码可在这里下载（不建议下载，除了makefile我都把代码全部贴出来了的，csdn的积分我没有找到怎么编辑，默认要5分）：<a target="_blank" rel="noopener" href="https://download.csdn.net/download/u011728480/11033121">https://download.csdn.net/download/u011728480/11033121</a></p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2019/03/12/blog_idx_081/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/03/12/blog_idx_081/" class="post-title-link" itemprop="url">Android匿名共享内存(Anonymous Shared Memory) --- 瞎折腾记录 (驱动程序篇)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-03-12 17:18:23" itemprop="dateCreated datePublished" datetime="2019-03-12T17:18:23+08:00">2019-03-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>14 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-30 21:41:35
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=081） 
&emsp;&emsp;本文发布于 2019-03-12 17:18:23，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=081） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="背景">背景</h3>
<p>  没有买卖，就没有伤害。 ------  （佚名）</p>
<p>  作为一个打工仔，要积极完成领导分配的任务。so,我分配到一个关于android进程间高效传输大量数据的的任务。不用我说，只要提及“大量”“高效”“进程间”这几个词，首先就得想到共享内存。虽然共享内存有这样那样的缺点，但是有一个优点，那就是快。</p>
<p>  可是这里有个问题，为什么我需要去读这些驱动或者乱七八糟的东西？因为Android提供了一个java类叫做：MemoryFile就可以实现共享内存，MemoryFile是android基于其共享内存机制实现的java层到java层之间的数据传输。但是，在我们的工作内容中，需要在android系统中用前向框架跑深度学习算法，这里有个问题，我们跑算法的时候是在C or C<ins>层跑的，但是我们有一些图像数据需要在apk里面采集或者使用。在Android中，怎么让图像数据在c or c</ins>层和java层快速传输，c or c++ 层之间快速传输，这就需要我们了解android 共享内存机制，做出合适的抉择。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Android-Anonymous-Shared-Memory-简介">Android Anonymous Shared Memory 简介</h3>
<hr>
<p>  我们都知道Android是基于Linux内核搭建的一个分层系统，其中有kernel层，RunTimeLib和其他lib层，Framework层，Application层。虽然Linux os带了很多IPC的机制，其中Sharedmemory也有两种，但是在android系统里面，是没有这些内容的，android的linuxkernel你可以理解为是一种深度定制版，很多东西都与普通的linux kenel不一致。</p>
<p>  由于Androidkernel不带普通的linuxkernel的常用共享内存方式，所以android 系统提供了另外一种替代方式，当然不是全部重复造轮子，只是通过驱动程序的方式，增加了自己想要的新特性，并封装了一个新的共享内存接口出来。</p>
<p>  更详细和基本的介绍：请大家去参考百度的很多对Android共享内存的介绍。现在网上有很多关于android共享内存的介绍，有部分是精品，让我受益匪浅，是可以参考的。这里向这些无私奉献精品的前辈致敬。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Android-Anonymous-Shared-Memory-驱动源码分析">Android Anonymous Shared Memory 驱动源码分析</h3>
<hr>
<p>  在我记忆中，有一个不知道谁说的，学习的好方法，那就是：从源码来，到源码去。我一直抱着这种心态来学习新的事物，毕竟许多理论是需要我们去了解，虽然不需要去重复造轮子。</p>
<p>  Android kernel的驱动编写和linuxkernel的驱动编写类似，都是有一个入口函数。我们首先从这两个函数开始分析，然后分析几个比较重要的接口就行。</p>
<p>  源码版本：android-p release kernel 4.9</p>
<p>  目录：\drivers\staging\android\ashmem.c</p>
<p>  驱动入口</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * struct ashmem_area - The anonymous shared memory area
 * @name:		The optional name in /proc/pid/maps
 * @unpinned_list:	The list of all ashmem areas
 * @file:		The shmem-based backing file
 * @size:		The size of the mapping, in bytes
 * @prot_mask:		The allowed protection bits, as vm_flags
 *
 * The lifecycle of this structure is from our parent file's open() until
 * its release(). It is also protected by 'ashmem_mutex'
 *
 * Warning: Mappings do NOT pin this structure; It dies on close()
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">ashmem_area</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">char</span> name<span class="token punctuation">[</span>ASHMEM_FULL_NAME_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> unpinned_list<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> size<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> prot_mask<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * struct ashmem_range - A range of unpinned/evictable pages
 * @lru:	         The entry in the LRU list
 * @unpinned:	         The entry in its area's unpinned list
 * @asma:	         The associated anonymous shared memory area.
 * @pgstart:	         The starting page (inclusive)
 * @pgend:	         The ending page (inclusive)
 * @purged:	         The purge status (ASHMEM_NOT or ASHMEM_WAS_PURGED)
 *
 * The lifecycle of this structure is from unpin to pin.
 * It is protected by 'ashmem_mutex'
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">ashmem_range</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> lru<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> unpinned<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">ashmem_area</span> <span class="token operator">*</span>asma<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> pgstart<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> pgend<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> purged<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> ashmem_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open <span class="token operator">=</span> ashmem_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> ashmem_release<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read <span class="token operator">=</span> ashmem_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>llseek <span class="token operator">=</span> ashmem_llseek<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>mmap <span class="token operator">=</span> ashmem_mmap<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> ashmem_ioctl<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_COMPAT</span></span>
	<span class="token punctuation">.</span>compat_ioctl <span class="token operator">=</span> compat_ashmem_ioctl<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">miscdevice</span> ashmem_misc <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">.</span>minor <span class="token operator">=</span> MISC_DYNAMIC_MINOR<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"ashmem"</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>fops <span class="token operator">=</span> <span class="token operator">&amp;</span>ashmem_fops<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">kmem_cache</span> <span class="token operator">*</span>ashmem_area_cachep __read_mostly<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">kmem_cache</span> <span class="token operator">*</span>ashmem_range_cachep __read_mostly<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">ashmem_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
	<span class="token comment">//slab 缓存 中 创建struct ashmem_area内存区域结构，这个创建后，下一次分配这个结构体的时候可以更快。</span>
	ashmem_area_cachep <span class="token operator">=</span> <span class="token function">kmem_cache_create</span><span class="token punctuation">(</span><span class="token string">"ashmem_area_cache"</span><span class="token punctuation">,</span>
					       <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ashmem_area</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					       <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">////unlikely()--执行else后面的语句概率较高，增加cache命中率，likely()与此功能相反</span>
	<span class="token comment">//</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>ashmem_area_cachep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"failed to create slab cache\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">//同上</span>
	ashmem_range_cachep <span class="token operator">=</span> <span class="token function">kmem_cache_create</span><span class="token punctuation">(</span><span class="token string">"ashmem_range_cache"</span><span class="token punctuation">,</span>
						<span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ashmem_range</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
						<span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>ashmem_range_cachep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"failed to create slab cache\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out_free1<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">//杂项设备注册</span>
	ret <span class="token operator">=</span> <span class="token function">misc_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_misc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"failed to register misc device!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out_free2<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">//这个好像和内存回收有关。我这里不关心。</span>
	<span class="token function">register_shrinker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_shrinker<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"initialized\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

out_free2<span class="token operator">:</span>
	<span class="token function">kmem_cache_destroy</span><span class="token punctuation">(</span>ashmem_range_cachep<span class="token punctuation">)</span><span class="token punctuation">;</span>
out_free1<span class="token operator">:</span>
	<span class="token function">kmem_cache_destroy</span><span class="token punctuation">(</span>ashmem_area_cachep<span class="token punctuation">)</span><span class="token punctuation">;</span>
out<span class="token operator">:</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">device_initcall</span><span class="token punctuation">(</span>ashmem_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  当这个设备创建以后，就会在/dev/下生成一个ashmem字符设备。</p>
<p>  在struct file_operations ashmem_fops中，我们注册了很多接口，如果大家对linux 驱动编程没有一点了解的话，你可以直接理解为我们在用户态调用open就会调用这里的ashmem_open，其他的类似。</p>
<p>  下面我们重点介绍几个我们常用的接口：ashmem_open，ashmem_ioctl，ashmem_mmap。</p>
<p>  ashmem_open</p>
<p>  我们调用open的时候，打开一个内存共享。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * ashmem_open() - Opens an Anonymous Shared Memory structure
 * @inode:	   The backing file's index node(?)
 * @file:	   The backing file
 *
 * Please note that the ashmem_area is not returned by this function - It is
 * instead written to "file->private_data".
 *
 * Return: 0 if successful, or another code if unsuccessful.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ashmem_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">ashmem_area</span> <span class="token operator">*</span>asma<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	
	<span class="token comment">//检查vfs打开的文件，在32为系统下打开大文件导致overflow的问题</span>
	ret <span class="token operator">=</span> <span class="token function">generic_file_open</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">////unlikely()--ret为0的概率较大，增加cache命中率，方便编译器优化分支语句。</span>
	<span class="token comment">//（把else后的语句紧贴if之后，把return 放到jmp之后。）likely()与此功能相反</span>
	<span class="token comment">//</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	<span class="token comment">/*

	GFP_KERNEL —— 正常分配内存，可以被中断，还有其他内存分配标志。GFP_KERNEL，GFP_DMA

	*/</span>
	<span class="token comment">//快速分配一个struct ashmem_area结构体，相当于这段新开辟的共享内存的句柄</span>
	asma <span class="token operator">=</span> <span class="token function">kmem_cache_zalloc</span><span class="token punctuation">(</span>ashmem_area_cachep<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>asma<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
	<span class="token comment">//这个和内存回收有关，不管</span>
	<span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>asma<span class="token operator">-></span>unpinned_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//给共享内存名字赋初值</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>asma<span class="token operator">-></span>name<span class="token punctuation">,</span> ASHMEM_NAME_PREFIX<span class="token punctuation">,</span> ASHMEM_NAME_PREFIX_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//设置保护位</span>
	asma<span class="token operator">-></span>prot_mask <span class="token operator">=</span> PROT_MASK<span class="token punctuation">;</span>
	<span class="token comment">//利用struct file结构体中的private_data 来保存我们刚刚分配的句柄的指针。private_data 可以用来携带个人定制的数据，这里用来携带我们定义的共享内存句柄。注意这个地方很重要，为啥重要后面独立解释。</span>
	file<span class="token operator">-></span>private_data <span class="token operator">=</span> asma<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  ashmem_ioctl</p>
<p>  这里我们关注一下，给struct ashmem_area 的name和size赋值即可，这里注意，还没有分配实际的内存，仅仅是句柄的相关信息填充完毕了。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">ashmem_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">//这里就是获取之前ashmem_open的过程中，我们保存的共享内存句柄</span>
	<span class="token keyword">struct</span> <span class="token class-name">ashmem_area</span> <span class="token operator">*</span>asma <span class="token operator">=</span> file<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
	<span class="token keyword">long</span> ret <span class="token operator">=</span> <span class="token operator">-</span>ENOTTY<span class="token punctuation">;</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> ASHMEM_SET_NAME<span class="token operator">:</span>
		ret <span class="token operator">=</span> <span class="token function">set_name</span><span class="token punctuation">(</span>asma<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ASHMEM_GET_NAME<span class="token operator">:</span>
		ret <span class="token operator">=</span> <span class="token function">get_name</span><span class="token punctuation">(</span>asma<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ASHMEM_SET_SIZE<span class="token operator">:</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>asma<span class="token operator">-></span>file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			asma<span class="token operator">-></span>size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ASHMEM_GET_SIZE<span class="token operator">:</span>
		ret <span class="token operator">=</span> asma<span class="token operator">-></span>size<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ASHMEM_SET_PROT_MASK<span class="token operator">:</span>
		ret <span class="token operator">=</span> <span class="token function">set_prot_mask</span><span class="token punctuation">(</span>asma<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ASHMEM_GET_PROT_MASK<span class="token operator">:</span>
		ret <span class="token operator">=</span> asma<span class="token operator">-></span>prot_mask<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ASHMEM_PIN<span class="token operator">:</span>
	<span class="token keyword">case</span> ASHMEM_UNPIN<span class="token operator">:</span>
	<span class="token keyword">case</span> ASHMEM_GET_PIN_STATUS<span class="token operator">:</span>
		ret <span class="token operator">=</span> <span class="token function">ashmem_pin_unpin</span><span class="token punctuation">(</span>asma<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ASHMEM_PURGE_ALL_CACHES<span class="token operator">:</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">capable</span><span class="token punctuation">(</span>CAP_SYS_ADMIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">struct</span> <span class="token class-name">shrink_control</span> sc <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
				<span class="token punctuation">.</span>gfp_mask <span class="token operator">=</span> GFP_KERNEL<span class="token punctuation">,</span>
				<span class="token punctuation">.</span>nr_to_scan <span class="token operator">=</span> LONG_MAX<span class="token punctuation">,</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
			ret <span class="token operator">=</span> <span class="token function">ashmem_shrink_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_shrinker<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">ashmem_shrink_scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_shrinker<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  ashmem_mmap</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ashmem_mmap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span>vma<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">//同上</span>
	<span class="token keyword">struct</span> <span class="token class-name">ashmem_area</span> <span class="token operator">*</span>asma <span class="token operator">=</span> file<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* user needs to SET_SIZE before mapping */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>asma<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/* requested mapping size larger than object size */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_end <span class="token operator">-</span> vma<span class="token operator">-></span>vm_start <span class="token operator">></span> <span class="token function">PAGE_ALIGN</span><span class="token punctuation">(</span>asma<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/* requested protection bits must match our allowed protection mask */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_flags <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token function">calc_vm_prot_bits</span><span class="token punctuation">(</span>asma<span class="token operator">-></span>prot_mask<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>
		     <span class="token function">calc_vm_prot_bits</span><span class="token punctuation">(</span>PROT_MASK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	vma<span class="token operator">-></span>vm_flags <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token function">calc_vm_may_flags</span><span class="token punctuation">(</span><span class="token operator">~</span>asma<span class="token operator">-></span>prot_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//第一次mmap时，正式申请内存</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>asma<span class="token operator">-></span>file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">char</span> <span class="token operator">*</span>name <span class="token operator">=</span> ASHMEM_NAME_DEF<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>vmfile<span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>asma<span class="token operator">-></span>name<span class="token punctuation">[</span>ASHMEM_NAME_PREFIX_LEN<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">)</span>
			name <span class="token operator">=</span> asma<span class="token operator">-></span>name<span class="token punctuation">;</span>

		<span class="token comment">/* ... and allocate the backing shmem file */</span>

		<span class="token comment">/**
		 * shmem_kernel_file_setup - get an unlinked file living in tmpfs which must be
		 *	kernel internal.  There will be NO LSM permission checks against the
		 *	underlying inode.  So users of this interface must do LSM checks at a
		 *	higher layer.  The users are the big_key and shm implementations.  LSM
		 *	checks are provided at the key or shm level rather than the inode.
		 * @name: name for dentry (to be seen in /proc/&lt;pid>/maps
		 * @size: size to be set for the file
		 * @flags: VM_NORESERVE suppresses pre-accounting of the entire object size
		 */</span>
		<span class="token comment">//在tmpfs中创建一个文件，并创建一个inode指向这个文件，并把inode和struct file的返回值关联起来。这个文件就是我们实际的共享的内存文件。这里我们看到其实android 匿名共享内存也是基于linux 普通的共享内存底层来实现的，不重复造轮子。</span>
		vmfile <span class="token operator">=</span> <span class="token function">shmem_file_setup</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> asma<span class="token operator">-></span>size<span class="token punctuation">,</span> vma<span class="token operator">-></span>vm_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>vmfile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			ret <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>vmfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		vmfile<span class="token operator">-></span>f_mode <span class="token operator">|=</span> FMODE_LSEEK<span class="token punctuation">;</span>
		<span class="token comment">//用file域保存我们在tmpfs中创建的共享内存文件的file结构指针。也就是说现在开始，asma->file指向了我们的共享内存文件。</span>
		asma<span class="token operator">-></span>file <span class="token operator">=</span> vmfile<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token function">get_file</span><span class="token punctuation">(</span>asma<span class="token operator">-></span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//把asma->file和我们mmap 的内存区域中的vma->vm_file关联起来。这样访问mmap的这段内存区域就等于访问我们创建的这个共享内存文件。</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_flags <span class="token operator">&amp;</span> VM_SHARED<span class="token punctuation">)</span>
		<span class="token function">shmem_set_file</span><span class="token punctuation">(</span>vma<span class="token punctuation">,</span> asma<span class="token operator">-></span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_file<span class="token punctuation">)</span>
			<span class="token function">fput</span><span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
		vma<span class="token operator">-></span>vm_file <span class="token operator">=</span> asma<span class="token operator">-></span>file<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

out<span class="token operator">:</span>
	<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ashmem_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="Android-Anonymous-Shared-Memory-驱动使用">Android Anonymous Shared Memory 驱动使用</h3>
<hr>
<p>  Android 官方的一个lib用例库中，封装了一部分共享内存的用法，这部分内容就是给MemoryFile的Native层的库使用的。下面我们一起来分析分析。</p>
<p>  Android O r4</p>
<p>  system/core/libcutils/ashmem-dev.c</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*
 * Copyright (C) 2008 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token comment">/*
 * Implementation of the user-space ashmem API for devices, which have our
 * ashmem-enabled kernel. See ashmem-sim.c for the "fake" tmp-based version,
 * used by the simulator.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOG_TAG</span> <span class="token string">"ashmem"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/ashmem.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cutils/ashmem.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;log/log.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ASHMEM_DEVICE</span> <span class="token string">"/dev/ashmem"</span></span>

<span class="token comment">/* ashmem identity */</span>
<span class="token keyword">static</span> dev_t __ashmem_rdev<span class="token punctuation">;</span>
<span class="token comment">/*
 * If we trigger a signal handler in the middle of locked activity and the
 * signal handler calls ashmem, we could get into a deadlock state.
 */</span>
<span class="token keyword">static</span> pthread_mutex_t __ashmem_lock <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>

<span class="token comment">/* logistics of getting file descriptor for ashmem */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__ashmem_open_locked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span>
	<span class="token comment">//这里打开了"/dev/ashmem"驱动设备，创建了一个共享内存文件，返回了这个共享文件的文件描述符</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">open</span><span class="token punctuation">(</span>ASHMEM_DEVICE<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    ret <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        errno <span class="token operator">=</span> save_errno<span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">S_ISCHR</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>st<span class="token punctuation">.</span>st_rdev<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        errno <span class="token operator">=</span> ENOTTY<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    __ashmem_rdev <span class="token operator">=</span> st<span class="token punctuation">.</span>st_rdev<span class="token punctuation">;</span>
    <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__ashmem_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>

    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>__ashmem_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fd <span class="token operator">=</span> <span class="token function">__ashmem_open_locked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>__ashmem_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* Make sure file descriptor references ashmem, negative number means false */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__ashmem_is_ashmem</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> fatal<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    dev_t rdev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    rdev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* Too much complexity to sniff __ashmem_rdev */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISCHR</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> st<span class="token punctuation">.</span>st_rdev<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>__ashmem_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rdev <span class="token operator">=</span> __ashmem_rdev<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rdev<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>__ashmem_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">__ashmem_open_locked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>__ashmem_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            rdev <span class="token operator">=</span> __ashmem_rdev<span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>__ashmem_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_rdev <span class="token operator">==</span> rdev<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fatal<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rdev<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">LOG_ALWAYS_FATAL</span><span class="token punctuation">(</span><span class="token string">"illegal fd=%d mode=0%o rdev=%d:%d expected 0%o %d:%d"</span><span class="token punctuation">,</span>
              fd<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_mode<span class="token punctuation">,</span> <span class="token function">major</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_rdev<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">minor</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_rdev<span class="token punctuation">)</span><span class="token punctuation">,</span>
              S_IFCHR <span class="token operator">|</span> S_IRUSR <span class="token operator">|</span> S_IWUSR <span class="token operator">|</span> S_IRGRP <span class="token operator">|</span> S_IWGRP <span class="token operator">|</span> S_IROTH <span class="token operator">|</span> S_IRGRP<span class="token punctuation">,</span>
              <span class="token function">major</span><span class="token punctuation">(</span>rdev<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">minor</span><span class="token punctuation">(</span>rdev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">LOG_ALWAYS_FATAL</span><span class="token punctuation">(</span><span class="token string">"illegal fd=%d mode=0%o rdev=%d:%d expected 0%o"</span><span class="token punctuation">,</span>
              fd<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_mode<span class="token punctuation">,</span> <span class="token function">major</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_rdev<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">minor</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_rdev<span class="token punctuation">)</span><span class="token punctuation">,</span>
              S_IFCHR <span class="token operator">|</span> S_IRUSR <span class="token operator">|</span> S_IWUSR <span class="token operator">|</span> S_IRGRP <span class="token operator">|</span> S_IWGRP <span class="token operator">|</span> S_IROTH <span class="token operator">|</span> S_IRGRP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">/* NOTREACHED */</span>
    <span class="token punctuation">&#125;</span>

    errno <span class="token operator">=</span> ENOTTY<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">ashmem_valid</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">__ashmem_is_ashmem</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
 * ashmem_create_region - creates a new ashmem region and returns the file
 * descriptor, or &lt;0 on error
 *
 * `name' is an optional label to give the region (visible in /proc/pid/maps)
 * `size' is the size of the region, in page-aligned bytes
 */</span>
 <span class="token comment">//实际我们要创建的共享内存方法就是这个，其实就是打开设备，然后设置name和size，最终通过mmap把这个fd映射到我们的进程空间，然后我们的程序就可以访问了。</span>
<span class="token keyword">int</span> <span class="token function">ashmem_create_region</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">,</span> save_errno<span class="token punctuation">;</span>

    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">__ashmem_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span>ASHMEM_NAME_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token function">strlcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ASHMEM_SET_NAME<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    ret <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ASHMEM_SET_SIZE<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> fd<span class="token punctuation">;</span>

error<span class="token operator">:</span>
    save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    errno <span class="token operator">=</span> save_errno<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">ashmem_set_prot_region</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">__ashmem_is_ashmem</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ASHMEM_SET_PROT_MASK<span class="token punctuation">,</span> prot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">ashmem_pin_region</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> size_t offset<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ashmem_pin</span> pin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> offset<span class="token punctuation">,</span> len <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">__ashmem_is_ashmem</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ASHMEM_PIN<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">ashmem_unpin_region</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> size_t offset<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ashmem_pin</span> pin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> offset<span class="token punctuation">,</span> len <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">__ashmem_is_ashmem</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ASHMEM_UNPIN<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">ashmem_get_size_region</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">__ashmem_is_ashmem</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ASHMEM_GET_SIZE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  同时，在MemoryFile的jni接口中，我们可以发现直接调用ashmem_create_region，创建了一块共享内存区域。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> jobject <span class="token function">SharedMemory_create</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jstring jname<span class="token punctuation">,</span> jint size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// Name is optional so we can't use ScopedUtfChars for this as it throws NPE on null</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> jname <span class="token operator">?</span> env<span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>jname<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">ashmem_create_region</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Capture the error, if there is one, before calling ReleaseStringUTFChars</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> fd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> errno <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        env<span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>jname<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">throwErrnoException</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"SharedMemory_create"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">jniCreateFileDescriptor</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  总结</p>
<p>  这里我们看到，共享内存的创建原理。但是这里有个问题没有解释清楚，那就是内存是怎么共享的？</p>
<p>  在本文中，我们可以知道我们的创建共享内存的进程可以得到一个共享内存文件的文件描述符，其他的进程怎么知道这块内存在那里呢？这里我明确说明，android还要靠共享共享内存文件文件描述符来实现共享内存，但是一个文件描述符只对当前进程有效，其他进程的同一个值的文件描述符可能指向不同的文件，所以得有一种可靠的方式来实现文件描述符的传递即可。</p>
<p>  预知后事如何，请听下回分解！！</p>
<h3 id="2019-3-18更新">2019/3/18更新</h3>
<p>  本来是一系列的文章，但是后续篇整理后，发现不能成为一个系列了。所以这里留个传送门：《linux kernel 中进程间描述符的传递方法及原理》：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011728480/article/details/88553602">https://blog.csdn.net/u011728480/article/details/88553602</a></p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2019/02/14/blog_idx_080/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/02/14/blog_idx_080/" class="post-title-link" itemprop="url">android ndk生成第三方库的so方法(ndk-build，Application.mk，Android.mk)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-02-14 15:40:13" itemprop="dateCreated datePublished" datetime="2019-02-14T15:40:13+08:00">2019-02-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-30 21:32:57
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=080） 
&emsp;&emsp;本文发布于 2019-02-14 15:40:13，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=080） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  本文适合至少知道makefile，jni，ndk，gcc基本编译知识是什么鬼东西的人阅读。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="背景">背景</h3>
<hr>
<p>  以前，关于android中使用jni相关的东西的时候(jni头文件生成，jni的so文件的生成)，我太依赖与as工具了。导致了，什么都需要ide来完成，平常这么用的时候，其实是没有什么毛病的。但是比如说你要发布一个自己封装的库时候，自己在ide上配置然后编译其实是没有什么问题的，但是你把as工程发给别人的时候，总会遇到这样那样的问题，很烦。于是想着把生成android app使用的so独立出来，方便我们查找错误，同时也加深了自己对于android ndk的理解。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="NDK">NDK</h3>
<hr>
<p>  ndk 是android提供的原生开发包。它可以让android app可以利用c和c<ins>的库等等。在我们安装的android sdk中，其实是就包含了ndk的内容，可以说ndk 部分内容是android系统可以正常运行的基石,因为在android 系统中，很多内容不适合使用java来开发，所以只能通过java调用c和c</ins>的方式来实现相应的内容。</p>
<p>  本文也是按照android开发者网站的ndk相关文档进行学习总结，同时也贴出一些基本错误方便排查。(<a target="_blank" rel="noopener" href="https://developer.android.google.cn/ndk/guides/">https://developer.android.google.cn/ndk/guides/</a>)</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="ndk-build-脚本">ndk-build 脚本</h3>
<hr>
<p>  按照官方文档的说法：ndk-build 这个脚本在ndk r4的时候就存在了。它的主要作用就是初始化很多内容，然后执行gnu-make 来编译ndk部分的源码。</p>
<p>  其核心执行的命令官网也给出来了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">GNUMAKE <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span>ndk<span class="token operator">></span>/build/core/build-local.mk <span class="token operator">&lt;</span>parameters<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>  这里我们其实也知道了，要成功使用这个脚本必须安装gnu-make （还必须是3.81级以上的版本）</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Android-mk文件">Android.mk文件</h3>
<hr>
<p>  首先我们要明白，Android.mk只是一个makefile片段，这个片段中定义相关变量，然后被make命令使用和解析，我们只需要按照别人规定好的方法填写相应变量的值即可。</p>
<p>  这里我主要使用了最基本的一些变量,同时提供相应的注释解释，如果要查看完整说明，请参考<a target="_blank" rel="noopener" href="https://developer.android.google.cn/ndk/guides/%E4%B8%ADandroid.mk%E9%83%A8%E5%88%86%E5%86%85%E5%AE%B9%EF%BC%8C%E5%AE%9E%E4%BE%8B%E5%A6%82%E4%B8%8B%EF%BC%9A">https://developer.android.google.cn/ndk/guides/中android.mk部分内容，实例如下：</a></p>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">LOCAL_PATH <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">call</span> my-dir<span class="token punctuation">)</span>
<span class="token comment">#这个LOCAL_PATH变量存储的是当前文件所在目录，是通过调用my-dir这个函数实现的</span>

<span class="token keyword">include</span> <span class="token variable">$</span><span class="token punctuation">(</span>CLEAR_VARS<span class="token punctuation">)</span>
<span class="token comment">#CLEAR_VARS是一个特殊的makefile文件，其中清空了许多变量的值</span>

LOCAL_MODULE <span class="token operator">:=</span> android-shmem
<span class="token comment">#LOCAL_MODULE填写的是你要生成的so的库名字的核心部分，这里生成的库名字为：libandroid-shmem.so</span>

LOCAL_SRC_FILES <span class="token operator">:=</span> shmem.c
<span class="token comment">#LOCAL_SRC_FILES填写你要编译到so的源文件名字</span>

<span class="token keyword">include</span> <span class="token variable">$</span><span class="token punctuation">(</span>BUILD_SHARED_LIBRARY<span class="token punctuation">)</span>
<span class="token comment">#BUILD_SHARED_LIBRARY指向一个特殊的makefile文件，将会收集以上的变量信息，然后生成动态库。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="Application-mk文件">Application.mk文件</h3>
<hr>
<p>  这个文件也是一个makefile文件，</p>
<p>  我这里也列出一个实例来说明：</p>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">APP_CFLAGS <span class="token operator">+=</span> -std<span class="token operator">=</span>c99
<span class="token comment">#做或者c++编程的都应该知道编译器编译参数设置</span>
APP_CPPFLAGS <span class="token operator">+=</span>
<span class="token comment">#做或者c++编程的都应该知道编译器编译参数设置</span>
APP_LDFLAGS <span class="token operator">+=</span> -llog
<span class="token comment">#做或者c++编程的都应该知道编译器链接参数设置，这里是填写依赖了哪些动态库</span>
APP_STL <span class="token operator">+=</span>
<span class="token comment">#生成 对应 某一运行时库的动态库文件</span>

APP_PIE <span class="token operator">=</span> true
<span class="token comment"># 生成位置独立的代码，</span>

APP_ABI <span class="token operator">=</span> armeabi-v7a
<span class="token comment">#这个变量我们会经常遇到，主要是指定app或者说so运行的cpu指令集。</span>

APP_PLATFORM <span class="token operator">=</span> android-21
<span class="token comment">#这个对应的android版本号</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  这里的APP_ABI的内容对于我们来说特别重要，我这里把官网的内容搬过来了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">基于 ARMv5TE的设备硬件（采用软件浮点运算）：APP_ABI :<span class="token operator">=</span> armeabi（兼容性最好，浮点运算性能差劲）
基于 ARMv7 的设备上的硬件 FPU 指令	APP_ABI :<span class="token operator">=</span> armeabi-v7a
ARMv8 AArch64	APP_ABI :<span class="token operator">=</span> arm64-v8a
IA-32	APP_ABI :<span class="token operator">=</span> x86
Intel64	APP_ABI :<span class="token operator">=</span> x86_64
MIPS32	APP_ABI :<span class="token operator">=</span> mips
MIPS64 <span class="token punctuation">(</span>r6<span class="token punctuation">)</span>	APP_ABI :<span class="token operator">=</span> mips64
所有支持的指令集	APP_ABI :<span class="token operator">=</span> all<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="使用实例">使用实例</h3>
<hr>
<p>  如果直接运行ndk-build会报如下错误：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>Android NDK: Could not find application project directory !</p>
</li>
<li class="lvl-2">
<p>Android NDK: Please define the NDK_PROJECT_PATH variable to point to it.</p>
</li>
</ul>
<p>  提示我们有个变量没有设置，我们设置上，后续还会提示其他的问题，我们一并设置，</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ndk-build <span class="token assign-left variable">NDK_PROJECT_PATH</span><span class="token operator">=</span>. <span class="token assign-left variable">APP_BUILD_SCRIPT</span><span class="token operator">=</span>./Android.mk <span class="token assign-left variable">NDK_APPLICATION_MK</span><span class="token operator">=</span>./Application.mk<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul class="lvl-0">
<li class="lvl-2">
<p>NDK_PROJECT_PATH 对应项目路径</p>
</li>
<li class="lvl-2">
<p>APP_BUILD_SCRIPT 对应Android.mk路径，这个变量有默认值，具体参考官网。</p>
</li>
<li class="lvl-2">
<p>NDK_APPLICATION_MK 对应Applicaiton.mk路径</p>
</li>
</ul>
<p>  结果：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_080/result.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  总结</p>
<p>  文中只是介绍了非常基础的内容，如果需要一些骚操作，可能就会用到一些其他变量，对于这些内容，请参考文中提到的android开发者官网。</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2019/02/14/blog_idx_079/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/02/14/blog_idx_079/" class="post-title-link" itemprop="url">java 手动生成jni头文件(JNI静态注册)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-02-14 13:29:50" itemprop="dateCreated datePublished" datetime="2019-02-14T13:29:50+08:00">2019-02-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JAVA/" itemprop="url" rel="index"><span itemprop="name">JAVA</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>867</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-30 21:26:57
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=079） 
&emsp;&emsp;本文发布于 2019-02-14 13:29:50，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=079） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="原因">原因</h3>
<hr>
<ol>
<li class="lvl-3">
<p>我之前写过一篇jni的文章，在那篇文中，我要为java jni静态注册补充一下，生成jni头文件相关的知识。</p>
</li>
<li class="lvl-3">
<p>在我们使用as开发带jni的app的时候，我们自己写的java native 方法，可以通过一定方式方便的生成jni的头文件，但是我们没有关注他是怎么生成的？</p>
</li>
<li class="lvl-3">
<p>在实际使用过程中，特别是测试过程中，或者为一个第三方c和c++库写jni接口时，手动生成jni头文件也是必须要掌握的。</p>
</li>
</ol>
<br/>
<br/>
<br/>
<br/>
<h3 id="方法">方法</h3>
<hr>
<ol>
<li class="lvl-3">
<p>首先在java层写你的native方法，注意包名等等。我这里的例子如下：</p>
</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com</span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> shmem<span class="token punctuation">&#123;</span>
	
	<span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
		
		<span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"libandroid-shmem.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token class-name">CreateSHMEM</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token class-name">AttachSHMEM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token class-name">SetDataToSHMEM</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token class-name">GetDataFromSHMEM</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data_buf<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token class-name">DetachSHMEM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token class-name">MarkDeleteSHMEM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li class="lvl-3">
<p>使用java sdk带的javac命令编译这个java文件。（注意这里的包名为com。那么记得把shmem.java放到一个名为com的文件夹下面去。）</p>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">javac shmem.java<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_079/javac.png" alt="rep_img"/></center>
    </div>
</div>    
<ol start="3">
<li class="lvl-3">
<p>通过javah命令生成jni头文件。（注意这里是完整的类名,shmem.class 必须在com文件夹下面）</p>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">javah <span class="token parameter variable">-jni</span> com.shmem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_079/javah.png" alt="rep_img"/></center>
    </div>
</div>    
<ol start="4">
<li class="lvl-3">
<p>生成的jni头文件实例</p>
</li>
</ol>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;jni.h></span></span>
<span class="token comment">/* Header for class com_shmem */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_Included_com_shmem</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_Included_com_shmem</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token comment">/*
 * Class:     com_shmem
 * Method:    CreateSHMEM
 * Signature: (I)I
 */</span>
JNIEXPORT jint JNICALL <span class="token function">Java_com_shmem_CreateSHMEM</span>
  <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span><span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jint<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Class:     com_shmem
 * Method:    AttachSHMEM
 * Signature: ()I
 */</span>
JNIEXPORT jint JNICALL <span class="token function">Java_com_shmem_AttachSHMEM</span>
  <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span><span class="token punctuation">,</span> jobject<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Class:     com_shmem
 * Method:    SetDataToSHMEM
 * Signature: ([B)I
 */</span>
JNIEXPORT jint JNICALL <span class="token function">Java_com_shmem_SetDataToSHMEM</span>
  <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span><span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jbyteArray<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Class:     com_shmem
 * Method:    GetDataFromSHMEM
 * Signature: ([BI)I
 */</span>
JNIEXPORT jint JNICALL <span class="token function">Java_com_shmem_GetDataFromSHMEM</span>
  <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span><span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jbyteArray<span class="token punctuation">,</span> jint<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Class:     com_shmem
 * Method:    DetachSHMEM
 * Signature: ()I
 */</span>
JNIEXPORT jint JNICALL <span class="token function">Java_com_shmem_DetachSHMEM</span>
  <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span><span class="token punctuation">,</span> jobject<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * Class:     com_shmem
 * Method:    MarkDeleteSHMEM
 * Signature: ()I
 */</span>
JNIEXPORT jint JNICALL <span class="token function">Java_com_shmem_MarkDeleteSHMEM</span>
  <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span><span class="token punctuation">,</span> jobject<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  这样我们就可以在生成的内容上修改修改就可以实际使用了。</p>
<ol start="5">
<li class="lvl-3">
<p>题外话：其实我们使用as等ide自动生成jni头文件，其底层的原理就是这几句简单的shell命令。</p>
</li>
</ol>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/NO_EXSIT.XXXXXXX/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/NO_EXSIT.XXXXXXX/">1</a><span class="space">&hellip;</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/14/">14</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/NO_EXSIT.XXXXXXX/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Sky</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">286k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">17:19</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":250,"hOffset":50,"vOffset":5},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
</html>
