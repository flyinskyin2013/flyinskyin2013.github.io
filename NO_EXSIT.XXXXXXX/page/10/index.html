<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"e-x.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Sky&#39;s Blogs">
<meta property="og:url" content="https://e-x.top/NO_EXSIT.XXXXXXX/page/10/index.html">
<meta property="og:site_name" content="Sky&#39;s Blogs">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Sky">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://e-x.top/NO_EXSIT.XXXXXXX/page/10/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"NO_EXSIT.XXXXXXX/page/10/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Sky's Blogs</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  




<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8677552300382028"
     crossorigin="anonymous"></script>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Sky's Blogs</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A normal star</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Sky</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">92</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">222</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/12/19/blog_idx_048/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/12/19/blog_idx_048/" class="post-title-link" itemprop="url">Caffe源码编译,win10+vs2015+Ninja,C++接口测试(mnist),Python接口测试(mnist),(坑爹篇)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-12-19 12:26:21" itemprop="dateCreated datePublished" datetime="2017-12-19T12:26:21+08:00">2017-12-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DL/" itemprop="url" rel="index"><span itemprop="name">DL</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DL/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">数据结构与算法</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 18:43:07
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=048） 
&emsp;&emsp;本文发布于 2017-12-19 12:26:21，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=048） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  date 2017.12.18</p>
<h3 id="前言">前言</h3>
<hr>
<p>  首先为了帮队友在win下配置caffe，本人特意在win平台下折腾了一波。在此只想说一句话：个人认为，caffe编译Win比Linux更坑，更难，花了我接近一天的时间（我以前在Linux上配置过N次了）。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="caffe-windows-编译">caffe windows 编译</h3>
<hr>
<p>  注意事项（这才是精华，我就是因为这个才浪费了这一天时间）</p>
<p>    1. 是否安装readme提供的符合要求的vs，cmake，ninja版本？</p>
<p>    2. 是否安装了正确的python版本?</p>
<p>    3. 对于VS来说，检查，你的电脑上应该只存在一个版本，而且此版本应该包含VC++的功能（包括MFC以及基础功能）（不理解就全部装上，绝对不吃亏，不上当，我就是因为节约空间，少装了一些东西，出问题了）</p>
<p>    4. 检查python是否只有一个版本，建议安装anaconda？</p>
<p>    5. 检查自己的环境变量，对于cl.exe,python.exe,cmake.exe,ninja.exe是否找到？</p>
<p>    6. 最后，不想折腾就尽量按照帮助文档，一个钉子一个眼的做法，这样会少很多错误？</p>
<ol>
<li class="lvl-3">
<p>下载caffe,切换分支,运行脚本,一切顺利，你就是幸运的那个人。执行以下命令以前，保证注意事项都看了，想要加速的，自己确定自己的cuda和cudnn配置好了。</p>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/BVLC/caffe.git
<span class="token builtin class-name">cd</span> caffe
<span class="token function">git</span> checkout windows
./scripts/build_win.cmd
（喝口水）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li class="lvl-3">
<p>WindowsDownloadPrebuiltDependencies.cmake 此脚本报错，报找不到服务器</p>
</li>
</ol>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">原因：主要是天朝牌防火墙
方法：
1 开vpn或者其他工具翻墙。
2 自己想办法去下对应的文件（自己分析以下这段文字），放到.caffe/download目录（一般在用户目录下）
我的下载地址：https://github.com/willyd/caffe-builder/releases/download/v1.1.0/libraries_v140_x64_py35_1.1.0.tar.bz2(对应vs2015,python3.5)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-CMAKE" data-language="CMAKE"><code class="language-CMAKE">set(DEPENDENCIES_VERSION 1.1.0)
set(DEPENDENCIES_NAME_1800_27 libraries_v120_x64_py27_$&#123;DEPENDENCIES_VERSION&#125;)
set(DEPENDENCIES_NAME_1900_27 libraries_v140_x64_py27_$&#123;DEPENDENCIES_VERSION&#125;)
set(DEPENDENCIES_NAME_1900_35 libraries_v140_x64_py35_$&#123;DEPENDENCIES_VERSION&#125;)

set(DEPENDENCIES_URL_BASE https:&#x2F;&#x2F;github.com&#x2F;willyd&#x2F;caffe-builder&#x2F;releases&#x2F;download)
set(DEPENDENCIES_FILE_EXT .tar.bz2)
set(DEPENDENCIES_URL_1800_27 &quot;$&#123;DEPENDENCIES_URL_BASE&#125;&#x2F;v$&#123;DEPENDENCIES_VERSION&#125;&#x2F;$&#123;DEPENDENCIES_NAME_1800_27&#125;$&#123;DEPENDENCIES_FILE_EXT&#125;&quot;)
set(DEPENDENCIES_SHA_1800_27 &quot;ba833d86d19b162a04d68b09b06df5e0dad947d4&quot;)
set(DEPENDENCIES_URL_1900_27 &quot;$&#123;DEPENDENCIES_URL_BASE&#125;&#x2F;v$&#123;DEPENDENCIES_VERSION&#125;&#x2F;$&#123;DEPENDENCIES_NAME_1900_27&#125;$&#123;DEPENDENCIES_FILE_EXT&#125;&quot;)
set(DEPENDENCIES_SHA_1900_27 &quot;17eecb095bd3b0774a87a38624a77ce35e497cd2&quot;)
set(DEPENDENCIES_URL_1900_35 &quot;$&#123;DEPENDENCIES_URL_BASE&#125;&#x2F;v$&#123;DEPENDENCIES_VERSION&#125;&#x2F;$&#123;DEPENDENCIES_NAME_1900_35&#125;$&#123;DEPENDENCIES_FILE_EXT&#125;&quot;)
set(DEPENDENCIES_SHA_1900_35 &quot;f060403fd1a7448d866d27c0e5b7dced39c0a607&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li class="lvl-3">
<p>.\caffe/export.hpp(7): fatal error C1083: 无法打开包括文件: “caffe/include_symbols.hpp”: No such file or directory</p>
</li>
</ol>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">此文件在caffe/build 目录，自己拷贝到caffe/include/caffe/下，就好了。
这个bug主要是由于没有把build目录传递给cl.exe,导致找不到文件。
（参考此问题https://github.com/BVLC/caffe/issues/5840，我也提交了可能的解决方法，希望帮助你们）
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li class="lvl-3">
<p>caffe mnist数据集的train 和test</p>
</li>
</ol>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">首先请下载mnist数据集，这里我打包上传了四个文件，下载地址。http://download.csdn.net/download/u011728480/10163922（下载地址参考caffe/data/mnist/get_mnist.sh文件，在原生的win下，wget是找不到的，所以，自己去下载吧）<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如图</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_048/dataset.png" alt="rep_img"/></center>
    </div>
</div>   
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 做以下操作时，保证caffe已经正常编译通过。</span>
<span class="token comment"># 首先把数据集转为lmdb格式存放，这是caffe支持的存储格式。</span>
<span class="token comment"># 转换：</span>
./convert_mnist_data.exe <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/data/mnist/train-images-idx3-ubyte <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/data/mnist/train-labels-idx1-ubyte ./mnist_train_lmdb <span class="token parameter variable">--backend</span><span class="token operator">=</span>lmdb

./convert_mnist_data.exe <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/data/mnist/t10k-images-idx3-ubyte <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/data/mnist/t10k-labels-idx1-ubyte ./mnist_test_lmdb <span class="token parameter variable">--backend</span><span class="token operator">=</span>lmdb
<span class="token comment"># 生成如图A两个文件夹</span>

<span class="token comment"># train:</span>
./build/tools/caffe.exe train <span class="token parameter variable">--solver</span><span class="token operator">=</span>examples/mnist/lenet_solver.prototxt
<span class="token comment"># 生成如图B四个文件</span>
<span class="token comment"># 结果如图C，迭代10000,准确率99.03%.</span>
<span class="token comment"># test:</span>
./build/tools/caffe.exe <span class="token builtin class-name">test</span> <span class="token parameter variable">-model</span><span class="token operator">=</span>examples/mnist/lenet_train_test.prototxt <span class="token parameter variable">-weights</span><span class="token operator">=</span>examples/mnist/lenet_iter_10000.caffemodel <span class="token parameter variable">-gpu</span><span class="token operator">=</span><span class="token number">0</span>

<span class="token comment"># 测试结果如图D,测试集,准确率98.56%</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>图A</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_048/lmdb.png" alt="rep_img"/></center>
    </div>
</div>   
<p>图B</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_048/model.png" alt="rep_img"/></center>
    </div>
</div> 
<p>图C</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_048/train.png" alt="rep_img"/></center>
    </div>
</div> 
<p>图D</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_048/test.png" alt="rep_img"/></center>
    </div>
</div> 
<ol start="5">
<li class="lvl-3">
<p>Caffe Python 接口测试</p>
</li>
</ol>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">(我用的anaconda环境,开vpn执行，
conda config --add channels conda-forge
conda config --add channels willyd
conda install --yes cmake ninja numpy scipy protobuf==3.1.0 six scikit-image pyyaml pydotplus graphviz)
把caffe/python/caffe目录放到python的site-packages目录。
把caffe/python目录添加到PYTHONPATH环境变量<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  准备一个py文件吧，迭代10000次。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> caffe
caffe<span class="token punctuation">.</span>set_device<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
caffe<span class="token punctuation">.</span>set_mode_gpu<span class="token punctuation">(</span><span class="token punctuation">)</span>
solver <span class="token operator">=</span> caffe<span class="token punctuation">.</span>SGDSolver<span class="token punctuation">(</span><span class="token string">'examples/mnist/lenet_solver.prototxt'</span><span class="token punctuation">)</span>

<span class="token builtin">iter</span> <span class="token operator">=</span> solver<span class="token punctuation">.</span><span class="token builtin">iter</span>
<span class="token keyword">while</span> <span class="token builtin">iter</span><span class="token operator">&lt;</span><span class="token number">10000</span><span class="token punctuation">:</span>
    solver<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token builtin">iter</span> <span class="token operator">=</span> solver<span class="token punctuation">.</span><span class="token builtin">iter</span>
    input_data <span class="token operator">=</span> solver<span class="token punctuation">.</span>net<span class="token punctuation">.</span>blobs<span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data  
    loss <span class="token operator">=</span> solver<span class="token punctuation">.</span>net<span class="token punctuation">.</span>blobs<span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data
    accuracy <span class="token operator">=</span> solver<span class="token punctuation">.</span>test_nets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>blobs<span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'iter:'</span><span class="token punctuation">,</span> <span class="token builtin">iter</span><span class="token punctuation">,</span> <span class="token string">'loss:'</span><span class="token punctuation">,</span> loss<span class="token punctuation">,</span><span class="token string">'accuracy:'</span><span class="token punctuation">,</span>accuracy<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_048/iter.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  注意：这里很有可能要报一个错误，PIL模块中的Image模块加载失败，提示核心提示：from PIL import Image ， DLL 加载失败。我把PIL模块降级到4.2左右就可以了，具体看你python版本，不要用最新的，不知道降到哪个版本就自己一个一个的降级。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  说真的，没有特别需求，别在windows下用源码折腾caffe，太坑。不喜欢折腾的人可以去下载已经编译好的二进制文件。最后说一句，在Linux下用caffe真的很简单的，点F*ck。</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/12/15/blog_idx_047/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/12/15/blog_idx_047/" class="post-title-link" itemprop="url">LeNet-5 论文及原理分析(笨鸟角度)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-12-15 11:32:12" itemprop="dateCreated datePublished" datetime="2017-12-15T11:32:12+08:00">2017-12-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DL/" itemprop="url" rel="index"><span itemprop="name">DL</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DL/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">数据结构与算法</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 18:35:40
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=047） 
&emsp;&emsp;本文发布于 2017-12-15 11:32:12，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=047） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  Notes:本人此前只对opencv处理图像有一定的了解。</p>
<p>  从毕业后开始，自己工作的周围就出现了无数次计算机视觉相关的内容。而我的工作也和这些有一定的交叉。虽然在学校对并行计算以及AI有一定所闻，但是都只是听说而已，以为离我们还很远，出来才知道，它们已经来了。此文由网上众多Lenet-5相关的文章和论文原文经过我的组合和理解后写出，只作为我的一个学习笔记。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="LeNet-5-分析">LeNet-5 分析</h3>
<hr>
<p>  LeNet-5简介：</p>
<p>    CNN里面的一篇代表性文章，主要是涵盖了现在CNN的卷积、池化、全连接等概念，同时其层数很浅，方便我学习。（这里主要基于LeNet5论文讲解，现在的caffe和tf上带的LeNet-5工程是和原文不同的，具体在后序两篇文章分析。）</p>
<br/>
<br/>
<h5 id="LeNet-5网络简介">LeNet-5网络简介</h5>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_047/network.png" alt="rep_img"/></center>
    </div>
</div>    
&emsp;&emsp;此截图来至于，LeNet-5论文原文。
<p>  主要由以下构成：</p>
<p>    INPUT输入、C1卷积层、S2池化层（(求和取平均)*w+b）、C3卷积层（此层是按照一定的规则卷积，所以不易理解，和C1,C5基本卷积操作不同）、S4池化层（S2类似）、C5卷积层、F6全连接映射的是一个字符表、OUTPUT打分输出（RBF）</p>
<p>  结构分析：</p>
<p><em><strong>Input层</strong></em></p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">size:32 * 32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><em><strong>C1层</strong></em></p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">卷积核(CC):5 * 5 
stride：1
pad：0
featuremapcount：6
featuremapsize：28 * 28
（计算方法：32-5+1= 28）
(计算公式：O=（I+2 * pad-CC）/ stride+1)
参数个数：6  * （5 * 5+1）=156
连接个数：（5 * 5+1） * 28 * 28 * 6
（featuremap每个像素和5*5个w和一个b有一个连接。w是权重，b是偏置）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em><strong>S2层</strong></em></p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">核:2*2
stride：2
featuremapcount：6
featuremapsize：14 * 14
（计算方法：28/2,对核进行求和，然后乘以w，加上一个偏置）
参数个数：(1+1) * 6=12
连接数：(4 * 1+1) * 14 * 14 * 6=5880
(不同的人有不同的理解，反正就是featuremap每个像素和上层的连线，这里是:4个像素求和平均乘以w加上一个b)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em><strong>C3层</strong></em></p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">卷积核(CC):5 * 5 
stride：1
pad：0
featuremapcount：16
（计算方法：下图每列对应一个featuremap，分为四组，0-5（分别和上层3个featuremap计算），6-11（同理），12-14（同理），15（同理）。）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_047/c3.png" alt="rep_img"/></center>
    </div>
</div>  
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">featuremapsize：10 * 10
(14-5+1=10)
参数个数：6*（3 * 5 * 5+1）+6* （4* 5* 5+1）+3*（4 *5* 5+1）+1* (6* 5* 5+1)=1516(分组计算)
连接个数：1516* 10* 10=151600(同上)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><em><strong>S4层</strong></em></p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">核:2*2
stride：2
featuremapcount：16
featuremapsize：5 * 5
参数个数：(1+1) * 16=12（2018/9/28,感谢网友指正此处参数个数）
连接数：(4* 1+1)* 5* 5* 16=2000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em><strong>C5层</strong></em></p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">卷积核(CC):5* 5 
stride：1
pad：0
featuremapcount：120
featuremapsize：1* 1
参数个数：(5* 5* 16+1)* 120=48120
(此处由于每个像素都和前一层16个featuremap相连)
连接数：48120* 1* 1=48120<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em><strong>F6层</strong></em></p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">featuremapcount：84
(为了输出选的特定的数)
featuremapsize：1* 1
参数个数：84* （120* 1+1）=10164
（上层为1* 1，全连接，输出为84* 1* 1）
连接数：84*（120 * 1+1）* 1 * 1=10164<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em><strong>Output层</strong></em></p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">参数个数：84* 10=840
连接数：84* 10=840=840
说明：我只知道这个打分函数叫做RBF，具体就是计算输入和参数的向量距离，距离越近，就越有可能是当前数字。对于此函数的更深原理，我看了个大概，有兴趣的可以去研究。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  只要具备CNN基本理论知识（卷积核、步长、pad、池化、卷积、全连接）都可以慢慢的理解这个东西。由于我是新手，我知道新手对哪些很疑惑，所以对每一个值的计算我都有详细的写出，包括原理和出处。</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/11/21/blog_idx_046/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/11/21/blog_idx_046/" class="post-title-link" itemprop="url">移远EC20 4G模块Linux驱动移植和测试</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-11-21 10:28:14" itemprop="dateCreated datePublished" datetime="2017-11-21T10:28:14+08:00">2017-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 18:30:41
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=046） 
&emsp;&emsp;本文发布于 2017-11-21 10:28:14，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=046） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="EC20-驱动移植与测试">EC20 驱动移植与测试</h3>
<hr>
<br/>
<br/>
<h5 id="EC20简介">EC20简介</h5>
<p>  EC20是一个全网通的4G模块，并提供了详细的驱动移植资料（源码+文档），我也仅仅是照着文档，一点点的改，并建立起来一个可用的环境。</p>
<br/>
<br/>
<h5 id="EC20驱动移植准备">EC20驱动移植准备</h5>
<ol>
<li class="lvl-3">
<p>首先你会从厂家拿到一个资料文件，并解压（类似Quectel_GobiNetSR01A02V16.zip）</p>
</li>
<li class="lvl-3">
<p>你会找到一个用户手册的PDF打开（类似Quectel_WCDMA&amp;LTE_Linux_USB_Driver_User_Guide_V1.6.pdf）</p>
</li>
<li class="lvl-3">
<p>这里还有一个Readme.txt告诉你需要阅读上文pdf的哪些内容。可能如下：</p>
</li>
</ol>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">About GobiNet driver, please refer to the chapter 3.2、3.4、5.4、6
About ConnectManager，please refer to the chapter 5.4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol start="4">
<li class="lvl-3">
<p>按照pdf指示如下。</p>
</li>
</ol>
<br/>
<br/>
<h5 id="EC20-Linux驱动移植">EC20 Linux驱动移植</h5>
<ol>
<li class="lvl-3">
<p>增加PID&amp;VID（对着两个不了解的，建议去找找资料来看看，这个的意思可以简单理解为这个设备的唯一标识）<br>
[KERNEL]/drivers/usb/serial/option.c</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">usb_device_id</span> option_ids<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">//Added by Sky  </span></span>
	<span class="token punctuation">&#123;</span> <span class="token function">USB_DEVICE</span><span class="token punctuation">(</span><span class="token number">0x05C6</span><span class="token punctuation">,</span> <span class="token number">0x9090</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">/* Quectel UC15 */</span>  
	<span class="token punctuation">&#123;</span> <span class="token function">USB_DEVICE</span><span class="token punctuation">(</span><span class="token number">0x05C6</span><span class="token punctuation">,</span> <span class="token number">0x9003</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">/* Quectel UC20 */</span>  
	<span class="token punctuation">&#123;</span> <span class="token function">USB_DEVICE</span><span class="token punctuation">(</span><span class="token number">0x05C6</span><span class="token punctuation">,</span> <span class="token number">0x9215</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">/* Quectel EC20 */</span>  
	<span class="token punctuation">&#123;</span> <span class="token function">USB_DEVICE</span><span class="token punctuation">(</span><span class="token number">0x2C7C</span><span class="token punctuation">,</span> <span class="token number">0x0125</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">/* Quectel EC25/EC20 R2.0 */</span>  
	<span class="token punctuation">&#123;</span> <span class="token function">USB_DEVICE</span><span class="token punctuation">(</span><span class="token number">0x2C7C</span><span class="token punctuation">,</span> <span class="token number">0x0121</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">/* Quectel EC21 */</span> 
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  这里其实只需要{ USB_DEVICE(0x05C6, 0x9215) }, /* Quectel EC20 */  这一项，其他是无关紧要的，可以不放进去。option_ids[]就是一usb serial的设备pid，vid表。</p>
<ol start="2">
<li class="lvl-3">
<p>注释掉冲突的vid以及pid设备（我猜存在相同的vid和pid是历史的原因）<br>
[KERNEL]/drivers/usb/serial/qcserial.c</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//Comment by Sky,</span>
<span class="token comment">//&#123;USB_DEVICE(0x05c6, 0x9215)&#125;,	/* Acer Gobi 2000 Modem device (VP413) */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>[KERNEL]/drivers/net/usb/qmi_wwan.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//comment by Sky</span>
<span class="token comment">//&#123;QMI_GOBI_DEVICE(0x05c6, 0x9215)&#125;,	/* Acer Gobi 2000 Modem device (VP413) */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>  注意这里貌似只有EC20的冲突了。</p>
<ol start="3">
<li class="lvl-3">
<p>添加零包处理（这个和usb 协议中的批量传输有关）<br>
For Linux Kernel Version newer than 2.6.34:</p>
</li>
</ol>
<p>File: [KERNEL]/drivers/usb/serial/usb_wwan.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">usb_fill_bulk_urb</span><span class="token punctuation">(</span>urb<span class="token punctuation">,</span> serial<span class="token operator">-></span>dev<span class="token punctuation">,</span>      <span class="token function">usb_sndbulkpipe</span><span class="token punctuation">(</span>serial<span class="token operator">-></span>dev<span class="token punctuation">,</span> endpoint<span class="token punctuation">)</span> <span class="token operator">|</span> dir<span class="token punctuation">,</span>      buf<span class="token punctuation">,</span> len<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">1</span> </span><span class="token comment">//Added by Sky for Zero Packet</span></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>dir <span class="token operator">==</span> USB_DIR_OUT<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">usb_device_descriptor</span> <span class="token operator">*</span>desc <span class="token operator">=</span> <span class="token operator">&amp;</span>serial<span class="token operator">-></span>dev<span class="token operator">-></span>descriptor<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token operator">-></span>idVendor <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span><span class="token number">0x05C6</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> desc<span class="token operator">-></span>idProduct <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span><span class="token number">0x9090</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		urb<span class="token operator">-></span>transfer_flags <span class="token operator">|=</span> URB_ZERO_PACKET<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token operator">-></span>idVendor <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span><span class="token number">0x05C6</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> desc<span class="token operator">-></span>idProduct <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span><span class="token number">0x9003</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		urb<span class="token operator">-></span>transfer_flags <span class="token operator">|=</span> URB_ZERO_PACKET<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token operator">-></span>idVendor <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span><span class="token number">0x05C6</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> desc<span class="token operator">-></span>idProduct <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span><span class="token number">0x9215</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		urb<span class="token operator">-></span>transfer_flags <span class="token operator">|=</span> URB_ZERO_PACKET<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token operator">-></span>idVendor <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span><span class="token number">0x2C7C</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		urb<span class="token operator">-></span>transfer_flags <span class="token operator">|=</span> URB_ZERO_PACKET<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  注意，pdf上还有For Linux Kernel Version older than 2.6.35的内容，请自行根据内核版本查看。</p>
<ol start="4">
<li class="lvl-3">
<p>增加休眠后唤醒接口</p>
</li>
</ol>
<p>For Linux Kernel Version newer than 3.4:</p>
<p>File: [KERNEL]/drivers/usb/serial/option.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">usb_serial_driver</span> option_1port_device <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
		<span class="token punctuation">.</span>owner <span class="token operator">=</span>	THIS_MODULE<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>name <span class="token operator">=</span>		<span class="token string">"option1"</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>description       <span class="token operator">=</span> <span class="token string">"GSM modem (1-port)"</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>id_table          <span class="token operator">=</span> option_ids<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>num_ports         <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>probe             <span class="token operator">=</span> option_probe<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open              <span class="token operator">=</span> usb_wwan_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>close             <span class="token operator">=</span> usb_wwan_close<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>dtr_rts	   <span class="token operator">=</span> usb_wwan_dtr_rts<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write             <span class="token operator">=</span> usb_wwan_write<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write_room        <span class="token operator">=</span> usb_wwan_write_room<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>chars_in_buffer   <span class="token operator">=</span> usb_wwan_chars_in_buffer<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>set_termios       <span class="token operator">=</span> usb_wwan_set_termios<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>tiocmget          <span class="token operator">=</span> usb_wwan_tiocmget<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>tiocmset          <span class="token operator">=</span> usb_wwan_tiocmset<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ioctl             <span class="token operator">=</span> usb_wwan_ioctl<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>attach            <span class="token operator">=</span> option_attach<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release           <span class="token operator">=</span> option_release<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>port_probe        <span class="token operator">=</span> usb_wwan_port_probe<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>port_remove	   <span class="token operator">=</span> usb_wwan_port_remove<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read_int_callback <span class="token operator">=</span> option_instat_callback<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PM</span></span>
	<span class="token punctuation">.</span>suspend           <span class="token operator">=</span> usb_wwan_suspend<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>resume            <span class="token operator">=</span> usb_wwan_resume<span class="token punctuation">,</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">1</span>  </span><span class="token comment">//Added by Sky  </span></span>
	<span class="token punctuation">.</span>reset_resume   <span class="token operator">=</span> usb_wwan_resume<span class="token punctuation">,</span> 
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="5">
<li class="lvl-3">
<p>如果要使用 GobiNet or QMI WWAN，需要阻止第四个接口注册为串口。<br>
For Linux Kernel Version newer than 2.6.30:</p>
</li>
</ol>
<p>File: [KERNEL]/drivers/usb/serial/option.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">option_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usb_serial</span> <span class="token operator">*</span>serial<span class="token punctuation">,</span>
			<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">usb_device_id</span> <span class="token operator">*</span>id<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">usb_interface_descriptor</span> <span class="token operator">*</span>iface_desc <span class="token operator">=</span>
				<span class="token operator">&amp;</span>serial<span class="token operator">-></span>interface<span class="token operator">-></span>cur_altsetting<span class="token operator">-></span>desc<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">usb_device_descriptor</span> <span class="token operator">*</span>dev_desc <span class="token operator">=</span> <span class="token operator">&amp;</span>serial<span class="token operator">-></span>dev<span class="token operator">-></span>descriptor<span class="token punctuation">;</span>

	<span class="token comment">/* Never bind to the CD-Rom emulation interface	*/</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>iface_desc<span class="token operator">-></span>bInterfaceClass <span class="token operator">==</span> <span class="token number">0x08</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * Don't bind reserved interfaces (like network ones) which often have
	 * the same class/subclass/protocol as the serial interfaces.  Look at
	 * the Windows driver .INF files for reserved interface numbers.
	 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_blacklisted</span><span class="token punctuation">(</span>
		iface_desc<span class="token operator">-></span>bInterfaceNumber<span class="token punctuation">,</span>
		OPTION_BLACKLIST_RESERVED_IF<span class="token punctuation">,</span>
		<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">option_blacklist_info</span> <span class="token operator">*</span><span class="token punctuation">)</span> id<span class="token operator">-></span>driver_info<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
	<span class="token comment">/*
	 * Don't bind network interface on Samsung GT-B3730, it is handled by
	 * a separate module.
	 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>dev_desc<span class="token operator">-></span>idVendor <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span>SAMSUNG_VENDOR_ID<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
	    dev_desc<span class="token operator">-></span>idProduct <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span>SAMSUNG_PRODUCT_GT_B3730<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
	    iface_desc<span class="token operator">-></span>bInterfaceClass <span class="token operator">!=</span> USB_CLASS_CDC_DATA<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>


		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">1</span>  </span><span class="token comment">//Added by Sky </span></span>
		<span class="token comment">//Quectel UC20's interface 4 can be used as USB Network device  </span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>serial<span class="token operator">-></span>dev<span class="token operator">-></span>descriptor<span class="token punctuation">.</span>idVendor <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span><span class="token number">0x05C6</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> serial<span class="token operator">-></span>dev<span class="token operator">-></span>descriptor<span class="token punctuation">.</span>idProduct <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span><span class="token number">0x9003</span><span class="token punctuation">)</span>  \
			 <span class="token operator">&amp;&amp;</span> serial<span class="token operator">-></span>interface<span class="token operator">-></span>cur_altsetting<span class="token operator">-></span>desc<span class="token punctuation">.</span>bInterfaceNumber <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">)</span>   
		<span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span> 
		<span class="token comment">//Quectel EC20's interface 4 can be used as USB Network device  </span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>serial<span class="token operator">-></span>dev<span class="token operator">-></span>descriptor<span class="token punctuation">.</span>idVendor <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span><span class="token number">0x05C6</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> serial<span class="token operator">-></span>dev<span class="token operator">-></span>descriptor<span class="token punctuation">.</span>idProduct <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span><span class="token number">0x9215</span><span class="token punctuation">)</span>  \
			<span class="token operator">&amp;&amp;</span> serial<span class="token operator">-></span>interface<span class="token operator">-></span>cur_altsetting<span class="token operator">-></span>desc<span class="token punctuation">.</span>bInterfaceNumber <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">)</span>   
			<span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span> 
			<span class="token comment">//Quectel EC21&amp;EC25&amp;EC20 R2.0's interface 4 can be used as USB Network device  </span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>serial<span class="token operator">-></span>dev<span class="token operator">-></span>descriptor<span class="token punctuation">.</span>idVendor <span class="token operator">==</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span><span class="token number">0x2C7C</span><span class="token punctuation">)</span>   \
			<span class="token operator">&amp;&amp;</span> serial<span class="token operator">-></span>interface<span class="token operator">-></span>cur_altsetting<span class="token operator">-></span>desc<span class="token punctuation">.</span>bInterfaceNumber <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">)</span>   
			<span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span> 
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>


	<span class="token comment">/* Store device id so we can use it during attach. */</span>
	<span class="token function">usb_set_serial_data</span><span class="token punctuation">(</span>serial<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="6">
<li class="lvl-3">
<p>修改内核配置，并编译内核，刷入新内核<br>
  添加USB 串口 GSM 和 CDMA 驱动选项</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_046/kernel0.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  启用USB网络支持</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_046/kernel1.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  添加驱动代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//Step 5: Please add the following statements to file "[KERNEL]/drivers/net/usb/Makefile" ([KERNEL]/drivers/usb/net/Makefile if the kernel version is older than 2.6.22). </span>
obj<span class="token operator">-</span>y <span class="token operator">+=</span> GobiNet<span class="token punctuation">.</span>o 
GobiNet<span class="token operator">-</span>objs <span class="token operator">:</span><span class="token operator">=</span> GobiUSBNet<span class="token punctuation">.</span>o QMIDevice<span class="token punctuation">.</span>o QMI<span class="token punctuation">.</span>o <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ol start="7">
<li class="lvl-3">
<p>quectel-CM 测试</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//交叉编译quectel-CM </span>
<span class="token comment">/*quectel-CM will  call busybox udhpc to obtain IP and NDS, and busybox udhpc will call script file /usr/share/udhcpc/default.script to set IP/DNS/Routing table for Linux board. You can download this tool’s source code from https://busybox.net/. You should enable CONFIG_UDHCPC in busybox menuconfig，and copy the script file [BUSYBOX]/examples/udhcp/simple.script to your Linux board (renamed as /usr/share/udhcpc/default.script). */</span>
quectel<span class="token operator">-</span>CM –s ctnet <span class="token operator">&amp;</span> 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">355</span><span class="token punctuation">]</span> Quectel_ConnectManager_SR01A01V10 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">356</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>quectel<span class="token operator">-</span>CM profile <span class="token operator">=</span> ctnet<span class="token comment">///, pincode =  </span>
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">357</span><span class="token punctuation">]</span> Find qmichannel <span class="token operator">=</span> <span class="token operator">/</span>dev<span class="token operator">/</span>qcqmi2 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">358</span><span class="token punctuation">]</span> Find usbnet_adapter <span class="token operator">=</span> eth2 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">368</span><span class="token punctuation">]</span> Get clientWDS <span class="token operator">=</span> <span class="token number">7</span> 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">400</span><span class="token punctuation">]</span> Get clientDMS <span class="token operator">=</span> <span class="token number">8</span> 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">432</span><span class="token punctuation">]</span> Get clientNAS <span class="token operator">=</span> <span class="token number">9</span> 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">464</span><span class="token punctuation">]</span> Get clientWDA <span class="token operator">=</span> <span class="token number">10</span> 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">496</span><span class="token punctuation">]</span> requestBaseBandVersion EC20CQAR02A03E2G_BETA0914  <span class="token number">1</span>  <span class="token punctuation">[</span>Sep <span class="token number">14</span> <span class="token number">2015</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">27</span><span class="token punctuation">]</span> 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">560</span><span class="token punctuation">]</span> requestGetSIMStatus SIMStatus<span class="token operator">:</span> SIM_READY 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">624</span><span class="token punctuation">]</span> requestGetProfile ctnet<span class="token comment">///0 </span>
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">656</span><span class="token punctuation">]</span> requestRegistrationState MCC<span class="token operator">:</span> <span class="token number">460</span><span class="token punctuation">,</span> MNC<span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span> PS<span class="token operator">:</span> Attached<span class="token punctuation">,</span> DataCap<span class="token operator">:</span> LTE 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">688</span><span class="token punctuation">]</span> requestQueryDataCall ConnectionStatus<span class="token operator">:</span> DISCONNECTED 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">720</span><span class="token punctuation">]</span> requestRegistrationState MCC<span class="token operator">:</span> <span class="token number">460</span><span class="token punctuation">,</span> MNC<span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span> PS<span class="token operator">:</span> Attached<span class="token punctuation">,</span> DataCap<span class="token operator">:</span> LTE 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">752</span><span class="token punctuation">]</span> requestQueryDataCall ConnectionStatus<span class="token operator">:</span> DISCONNECTED 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">816</span><span class="token punctuation">]</span> requestSetupDataCall WdsConnectionIPv4Handle<span class="token operator">:</span> <span class="token number">0x43cc4478</span> 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">912</span><span class="token punctuation">]</span> requestQueryDataCall ConnectionStatus<span class="token operator">:</span> CONNECTED 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">937</span><span class="token punctuation">]</span> <span class="token function">udhcpc</span> <span class="token punctuation">(</span>v1<span class="token punctuation">.</span><span class="token number">20.2</span><span class="token punctuation">)</span> started 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">956</span><span class="token punctuation">]</span> Sending discover<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">960</span><span class="token punctuation">]</span> Sending select <span class="token keyword">for</span> <span class="token number">10.172</span><span class="token number">.27</span><span class="token number">.151</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">964</span><span class="token punctuation">]</span> Lease of <span class="token number">10.172</span><span class="token number">.27</span><span class="token number">.151</span> obtained<span class="token punctuation">,</span> lease time <span class="token number">7200</span> 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">984</span><span class="token punctuation">]</span> deleting routers 
route<span class="token operator">:</span> SIOCDELRT<span class="token operator">:</span> No such process 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">46</span><span class="token operator">:</span><span class="token number">003</span><span class="token punctuation">]</span> adding dns <span class="token number">61.132</span><span class="token number">.163</span><span class="token number">.68</span> 
<span class="token punctuation">[</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>_00<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">46</span><span class="token operator">:</span><span class="token number">003</span><span class="token punctuation">]</span> adding dns <span class="token number">202.102</span><span class="token number">.213</span><span class="token number">.68</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  注意，这里需要UDHCPC ，检测你的busybox是否有这个东西，如果不存在，你需要重新移植busybox，启用CONFIG_UDHCPC选项。还需要配置一个配置文件，注意检查。</p>
<p>  特别提示，其中很多关于内核源码修改，以及内核配置修改，不同的版本有不同的写法，文档里面都有详细说明，请使用时，特别注意。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/11/20/blog_idx_045/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/11/20/blog_idx_045/" class="post-title-link" itemprop="url">Libcurl & Log4cplus 移植和使用 以及 Jsoncpp 简单使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-11-20 16:55:24" itemprop="dateCreated datePublished" datetime="2017-11-20T16:55:24+08:00">2017-11-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>974</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 18:27:52
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=045） 
&emsp;&emsp;本文发布于 2017-11-20 16:55:24，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=045） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Libcurl篇（curl-7-55-1-tar-gz）">Libcurl篇（curl-7.55.1.tar.gz）</h3>
<hr>
<br/>
<br/>
<h5 id="移植Libcurl">移植Libcurl</h5>
<p>  我首先看了一下其目录结构，里面存在两套编译结构，一个是依赖于CMake，一个是依赖于Autoconf。</p>
<p>  这里使用的是Autoconf。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>你的安装绝对路径 <span class="token parameter variable">--host</span><span class="token operator">=</span>arm-linux-gnueabi <span class="token parameter variable">--target</span><span class="token operator">=</span>arm-linux-gnueabi <span class="token assign-left variable">CXX</span><span class="token operator">=</span>arm-linux-gnueabi-g++ <span class="token assign-left variable">CC</span><span class="token operator">=</span>arm-linux-gnueabi-gcc
<span class="token function">make</span> <span class="token parameter variable">-j16</span>
<span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>  说明：–prefix 指定安装路径， --host以及–target指定目标架构， CC和CXX变量指定了工具链</p>
<br/>
<br/>
<h5 id="使用Libcurl">使用Libcurl</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">curl_global_init
curl_easy_init
curl_easy_setopt
<span class="token comment">//CURLOPT_HTTPHEADER 设置头信息</span>
<span class="token comment">//CURLOPT_URL 设置url信息</span>
<span class="token comment">//CURLOPT_POST 设置本次http请求方式是否为post</span>
<span class="token comment">//CURLOPT_POSTFIELDS 设置post 数据域</span>
<span class="token comment">//CURLOPT_WRITEFUNCTION 设置http返回信息的回调函数</span>
<span class="token comment">//CURLOPT_WRITEDATA 设置回调函数中，userdata的数据内存</span>
curl_easy_perform
curl_easy_cleanup
curl_global_cleanup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int yUpgrade::ReportUpgradeStatus(const std::string &amp; str)&#123;
    
   &#x2F;&#x2F; InitLibCurl(ycurl);

    if ( CURLE_OK !&#x3D; (res &#x3D; curl_global_init(CURL_GLOBAL_ALL)) )&#123;
    std::cout&lt;&lt;&quot;curl_global_init call  failed &quot;&lt;&lt;std::endl;
    return -1;
    &#125; 
    if ( !( ycurl &#x3D; curl_easy_init() ) )&#123;
    std::cout&lt;&lt;&quot;curl_easy_init call  failed &quot;&lt;&lt;std::endl;
    return -1;
    &#125;

    struct curl_slist *headers &#x3D; NULL;
    headers&#x3D;curl_slist_append(headers, &quot;Content-Type:application&#x2F;json&quot;);
    headers&#x3D;curl_slist_append(headers, &quot;Accept:application&#x2F;json&quot;);
    headers &#x3D; curl_slist_append(headers, &quot;charset:utf-8&quot;);
    
    curl_easy_setopt(ycurl, CURLOPT_HTTPHEADER, headers);
    &#x2F;&#x2F;headers &#x3D; curl_slist_append(headers, &quot;Accept: Agent-007&quot;);
    &#x2F;&#x2F;curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headers);

    curl_easy_setopt(ycurl, CURLOPT_URL, REPORTUPGRADESTATUS_URL);
     &#x2F;&#x2F;curl_easy_setopt(curl,  CURLOPT_CUSTOMREQUEST, &quot;POST&quot;);&#x2F;&#x2F;自定义请求方式
    curl_easy_setopt(ycurl, CURLOPT_POST, 1);&#x2F;&#x2F;设置为非0表示本次操作为POS

    &#x2F;&#x2F;curl_easy_setopt(ycurl, CURLOPT_POSTFIELDSIZE, str.size());&#x2F;&#x2F;设置上传json串长度,这个设置可以忽略
    curl_easy_setopt(ycurl, CURLOPT_POSTFIELDS, str.c_str()); 

    curl_easy_setopt(ycurl, CURLOPT_WRITEFUNCTION, write_callback);&#x2F;&#x2F;设置回调函数
    curl_easy_setopt(ycurl, CURLOPT_WRITEDATA, RecCharBuf);&#x2F;&#x2F;设置写数据

    if ( CURLE_OK !&#x3D;  (res &#x3D; curl_easy_perform(ycurl)) )&#123;

        CleanUpLibCurl(ycurl);
        curl_slist_free_all(headers);
        std::cout&lt;&lt;&quot;curl_easy_perform call  failed,Res&#x3D; &quot;&lt;&lt;res&lt;&lt;std::endl;
        return -1;
    &#125;


    CleanUpLibCurl(ycurl);
    curl_slist_free_all(headers);
    return 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="Log4cplus篇（log4cplus-1-2-1-rc2-7z）">Log4cplus篇（log4cplus-1.2.1-rc2.7z）</h3>
<hr>
<br/>
<br/>
<h5 id="移植Log4cplus">移植Log4cplus</h5>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure <span class="token parameter variable">--host</span><span class="token operator">=</span>arm-linux-gnueabi <span class="token parameter variable">--target</span><span class="token operator">=</span>arm-linux-gnueabi <span class="token assign-left variable">CC</span><span class="token operator">=</span>arm-hisiv400-linux-gcc <span class="token assign-left variable">CXX</span><span class="token operator">=</span>arm-hisiv400-linux-g++
<span class="token function">make</span> <span class="token parameter variable">-j8</span>
<span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="Log4cplus的使用（网上去找教程就可以了，一大堆，推荐使用加载配置文件的方式，不要在程序中配置）">Log4cplus的使用（网上去找教程就可以了，一大堆，推荐使用加载配置文件的方式，不要在程序中配置）</h5>
<ol>
<li class="lvl-3">
<p>PropertyConfigurator 类来加载配置文件</p>
</li>
<li class="lvl-3">
<p>然后正常使用就可以了</p>
</li>
</ol>
<br/>
<br/>
<br/>
<br/>
<h3 id="Jsoncpp篇（1-8-3）">Jsoncpp篇（1.8.3）</h3>
<hr>
<br/>
<br/>
<h5 id="Jsoncpp的简单使用（注意，Jsoncpp更新了，有些接口不推荐了，但是可以用，网上大部分的教程都是旧版的，这里我会给出新的和旧的的使用）-这里只有读的。写的类似。">Jsoncpp的简单使用（注意，Jsoncpp更新了，有些接口不推荐了，但是可以用，网上大部分的教程都是旧版的，这里我会给出新的和旧的的使用）.这里只有读的。写的类似。</h5>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">	std::string G4FileUrl;
	&#x2F;&#x2F; Json::CharReader *tmp ;
    &#x2F;&#x2F; Json::CharReaderBuilder * ptmp &#x3D;  new Json::CharReaderBuilder();
    &#x2F;&#x2F; tmp &#x3D; ptmp-&gt;newCharReader();
    &#x2F;&#x2F;tmp-&gt;parse(upgrade.RecStr,root1)
    Json::Reader UpGradeInfo;
    Json::Value root1;
    UpGradeInfo.parse(upgrade.RecStr,root1)
    G4FileUrl &#x3D; root1[&quot;fileInfo&quot;][&quot;fileUrl&quot;].asString();
    &#x2F;*例子json结构
&#123;
&quot;fileInfo&quot;:&#123;
&quot;id&quot;:&#123;&quot;timestamp&quot;:1508143624,&quot;machineIdentifier&quot;:439847,&quot;processIdentifier&quot;:524,
&quot;counter&quot;:15004360&#125;,
&quot;fileUrl&quot;:&quot;http:&#x2F;&#x2F;xxxxxxxxx&#x2F;group1&#x2F;M00&#x2F;00&#x2F;35&#x2F;wKgfdVnkcgiAVnsqAAHEhu0PItU720.jpg&quot;,
&quot;fileName&quot;:&quot;TX.jpg&quot;,
&quot;fileType&quot;:4,
&quot;cameraId&quot;:0,
&quot;addedDate&quot;:&quot;Oct 16, 2017 4:47:04 PM&quot;&#125;
	&#125;
&#125;
*&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  说明，如果使用旧版接口，gcc会报warning: ‘Reader’ is deprecated: Use CharReader and CharReaderBuilder instead [-Wdeprecated-declarations]，msvc (//  MSVC 2008 以上 )会报error。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/11/17/blog_idx_044/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/11/17/blog_idx_044/" class="post-title-link" itemprop="url">Linux Daemon & 单例模式 设计与实现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-11-17 16:33:04" itemprop="dateCreated datePublished" datetime="2017-11-17T16:33:04+08:00">2017-11-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux%E5%BC%80%E5%8F%91/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 16:36:36
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=044） 
&emsp;&emsp;本文发布于 2017-11-17 16:33:04，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=044） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Linux-Daemo-和-单例模式">Linux Daemo 和 单例模式</h3>
<hr>
<br/>
<br/>
<h5 id="Linux-单例模式">Linux 单例模式</h5>
<p>  原理：创建一个保存进程名的文件，利用linux的文件锁来判断文件是否加锁来判断是否已有相同的程序运行。</p>
<p>例子</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">CheckIsSingleton</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>fd<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

    <span class="token keyword">struct</span> <span class="token class-name">flock</span> loglock<span class="token punctuation">;</span>  
    <span class="token keyword">char</span> nowpid<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> num<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token operator">*</span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>LOCK_FILE_NAME<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>

        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open lock file failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/*

struct flock &#123;
               ...
               short l_type;    // Type of lock: F_RDLCK,
                                   //F_WRLCK, F_UNLCK 
               short l_whence;  // How to interpret l_start:
                                //SEEK_SET, SEEK_CUR, SEEK_END 
               off_t l_start;   // Starting offset for lock 
               off_t l_len;     // Number of bytes to lock 
               pid_t l_pid;     // PID of process blocking our lock
                                  // (set by F_GETLK and F_OFD_GETLK) 
               ...
           &#125;;

       As well as being removed by an explicit F_UNLCK, record locks are auto‐
       matically released when the process terminates.


*/</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loglock<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">flock</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loglock<span class="token punctuation">.</span>l_type <span class="token operator">=</span> F_WRLCK<span class="token punctuation">;</span>
    loglock<span class="token punctuation">.</span>l_whence <span class="token operator">=</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span>  <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token operator">*</span>fd<span class="token punctuation">,</span> F_GETLK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>loglock<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//检查是否能够加F_WRLCK锁，不能够确认文件是否有锁。</span>
    
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">*</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fcntl F_WRLCK failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> loglock<span class="token punctuation">.</span>l_type <span class="token operator">!=</span> F_UNLCK<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

            <span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">*</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"check F_WRLCK failed\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"check F_WRLCK failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//stdout was closed!!!</span>
            <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"The same process is running\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"The same process is running\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    loglock<span class="token punctuation">.</span>l_type <span class="token operator">=</span> F_WRLCK<span class="token punctuation">;</span>
    loglock<span class="token punctuation">.</span>l_start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">//从文件开始加锁</span>
    loglock<span class="token punctuation">.</span>l_whence <span class="token operator">=</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">;</span>  
    loglock<span class="token punctuation">.</span>l_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//加锁整个文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span>  <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token operator">*</span>fd<span class="token punctuation">,</span> F_SETLK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>loglock<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

        <span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">*</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fcntl F_WRLCK failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The same process is running\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    num <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>nowpid<span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">*</span>fd<span class="token punctuation">,</span> nowpid<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="Daemon-简单设计">Daemon 简单设计</h5>
<p>  原理</p>
<ol>
<li class="lvl-3">
<p>利用fork来实现。setsid使当前子进程成为新的进程组长，在使用fork使其与终端脱离，设置工作目录，设置文件掩码</p>
</li>
<li class="lvl-3">
<p>利用系统提供的daemon（）（此调用来至于glibc）来完成功能。（底层使用fork来实现）<br>
  例子</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">CreateDaemonProcess_daemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//根据daemon函数的源码来看，后面补充了一个fork比较安全</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/*
       The daemon() function is for programs wishing to detach themselves from
       the controlling terminal and run in the background as system daemons.

       If nochdir is zero, daemon()  changes  the  process's  current  working
       directory  to  the root directory ("/"); otherwise, the current working
       directory is left unchanged.

       If noclose is zero, daemon() redirects standard input, standard  output
       and  standard  error  to  /dev/null;  otherwise, no changes are made to
       these file descriptors.

int
daemon(nochdir, noclose)
    int nochdir, noclose;
&#123;
    int fd;
 
    switch (__fork()) &#123;
    case -1:
        return (-1);
    case 0:
        break;
    default:
        _exit(0);
    &#125;
 
    if (__setsid() == -1)
        return (-1);
 
    if (!nochdir)
        (void)__chdir("/");
 
    if (!noclose) &#123;
        struct stat64 st;
 
        if ((fd = open_not_cancel(_PATH_DEVNULL, O_RDWR, 0)) != -1
            &amp;&amp; (__builtin_expect (__fxstat64 (_STAT_VER, fd, &amp;st), 0)
            == 0)) &#123;
            if (__builtin_expect (S_ISCHR (st.st_mode), 1) != 0
#if defined DEV_NULL_MAJOR &amp;&amp; defined DEV_NULL_MINOR
                &amp;&amp; (st.st_rdev
                == makedev (DEV_NULL_MAJOR, DEV_NULL_MINOR))
#endif
                ) &#123;
                (void)__dup2(fd, STDIN_FILENO);
                (void)__dup2(fd, STDOUT_FILENO);
                (void)__dup2(fd, STDERR_FILENO);
                if (fd > 2)
                    (void)__close (fd);
            &#125; else &#123;
                // We must set an errno value since no
                 //  function call actually failed.  
                close_not_cancel_no_status (fd);
                __set_errno (ENODEV);
                return -1;
            &#125;
        &#125; else &#123;
            close_not_cancel_no_status (fd);
            return -1;
        &#125;
    &#125;
    return (0);
&#125;

*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">></span> <span class="token function">daemon</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>

        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"daemon call failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//setsid();</span>
    <span class="token comment">// int fd;</span>
    <span class="token comment">// if ( 0 > (fd = open("/dev/tty", O_RDWR )) )&#123;</span>

    <span class="token comment">//     perror("open tty failed!");</span>
    <span class="token comment">//     _exit(-1);</span>
    <span class="token comment">// &#125;</span>

    <span class="token comment">// if ( ioctl(fd, TIOCNOTTY, NULL) &lt; 0)&#123;</span>

    <span class="token comment">//     perror("ioctl TIOCNOTTY failed!");</span>
    <span class="token comment">//     close(fd);</span>
    <span class="token comment">//     _exit(-1);</span>
    <span class="token comment">// &#125;</span>
    <span class="token comment">// close(fd);</span>

    <span class="token keyword">int</span> pid<span class="token punctuation">;</span>
    pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>

        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork first error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span> <span class="token comment">//parent 1</span>

        <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span> <span class="token comment">//child pid==0</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token function">CreateDaemonProcess_Fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

    <span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> pid1<span class="token punctuation">,</span> pid2<span class="token punctuation">;</span>

    pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>

        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork first error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span> <span class="token comment">//parent 1</span>

        <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span> <span class="token comment">//child pid==0</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>pid1 <span class="token operator">=</span> <span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setsid() call failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"New session id is %d\n"</span><span class="token punctuation">,</span> pid1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        pid2 <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid2 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>

            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork second error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid2 <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span> <span class="token comment">//parent</span>

            <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//change current working directory</span>
            <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  说明：</p>
<ol>
<li class="lvl-3">
<p>双fork的原因是进程组长会开启终端。而我们的daemon程序是不需要终端的。</p>
</li>
<li class="lvl-3">
<p>文件掩码用于设置默认的文件权限。</p>
</li>
<li class="lvl-3">
<p>子进程会继承父进程的大部分属性，包括已打开文件描述符、文件掩码、工作目录等待，这些根据需求处理。</p>
</li>
</ol>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/09/30/blog_idx_043/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/30/blog_idx_043/" class="post-title-link" itemprop="url">Ubuntu 16.04 配置NFS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-09-30 15:34:17" itemprop="dateCreated datePublished" datetime="2017-09-30T15:34:17+08:00">2017-09-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Ubuntu%E4%BD%BF%E7%94%A8/" itemprop="url" rel="index"><span itemprop="name">Ubuntu使用</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Ubuntu%E4%BD%BF%E7%94%A8/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>681</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 16:26:25
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=043） 
&emsp;&emsp;本文发布于 2017-09-30 15:34:17，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=043） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  Linux 4.10.0-35-generic #39~16.04.1-Ubuntu SMP Wed Sep 13 09:02:42 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</p>
<h3 id="前言">前言</h3>
<hr>
<p>  最近太TNND忙了，好多东西都没有办法记录，只能等待闲暇时来记录。</p>
<p>  最近项目上用了一个牛逼的核心板子，整个NAND本来总大小为2G，结果TMD官方给的资料居然只启用了32MB，心都在滴血啊，uboot 1MB，kernel 4MB，剩余20+MB简直了，因为我们要跑一个大一点点的程序，什么都移植不上去，分分钟空间就不够用了。所以没有办法，只有弄一个NFS来先凑合着（其实NFS对于调试来说，还是非常爽的，及其方便）。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="NFS配置">NFS配置</h3>
<hr>
<ol>
<li class="lvl-3">
<p>sudo apt-get install nfs-kernel-server #直接装就好了，其中，apt会给你自动解决依赖，主要是nfs-common  rpcbind 这两个包。</p>
</li>
<li class="lvl-4">
<p>vim /etc/exports #修改配置文件，并在文件末行添加：</p>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">   要挂载的绝对目录 *<span class="token punctuation">(</span>rw,sync,no_root_squash,no_subtree_check<span class="token punctuation">)</span>
   规则：目录 ip（权限）
example：
/home/xxx/nfsroot  *<span class="token punctuation">(</span>rw,sync,no_root_squash,no_subtree_check<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li class="lvl-3">
<p>注意，要在嵌入式板子上挂载nfs,mount需要-o nolock 参数,nfs对挂载目录存在文件锁，把文件锁放在板子端，避免冲突。</p>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">example：
<span class="token function">mount</span> <span class="token parameter variable">-t</span> nfs <span class="token parameter variable">-o</span> nolock <span class="token number">192.168</span>.31.137:/home/xxxx/nfs_rootfs /nfsroot/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><em><strong>注意:配置完配置文件后，可通过重启系统以及重启nfs服务来使配置生效</strong></em></p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/09/21/blog_idx_042/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/21/blog_idx_042/" class="post-title-link" itemprop="url">GdbServer和libuuid移植到HISI3520d</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-09-21 19:47:19" itemprop="dateCreated datePublished" datetime="2017-09-21T19:47:19+08:00">2017-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>641</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 16:21:01
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=042） 
&emsp;&emsp;本文发布于 2017-09-21 19:47:19，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=042） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  Linux 4.10.0-35-generic #39~16.04.1-Ubuntu SMP Wed Sep 13 09:02:42 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</p>
<h3 id="前言">前言</h3>
<hr>
<p>  我们用的这个板子，NAND是32MB，除去uboot，kernel，根文件系统总大小11MB(没有使用完NAND)，所以对于这一点容量，导致了我们得省着点用才行。对于板子上的一个程序，当它出问题后，我们没有任何办法调试，因为移植一个gdb上去太大了。so，我们便想着移植一个gdbserver来远程调试。libuuid是这个我们要调试的目标程序需要。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="GdbServer和libuuid移植">GdbServer和libuuid移植</h3>
<hr>
<ol>
<li class="lvl-3">
<p>首先移植gdbserver，从下面地址下载，<a target="_blank" rel="noopener" href="http://www.gnu.org/software/gdb/download/%E3%80%82%E7%9B%B4%E6%8E%A5%E8%A7%A3%E5%8E%8B%EF%BC%8C%E8%BF%9B%E5%85%A5%E6%BA%90%E7%A0%81%E7%9B%AE%E5%BD%95%E3%80%82">http://www.gnu.org/software/gdb/download/。直接解压，进入源码目录。</a></p>
</li>
</ol>
<p>    1. 先生成对应的GDB。(注意这是在宿主机上运行，而不是板子，一定要指定target,此target一定要和gdbserver一致，不然可能出现未知的问题)</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure <span class="token parameter variable">--target</span><span class="token operator">=</span>arm-hisiv400-linux <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/home/xxx/xxx
<span class="token function">make</span>
<span class="token function">make</span> <span class="token function">install</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>    2. 生成对应的GdbServer，进入到源码根目录，在进入gdb/gdbserver/。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure  <span class="token parameter variable">--target</span><span class="token operator">=</span>arm-hisiv400-linux  <span class="token parameter variable">--host</span><span class="token operator">=</span>arm-hisiv400-linux
<span class="token function">make</span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol start="2">
<li class="lvl-3">
<p>首先下载libuuid，<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/libuuid/%E3%80%82%E8%A7%A3%E5%8E%8B%EF%BC%8C%E8%BF%9B%E5%85%A5%E6%BA%90%E7%A0%81%E7%9B%AE%E5%BD%95%E3%80%82">https://sourceforge.net/projects/libuuid/。解压，进入源码目录。</a></p>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure <span class="token parameter variable">--host</span><span class="token operator">=</span>arm-hisiv400-linux  --enable-shared <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/home/xxx/xxx
<span class="token function">make</span> 
<span class="token function">make</span> <span class="token function">install</span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/09/20/blog_idx_041/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/20/blog_idx_041/" class="post-title-link" itemprop="url">移植openssh-7.5p1(包括openssl-1.0.2l、zlib-1.2.11)到HISI3520d（编译篇）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-09-20 09:59:43" itemprop="dateCreated datePublished" datetime="2017-09-20T09:59:43+08:00">2017-09-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 16:17:18
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=041） 
&emsp;&emsp;本文发布于 2017-09-20 09:59:43，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=041） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  HOST:</p>
<p>    Linux 4.10.0-35-generic #39~16.04.1-Ubuntu SMP Wed Sep 13 09:02:42 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</p>
<p>  TARGET:</p>
<p>    arm-hisiv400-linux-gnueabi 工具链，GLIBC-Kernel</p>
<h3 id="前言">前言</h3>
<hr>
<p>  最近有个项目是使用的hisiv3520d的片子，按照官方SDK移植好了glibc-kernel之后，准备进行后期的开发。但是这块板子只有一个调试串口，多个同事就不能够同时使用这块板子，所以，就有了移植openssh的想法。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="移植Openssh">移植Openssh</h3>
<hr>
<ol>
<li class="lvl-3">
<p>首先配置好官方的SDK，工具链必须是hisiv400的，这个工具链是glibc版本的，同时为了保持和内核的兼容性。</p>
</li>
<li class="lvl-3">
<p>首先找到当前openssh的稳定版本，下载地址为下面的地址，版本为7.5p1<br>
<a href="ftp://mirror.internode.on.net/pub/OpenBSD/OpenSSH/portable/">ftp://mirror.internode.on.net/pub/OpenBSD/OpenSSH/portable/</a><br>
下载解压后，这里有一个文件希望大家在移植前先读一读根目录下一个叫做INSTALL的文本文件，特别是关于依赖的zlib和openssl兼容版本部分（下图已圈出重点）。下面是截图：</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_041/install.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  友情提示：一定要选择  《  <em><strong>版本合适</strong></em>  》  的zlib和openssl，不然最后编译不过openssh，我就是踩了这个坑。</p>
<ol start="3">
<li class="lvl-3">
<p>移植openssl-1.0.2l,下载地址（<a target="_blank" rel="noopener" href="https://www.openssl.org/source/%EF%BC%89%E3%80%82%E8%BF%99%E9%87%8C%E5%BE%88%E5%A4%9A%E7%BD%91%E4%B8%8A%E7%9A%84%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E6%96%B9%E6%B3%95%E7%AD%94%E6%A1%88%E9%83%BD%E6%AF%94%E8%BE%83%E7%9A%84%E4%B9%B1%EF%BC%8C%E4%B8%AA%E4%BA%BA%E6%84%9F%E8%A7%89%E6%9C%89%E7%82%B9%E5%A4%8D%E6%9D%82%EF%BC%8C%E9%83%BD%E6%B2%A1%E6%9C%89%E4%BB%94%E7%BB%86%E7%9A%84%E5%8E%BB%E8%AF%BBINSTALL%E6%96%87%E4%BB%B6%E3%80%82">https://www.openssl.org/source/）。这里很多网上的交叉编译方法答案都比较的乱，个人感觉有点复杂，都没有仔细的去读INSTALL文件。</a></p>
</li>
</ol>
<p>  其实直接执行:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./config no-asm shared <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/home/sky/hisi3520d/Work/install --cross-compile-prefix<span class="token operator">=</span>arm-hisiv400-linux-gnueabi-<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>  我就不对这些参数一一说明了，这些参数的说明来自于Configure和INSTALL这个文件。非常全，下面是节选的部分说明。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># --prefix      prefix for the OpenSSL include, lib and bin directories</span>
<span class="token comment"># --cross-compile-prefix Add specified prefix to binutils components.</span>
<span class="token comment"># no-asm        do not use assembler</span>
<span class="token comment"># shared        In addition to the usual static libraries, create # shared libraries on platforms where it's supported.  </span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>  这里，我们需要查找自己要移植的芯片的arm架构版本，并且修改.config里面的有个叫做GUESSOS的变量。我看它脚本里面写的TARGET名字的规则（如下图），就自己定义一个合理的值给GUESSOS（这里很烦的，这个东西猜不准我的目标架构）</p>
<p>  比如我给的值就是GUESSOS=armv7-hisi-3520d-linux2,中间的随意填，只要注意他的命名规则就好了</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_041/guess_os.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  然后，make ,make install 就好了(其实有兴趣的可以去研究那个叫做Configure的文件，并直接执行这个脚本就可以配置完成了，但是在linux下，这样不推荐，config脚本也是调用的Configure的那个脚本)</p>
<p><strong>2019/5/17更新</strong></p>
<p>  关于交叉编译，其实其INSTALL文件中有一段说明：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_041/install1.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  意思就是让我们直接修改Configure脚本，然后得到自己想要的架构的库。经过一番研究发现，大概需要如下步骤：</p>
<p>    1 首先查看适合你的架构</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_041/arch.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  这里的话，我板子是armv7的，所以我选择linux-armv4，如果是64位的，就选择linux-aarch64.</p>
<p>  但是这样还不够，因为我们还需要指定编译相关的工具名字，这里需要直接去修改Cofigure脚本。</p>
<p>    2 修改如下：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_041/arch1.png" alt="rep_img"/></center>
    </div>
</div>  
<p>    3 然后执行:./Configure linux-armv4 --prefix=xxx shared</p>
<p>    4 make -j 16 &amp;&amp; make install</p>
<ol start="4">
<li class="lvl-3">
<p>移植zlib-1.2.11，下载地址(<a target="_blank" rel="noopener" href="http://www.zlib.net/">http://www.zlib.net/</a>)，这个我没有找到好的方法，只有通过原始的改Makefile来实现。首先</p>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./config <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/<span class="token punctuation">..</span>./<span class="token punctuation">..</span>./<span class="token punctuation">..</span>./zlib_install<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>  把makefile里面的CC,LDSHARED,CPP,AR,RANLIB等变量中编译链接相关的东西，改为交叉工具链中对应的东西。然后make,make install</p>
<ol start="5">
<li class="lvl-3">
<p>开始正题。</p>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure <span class="token parameter variable">--host</span><span class="token operator">=</span>arm-hisiv400-linux-gnueabi --with-libs --with-zlib<span class="token operator">=</span>/home/sky/hisi3520d/Work/install --with-ssl-dir<span class="token operator">=</span>/home/sky/hisi3520d/Work/install --disable-etc-default-login <span class="token assign-left variable">CC</span><span class="token operator">=</span>arm-hisiv400-linux-gnueabi-gcc <span class="token assign-left variable">AR</span><span class="token operator">=</span>arm-hisiv400-linux-gnueabi-ar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>  然后make就可以了。最终生成的openssh相关的可执行程序在根目录。</p>
<p><em><strong>特此说明：configure 脚本可通过–prefix参数来配置实际的安装目录，编译生成的程序写死这个目录，若不想使用默认的配置，建议使用此参数配置</strong></em></p>
<p><em><strong>最后相关的安装步骤在：<a target="_blank" rel="noopener" href="http://blog.csdn.net/u011728480/article/details/78969958">http://blog.csdn.net/u011728480/article/details/78969958</a></strong></em></p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/09/07/blog_idx_040/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/07/blog_idx_040/" class="post-title-link" itemprop="url">thttpd 2.27（最新）移植指南（官方安装脚本好多坑，我只想说）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-09-07 11:05:41" itemprop="dateCreated datePublished" datetime="2017-09-07T11:05:41+08:00">2017-09-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>821</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 18:18:10
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=040） 
&emsp;&emsp;本文发布于 2017-09-07 11:05:41，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=040） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  Date:Thu Sep  7 10:38:53 CST 2017<br>
  Version:Linux  3.10.40 #43 SMP PREEMPT Thu Aug 17 11:42:21 CST 2017 armv7l armv7l armv7l GNU/Linux</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="httpd">httpd</h3>
<hr>
<p>  最近需要在板子上移植一个小型的web服务器，所以选用了thttpd这个小玩意儿。(下文中出现的A代表目标路径)</p>
<p>  这类带configure脚本的程序都是一个流程。直接:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>A
<span class="token function">make</span> <span class="token parameter variable">-j</span> <span class="token number">4</span>
<span class="token function">make</span> <span class="token function">install</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>  在最后一步，问题多的爆炸（不知道是不是我指定了特殊安装路径造成的）。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>无www用户组，直接sudo groupadd www添加</p>
</li>
</ul>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_040/www.png" alt="rep_img"/></center>
    </div>
</div>  
<ul class="lvl-0">
<li class="lvl-2">
<p>目标目录无man1目录，直接sudo mkdir -p A/man/man1</p>
</li>
</ul>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_040/man1.png" alt="rep_img"/></center>
    </div>
</div> 
<ul class="lvl-0">
<li class="lvl-2">
<p>目标目录无thttpd.conf文件，直接从源码中带的拷贝到当前目录</p>
</li>
</ul>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_040/httpd.png" alt="rep_img"/></center>
    </div>
</div>
<ul class="lvl-0">
<li class="lvl-2">
<p>建立网页资源目录,并写入一个Index.html文件</p>
</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">mkdir</span> A/html 
<span class="token function">sudo</span> <span class="token function">chmod</span> +755 html
<span class="token builtin class-name">echo</span> <span class="token string">"Hello Sky Hello World"</span> <span class="token operator">>></span> html/index.html
<span class="token function">sudo</span> <span class="token function">chmod</span> +644 html/index.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul class="lvl-0">
<li class="lvl-2">
<p>无httpd用户，sudo useradd httpd</p>
</li>
<li class="lvl-2">
<p>改一下端口，80口可能随时被占用了。（thttp.conf）</p>
</li>
</ul>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_040/port.png" alt="rep_img"/></center>
    </div>
</div>
<ul class="lvl-0">
<li class="lvl-2">
<p>改目标资源网页目录（thttp.conf）</p>
</li>
</ul>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_040/dir.png" alt="rep_img"/></center>
    </div>
</div>
<p>  到这里坑填的差不多了，直接root用户下,</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./thttpd <span class="token parameter variable">-C</span> thttpd.conf
<span class="token function">ps</span> <span class="token parameter variable">-aux</span> <span class="token operator">|</span> <span class="token function">grep</span> thttpd看一下是否正常启动<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_040/httpd1.png" alt="rep_img"/></center>
    </div>
</div>
<p>  最后看效果：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_040/result.png" alt="rep_img"/></center>
    </div>
</div>
<p>  题外话，CGI这类的配置网上主流的教程可以用</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/08/31/blog_idx_039/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/08/31/blog_idx_039/" class="post-title-link" itemprop="url">Linux Socket 摘要（二）（基于TCP的C/S基本实现，相关基础知识，非阻塞select）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-08-31 16:18:21" itemprop="dateCreated datePublished" datetime="2017-08-31T16:18:21+08:00">2017-08-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 18:07:54
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=039） 
&emsp;&emsp;本文发布于 2017-08-31 16:18:21，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=039） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  测试环境:Linux  4.10.0-33-generic #37~16.04.1-Ubuntu SMP Fri Aug 11 14:07:24 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Socket摘要2">Socket摘要2</h3>
<hr>
<ol>
<li class="lvl-3">
<p>关于linux socket通信，要详细了解清楚，不知道要说多少天。所以网上大部分教程也是只介绍了基本的api调用流程。一些其他的问题还没有提及，当然本文作者由于水平有限，估计也只能介绍个流程，并且解决一些简单的未涉及的问题。</p>
</li>
<li class="lvl-3">
<p>TCP的基本要点，三次握手，四次分手，分别代表了开始和结束。下图是我在百度图片上找的一个图，完全找不到原图出自哪里，很伤感。</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_039/tcp0.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  说明：此图完全清晰可见的描述了一个tcp通信到底做了一些什么。我也不详细说明，改天可以给大家抓包分析分析。</p>
<ol start="3">
<li class="lvl-3">
<p>通过上图我们可以看到，客户端connect后，就可以write和read了，而服务端accept后可以做同样的事情，最后只需要close就能够解决。下面我们简要的来分析一下这个流程。</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_039/server.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_039/server_info.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  上图是我写的一个服务端程序跑起来后，通过netstat可以看到此进程进入了listen状态。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_039/server1.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_039/client.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_039/cap.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  上面三个图演示了一个tcp通信的完整过程。第三图1-3是connect，4是write：Hello Server，5是对4的响应，代表收到，6是write：Hello Client，7同理5，8-11对应close，和上文所要展示的流程基本相同。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_039/socket_info.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  上图是查看端口，可见tcp的链接状况（图中pid和上文图中pid不对应的原因是非同一个测试）。</p>
<ol start="4">
<li class="lvl-3">
<p>好了，上文BB了那么多，只是要科普一下而已，现在进入正题，首先来看几个定义及结构体。结构体1</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> __kernel_sa_family_t<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> __kernel_sa_family_t	<span class="token class-name">sa_family_t</span><span class="token punctuation">;</span>      
<span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token punctuation">&#123;</span><span class="token comment">//通用结构体，很多socket相关api都要使用它</span>
           <span class="token class-name">sa_family_t</span> sa_family<span class="token punctuation">;</span>
           <span class="token keyword">char</span>        sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结构体2</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token class-name">uint32_t</span> <span class="token class-name">in_addr_t</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">in_addr</span><span class="token comment">//ip地址存放结构体</span>
<span class="token punctuation">&#123;</span>
<span class="token class-name">in_addr_t</span> s_addr<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__SOCKADDR_COMMON</span><span class="token expression"><span class="token punctuation">(</span>sa_prefix<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token class-name">sa_family_t</span> sa_prefix</span><span class="token punctuation">##</span><span class="token expression">family</span></span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token comment">//ip4 地址结构</span>
<span class="token punctuation">&#123;</span>
<span class="token function">__SOCKADDR_COMMON</span> <span class="token punctuation">(</span>sin_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">in_port_t</span> sin_port<span class="token punctuation">;</span>                 <span class="token comment">//Port number.  </span>
<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span>            <span class="token comment">// Internet address.  </span>

<span class="token comment">// Pad to size of `struct sockaddr'</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> sin_zero<span class="token punctuation">[</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">)</span> <span class="token operator">-</span>
                           __SOCKADDR_COMMON_SIZE <span class="token operator">-</span>
                           <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token class-name">in_port_t</span><span class="token punctuation">)</span> <span class="token operator">-</span>
                           <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结构体3</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_K_SS_MAXSIZE</span>   <span class="token expression"><span class="token number">128</span>      </span><span class="token comment">//Implementation specific max size </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_K_SS_ALIGNSIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token function">__alignof__</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">//Implementation specific desired alignment </span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> __kernel_sa_family_t<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">__kernel_sockaddr_storage</span> <span class="token punctuation">&#123;</span><span class="token comment">//此结构体是新内核提出的，可以存储所有协议地址类型</span>
    __kernel_sa_family_t    ss_family<span class="token punctuation">;</span>              <span class="token comment">//address family </span>
    <span class="token comment">// Following field(s) are implementation specific </span>
    <span class="token keyword">char</span>            __data<span class="token punctuation">[</span>_K_SS_MAXSIZE <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// space to achieve desired size, </span>
<span class="token comment">// _SS_MAXSIZE value minus size of ss_family </span>
<span class="token punctuation">&#125;</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">aligned</span><span class="token punctuation">(</span>_K_SS_ALIGNSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* force desired alignment </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  结构体1，2是ip4网络编程常用的一些结构体，结构体3是新内核对于多种协议地址结构提出的一个新的通用的存储结构体。</p>
<ol start="5">
<li class="lvl-3">
<p>关于这些结构体的知识我们就到这里了。现在来讲一讲linux上的socket编程。下面就是cs通信中，各自要使用的api及调用顺序，这也是最基本的socket通信，也是网上流传最广的通信例子。</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">client<span class="token operator">:</span>
<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span>  <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
read<span class="token operator">/</span>write
close
server<span class="token operator">:</span>
<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span><span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//阻塞io</span>
read<span class="token operator">/</span>write
close<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="6">
<li class="lvl-3">
<p>非阻塞通信，关键select(注意，这里没有使用更高级的epoll，因为我对这个api也是一个菜鸡)</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> nfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span>
           fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">FD_CLR</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>  <span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">FD_SET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">FD_ZERO</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  对于这个api，简单来说，就是监控 所有传入的 文件描述符集合，当相关文件描述集合可读， 可写 ，异常时，select正常返回，否则可能是等待超时，可能是出错。对于本文，就是监控客户端socket fd，监控服务端socket fd和accept接受的fd。</p>
<ol start="7">
<li class="lvl-3">
<p>其他的都不说了，口水都干了，直接上例子代码，然后喝口水，上个厕所，洗个手，坐等下班<br>
client.c</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span> <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h></span></span>

<span class="token comment">/* According to earlier standards */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TARGETPORT</span> <span class="token expression"><span class="token number">6666</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TARGETIP</span> <span class="token string">"127.0.0.1"</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

    <span class="token comment">/*
int socket(int domain, int type, int protocol);

domain:
       AF_UNIX, AF_LOCAL   Local communication              unix(7)
       AF_INET             IPv4 Internet protocols          ip(7)
       AF_INET6            IPv6 Internet protocols          ipv6(7)
       AF_IPX              IPX - Novell protocols
       AF_NETLINK          Kernel user interface device     netlink(7)
       AF_X25              ITU-T X.25 / ISO-8208 protocol   x25(7)
       AF_AX25             Amateur radio AX.25 protocol
       AF_ATMPVC           Access to raw ATM PVCs
       AF_APPLETALK        AppleTalk                        ddp(7)
       AF_PACKET           Low level packet interface       packet(7)
       AF_ALG              Interface to kernel crypto API
type:
       SOCK_STREAM     Provides sequenced, reliable, two-way, connection-based
                       byte  streams.  An out-of-band data transmission mecha‐
                       nism may be supported.

       SOCK_DGRAM      Supports datagrams (connectionless, unreliable messages
                       of a fixed maximum length).

       SOCK_SEQPACKET  Provides  a  sequenced,  reliable,  two-way connection-
                       based data transmission path  for  datagrams  of  fixed
                       maximum  length;  a  consumer  is  required  to read an
                       entire packet with each input system call.

       SOCK_RAW        Provides raw network protocol access.

       SOCK_RDM        Provides a reliable datagram layer that does not  guar‐
                       antee ordering.

       SOCK_PACKET     Obsolete  and  should  not be used in new programs; see
                       packet(7).

protocol:
       The protocol specifies a  particular  protocol  to  be  used  with  the
       socket.  Normally only a single protocol exists to support a particular
       socket type within a given protocol family, in which case protocol  can
       be  specified  as  0.   However, it is possible that many protocols may
       exist, in which case a particular protocol must be  specified  in  this
       manner.   The  protocol number to use is specific to the “communication
       domain” in which communication is to take place; see protocols(5).  See
       getprotoent(3) on how to map protocol name strings to protocol numbers.
*/</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>

        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket create error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/*
    int bind(int sockfd, const struct sockaddr *addr,
                socklen_t addrlen);

    typedef unsigned short __kernel_sa_family_t;
    typedef __kernel_sa_family_t	sa_family_t;      
    struct sockaddr &#123;
               sa_family_t sa_family;
               char        sa_data[14];
    &#125;

    typedef uint32_t in_addr_t;
    struct in_addr
    &#123;
    in_addr_t s_addr;
    &#125;;

    #define __SOCKADDR_COMMON(sa_prefix) \
    sa_family_t sa_prefix##family

    struct sockaddr_in
    &#123;
    __SOCKADDR_COMMON (sin_);
    in_port_t sin_port;                 /* Port number.  
    struct in_addr sin_addr;            /* Internet address.  
    
    // Pad to size of `struct sockaddr'.  
    unsigned char sin_zero[sizeof (struct sockaddr) -
                               __SOCKADDR_COMMON_SIZE -
                               sizeof (in_port_t) -
                               sizeof (struct in_addr)];
    &#125;;
    

    #define _K_SS_MAXSIZE   128      //Implementation specific max size 
    #define _K_SS_ALIGNSIZE (__alignof__ (struct sockaddr *))
    //Implementation specific desired alignment 

    typedef unsigned short __kernel_sa_family_t;

    struct __kernel_sockaddr_storage &#123;
        __kernel_sa_family_t    ss_family;              /* address family 
        /* Following field(s) are implementation specific 
        char            __data[_K_SS_MAXSIZE - sizeof(unsigned short)];
        /* space to achieve desired size, */</span>
    <span class="token comment">/* _SS_MAXSIZE value minus size of ss_family 
    &#125; __attribute__ ((aligned(_K_SS_ALIGNSIZE)));   /* force desired alignment 

    */</span>

    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>TARGETPORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//addr.sin_addr.s_addr = htonl</span>
    <span class="token comment">//int inet_pton(int af, const char *src, void *dst);</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> TARGETIP<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//int connect(int sockfd, const struct sockaddr *addr,\
        socklen_t addrlen);</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">></span> <span class="token function">connect</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>

        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket connect error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> timeout<span class="token punctuation">;</span>
    <span class="token keyword">char</span>  SendMsg<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"Hello Server"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> RecBuf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    fd_set rec_set<span class="token punctuation">;</span>
    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rec_set<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">FD_SET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rec_set<span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">//ssize_t write(int fd, const void *buf, size_t count);</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SendMsg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SendMsg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        timeout<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>   
        timeout<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
        <span class="token comment">//int select(int nfds, fd_set *readfds, fd_set *writefds,\
            fd_set *exceptfds, struct timeval *timeout);</span>
        ret <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>fd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rec_set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">//select返回表示检测到可读事件 </span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"select timeout!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"select error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">default</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
                <span class="token comment">//ssize_t read(int fd, void *buf, size_t count);</span>
                <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> RecBuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SendMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"RecBuf:%s\n"</span><span class="token punctuation">,</span>RecBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>server.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span> <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h></span></span>

<span class="token comment">/* According to earlier standards */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h></span></span>



<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TARGETPORT</span> <span class="token expression"><span class="token number">6666</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TARGETIP</span> <span class="token string">"127.0.0.1"</span></span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_MyFdSet</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> FdNum<span class="token punctuation">;</span>
    <span class="token keyword">int</span> AllFdSet<span class="token punctuation">[</span>FD_SETSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> MyFdSet<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">MyFdSet_INSERT</span><span class="token punctuation">(</span>MyFdSet <span class="token operator">*</span>set<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    set<span class="token operator">-></span>AllFdSet<span class="token punctuation">[</span>set<span class="token operator">-></span>FdNum<span class="token punctuation">]</span> <span class="token operator">=</span> fd<span class="token punctuation">;</span> 
    set<span class="token operator">-></span>FdNum<span class="token operator">++</span><span class="token punctuation">;</span>    
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span>  <span class="token function">MyFdSet_GETMAX</span><span class="token punctuation">(</span>MyFdSet <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> max_fd <span class="token operator">=</span> set<span class="token operator">-></span>AllFdSet<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> set<span class="token operator">-></span>FdNum<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span> max_fd <span class="token operator">&lt;</span> set<span class="token operator">-></span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            max_fd <span class="token operator">=</span> set<span class="token operator">-></span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> max_fd<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">MyFdSet_REMOVE</span><span class="token punctuation">(</span>MyFdSet <span class="token operator">*</span> set<span class="token punctuation">,</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    MyFdSet tmp<span class="token punctuation">;</span>
    tmp<span class="token punctuation">.</span>FdNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> set<span class="token operator">-></span>FdNum<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> fd <span class="token operator">!=</span> set<span class="token operator">-></span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            tmp<span class="token punctuation">.</span>AllFdSet<span class="token punctuation">[</span>tmp<span class="token punctuation">.</span>FdNum<span class="token punctuation">]</span> <span class="token operator">=</span> set<span class="token operator">-></span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            tmp<span class="token punctuation">.</span>FdNum<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    set<span class="token operator">-></span>FdNum <span class="token operator">=</span> tmp<span class="token punctuation">.</span>FdNum<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> set<span class="token operator">-></span>FdNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        set<span class="token operator">-></span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">.</span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>

        <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">></span> <span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>

            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_addr<span class="token punctuation">;</span>

        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
        addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>TARGETPORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//   int bind(int sockfd, const struct sockaddr *addr,\
        socklen_t addrlen);</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">></span> <span class="token function">bind</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>

            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//int listen(int sockfd, int backlog);</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">></span> <span class="token function">listen</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>

            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        fd_set ser_set<span class="token punctuation">;</span>
        <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ser_set<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">FD_SET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ser_set<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">timeval</span> timeout<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

        MyFdSet myfdset <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token function">MyFdSet_INSERT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myfdset<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> RecBuf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> SendMsg<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"Hello Client"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ser_set<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> n <span class="token operator">&lt;</span> myfdset<span class="token punctuation">.</span>FdNum<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

                <span class="token function">FD_SET</span><span class="token punctuation">(</span>myfdset<span class="token punctuation">.</span>AllFdSet<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ser_set<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"exist fd %d\n"</span><span class="token punctuation">,</span>myfdset<span class="token punctuation">.</span>AllFdSet<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            timeout<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
            timeout<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">//int select(int nfds, fd_set *readfds, fd_set *writefds,\
            fd_set *exceptfds, struct timeval *timeout);</span>
            ret <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span> <span class="token function">MyFdSet_GETMAX</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myfdset<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ser_set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
            <span class="token punctuation">&#123;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"select timeout!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span>
            <span class="token punctuation">&#123;</span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"select error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token punctuation">&#123;</span>  
               <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
               <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> myfdset<span class="token punctuation">.</span>FdNum<span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>myfdset<span class="token punctuation">.</span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ser_set<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span> fd <span class="token operator">==</span> myfdset<span class="token punctuation">.</span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//client connect</span>
                            
                            <span class="token keyword">int</span> c_fd<span class="token punctuation">;</span>
                            <span class="token keyword">int</span> client_addr_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span>  <span class="token operator">></span>  <span class="token punctuation">(</span>c_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addr_len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

                                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>

                            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client ip:%s,port:%d\n"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">MyFdSet_INSERT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myfdset<span class="token punctuation">,</span> c_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">FD_SET</span><span class="token punctuation">(</span>c_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ser_set<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token comment">//client sent datas in buf</span>
                            
                            ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>myfdset<span class="token punctuation">.</span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> RecBuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SendMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">></span> ret <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                
                                <span class="token function">MyFdSet_REMOVE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myfdset<span class="token punctuation">,</span> myfdset<span class="token punctuation">.</span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token function">close</span><span class="token punctuation">(</span>myfdset<span class="token punctuation">.</span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> ret <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//client disconnected</span>
                                
                                <span class="token function">MyFdSet_REMOVE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myfdset<span class="token punctuation">,</span> myfdset<span class="token punctuation">.</span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token function">close</span><span class="token punctuation">(</span>myfdset<span class="token punctuation">.</span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client disconnected\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                            <span class="token keyword">else</span><span class="token punctuation">&#123;</span>

                                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"RecMsg:%s\n"</span><span class="token punctuation">,</span> RecBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token function">write</span><span class="token punctuation">(</span>myfdset<span class="token punctuation">.</span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> SendMsg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SendMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
               <span class="token punctuation">&#125;</span>
               <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> myfdset<span class="token punctuation">.</span>FdNum<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//close fd</span>

            <span class="token function">close</span><span class="token punctuation">(</span>myfdset<span class="token punctuation">.</span>AllFdSet<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  直接gcc client.c -o client gcc server.c -o server 就可以使用了</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/NO_EXSIT.XXXXXXX/page/9/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/NO_EXSIT.XXXXXXX/">1</a><span class="space">&hellip;</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/14/">14</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/NO_EXSIT.XXXXXXX/page/11/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Sky</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">286k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">17:19</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":250,"hOffset":50,"vOffset":5},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
</html>
