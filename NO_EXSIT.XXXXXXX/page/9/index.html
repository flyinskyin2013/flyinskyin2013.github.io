<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"e-x.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Sky&#39;s Blogs">
<meta property="og:url" content="https://e-x.top/NO_EXSIT.XXXXXXX/page/9/index.html">
<meta property="og:site_name" content="Sky&#39;s Blogs">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Sky">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://e-x.top/NO_EXSIT.XXXXXXX/page/9/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"NO_EXSIT.XXXXXXX/page/9/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Sky's Blogs</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8677552300382028"
     crossorigin="anonymous"></script>


  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Sky's Blogs</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A normal star</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>
<div class="custom-middle-nav animated fadeInDown">
  <div class="custom-nav-item">
    <a href="/archives/"><i class="fa fa-archive"></i> 日志历程</a>
  </div>
  <div class="custom-nav-item">
    <a href="/categories/"><i class="fa fa-th"></i> 全部分类</a>
  </div>
  <div class="custom-nav-item">
    <a href="/tags/"><i class="fa fa-tags"></i> 热门标签</a>
  </div>
  <div class="custom-nav-item">
    <a href="javascript:;" class="my-search-btn"><i class="fa fa-search"></i> 本站搜索</a>
  </div>
</div>


<script>
// 使用脚本手动触发 NexT 的搜索弹窗
document.addEventListener('DOMContentLoaded', () => {
  const customBtn = document.querySelector('.my-search-btn');
  customBtn.addEventListener('click', (e) => {
    e.preventDefault();
    // 找到 NexT 原生的那个搜索触发按钮并模拟点击
    const originalBtn = document.querySelector('.site-nav-right .popup-trigger');
    if (originalBtn) {
      originalBtn.click();
    } else {
      // 如果原生的没找到，尝试直接调用 NexT 的 Search 内部变量（针对某些版本）
      if (typeof CONFIG.local_search !== 'undefined') {
        // 尝试手动激活弹窗
        document.querySelector('.search-pop-overlay').style.display = 'block';
        document.body.style.overflow = 'hidden';
        document.querySelector('.search-input').focus();
      }
    }
  });
});
</script>
</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sky"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Sky</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">92</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">222</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/flyinskyin2013" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;flyinskyin2013" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
<div id="days" style="margin-top: 10px; font-size: 13px; color: #555;"></div>
<script>
  function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("01/07/2014 00:00:00"); // 这里改成你建站的时间
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
    secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
    e_daysold=timeold/msPerDay
    daysold=Math.floor(e_daysold);
    document.getElementById("days").innerHTML="本站已运行 "+daysold+" 天";
  }
  show_date_time();
</script>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/03/19/blog_idx_058/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/03/19/blog_idx_058/" class="post-title-link" itemprop="url">关于全景（360）图片拼接的方法（Opencv3.0 Stitcher）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-03-19 11:36:39" itemprop="dateCreated datePublished" datetime="2018-03-19T11:36:39+08:00">2018-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/" itemprop="url" rel="index"><span itemprop="name">计算机视觉</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">数据结构与算法</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>656</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 15:59:40
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=058） 
&emsp;&emsp;本文发布于 2018-03-19 11:36:39，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=058） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Opencv-Stitcher">Opencv Stitcher</h3>
<hr>
<p>  最近有个项目就是要采集海康摄像头（可转动的摄像头）的数据做全景图片拼接，然后送到算法模块去检测人脸数目。</p>
<p>  这里使用的是opencv 3.0+ 的Stitcher 类。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">   std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">></span> vecSrc<span class="token punctuation">;</span><span class="token comment">//t1.jpg,t2.jpg,t3.jpg</span>
   cv<span class="token double-colon punctuation">::</span>Mat Dst<span class="token punctuation">;</span>
Stitcher stitcher <span class="token operator">=</span> <span class="token class-name">Stitcher</span><span class="token double-colon punctuation">::</span><span class="token function">createDefault</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
Stitcher<span class="token double-colon punctuation">::</span>Status status <span class="token operator">=</span> stitcher<span class="token punctuation">.</span><span class="token function">stitch</span><span class="token punctuation">(</span>vecSrc<span class="token punctuation">,</span> Dst<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> Stitcher<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"图像相似度太差，拼接失败！ "</span>  <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  
<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
	<span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"out"</span><span class="token punctuation">,</span> Dst<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//out.jpg</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  下面是原始图片和拼接后的图片：</p>
<p>t1</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_058/t1.png" alt="rep_img"/></center>
    </div>
</div>    
<p>t2</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_058/t2.png" alt="rep_img"/></center>
    </div>
</div>    
t3
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_058/t3.png" alt="rep_img"/></center>
    </div>
</div>    
t4
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_058/t4.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  注意：这里的out图片可以看到边缘丢失了一部分，如果图片源大小不一致或者重叠部分不明显，则可能丢失更多。此外：图片需要相当一部分的重叠才能拼接，否则拼接失败。</p>
<p>  问题：合成后的图片拼接部分可能扭曲</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/03/19/blog_idx_057/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/03/19/blog_idx_057/" class="post-title-link" itemprop="url">C++11 中运行代码块耗时的方法以及坑（chrono 方法）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-03-19 11:18:21" itemprop="dateCreated datePublished" datetime="2018-03-19T11:18:21+08:00">2018-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>996</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 15:46:16
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=057） 
&emsp;&emsp;本文发布于 2018-03-19 11:18:21，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=057） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="chrono">chrono</h3>
<hr>
<br/>
<br/>
<h5 id="chrono-简介：">chrono 简介：</h5>
<p>  来源：<a target="_blank" rel="noopener" href="http://www.cplusplus.com/reference/chrono/?kw=chrono">http://www.cplusplus.com/reference/chrono/?kw=chrono</a></p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">The elements in this header deal with time. This is done mainly by means of three concepts:
Durations
They measure time spans, like: one minute, two hours, or ten milliseconds.
In this library, they are represented with objects of the duration class template, that couples a count representation and a period precision (e.g., ten milliseconds has ten as count representation and milliseconds as period precision).
Time points
A reference to a specific point in time, like one's birthday, today's dawn, or when the next train passes.
In this library, objects of the time_point class template express this by using a duration relative to an epoch (which is a fixed point in time common to all time_point objects using the same clock).
Clocks
A framework that relates a time point to real physical time.
The library provides at least three clocks that provide means to express the current time as a time_point: system_clock, steady_clock and high_resolution_clock.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="对我来看：">对我来看：</h5>
<p>  3种计时方式以及一个时间转换方式就ok，分别对应：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">计时方式：
std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>high_resolution_clock <span class="token comment">//high_resolution_clock is the clock with the shortest tick period. It may be a synonym for system_clock or steady_clock.</span>
std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock <span class="token comment">//Specifically, system_clock is a system-wide realtime clock.</span>
std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>steady_clock <span class="token comment">//steady_clock is specifically designed to calculate time intervals.</span>
时间转换方式：
std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>duration_cast
<span class="token comment">/*
Converts the value of dtn into some other duration type, taking into account differences in their periods.

The function does not use implicit conversions. Instead, all count values are internally converted into the widest representation (the common_type for the internal count types) and then casted to the destination type, all conversions being done explicitly with static_cast.
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="chrono-大法中的坑（不同的时钟计时存在ms及us及ns级别的差别）">chrono 大法中的坑（不同的时钟计时存在ms及us及ns级别的差别）</h5>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">//windows下，std::chrono::system_clock 可能计时不准确，注意这里是“”“”可能“”“”
//windows下，high_resolution_clock 时间计时最精确，如果需要最高精确度，请使用此时钟
//总结：
//1 如果是秒级时间评估，std::chrono::system_clock 无所谓，如果是ms、us、ns级的时间评估(这里我做算法评估)，那么std::chrono::system_clock可能会出现较大的问题，这时候可用high_resolution_clock来解决此问题。
//2 如果计时应用在了多个线程，你需要把所有线程的计时加起来，才是你的真正耗时
//同时我猜测，出现此问题的原因就是不同时钟类型用的时间片(就是对应不同类型的一个时钟周期)是不一样的。当然，有一些cpu相关知识的朋友应该知道，最准确的计时是：时间片=cpu时钟周期（这是不合理的，理解到一部分就行了）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="chrono-计时方法">chrono 计时方法</h5>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//代码点一</span>
std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>time_point<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>high_resolution_clock<span class="token operator">></span> p0 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>high_resolution_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ....... 若干代码</span>
<span class="token comment">//代码点二</span>
std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>time_point<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>high_resolution_clock<span class="token operator">></span> p1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>high_resolution_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//计算及打印耗时，用法不太标准,文中的1000 是换算到毫秒的意思</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"stitch high_resolution_clock time:"</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">duration_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>microseconds<span class="token operator">></span></span></span><span class="token punctuation">(</span>p1 <span class="token operator">-</span> p0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ms"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/03/10/blog_idx_056/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/03/10/blog_idx_056/" class="post-title-link" itemprop="url">HISI3520DV300 折腾记录(二)之《内存映射、存储(DDRC,FMC)、启动模式分析》</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-03-10 10:12:11" itemprop="dateCreated datePublished" datetime="2018-03-10T10:12:11+08:00">2018-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 15:41:39
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=056） 
&emsp;&emsp;本文发布于 2018-03-10 10:12:11，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=056） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  此文分析基于某HISI3520DV300单板以及所带的datasheet</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="启动分析">启动分析</h3>
<hr>
<p>  关于其启动方式有如图说明：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/bootmode.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  解释：支持bootrom和SPI Flash两种启动方式，由BOOTROM_SEL引脚决定。bootrom是海思已经写好的程序烧写在里面，支持和其自身所写的PC软件进行串口通信。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="存储模块（DDRC-FMC）">存储模块（DDRC,FMC）</h3>
<hr>
<br/>
<br/>
<h5 id="DDRC（hisi3520dv300-支持16bit数据读写）">DDRC（hisi3520dv300 支持16bit数据读写）</h5>
<p>  SDRAM信息：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>此板子的SDRAM型号为：k4b2g1646q-bck0</p>
</li>
<li class="lvl-2">
<p>此SDRAM相关信息如图：</p>
</li>
</ul>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/sdram.png" alt="rep_img"/></center>
    </div>
</div>   
<ul class="lvl-0">
<li class="lvl-2">
<p>容量：2Gbit (就是256MByte)</p>
</li>
<li class="lvl-2">
<p>数据宽度：16bit</p>
</li>
<li class="lvl-2">
<p>banks:8</p>
</li>
<li class="lvl-2">
<p>每bank大小：128MBbit</p>
</li>
</ul>
<p>  DDRC信息：</p>
<p>连线：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/ddr.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  地址线分配：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/addr.png" alt="rep_img"/></center>
    </div>
</div>   
<ul class="lvl-0">
<li class="lvl-2">
<p>DDR_BA：3bit</p>
</li>
<li class="lvl-2">
<p>DDR_R:14bit</p>
</li>
<li class="lvl-2">
<p>DDR_C:10</p>
</li>
</ul>
<p>  并且只支持RBC地址映射模式(行地址+bank+列地址+数据宽度)</p>
<p>  于是此板子SDRAM：2^(14+3+10+1)=256MB</p>
<br/>
<br/>
<h5 id="FMC">FMC</h5>
<p>  NAND信息：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>此板子NAND型号为：mx25l256fz2</p>
</li>
<li class="lvl-2">
<p>此型号相关信息为：</p>
</li>
</ul>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/nand.png" alt="rep_img"/></center>
    </div>
</div>
<p>  FMC信息：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/fmc.png" alt="rep_img"/></center>
    </div>
</div>
<p>  于是此板子NAND大小为256MBits</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="内存映射（最重要，所有的一切都基于此）">内存映射（最重要，所有的一切都基于此）</h3>
<hr>
<p>  地址映射图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/map.png" alt="rep_img"/></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/map1.png" alt="rep_img"/></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/map2.png" alt="rep_img"/></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/map3.png" alt="rep_img"/></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/map4.png" alt="rep_img"/></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/map5.png" alt="rep_img"/></center>
    </div>
</div>
<p>  关于0x8000 0000—0xFFFF FFFF此地址空间是分配给SDRAM用的（也就是我们说的内存）</p>
<p>  关于0x0000 0000—0x03FF FFFF：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>在地址映射时：这64MB指向启动地址空间。</p>
</li>
<li class="lvl-2">
<p>在地址映射取消时：指向片内的16KB 空间。</p>
</li>
</ul>
<p><font color = red size = 5 >下文纯属我的“猜测”，因为其提供的文档说明极不详细：首先关于其Start.S的某段：</font></p>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">normal_start_flow:

       	@if running not boot from  spi&#x2F;nand&#x2F;ddr ram,
		@we skipping boot_type checking.
		&#x2F;*
		0x1400_0000:SFC NAND&#x2F;NOR MEMORY
地址空间
		*&#x2F;
    	mov    r0, pc, lsr#24
    	cmp    r0, #0x0
    	bne    do_clr_remap

check_boot_type:
        ldr     r0, &#x3D;SYS_CTRL_REG_BASE
        ldr     r0, [r0, #REG_SYSSTAT]
        mov     r6, r0, lsr#4
	and     r6, #0x1
	&#x2F;*
		此处可能有个错误，按照datasheet应该右移31bit才行
	*&#x2F;
        cmp     r6, #0			@ [4] &#x3D; 0 FMC &#x2F;* spi nor | spi nand *&#x2F;
        ldreq   pc, _clr_remap_fmc_entry
     &#x2F;*
	这里应该永久跳转才对，不然就卡死了。结合下文内容，感觉应该右移31位才对。
*&#x2F;

	@otherwise, [31]&#x3D;1 means boot from bootrom, err
	beq	bug<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><font color = red size = 5 >文中的REG_SYSSTAT寄存器在datasheet中的说明如下：</font></p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/reg_sys.png" alt="rep_img"/></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/reg_sys1.png" alt="rep_img"/></center>
    </div>
</div>
<p><font color = red size = 5 >关于“”启动地址空间“这个词语，我猜测是来至于：0x1400 0000—0x14FF FFFF</font></p>
<p><font color = red size = 5 >关于其FMC还有一句话：</font></p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_056/fmc_desc.png" alt="rep_img"/></center>
    </div>
</div>
<p><font color = red size = 5 >这部分说：CPU可以直接读取的最大1MB的数据。</font></p>
<p><font color = red size = 5 >所以对于NAND，直接上电时，NAND器件中的16MB被硬件默认映射到0x1400 0000—0x14FF FFFF这个地址（或者换句话说：0x1400 0000—0x14FF FFFF就是NAND器件中起始16MB这时候的地址），且当cpu上电时，根据内存映射寄存器的值，确定默认是开启内存映射的，于是，0x1400 0000—0x14FF FFFF被映射到了0x0000 0000 0x00FF FFFF中，这个时候PC指向0x0000 0000 开始执行指令。也就是前文所说的：b reset</font></p>
<p><font color = red size = 5 >注意：以上关于NAND启动原理，纯属我的猜测，因为它的datasheet文档确实感觉不够详细。</font></p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/03/09/blog_idx_055/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/03/09/blog_idx_055/" class="post-title-link" itemprop="url">HISI3520DV300 折腾记录（一）之 《Uboot-Start.S分析 以及 相关启动流程分析》</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-03-09 16:54:53" itemprop="dateCreated datePublished" datetime="2018-03-09T16:54:53+08:00">2018-03-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>12 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 18:49:40
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=055） 
&emsp;&emsp;本文发布于 2018-03-09 16:54:53，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=055） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  uboot版本：2010.06</p>
<p>  前置资料：HISI3520DV300的某单板提供的SDK（datasheet，原理图）。</p>
<h3 id="前言">前言</h3>
<hr>
<p>  由于需求，需要对某板子的内存容量，以及Nand容量进行可能的“”软“”变更。（不修改硬件的情况下），于是需要研究此板子的启动模式以及内存映射相关的东西，并得到，变更后的设置，对整个系统有哪些影响。</p>
<p>  根据以上的需求，我对其Uboot启动过程进行了粗略的研究。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="执行指令流程分析：">执行指令流程分析：</h3>
<hr>
<p>  本文中的分析流程是CPU从没电到上电，uboot从nand中加载执行的过程。</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">cpu上电
------------------------->
b	reset @进svc，关mmu，关cache
------------------------->
bne	normal_start_flow
------------------------->
bne    do_clr_remap @关闭remap（remap关闭后，0x0000 0000 - 0x03ff ffff指向片内ram，实际只有4kb），打开cache
------------------------->
bl      init_registers@ppl，mmu 等等
------------------------->
init_registers函数结束后，调用bx	lr
跳转到relocate:标号
------------------------->
搬运异常向量表到片内ram，参考copy_exception_table:标号
------------------------->
在copy_exception_table:标号中，根据_start 和 _TEXT_BASE的值，来判断uboot需不需要搬运
------------------------->
copy_loop: 开始搬运uboot到_TEXT_BASE
------------------------->
stack_setup:建立堆栈和相关的信息内存区域
------------------------->
跳转到C部分继续执行。_start_armboot：
-------------------------><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><font color = red size = 5 >注意：若想知道根据相关寄存器的值为何是这样跳转的，请参考本系列后续文章中硬件相关的分析，或者自己在datasheet上去找相关内容.这里还是要吐槽一下：海思datasheet写的有点水，好多都一概而过，没有详细的解释或者举例分析，所以我的分析也可能是有误的，更准确内容估计只有联系官方的人员了。（但是官方可能不理我们这样的小白@！！@）</font></p>
<h5 id="我添加注释的Start-S文件如下：">我添加注释的Start.S文件如下：</h5>
<p>  （可能会有错，因为我没有理解到位或者其提供的datasheet介绍并不详细）</p>
<p>  在此目录下：u-boot-2010.06\arch\arm\cpu\hi3521a</p>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">&#x2F;*
 * armboot - Startup Code for OMAP3530&#x2F;ARM Cortex CPU-core
 *
 * Copyright (c) 2004	Texas Instruments &lt;r-woodruff2@ti.com&gt;
 *
 * Copyright (c) 2001	Marius Gr枚ger &lt;mag@sysgo.de&gt;
 * Copyright (c) 2002	Alex Z眉pke &lt;azu@sysgo.de&gt;
 * Copyright (c) 2002	Gary Jennejohn &lt;garyj@denx.de&gt;
 * Copyright (c) 2003	Richard Woodruff &lt;r-woodruff2@ti.com&gt;
 * Copyright (c) 2003	Kshitij &lt;kshitij@ti.com&gt;
 * Copyright (c) 2006-2008 Syed Mohammed Khasim &lt;x0khasim@ti.com&gt;
 *
 * See file CREDITS for list of people who contributed to this
 * project.
 *
 * This program is free software; you can redistribute it and&#x2F;or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation; either version 2 of
 * the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston,
 * MA 02111-1307 USA
 *&#x2F;

#include &lt;config.h&gt;
#include &lt;version.h&gt;

&#x2F;*
 *************************************************************************
 *
 * Jump vector table as in table 3.1 in [1]
 *
 *************************************************************************
 *&#x2F;


.globl _start
_start: b	reset
	ldr	pc, _undefined_instruction
	ldr	pc, _software_interrupt
	ldr	pc, _prefetch_abort
	ldr	pc, _data_abort
	ldr	pc, _not_used
	ldr	pc, _irq
	ldr	pc, _fiq

&#x2F;*

LDR &lt;reg&gt;, &#x3D; &lt;constant-expression&gt;

*&#x2F;

_undefined_instruction: .word undefined_instruction
_software_interrupt:	.word software_interrupt
_prefetch_abort:	.word prefetch_abort
_data_abort:		.word data_abort
_not_used:		.word not_used
_irq:			.word irq
_fiq:			.word fiq
_pad:			.word 0x12345678 &#x2F;* now 16*4&#x3D;64 *&#x2F;
	&#x2F;*
	.fill	repeat&#123;,   size&#125;&#123;,	 value&#125;
	Repeat：重复填充的次数
	Size：每次填充的字节，默认为1
	Value：所填充的数据，默认为0
	定义重复内存单元
	
	*&#x2F;

__blank_zone_start:
.fill 1024*4,1,0
__blank_zone_end:

.globl _blank_zone_start
_blank_zone_start:
.word __blank_zone_start


.globl _blank_zone_end
_blank_zone_end:
.word __blank_zone_end

	.balignl 16,0xdeadbeef

&#x2F;*
后面的代码，16byte对齐，不足用0xdeadbeef来填充，此值网上大部分说就是&quot;坏牛肉&quot;的意思,无特定含义，估计方便记忆
*&#x2F;
&#x2F;*************************************************************************
 *
 * Startup Code (reset vector)
 *
 * do important init only if we don&#39;t start from memory!
 * setup Memory and board specific bits prior to relocation.
 * relocate armboot to ram
 * setup stack
 *
 *************************************************************************&#x2F;

_TEXT_BASE:
	.word	TEXT_BASE

.globl _armboot_start
_armboot_start:
	.word _start

&#x2F;*
 * These are defined in the board-specific linker script.
 *&#x2F;
.globl _bss_start
_bss_start:
	.word __bss_start

.globl _bss_end
_bss_end:
	.word _end

#ifdef CONFIG_USE_IRQ
&#x2F;* IRQ stack memory (calculated at run-time) *&#x2F;
.globl IRQ_STACK_START
IRQ_STACK_START:
	.word	0x0badc0de

&#x2F;* IRQ stack memory (calculated at run-time) *&#x2F;
.globl FIQ_STACK_START
FIQ_STACK_START:
	.word 0x0badc0de
#endif

_clr_remap_fmc_entry:
    .word   FMC_TEXT_ADRS + do_clr_remap - TEXT_BASE

&#x2F;*
 * the actual reset code
 *&#x2F;

reset:
	&#x2F;*
	 * set the cpu to SVC32 mode
	 *&#x2F;
	mrs	r0, cpsr
	bic	r0, r0, #0x1f &#x2F;&#x2F;&#x2F;&#x2F;将 r0 的低 6 位清零，进入 ARM 状态（bit5） 
	orr	r0, r0, #0xd3 &#x2F;&#x2F;&#x2F;&#x2F;将 r0 低八位置位 0x11010011，禁止 IRQ、FIQ，进 入 SVC 模式
&#x2F;*
cpsr[4:0] &#x3D; 0 0011(svc)
*&#x2F;
	msr	cpsr,r0

	&#x2F;*
	 * Invalidate L1 I&#x2F;D
	 *&#x2F;
	mov	r0, #0			@ set up for MCR
	mcr	p15, 0, r0, c8, c7, 0	@ invalidate TLBs
	mcr	p15, 0, r0, c7, c5, 0	@ invalidate icache
&#x2F;*
MCR   ARM寄存器到协处理器寄存器的数据传送
MRC   协处理器寄存器到ARM寄存器的数据传送
*&#x2F;
	&#x2F;*
	 * disable MMU stuff and caches
	 *&#x2F;
	mrc	p15, 0, r0, c1, c0, 0
&#x2F;*

BIC 是 逻辑”与非” 指令, 实现的 Bit Clear的功能

*&#x2F;
	bic	r0, r0, #0x00002000	@ clear bits 13 (--V-)
	bic	r0, r0, #0x00000007	@ clear bits 2:0 (-CAM)
	orr	r0, r0, #0x00000002	@ set bit 1 (--A-) Align
	orr	r0, r0, #0x00000800	@ set bit 11 (Z---) BTB
&#x2F;*
ORR指令用于在两个操作数上进行逻辑戒运算，并把结果放置到目的寄存器中。操作数1应该是一
个寄存器，操作数2可以是一个寄存器，被移位的寄存器，或一个立即数。该指令常用于设置操
作数1的某些位。

*&#x2F;
	mcr	p15, 0, r0, c1, c0, 0

	&#x2F;*
	 *  read system register REG_SC_GEN2
         *  check if ziju flag
	 *&#x2F;
	ldr	r0, &#x3D;SYS_CTRL_REG_BASE
    ldr	r1, [r0, #REG_SC_GEN2]
    &#x2F;*
		addr:0x12050140 ------&gt; sp
	*&#x2F;
	ldr	r2, &#x3D;0x7a696a75          &#x2F;* magic for &quot;ziju&quot; *&#x2F;
	cmp	r1, r2
	bne	normal_start_flow
	&#x2F;*
	Assume nomal start
	*&#x2F;
	mov	r1, sp                   &#x2F;* save sp *&#x2F;
	str	r1, [r0, #REG_SC_GEN2]  &#x2F;* clear ziju flag *&#x2F;

	&#x2F;* init PLL&#x2F;DDRC&#x2F;pin mux&#x2F;... *&#x2F;
	ldr	r0, _blank_zone_start
	ldr	r1, _TEXT_BASE
	sub	r0, r0, r1
	ldr	r1, &#x3D;RAM_START_ADRS
	add	r0, r0, r1
	mov	r1, #0x0                 &#x2F;* flags: 0-&gt;normal 1-&gt;pm *&#x2F;
	bl	init_registers           &#x2F;* init PLL&#x2F;DDRC&#x2F;... *&#x2F;

	&#x2F;* after ziju, we need ddr traning *&#x2F;
#ifdef CONFIG_DDR_TRAINING_V2
	ldr	sp, &#x3D;STACK_TRAINING
	ldr	r0, &#x3D;REG_BASE_SCTL
	bl	start_ddr_training       &#x2F;* DDR training *&#x2F;
#endif

	ldr	r0, &#x3D;SYS_CTRL_REG_BASE
    	ldr	r1, [r0, #REG_SC_GEN2]
	mov	sp, r1		         &#x2F;* restore sp *&#x2F;
    	ldr	r1, [r0, #REG_SC_GEN3]
	mov	pc, r1                   &#x2F;* return to bootrom *&#x2F;
	nop
	nop
	nop
	nop
	nop
	nop
	nop
	nop
	b	.                        &#x2F;* bug here *&#x2F;

normal_start_flow:

       	@if running not boot from  spi&#x2F;nand&#x2F;ddr ram,
		@we skipping boot_type checking.
		&#x2F;*
		0x1400_0000:SFC NAND&#x2F;NOR MEMORY
地址空间
		*&#x2F;
    	mov    r0, pc, lsr#24
    	cmp    r0, #0x0
    	bne    do_clr_remap

check_boot_type:
        ldr     r0, &#x3D;SYS_CTRL_REG_BASE
        ldr     r0, [r0, #REG_SYSSTAT]
        mov     r6, r0, lsr#4
	and     r6, #0x1
	&#x2F;*
		此处可能有个错误，按照datasheet应该右移31bit才行
	*&#x2F;
        cmp     r6, #0			@ [4] &#x3D; 0 FMC &#x2F;* spi nor | spi nand *&#x2F;
        ldreq   pc, _clr_remap_fmc_entry

	@otherwise, [31]&#x3D;1 means boot from bootrom, err
	beq	bug

do_clr_remap:
        &#x2F;* do clear remap *&#x2F;
    	ldr     r4, &#x3D;SYS_CTRL_REG_BASE
	ldr 	r0, [r4, #REG_SC_CTRL]
		&#x2F;&#x2F;REG_SC_CTRL reset_value:0x0000_0212,REG_SC_CTRL[9]&#x3D;1,enable remap
    	@Set clear remap bit.
    	orr 	r0, #(1&lt;&lt;8)
    	str 	r0, [r4, #REG_SC_CTRL]

	&#x2F;*
	 * Set ACTLR.SMP to 1
	 * This is a bug on Cortex-A7 MPCORE. see buglist of Cortex-A7
	 * The D-caches are disabled when ACTLR.SMP is set to 0 regardless of
	 * the value of the cache enable bit. so we must set SMP bit of ACTLR
	 * register before enable D-cache
	 *&#x2F;
	mrc     p15, 0, r0, c1, c0, 1
	orr     r0, #(1 &lt;&lt; 6)
	mcr     p15, 0, r0, c1, c0, 1

	@enable I-Cache now
 	mrc p15, 0, r0, c1, c0, 0
        orr r0, r0, #0x00001000 &#x2F;* set bit 12 (I) I-Cache *&#x2F;
        mcr p15, 0, r0, c1, c0, 0
	isb

	@Check wether I am running in dynamic mem bank
	mov r0, pc, lsr#28
	cmp r0, #8
	bleq    relocate

	ldr     r0, _blank_zone_start
	ldr     r1, _TEXT_BASE
	sub     r0, r0, r1
	adrl    r1, _start
	add     r0, r0, r1
	mov     r1, #0          &#x2F;* flags: 0-&gt;normal 1-&gt;pm *&#x2F;
	bl      init_registers
#ifdef CONFIG_DDR_TRAINING_V2
	ldr	sp, &#x3D;STACK_TRAINING
	ldr	r0, &#x3D;REG_BASE_SCTL
	bl	start_ddr_training       &#x2F;* DDR training *&#x2F;
#endif

#ifndef CONFIG_SKIP_RELOCATE_UBOOT

&#x2F;*
0x0000 0000 0x03ff ffff
地址重映射时：此地址指向
启动地址空间。
地址重映射撤销后：此地址
空间指向片内RAM

*&#x2F;
relocate:
	@copy arm exception table in 0 address
	adrl	r0, _start
	mov	r1, #0
	mov	r2, #0x100		&#x2F;* copy arm Exception table to 0 addr *&#x2F;
	add     r2, r0, r2
copy_exception_table:
	ldmia   r0!, &#123;r3 - r10&#125;
	stmia   r1!, &#123;r3 - r10&#125;
	cmp     r0, r2
	ble     copy_exception_table

	@ relocate U-Boot to RAM
	adrl	r0, _start		@ r0 &lt;- current position of code
	ldr	r1, _TEXT_BASE		@ test if we run from flash or RAM
	cmp	r0, r1			@ don t reloc during debug,
	&#x2F;&#x2F;I think ifeq may means jtag-mode(arm on chip debug) 
	beq	stack_setup

	ldr	r2, _armboot_start
	ldr	r3, _bss_start
	&#x2F;*
	Text segment
	*&#x2F;
	sub	r2, r3, r2		@ r2 &lt;- size of armboot
	add	r2, r0, r2		@ r2 &lt;- source end address

copy_loop:				@ copy 32 bytes at a time
	ldmia	r0!, &#123;r3 - r10&#125;		@ copy from source address [r0]
	stmia	r1!, &#123;r3 - r10&#125;		@ copy to   target address [r1]
	cmp	r0, r2			@ until source end addreee [r2]
	ble	copy_loop
#endif	&#x2F;* CONFIG_SKIP_RELOCATE_UBOOT *&#x2F;

	&#x2F;* Set up the stack *&#x2F;
stack_setup:
	ldr	r0, _TEXT_BASE		@ upper 128 KiB: relocated uboot
	sub	r0, r0, #CONFIG_SYS_MALLOC_LEN @ malloc area
	sub	r0, r0, #CONFIG_SYS_GBL_DATA_SIZE @ bdinfo
#ifdef CONFIG_USE_IRQ
	sub	r0, r0, #(CONFIG_STACKSIZE_IRQ + CONFIG_STACKSIZE_FIQ)
#endif
	sub	sp, r0, #12		@ leave 3 words for abort-stack
	and	sp, sp, #~7		@ 8 byte alinged for (ldr&#x2F;str)d

	&#x2F;* Clear BSS (if any). Is below tx (watch load addr - need space) *&#x2F;
clear_bss:
	ldr	r0, _bss_start		@ find start of bss segment
	ldr	r1, _bss_end		@ stop here
	mov	r2, #0x0		@ clear value
clbss_l:
	str	r2, [r0]		@ clear BSS location
	cmp	r0, r1			@ are we at the end yet
	add	r0, r0, #4		@ increment clear index pointer
	bne	clbss_l			@ keep clearing till at end

	ldr	pc, _start_armboot	@ jump to C code

_start_armboot: .word start_armboot

bug:

	nop
	nop
	nop
	nop
	nop
	nop
	nop
	nop
	b	.			&#x2F;* bug here *&#x2F;

&#x2F;*
 *************************************************************************
 *
 * Interrupt handling
 *
 *************************************************************************
 *&#x2F;
@
@ IRQ stack frame.
@
#define S_FRAME_SIZE	72

#define S_OLD_R0	68
#define S_PSR		64
#define S_PC		60
#define S_LR		56
#define S_SP		52

#define S_IP		48
#define S_FP		44
#define S_R10		40
#define S_R9		36
#define S_R8		32
#define S_R7		28
#define S_R6		24
#define S_R5		20
#define S_R4		16
#define S_R3		12
#define S_R2		8
#define S_R1		4
#define S_R0		0

#define MODE_SVC 0x13
#define I_BIT	 0x80

&#x2F;*
 * use bad_save_user_regs for abort&#x2F;prefetch&#x2F;undef&#x2F;swi ...
 * use irq_save_user_regs &#x2F; irq_restore_user_regs for IRQ&#x2F;FIQ handling
 *&#x2F;

	.macro	bad_save_user_regs
	sub	sp, sp, #S_FRAME_SIZE		@ carve out a frame on current
						@ user stack
	stmia	sp, &#123;r0 - r12&#125;			@ Save user registers (now in
						@ svc mode) r0-r12

	ldr	r2, _armboot_start
	sub	r2, r2, #(CONFIG_SYS_MALLOC_LEN)
	@ set base 2 words into abort
	sub	r2, r2, #(CONFIG_SYS_GBL_DATA_SIZE + 8)
						@ stack
	ldmia	r2, &#123;r2 - r3&#125;			@ get values for &quot;aborted&quot; pc
						@ and cpsr (into parm regs)
	add	r0, sp, #S_FRAME_SIZE		@ grab pointer to old stack

	add	r5, sp, #S_SP
	mov	r1, lr
	stmia	r5, &#123;r0 - r3&#125;			@ save sp_SVC, lr_SVC, pc, cpsr
	mov	r0, sp				@ save current stack into r0
						@ (param register)
	.endm

	.macro	irq_save_user_regs
	sub	sp, sp, #S_FRAME_SIZE
	stmia	sp, &#123;r0 - r12&#125;			@ Calling r0-r12
	add	r8, sp, #S_PC			@ !! R8 NEEDS to be saved !!
						@ a reserved stack spot would
						@ be good.
	stmdb	r8, &#123;sp, lr&#125;^			@ Calling SP, LR
	str	lr, [r8, #0]			@ Save calling PC
	mrs	r6, spsr
	str	r6, [r8, #4]			@ Save CPSR
	str	r0, [r8, #8]			@ Save OLD_R0
	mov	r0, sp
	.endm

	.macro	irq_restore_user_regs
	ldmia	sp, &#123;r0 - lr&#125;^			@ Calling r0 - lr
	mov	r0, r0
	ldr	lr, [sp, #S_PC]			@ Get PC
	add	sp, sp, #S_FRAME_SIZE
	subs	pc, lr, #4			@ return &amp; move spsr_svc into
						@ cpsr
	.endm

	.macro get_bad_stack
	ldr	r13, _armboot_start		@ setup our mode stack (enter
						@ in banked mode)
	@ move past malloc pool
	sub	r13, r13, #(CONFIG_SYS_MALLOC_LEN)
	@ move to reserved a couple
	sub	r13, r13, #(CONFIG_SYS_GBL_DATA_SIZE + 8)
						@ spots for abort stack

	str	lr, [r13]			@ save caller lr in position 0
						@ of saved stack
	mrs	lr, spsr			@ get the spsr
	str	lr, [r13, #4]			@ save spsr in position 1 of
						@ saved stack

	mov	r13, #MODE_SVC			@ prepare SVC-Mode
	@ msr	spsr_c, r13
	msr	spsr, r13			@ switch modes, make sure
						@ moves will execute
	mov	lr, pc				@ capture return pc
	movs	pc, lr				@ jump to next instruction &amp;
						@ switch modes.
	.endm

	.macro get_bad_stack_swi
	sub	r13, r13, #4			@ space on current stack for
						@ scratch reg.
	str	r0, [r13]			@ save R0‘s value.
	ldr	r0, _armboot_start		@ get data regions start
	@ move past malloc pool
	sub	r0, r0, #(CONFIG_SYS_MALLOC_LEN)
	@ move past gbl and a couple
	sub	r0, r0, #(CONFIG_SYS_GBL_DATA_SIZE + 8)
						@ spots for abort stack
	str	lr, [r0]			@ save caller lr in position 0
						@ of saved stack
	mrs	r0, spsr			@ get the spsr
	str	lr, [r0, #4]			@ save spsr in position 1 of
						@ saved stack
	ldr	r0, [r13]			@ restore r0
	add	r13, r13, #4			@ pop stack entry
	.endm

	.macro get_irq_stack			@ setup IRQ stack
	ldr	sp, IRQ_STACK_START
	.endm

	.macro get_fiq_stack			@ setup FIQ stack
	ldr	sp, FIQ_STACK_START
	.endm

&#x2F;*
 * exception handlers
 *&#x2F;
	.align	5
undefined_instruction:
	get_bad_stack
	bad_save_user_regs
	bl	do_undefined_instruction

	.align	5
software_interrupt:
	get_bad_stack_swi
	bad_save_user_regs
	bl	do_software_interrupt

	.align	5
prefetch_abort:
	get_bad_stack
	bad_save_user_regs
	bl	do_prefetch_abort

	.align	5
data_abort:
	get_bad_stack
	bad_save_user_regs
	bl	do_data_abort

	.align	5
not_used:
	get_bad_stack
	bad_save_user_regs
	bl	do_not_used

#ifdef CONFIG_USE_IRQ

	.align	5
irq:
	get_irq_stack
	irq_save_user_regs
	bl	do_irq
	irq_restore_user_regs

	.align	5
fiq:
	get_fiq_stack
	&#x2F;* someone ought to write a more effective fiq_save_user_regs *&#x2F;
	irq_save_user_regs
	bl	do_fiq
	irq_restore_user_regs

#else

	.align	5
irq:
	get_bad_stack
	bad_save_user_regs
	bl	do_irq

	.align	5
fiq:
	get_bad_stack
	bad_save_user_regs
	bl	do_fiq

#endif

&#x2F;*
 *	v7_flush_dcache_all()
 *
 *	Flush the whole D-cache.
 *
 *	Corrupted registers: r0-r5, r7, r9-r11
 *
 *	- mm	- mm_struct describing address space
 *&#x2F;
	.align 5
.global v7_flush_dcache_all
v7_flush_dcache_all:
	stmfd	r13!, &#123;r0 - r5, r7, r9 - r12, r14&#125;

	mov	r7, r0				@ take a backup of device type
	cmp	r0, #0x3			@ check if the device type is
						@ GP
	moveq r12, #0x1				@ set up to invalide L2
smi:	.word 0x01600070			@ Call SMI monitor (smieq)
	cmp	r7, #0x3			@ compare again in case its
						@ lost
	beq	finished_inval			@ if GP device, inval done
						@ above

	mrc	p15, 1, r0, c0, c0, 1		@ read clidr
	ands	r3, r0, #0x7000000		@ extract loc from clidr
	mov	r3, r3, lsr #23			@ left align loc bit field
	beq	finished_inval			@ if loc is 0, then no need to
						@ clean
	mov	r10, #0				@ start clean at cache level 0
inval_loop1:
	add	r2, r10, r10, lsr #1		@ work out 3x current cache
						@ level
	mov	r1, r0, lsr r2			@ extract cache type bits from
						@ clidr
	and	r1, r1, #7			@ mask of the bits for current
						@ cache only
	cmp	r1, #2				@ see what cache we have at
						@ this level
	blt	skip_inval			@ skip if no cache, or just
						@ i-cache
	mcr	p15, 2, r10, c0, c0, 0		@ select current cache level
						@ in cssr
	mov	r2, #0				@ operand for mcr SBZ
	mcr	p15, 0, r2, c7, c5, 4		@ flush prefetch buffer to
						@ sych the new cssr&amp;csidr,
						@ with armv7 this is &#39;isb&#39;,
						@ but we compile with armv5
	mrc	p15, 1, r1, c0, c0, 0		@ read the new csidr
	and	r2, r1, #7			@ extract the length of the
						@ cache lines
	add	r2, r2, #4			@ add 4 (line length offset)
	ldr	r4, &#x3D;0x3ff
	ands	r4, r4, r1, lsr #3		@ find maximum number on the
						@ way size
	clz	r5, r4				@ find bit position of way
						@ size increment
	ldr	r7, &#x3D;0x7fff
	ands	r7, r7, r1, lsr #13		@ extract max number of the
						@ index size
inval_loop2:
	mov	r9, r4				@ create working copy of max
						@ way size
inval_loop3:
	orr	r11, r10, r9, lsl r5		@ factor way and cache number
						@ into r11
	orr	r11, r11, r7, lsl r2		@ factor index number into r11
	mcr	p15, 0, r11, c7, c6, 2		@ invalidate by set&#x2F;way
	subs	r9, r9, #1			@ decrement the way
	bge	inval_loop3
	subs	r7, r7, #1			@ decrement the index
	bge	inval_loop2
skip_inval:
	add	r10, r10, #2			@ increment cache number
	cmp	r3, r10
	bgt	inval_loop1
finished_inval:
	mov	r10, #0				@ swith back to cache level 0
	mcr	p15, 2, r10, c0, c0, 0		@ select current cache level
						@ in cssr
	mcr	p15, 0, r10, c7, c5, 4		@ flush prefetch buffer,
						@ with armv7 this is &#39;isb&#39;,
						@ but we compile with armv5

	ldmfd	r13!, &#123;r0 - r5, r7, r9 - r12, pc&#125;

#include &quot;lowlevel_init.S&quot;

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  注意：关于Start.S我说明可能有错的地方，check_boot_type:标号附近，关于这里的详细说明，参考后续文章的内存映射部分。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/02/08/blog_idx_054/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/02/08/blog_idx_054/" class="post-title-link" itemprop="url">菜鸟角度简单分析BP算法（Error Back Propagation）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-02-08 15:15:00" itemprop="dateCreated datePublished" datetime="2018-02-08T15:15:00+08:00">2018-02-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">数据结构与算法</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/DL/" itemprop="url" rel="index"><span itemprop="name">DL</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>913</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 15:16:38
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=054） 
&emsp;&emsp;本文发布于 2018-02-08 15:15:00，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=054） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<ul class="lvl-0">
<li class="lvl-2">
<p>模型：就是一个函数G(I1,I2,…,In),此函数的作用就是给定In（输入数据）,就能够得到函数的值（打分）。</p>
</li>
<li class="lvl-2">
<p>损失函数：E(w1,w2,…,wn,b1…bn),此函数是由此网络中所有的权重为变量构成的。此函数的作用是描述在某组权重的和输入下，此网络的得分与标准值（标签）的误差。</p>
</li>
<li class="lvl-2">
<p>梯度：就是某变量（向量）在某方向上的变化率。</p>
</li>
<li class="lvl-2">
<p>网络训练过程：而在网络训练中，目标就得把此误差减小，提高准确率。</p>
</li>
</ul>
<br/>
<br/>
<br/>
<br/>
<h3 id="BP-分析">BP 分析</h3>
<hr>
<ol>
<li class="lvl-3">
<p>对BP的一个简单例子推导过程（此过程来至于网上的一篇文章，无复杂的数学公式，注意抽象，示例图字丑，请忽略）</p>
</li>
</ol>
<p>  假设我定义此示例网络为：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_054/net.png" alt="rep_img"/></center>
    </div>
</div>    
<ol start="2">
<li class="lvl-3">
<p>定义前向推导为：</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_054/forward.png" alt="rep_img"/></center>
    </div>
</div>    
<ol start="3">
<li class="lvl-3">
<p>定义此网络的损失函数E为（也可以说是误差函数）：</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_054/loss.png" alt="rep_img"/></center>
    </div>
</div> 
<ol start="4">
<li class="lvl-3">
<p>对权重W5,求其相对于E的偏导，过程如下：</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_054/diff.png" alt="rep_img"/></center>
    </div>
</div> 
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_054/diff1.png" alt="rep_img"/></center>
    </div>
</div> 
<ol start="5">
<li class="lvl-3">
<p>对权重W1,求其相对于E的偏导，过程如下：</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_054/diff2.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  当我们得到dE/dW1,dE/dW2 … dE/dW8 ,dE/db1,dE/db2这些的值后，我们就可以更新这些参数，让E的输出更小，准确度越高。</p>
<p>  定义原参数为Po，定义更新参数为Pn,定义学习率为m,则参数更新过程为：<br>
Pn = Po - m*dE/dPo</p>
<p>  经过多次迭代后，E会越来越小，模型准确率越来越高。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  提示：个人认为对于一些数学原理相关的，还是动手自己推导一次，这样比单单看理解的快和深刻一点。这种方式非常适合我这种笨鸟。</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/01/18/blog_idx_053/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/01/18/blog_idx_053/" class="post-title-link" itemprop="url">x86 常见调用约定(cdecl,fastcall,stdcall) & x86和ARM调用约定的栈帧分析 & ARM ATPCS(ARM-THUMB procedure call standard)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-01-18 11:29:39" itemprop="dateCreated datePublished" datetime="2018-01-18T11:29:39+08:00">2018-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/C-CPP/%E5%B8%B8%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">常识</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 18:47:22
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=053） 
&emsp;&emsp;本文发布于 2018-01-18 11:29:39，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=053） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  X86:gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.5)</p>
<p>  ARM:gcc version 4.8.3 20131202 (prerelease) (Hisilicon_v400)</p>
<h3 id="前言">前言</h3>
<hr>
<p>  由于某些工作的需要，我需要掌握X86以及ARM的一些调用规则，让自己可以大致看懂ASM代码。于是，我总结了一下我需要的东西。</p>
<p>  <em><strong>调用约定有啥用？</strong></em></p>
<p>  对于现在习惯使用高级程序的人来说，这一切都是闲的蛋疼才会去看这些，不止浪费时间，还浪费表情。但对于有需求使用ASM+C或者C艹的混合编程或者纯ASM编程的时候，这就得注意这些了。因为这代表着你的目标能否成功的问题。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="x86-常见调用以及对应的栈帧分析">x86 常见调用以及对应的栈帧分析</h3>
<hr>
<br/>
<br/>
<h5 id="cdecl用在C-C-，MFC的默认方式，-可变参数">cdecl用在C/C++，MFC的默认方式， 可变参数</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//cdecl</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span>
<span class="token keyword">int</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cdecl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">Func2</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> c<span class="token punctuation">,</span> <span class="token keyword">int</span> d<span class="token punctuation">,</span> <span class="token keyword">int</span> e<span class="token punctuation">,</span> <span class="token keyword">int</span> f<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	
	<span class="token keyword">int</span> aa<span class="token punctuation">;</span>
	<span class="token keyword">int</span> bb<span class="token punctuation">;</span>
	<span class="token keyword">int</span> cc<span class="token punctuation">;</span>
	<span class="token keyword">int</span> dd<span class="token punctuation">;</span>
	
	aa <span class="token operator">=</span> bb <span class="token operator">=</span> cc<span class="token operator">=</span> dd <span class="token operator">=</span> a<span class="token punctuation">;</span>	

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">@调用子程序过程
	pushl	$6
	pushl	$5
	pushl	$4
	pushl	$3
	pushl	$2
	pushl	$1
	call	Func2
	@call，eip入栈，跳转到子程序
	addl	$24, %esp
	@esp-24,清空临时栈<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">@子程序过程
.LFE1021:
	.size	Func1, .-Func1
	.globl	Func2
	.type	Func2, @function
Func2:
.LFB1022:
	.cfi_startproc
	pushl	%ebp
	@ebp入栈
	.cfi_def_cfa_offset 8
	.cfi_offset 5, -8
	movl	%esp, %ebp
	@esp赋值给ebp
	.cfi_def_cfa_register 5
	subl	$16, %esp
	@注意，虽然上面esp减16是由于有4个4byte的局部变量，但是如果不是4个局部变量，此版本的编译器是按照16byte*N(N取大于0的整数)来分配的局部栈。列如：3个4byte变量，局部栈大小是16bytes,5个4byte变量，局部栈大小为32bytes，其他类似方式分配，不要看不懂为啥多分配了，或者少分配了。
	movl	8(%ebp), %eax
	@a 赋值给eax
	movl	%eax, -16(%ebp)
	@ eax 赋值给dd
	movl	-16(%ebp), %eax
	movl	%eax, -12(%ebp)
	movl	-12(%ebp), %eax
	movl	%eax, -8(%ebp)
	movl	-8(%ebp), %eax
	movl	%eax, -4(%ebp)
	movl	$0, %eax
	@返回值放在eax
	leave
	@leave &#x3D; mov ebp,esp 以及 pop ebp
	.cfi_restore 5
	.cfi_def_cfa 4, 4
	ret
	@pop eip
	.cfi_endproc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  说明：按从右至左的顺序压参数入栈，由调用者把参数弹出栈。</p>
<p>  对子程序分析：其他详见注释。具体栈帧分布图，见下图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_053/stack.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<h5 id="stdcall，Win-API">stdcall，Win API</h5>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">extern &quot;C&quot;
int __attribute__((stdcall)) Func3(int a, int b, int c, int d, int e, int f)&#123;
	
	int aa;
	int bb;
	int cc;

	aa &#x3D; bb &#x3D; cc;		
	
	return 0;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">pushl	$6
pushl	$5
pushl	$4
pushl	$3
pushl	$2
pushl	$1
call	Func3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">.LFE1022:
	.size	Func2, .-Func2
	.globl	Func3
	.type	Func3, @function
Func3:
.LFB1023:
	.cfi_startproc
	pushl	%ebp
	.cfi_def_cfa_offset 8
	.cfi_offset 5, -8
	movl	%esp, %ebp
	.cfi_def_cfa_register 5
	subl	$16, %esp
	movl	-12(%ebp), %eax
	movl	%eax, -8(%ebp)
	movl	-8(%ebp), %eax
	movl	%eax, -4(%ebp)
	movl	$0, %eax
	leave
	.cfi_restore 5
	.cfi_def_cfa 4, 4
	ret	$24
	@pop eip , subl 24,esp
	.cfi_endproc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  说明：按从右至左的顺序压参数入栈，由被调用者从栈中弹出参数。</p>
<p>  其他参考见上文。</p>
<br/>
<br/>
<h5 id="fastcall，要求速度快">fastcall，要求速度快</h5>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">extern &quot;C&quot;
int __attribute__((fastcall)) Func4(int a, int b, int c, int d, int e, int f)&#123;
	
	int aa;
	int bb;
	int cc;

	aa &#x3D; bb &#x3D; cc;	

	return 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">pushl	$6
pushl	$5
pushl	$4
pushl	$3
movl	$2, %edx
movl	$1, %ecx
call	Func4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">.LFE1023:
	.size	Func3, .-Func3
	.globl	Func4
	.type	Func4, @function
Func4:
.LFB1024:
	.cfi_startproc
	pushl	%ebp
	.cfi_def_cfa_offset 8
	.cfi_offset 5, -8
	movl	%esp, %ebp
	.cfi_def_cfa_register 5
	subl	$24, %esp
	movl	%ecx, -20(%ebp)
	movl	%edx, -24(%ebp)
	movl	-12(%ebp), %eax
	movl	%eax, -8(%ebp)
	movl	-8(%ebp), %eax
	movl	%eax, -4(%ebp)
	movl	$0, %eax
	leave
	.cfi_restore 5
	.cfi_def_cfa 4, 4
	ret	$16
	.cfi_endproc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  说明：按从右至左的顺序压参数入栈，参数1，参数2通过ecx,edx传递，由被调用者从栈中弹出参数。</p>
<p>  其他参考见上文。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="ARM-ATPCS">ARM ATPCS</h3>
<hr>
<pre class="line-numbers language-none"><code class="language-none">extern &quot;C&quot;
int Func1(int a, int b, int c, int d, int e, int f)&#123;
	
	int aa;
	int bb;
	int cc;
	int dd;
	int ee;
	
	aa &#x3D; bb &#x3D; cc&#x3D; dd &#x3D; ee &#x3D; a;	

	return 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">mov	r3, #5
str	r3, [sp]
mov	r3, #6
str	r3, [sp, #4]
mov	r0, #1
mov	r1, #2
mov	r2, #3
mov	r3, #4
bl	Func1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">	.text
	.align	2
	.global	Func1
	.type	Func1, %function
Func1:
	.fnstart
.LFB971:
	@ args &#x3D; 8, pretend &#x3D; 0, frame &#x3D; 40
	@ frame_needed &#x3D; 1, uses_anonymous_args &#x3D; 0
	@ link register save eliminated.
	str	fp, [sp, #-4]!
	add	fp, sp, #0
	sub	sp, sp, #44
	str	r0, [fp, #-32]
	str	r1, [fp, #-36]
	str	r2, [fp, #-40]
	str	r3, [fp, #-44]
	ldr	r3, [fp, #-32]
	str	r3, [fp, #-8]
	ldr	r3, [fp, #-8]
	str	r3, [fp, #-12]
	ldr	r3, [fp, #-12]
	str	r3, [fp, #-16]
	ldr	r3, [fp, #-16]
	str	r3, [fp, #-20]
	ldr	r3, [fp, #-20]
	str	r3, [fp, #-24]
	mov	r3, #0
	mov	r0, r3
	sub	sp, fp, #0
	@ sp needed
	ldr	fp, [sp], #4
	bx	lr
	.cantunwind
	.fnend<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  分析：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>r15 PC The Program Counter.</p>
</li>
<li class="lvl-2">
<p>r14 LR The Link Register.</p>
</li>
<li class="lvl-2">
<p>r13 SP The Stack Pointer.</p>
</li>
<li class="lvl-2">
<p>r12 IP The Intra-Procedure-call scratch register. （可简单的认为暂存SP）</p>
</li>
<li class="lvl-2">
<p>R11 可选，被称为FP，即frame pointer。</p>
</li>
</ul>
<p>  其他分析见下图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_053/arm_stack.png" alt="rep_img"/></center>
    </div>
</div>   
<p><font color = red>特别说明：此图保留区域写错了，对于此编译器来说，应该是4个4bytes*N(N大于0的整数)的分配本地变量的方式</font></p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/01/09/blog_idx_052/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/01/09/blog_idx_052/" class="post-title-link" itemprop="url">Android JNI静态和动态注册 、Java Reflect（C或C++层反射和JAVA层反射）、Java 可变参数（JNI实现）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-01-09 09:13:35" itemprop="dateCreated datePublished" datetime="2018-01-09T09:13:35+08:00">2018-01-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/JAVA/" itemprop="url" rel="index"><span itemprop="name">JAVA</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/JAVA/%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">安全</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 15:00:22
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=052） 
&emsp;&emsp;本文发布于 2018-01-09 09:13:35，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=052） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  由于最近重新接触了部分Android相关的东西，对一些需要混合编程的手段做了整理，同时也对Java中常见的反射技术进行归纳总结。（本文适合知道JNI和反射是什么鬼的人阅读）(可变参数实现在JNI部分的IoctlGpio方法)</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Java-JNI">Java JNI</h3>
<hr>
<p>  Java native interface（java本地调用接口）主要是实现C或者C++和java交互。先来看一张来至于网上的图（如果侵权，请联系我，我会第一时间删除）</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_052/jvm_arch.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  此图说明了一个jvm中（一个进程中）所拥有的资源。而JNI就是用来实现调用本地方法的一种方法。而这些本地方法有两种方式可以被注册到jvm中，分别如下:</p>
<br/>
<br/>
<h5 id="JNI之静态注册">JNI之静态注册</h5>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Operate_Gpio</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token class-name">IoctlGpio</span><span class="token punctuation">(</span><span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token class-name">String</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token class-name">IoctlGpio</span><span class="token punctuation">(</span><span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token comment">//java static code</span>
	<span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"OperateGpio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
    <span class="token comment">//call IoctlGpio()</span>
  <span class="token class-name">Operate_Gpio</span> op_gpio <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Operate_Gpio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">op_gpio<span class="token punctuation">.</span></span>IoctlGpio</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">op_gpio<span class="token punctuation">.</span></span>IoctlGpio</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span>
JNIEXPORT jint JNICALL
<span class="token function">Java_JNI_Operate_1Gpio_IoctlGpio</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject instance<span class="token punctuation">,</span> jint cmd<span class="token punctuation">,</span>jobjectArray arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    jboolean iscopy<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            jint <span class="token operator">*</span>arg1 <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">GetIntArrayElements</span><span class="token punctuation">(</span><span class="token punctuation">(</span>jintArray<span class="token punctuation">)</span> arg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">NativeLog</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> <span class="token char">'D'</span><span class="token punctuation">,</span> <span class="token string">"Test string arg1"</span><span class="token punctuation">,</span>
                      <span class="token function">Int_to_String</span><span class="token punctuation">(</span>arg1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">NativeLog</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> <span class="token char">'D'</span><span class="token punctuation">,</span> <span class="token string">"Test string arg2"</span><span class="token punctuation">,</span>
                      <span class="token function">Int_to_String</span><span class="token punctuation">(</span>arg1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      env<span class="token operator">-></span><span class="token function">ReleaseIntArrayElements</span><span class="token punctuation">(</span><span class="token punctuation">(</span>jintArray<span class="token punctuation">)</span>arg<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            jstring arg3 <span class="token operator">=</span> <span class="token punctuation">(</span>jstring<span class="token punctuation">)</span> env<span class="token operator">-></span><span class="token function">GetObjectArrayElement</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jstring arg4 <span class="token operator">=</span> <span class="token punctuation">(</span>jstring<span class="token punctuation">)</span> env<span class="token operator">-></span><span class="token function">GetObjectArrayElement</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">NativeLog</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> <span class="token char">'D'</span><span class="token punctuation">,</span> <span class="token string">"Test string arg3"</span><span class="token punctuation">,</span>
                      env<span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>arg3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>iscopy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">NativeLog</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> <span class="token char">'D'</span><span class="token punctuation">,</span> <span class="token string">"Test string arg4"</span><span class="token punctuation">,</span>
                      env<span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>arg4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>iscopy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">default</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  说明：通过特定的函数命名方式（包名__类名__函数名）（若以上命名中含有_，将会通过在其后加一位数字方式来标识）来注册。当在java层调用System.loadLibrary，jvm会遍历这个so库的所有合法的方法，并放到本地方法栈，以供使用。</p>
<p>  缺点：</p>
<ol>
<li class="lvl-3">
<p>初次call本地函数时，需要先在jni下去搜索相关的jni函数，然后建立jni函数和native函数关系，导致效率降低</p>
</li>
<li class="lvl-3">
<p>使用规则复杂，不利于开发（不方便）。</p>
</li>
</ol>
<br/>
<br/>
<h5 id="JNI之动态注册">JNI之动态注册</h5>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Operate_Gpio</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span> <span class="token keyword">native</span>  <span class="token keyword">int</span> <span class="token class-name">TestGpio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//java static code</span>
	<span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"OperateGpio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

  <span class="token class-name">Operate_Gpio</span> op_gpio <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Operate_Gpio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token namespace">op_gpio<span class="token punctuation">.</span></span>TestGpio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/**
* Table of methods associated with a single class.
*/</span>
<span class="token comment">/*
 *
 * typedef struct &#123;
    const char* name;
    const char* signature;
    void*       fnPtr;
&#125; JNINativeMethod;
 * */</span>
<span class="token comment">// 结构体，分别是java层的函数名称，签名，对应的函数指针</span>
<span class="token keyword">static</span> JNINativeMethod gMethods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#123;</span> <span class="token string">"TestGpio"</span><span class="token punctuation">,</span> <span class="token string">"()I"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>TestGpio <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token comment">//绑定</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">registerNativeMethods</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> className<span class="token punctuation">,</span>
                                 JNINativeMethod<span class="token operator">*</span> gMethods<span class="token punctuation">,</span> <span class="token keyword">int</span> numMethods<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    jclass clazz<span class="token punctuation">;</span>
    clazz <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> JNI_FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">RegisterNatives</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> gMethods<span class="token punctuation">,</span> numMethods<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> JNI_FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> JNI_TRUE<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

JNIEXPORT jint JNICALL <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> reserved<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    JNIEnv<span class="token operator">*</span> env <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> vm<span class="token operator">-></span><span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> JNI_VERSION_1_4<span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>env <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">registerNativeMethods</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> JNIREG_CLASS<span class="token punctuation">,</span> gMethods<span class="token punctuation">,</span>
                               <span class="token keyword">sizeof</span><span class="token punctuation">(</span>gMethods<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>gMethods<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">/* success -- return valid version number */</span>
    <span class="token keyword">return</span> JNI_VERSION_1_4<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  说明：</p>
<ol>
<li class="lvl-3">
<p>JNINativeMethod保存Java Native函数和JNI函数的对应关系</p>
</li>
<li class="lvl-3">
<p>Java层中调用System.loadLibrary加载so库，并调用JNI_OnLoad开始注册</p>
</li>
<li class="lvl-3">
<p>JNI_OnLoad中调用AndroidRuntime::registerNativeMethods</p>
</li>
<li class="lvl-3">
<p>AndroidRuntime::registerNativeMethods中调用        jniRegisterNativeMethods</p>
</li>
</ol>
<p>  注意：这里有个知识叫做java签名，此签名是指的方法的类型标识，也就是一堆类型简写。（写法：(函数参数列表)返回值）</p>
<p>  下列是常用的类型总结（资料来于网上，若有侵权，请联系我，我第一时间删除）：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;*

Java方法签名中特殊字符&#x2F;字母含义
特殊字符	数据类型	特殊说明
V	void 	一般用于表示方法的返回值
Z	boolean	 
B	byte	 
C	char	 
S	short	 
I	int	 
J	long	 
F	float	 
D	double	 
[	数组	以[开头，配合其他的特殊字符，表示对应数据类型的数组，几个[表示几维数组
L全类名;	引用类型	以L开头、;结尾，中间是引用类型的全类名

*&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="Java-Reflect">Java Reflect</h3>
<hr>
<p>  程序运行时获取类的属性，也可调用类的方法。可灵活的方便构建出各种复杂的逻辑结构。</p>
<br/>
<br/>
<h5 id="C或者C-层反射">C或者C++层反射</h5>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">
int static NativeLog(JNIEnv *env, jobject instance ,char type, std::string tag, std::string msg)&#123;

    jclass clazz &#x3D; env-&gt;FindClass(&quot;android&#x2F;util&#x2F;Log&quot;) ;
    jmethodID jmth_id;
    switch (type)&#123;

        case &#39;V&#39;:
            jmth_id  &#x3D; env-&gt;GetStaticMethodID(clazz, &quot;v&quot;, &quot;(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;lang&#x2F;String;)I&quot;);
            break;
        case &#39;D&#39;:
            jmth_id  &#x3D; env-&gt;GetStaticMethodID(clazz, &quot;d&quot;, &quot;(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;lang&#x2F;String;)I&quot;);
            break;
        case &#39;I&#39;:
            jmth_id  &#x3D; env-&gt;GetStaticMethodID(clazz, &quot;i&quot;, &quot;(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;lang&#x2F;String;)I&quot;);
            break;
        case &#39;W&#39;:
            jmth_id  &#x3D; env-&gt;GetStaticMethodID(clazz, &quot;w&quot;, &quot;(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;lang&#x2F;String;)I&quot;);
            break;
        case &#39;E&#39;:
            jmth_id  &#x3D; env-&gt;GetStaticMethodID(clazz, &quot;e&quot;, &quot;(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;lang&#x2F;String;)I&quot;);
            break;
        default:
            break;
    &#125;

    return env-&gt;CallStaticIntMethod(clazz, jmth_id, env-&gt;NewStringUTF(tag.c_str()), env-&gt;NewStringUTF(msg.c_str()));
&#125;

extern &quot;C&quot;
JNIEXPORT jint JNICALL
Java_JNI_Operate_1Gpio_OpenGpio(JNIEnv * env, jobject obj)&#123;
    &#x2F;&#x2F;open devices ... ...
    NativeLog(env, obj, &#39;D&#39;, &quot;Test&quot;, &quot;Reflect test.&quot;);
    return 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Operate_Gpio</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token class-name">OpenGpio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Used to load the 'native-lib' library on application startup.</span>
    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"OperateGpio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">Operate_Gpio</span> op_gpio <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Operate_Gpio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token namespace">op_gpio<span class="token punctuation">.</span></span>OpenGpio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="JAVA层反射">JAVA层反射</h5>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Class</span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.util.Log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Method</span> method <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token string">"Test"</span><span class="token punctuation">,</span><span class="token string">"Fuck"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用静态函数</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  所有结果的最终效果如图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_052/ret.png" alt="rep_img"/></center>
    </div>
</div>  
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/01/04/blog_idx_051/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/01/04/blog_idx_051/" class="post-title-link" itemprop="url">移植openssh-7.5p1(包括openssl-1.0.2l、zlib-1.2.11)到HISI3520d(部署篇)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-01-04 14:09:56" itemprop="dateCreated datePublished" datetime="2018-01-04T14:09:56+08:00">2018-01-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 14:44:59
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=051） 
&emsp;&emsp;本文发布于 2018-01-04 14:09:56，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=051） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  此文的编译篇在：<a target="_blank" rel="noopener" href="http://blog.csdn.net/u011728480/article/details/78037404">http://blog.csdn.net/u011728480/article/details/78037404</a></p>
<p>  原本不想写这篇文章的，但是最近，新的需求下来，需要配置一个ssh服务端，但是板子的nand经过精打细算之后，只剩了几MB的空间了，于是得重新对编译和部署进行整理。然后将SSH部署到板子的SD卡上去。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="openssh-的部署">openssh 的部署</h3>
<hr>
<p>  首先根据编译篇的内容，将你要指定的SD卡的挂载目录参数添加上，而不是按照ssh的默认目录去部署。</p>
<p>  最终，configure之后得到下图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_051/configure.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  可以看到，我已经指定了我想要的路径，这个路径很重要，有些ssh相关的二进制文件根据编译时的参数写死了，所以，需要编译时指定。</p>
<br/>
<br/>
<h5 id="开始部署：">开始部署：</h5>
<ol>
<li class="lvl-3">
<p>首先根据前文，准备以下的文件到一个目录。</p>
</li>
</ol>
<p>  如图：（ssh相关的bin文件和配置文件）</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_051/ssh_bin.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  （ssh 所依赖的so库）</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_051/ssh_dep.png" alt="rep_img"/></center>
    </div>
</div>  
<ol start="2">
<li class="lvl-3">
<p>创建相关的文件夹</p>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /TFDISK/rootfs/bin/
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /TFDISK/rootfs/sbin/
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /TFDISK/rootfs/etc/
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /TFDISK/rootfs/libexec/
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /TFDISK/rootfs/share/
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /TFDISK/rootfs/lib/
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/run/
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/empty/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li class="lvl-3">
<p>修改相关文件夹权限以及添加ssh所需的用户组和用户</p>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chown</span> root:root /var/empty
<span class="token function">chmod</span> <span class="token number">755</span> /var/empty
addgroup sshd
adduser <span class="token parameter variable">-G</span> sshd <span class="token parameter variable">-g</span> <span class="token string">'sshd privsep'</span> <span class="token parameter variable">-h</span> /var/empty <span class="token parameter variable">-s</span> /bin/ssh sshd
<span class="token punctuation">(</span>添加用户时，也可直接修改/etc/passwd 文件，在最后一行添加sshd:x:74:74:Sky-SSH:/var/empty/sshd:/sbin/nologin<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//username:password:User ID:Group ID:comment:home directory:shell</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol start="4">
<li class="lvl-3">
<p>复制相关文件及so库到相关的文件夹</p>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> sshd /TFDISK/rootfs/sbin/
<span class="token function">cp</span> <span class="token function">scp</span> <span class="token function">sftp</span> <span class="token function">ssh</span> ssh-add ssh-agent ssh-keygen ssh-keyscan ssh-pkcs11-helper /TFDISK/rootfs/bin/
<span class="token function">cp</span> sftp-server ssh-keysign /TFDISK/rootfs/libexec/
<span class="token function">cp</span> sshd_config ssh_config moduli /TFDISK/rootfs/etc/

<span class="token comment">#libcrypto.so libssl.so libz.so</span>
<span class="token function">cp</span> lib*.so* /TFDISK/rootfs/lib/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="5">
<li class="lvl-3">
<p>到开发板上，在ssh所需的etc/目录生成相关的秘钥文件，并修改权限</p>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /TFDISK/rootfs/etc/
ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-f</span> ssh_host_rsa_key <span class="token parameter variable">-N</span> <span class="token string">""</span>
ssh-keygen <span class="token parameter variable">-t</span> dsa <span class="token parameter variable">-f</span> ssh_host_dsa_key <span class="token parameter variable">-N</span> <span class="token string">""</span>
ssh-keygen <span class="token parameter variable">-t</span> ecdsa <span class="token parameter variable">-f</span> ssh_host_ecdsa_key <span class="token parameter variable">-N</span> <span class="token string">""</span>
ssh-keygen <span class="token parameter variable">-t</span> dsa <span class="token parameter variable">-f</span> ssh_host_ed25519_key <span class="token parameter variable">-N</span> <span class="token string">""</span>
<span class="token function">chmod</span> <span class="token number">600</span> ssh_host_ed25519_key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="6">
<li class="lvl-3">
<p>到此，直接可以通过/TFDISK/rootfs/sbin/sshd&amp;运行，然后连接即可。（此时root和空密码是无法登录的）</p>
</li>
</ol>
<br/>
<br/>
<h5 id="号外号外：必须注意相关的额外配置">号外号外：必须注意相关的额外配置</h5>
<ol>
<li class="lvl-4">
<p>若想使用root登录，那么必须在sshd_config 里面，取消PermitRootLogin yes注释，并改值为yes，如果需要无密码登录，需要取消PermitEmptyPasswords yes注释，设置登录名密码为空（此选项不建议使用，因为我这里是开发板可以这样，毕竟不安全）。</p>
</li>
<li class="lvl-3">
<p>因为上文实现了不安全的免密登录，安全的免密登录可以使用公钥来配置，具体可以去网上查找相关资料。</p>
</li>
</ol>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/12/29/blog_idx_050/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/12/29/blog_idx_050/" class="post-title-link" itemprop="url">terminate called after throwing an instance of 'std::regex_error'（C++11）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-12-29 14:31:11" itemprop="dateCreated datePublished" datetime="2017-12-29T14:31:11+08:00">2017-12-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>883</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 17:29:00
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=050） 
&emsp;&emsp;本文发布于 2017-12-29 14:31:11，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=050） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="std-regex-error">std::regex_error</h3>
<hr>
<p>  最近修改一个程序，增加了一些功能，为了方便移植，要用到C++11的正则表达式(正则用起来顺手)。这里我就想说明的是：TMD，GCC 语法实现了，库没有写完。。。QAQ，WC。什么不说了。</p>
<p>  目标：得到url(类似<a target="_blank" rel="noopener" href="http://1.1.1.1:9001/group1/M00/00/37/wKgfdVoNSTKAKXAzAAD25Sg6ZTE5747.gz">http://1.1.1.1:9001/group1/M00/00/37/wKgfdVoNSTKAKXAzAAD25Sg6ZTE5747.gz</a>)中的文件名（wKgfdVoNSTKAKXAzAAD25Sg6ZTE5747.gz）。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">	<span class="token comment">/*file_path = 类似http://1.1.1.1:9001/group1/M00/00/37/wKgfdVoNSTKAKXAzAAD25Sg6ZTE5747.gz
*/</span>
    std<span class="token double-colon punctuation">::</span>string Target_FileName<span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>string <span class="token function">pattern</span><span class="token punctuation">(</span><span class="token string">".*/([^/]+\\.[a-zA-Z]+)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>regex <span class="token function">re</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>match_results<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token double-colon punctuation">::</span>const_iterator<span class="token operator">></span> result<span class="token punctuation">;</span>
    <span class="token comment">//std::smatch == std::match_results&lt;std::string::const_iterator></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>std<span class="token double-colon punctuation">::</span><span class="token function">regex_match</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span>result<span class="token punctuation">,</span>re<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

        <span class="token function">yUpgradeLog_Msg</span><span class="token punctuation">(</span><span class="token string">"std::regex_match false."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">yUpgradeLog_Msg</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Target_FileName <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  得到了下面如图的问题：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_050/problem.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  于是我去网上找答案，问题出在我构造正则表达式的时候。也就是这句中，std::string pattern(“.*/([^/]+\.[a-zA-Z]+)”);于是我重新修改了表达式N次还是不行，没有办法了，只有去网络海洋去在瞧一瞧看一看。</p>
<p>  最终，我看到了一个消息，给了我一点提示，文中说，可能和GCC版本有关，如果要正常使用C++11的正则表达式，需要注意GCC版本必须为4.9+，WC，TMD，赶紧去看看GCC版本。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_050/gcc.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  然后赶紧使用5.4的gcc再试试如下的代码，过了。我真是无F*uck说。</p>
<pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">#include &lt;regex&gt;
#include &lt;iostream&gt;
int main()&#123;

	
    std::string pattern(&quot;.*&#x2F;([^&#x2F;]+\\.[a-zA-Z]+)&quot;);
    std::regex re(pattern);
    std::match_results&lt;std::string::const_iterator&gt; result;
    &#x2F;&#x2F;std::smatch &#x3D;&#x3D; std::match_results&lt;std::string::const_iterator&gt;
	std::string t &#x3D; &quot;http:&#x2F;&#x2F;1.1.1.1:9001&#x2F;group1&#x2F;M00&#x2F;00&#x2F;37&#x2F;wKgfdVoNSTKAKXAzAAD25Sg6ZTE5747.gz&quot;;
    if ( !std::regex_match(t,result,re) )&#123;

        std::cout&lt;&lt;&quot;std::regex_match false.&quot;;
        return -1;
    &#125;
   
 	std::cout&lt;&lt;&quot;result is &quot;&lt;&lt;result[1];
	return 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_050/gcc1.png" alt="rep_img"/></center>
    </div>
</div>   
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_050/ret.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  最后在说一下不用正则怎么实现的吧！(其实，下面的还要简单点，感觉自己  大写的  ZZ  了，不过涨姿势了。)</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">file_path<span class="token operator">=</span><span class="token string">"http://1.1.1.1:9001/group1/M00/00/37/wKgfdVoNSTKAKXAzAAD25Sg6ZTE5747.gz"</span><span class="token punctuation">;</span>
file_path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>file_path<span class="token punctuation">.</span><span class="token function">rfind</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/12/22/blog_idx_049/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/12/22/blog_idx_049/" class="post-title-link" itemprop="url">反编译和逆向出现:java.lang.VerifyError(新问题样本)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-12-22 15:54:49" itemprop="dateCreated datePublished" datetime="2017-12-22T15:54:49+08:00">2017-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">安全</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>733</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 17:23:49
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=049） 
&emsp;&emsp;本文发布于 2017-12-22 15:54:49，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=049） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  某日，遇到一个App，突然想来一发，于是，直接下到这个app的老一点的版本，用某自动脱壳机脱壳后，得到Dex文件。并通过工具（AndroidKiller）生成Smali文件（此文件不完整）</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="java-lang-VerifyError">java.lang.VerifyError</h3>
<hr>
<p>  首先，把Smali文件放回到我们反编译后的Apk文件目录去，修复相关的类目录。这时候，在通过工具，把整个工程重新编译生成Apk，是可以正常安装的，但是不能够正常打开，并且得到java.lang.VerifyError错误。</p>
<p>  经过大量的搜索和整理，得到如下结论。</p>
<p>    此错的原因为：由于smali指令序列不符合相关的规范（指令丢失，反编译失败了，或者指令反编译错误，得到了错误的smali指令。对于反编译失败，相关的反编译工具（AndroidKiller）可能会在当前字段出现标注，根据标注解决就好）。</p>
<p>  网上现存的不规范的原因：</p>
<ol>
<li class="lvl-3">
<p>寄存器使用数量和定义个数不一致（用脚本很容易出现此问题）</p>
</li>
<li class="lvl-3">
<p>函数体不完整，丢失相关标识符.end method等</p>
</li>
</ol>
<p><em><strong>java.lang.VerifyError 新问题样本</strong></em></p>
<ol>
<li class="lvl-3">
<p>反编译出问题的东西大部分在构造函数，init()方法大部分都出现在缺少return-void</p>
</li>
<li class="lvl-3">
<p>当前类继承的interface，父类为java object ，出现 没有调用java object - &gt; init()方法</p>
</li>
</ol>
<p>  对于以上问题，其实相关工具会在smali文件里面存在 #disallowed odex opcode错误，直接搜索就可以解决。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/NO_EXSIT.XXXXXXX/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/NO_EXSIT.XXXXXXX/">1</a><span class="space">&hellip;</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/14/">14</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/NO_EXSIT.XXXXXXX/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Sky</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">286k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">17:19</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":250,"hOffset":50,"vOffset":5},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
</html>
