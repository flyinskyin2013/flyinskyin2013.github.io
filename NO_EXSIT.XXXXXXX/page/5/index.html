<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"e-x.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Sky&#39;s Blogs">
<meta property="og:url" content="https://e-x.top/NO_EXSIT.XXXXXXX/page/5/index.html">
<meta property="og:site_name" content="Sky&#39;s Blogs">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Sky">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://e-x.top/NO_EXSIT.XXXXXXX/page/5/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"NO_EXSIT.XXXXXXX/page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Sky's Blogs</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8677552300382028"
     crossorigin="anonymous"></script>


  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Sky's Blogs</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A normal star</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>
<div class="custom-middle-nav animated fadeInDown">
  <div class="custom-nav-item">
    <a href="/archives/"><i class="fa fa-archive"></i> 日志历程</a>
  </div>
  <div class="custom-nav-item">
    <a href="/categories/"><i class="fa fa-th"></i> 全部分类</a>
  </div>
  <div class="custom-nav-item">
    <a href="/tags/"><i class="fa fa-tags"></i> 热门标签</a>
  </div>
  <div class="custom-nav-item">
    <a href="javascript:;" class="my-search-btn"><i class="fa fa-search"></i> 本站搜索</a>
  </div>
</div>


<script>
// 使用脚本手动触发 NexT 的搜索弹窗
document.addEventListener('DOMContentLoaded', () => {
  const customBtn = document.querySelector('.my-search-btn');
  customBtn.addEventListener('click', (e) => {
    e.preventDefault();
    // 找到 NexT 原生的那个搜索触发按钮并模拟点击
    const originalBtn = document.querySelector('.site-nav-right .popup-trigger');
    if (originalBtn) {
      originalBtn.click();
    } else {
      // 如果原生的没找到，尝试直接调用 NexT 的 Search 内部变量（针对某些版本）
      if (typeof CONFIG.local_search !== 'undefined') {
        // 尝试手动激活弹窗
        document.querySelector('.search-pop-overlay').style.display = 'block';
        document.body.style.overflow = 'hidden';
        document.querySelector('.search-input').focus();
      }
    }
  });
});
</script>
</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sky"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Sky</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">92</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">222</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/flyinskyin2013" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;flyinskyin2013" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
<div id="days" style="margin-top: 10px; font-size: 13px; color: #555;"></div>
<script>
  function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("01/07/2014 00:00:00"); // 这里改成你建站的时间
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
    secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
    e_daysold=timeold/msPerDay
    daysold=Math.floor(e_daysold);
    document.getElementById("days").innerHTML="本站已运行 "+daysold+" 天";
  }
  show_date_time();
</script>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2021/04/18/blog_idx_103/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/18/blog_idx_103/" class="post-title-link" itemprop="url">Mediapipe 在RK3399PRO上的初探（一）(编译、运行CPU和GPU Demo, RK OpenglES 填坑，编译bazel)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-18 19:39:44" itemprop="dateCreated datePublished" datetime="2021-04-18T19:39:44+08:00">2021-04-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C-CPP/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C-CPP/%E5%B5%8C%E5%85%A5%E5%BC%8F/DL/" itemprop="url" rel="index"><span itemprop="name">DL</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>15 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2023-04-08 11:06:21
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=103）
&emsp;&emsp;本文发布于 2021-04-18 19:39:44     （BlogID=103） -->
<h6 id="环境说明">环境说明</h6>
<ul class="lvl-0">
<li class="lvl-2">
<p>Ubuntu 18.04</p>
</li>
<li class="lvl-2">
<p>gcc version 7.5.0 (Ubuntu 7.5.0-3ubuntu1~18.04)</p>
</li>
<li class="lvl-2">
<p>OpenGl ES 3.1 or 3.1+</p>
</li>
<li class="lvl-2">
<p>RK3399PRO 板卡</p>
</li>
</ul>
<h3 id="前言">前言</h3>
<hr>
<p>  由于我们小组的产品落地越来越多，以前（2018年）我搭建的老旧产品框架已经有点日落西山的感觉了。倒不是说产品业务不能支撑了，只是随着使用的时间增多，逐渐的感觉框架比较’LOW’，全靠使用者调教的怎么样，缺少了很多公共的组件。我倒是觉得这是必然的，因为当时我们小组的产品功能还比较的单一，随着产品功能多样化，产品迭代的频率越来越高，使得我们现有的框架在对付当前的产品的时候，有点落后了。最主要的就是我们的框架代码复用率有点低，导致快速开发的时候，那叫一个不爽。在我们都是打工仔的前提下，这一致命缺陷让我很难受，项目Code&amp;Debug的时间成本越来越高。还有一个原因就是当时我设计这个框架的时候，自己的想法很单纯，也很简单。<br>
  下图是当时我设计的框架的一个简单示意图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_103/prj_framework.png" alt="prj_framework"/></center>
    </div>
</div>   
父进程对子进程的所有行为进行监控和处理，子进程进行实际的逻辑开发。
<p>  因此，我们小组内部决定要预研和引入一套开源的比较好使的框架，在后面如果上大项目的时候，可能就要上这个预研的新框架，经过了一圈调研，可能觉得Mediapipe和我们的业务很耦合，应该是可以使用的。于是乎，就有了我来踩一踩这个大坑。</p>
<p>  好的多说无益，直接看运行Demo效果（包含FaceDetectDemo 和 HolisticDemo）,截图来自于我录制的4个视频。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_103/facedetect_cpu.png" alt="facedetect_cpu"/></center>
    </div>
	<div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_103/facedetect_gpu.png" alt="facedetect_gpu"/></center>
    </div>
</div>    
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_103/pose_cpu.png" alt="pose_cpu"/></center>
    </div>
	<div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_103/pose_gpu.png" alt="pose_gpu"/></center>
    </div>
</div>    
<p>  由于Mediapipe使用的是一个名为bazel的编译管理工具，可以说是大大增加了我们解决问题的难度。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="安装Bazel-4-0-0">安装Bazel 4.0.0</h3>
<hr>
<p>  注意，Mediapipe使用的是bazel来编译的，如果以前没有接触过，可能使用起来不是那么的友好。而且Mediapipe基本是和特定版本的bazel是绑定的，所以在安装bazel之前，建议大家去看看你要使用的mediapipe版本所依赖的bazel版本是多少。你可以去看 ‘gay-hub’ 上面Mediapipe 的关于bazel的说明。如下图类似的说明：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_103/mp_bazel_version.png" alt="mp_bazel_version"/></center>
    </div>
</div>   
<p>一般来说，Mediapipe依赖的bazel比较新，可能常见的发行版里面自带的bazel版本比较低，所以一般都需要从源码开始从零编译bazel，如果系统已有bazel等，可以用其他方式编译，详见后文链接的文档内容。下面的内容一般都是copy来自于 <a target="_blank" rel="noopener" href="https://docs.bazel.build/versions/4.0.0/install-compile-source.html">https://docs.bazel.build/versions/4.0.0/install-compile-source.html</a> 。<br>
<br/><br>
<br/></p>
<h5 id="安装依赖">安装依赖</h5>
<p>安装依赖</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>sudo apt-get install build-essential openjdk-11-jdk python zip unzip</p>
</li>
</ul>
<br/>
<br/>
<h5 id="编译和部署-bazel">编译和部署 bazel</h5>
<p>编译bazel</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>cd bazel-src-dir</p>
</li>
<li class="lvl-2">
<p>env EXTRA_BAZEL_ARGS=“–host_javabase=@local_jdk//:jdk” bash ./compile.sh</p>
</li>
</ul>
<p>编译生成的bazel二进制文件在bazel-src-dir/output/ 目录。</p>
<p>  这时我们可以选择将bazel安装到/usr/bin or /usr/local/bin或者把bazel-src-dir/output/ 添加到PATH环境变量。</p>
<p>  然后运行可以得到如下图的内容：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>bazel --help</p>
</li>
</ul>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_103/bazel_help.png" alt="bazel_help"/></center>
    </div>
</div>   
<p>至此，bazel安装完毕，这里我就不详细介绍bazel了，网上有许多的介绍资料。这里可以简单的记住这两点就够了：bazel build target 和 bazel run target。bazel build target是编译目标。bazel run target 是编译并运行目标。<br>
<br/><br>
<br/><br>
<br/><br>
<br/></p>
<h3 id="在rk3399pro上编译Mediapipe-Demo">在rk3399pro上编译Mediapipe Demo</h3>
<hr>
<p>  首先我们要下载好源码,并切换到对应的版本：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>git clone <a target="_blank" rel="noopener" href="https://github.com/google/mediapipe">https://github.com/google/mediapipe</a></p>
</li>
<li class="lvl-2">
<p>git checkout 0.8.3.2</p>
</li>
</ul>
<p>  然后，根据网页 <a target="_blank" rel="noopener" href="https://google.github.io/mediapipe/solutions/face_detection.html">https://google.github.io/mediapipe/solutions/face_detection.html</a> 的Example Apps-&gt; Desktop 小节里面，我们可以看到如下图的内容：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_103/solution_eg.png" alt="solution_eg"/></center>
    </div>
</div>   
<p>  图中给出了关于人脸检测的demo的target 和 对应的graph-cfg文件。类似的说明，在每个solution下面都有。我推荐大家优先从hello_world开始编译，因为这个target简单，出错也好排查。此外，一些可以复用的文件，只要你不修改，就只会编译一次。</p>
<p>  此外，我们编译的平台是aarch64+ubuntu18.04，而官方的编译结构带的是x86-64 + ubuntu 18.04，所以在链接一些第三方库的时候，例如：opencv，我们需要改一下路径才行，如下图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_103/opencv_dep.png" alt="opencv_dep"/></center>
    </div>
</div>   
<p>可能在编译的过程中还会遇到其他的错误，大家就按着修改就好了。后面我会列出一些可能的错误及参考解决方法。</p>
<br/>
<br/>
<h5 id="HelloWorld-编译和运行">HelloWorld 编译和运行</h5>
<p>  进入mediapipe的源码根目录开始编译运行CPU版本。</p>
<pre class="line-numbers language-none"><code class="language-none">&gt; bazel build --define MEDIAPIPE_DISABLE_GPU&#x3D;1 mediapipe&#x2F;examples&#x2F;desktop&#x2F;hello_world:hello_world --local_cpu_resources&#x3D;1
&gt; bazel run   --define MEDIAPIPE_DISABLE_GPU&#x3D;1 mediapipe&#x2F;examples&#x2F;desktop&#x2F;hello_world:hello_world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>  进入mediapipe的源码根目录开始编译运行GPU版本。(注意，这里的helloworld并没有gpu加速，这里这是演示怎么编译一些公共的包含gpu的代码)</p>
<pre class="line-numbers language-none"><code class="language-none">&gt; bazel build --define MEDIAPIPE_DISABLE_GPU&#x3D;1 mediapipe&#x2F;examples&#x2F;desktop&#x2F;hello_world:hello_world --local_cpu_resources&#x3D;1
&gt; bazel run   --define MEDIAPIPE_DISABLE_GPU&#x3D;1 mediapipe&#x2F;examples&#x2F;desktop&#x2F;hello_world:hello_world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>–local_cpu_resources 是为了指定线程个数，一般来说，编译这个东西比较耗费内存，建议大家合力设定。如果不指定这个参数，bazel 按照 nproc 开启多线程编译。这样可能在某些情况下要爆内存。</p>
<p>  在bazel build 之后，第一次编译可能要耗费大量的时间，我建议去干干别的，休息一会儿。<br>
  在bazel run 之后，会打印一串helloworld。</p>
<br/>
<br/>
<h5 id="人脸检测demo编译和运行">人脸检测demo编译和运行</h5>
<p>  进入mediapipe的源码根目录开始编译运行CPU版本。</p>
<pre class="line-numbers language-none"><code class="language-none">&gt; bazel build --define MEDIAPIPE_DISABLE_GPU&#x3D;1 --copt -DMESA_EGL_NO_X11_HEADERS --copt -DEGL_NO_X11 mediapipe&#x2F;examples&#x2F;desktop&#x2F;face_detection:face_detection_cpu --local_ram_resources&#x3D;1500  --local_cpu_resources&#x3D;1

&gt; .&#x2F;bazel-bin&#x2F;mediapipe&#x2F;examples&#x2F;desktop&#x2F;face_detection&#x2F;face_detection_cpu -calculator_graph_config_file&#x3D;.&#x2F;mediapipe&#x2F;graphs&#x2F;face_detection&#x2F;face_detection_desktop_live.pbtxt -input_video_path&#x3D;.&#x2F;TestVideos&#x2F;out.mp4
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>  进入mediapipe的源码根目录开始编译运行GPU版本。</p>
<pre class="line-numbers language-none"><code class="language-none">&gt; bazel build --copt -DMESA_EGL_NO_X11_HEADERS --copt -DEGL_NO_X11 mediapipe&#x2F;examples&#x2F;desktop&#x2F;face_detection:face_detection_gpu --local_ram_resources&#x3D;1500  --local_cpu_resources&#x3D;1

&gt; .&#x2F;bazel-bin&#x2F;mediapipe&#x2F;examples&#x2F;desktop&#x2F;face_detection&#x2F;face_detection_gpu -calculator_graph_config_file&#x3D;.&#x2F;mediapipe&#x2F;graphs&#x2F;face_detection&#x2F;face_detection_mobile_gpu.pbtxt -input_video_path&#x3D;.&#x2F;TestVideos&#x2F;out.mp4
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>   运行之后，就会弹一个框开始检测了。</p>
<br/>
<br/>
<h5 id="姿态demo编译和运行">姿态demo编译和运行</h5>
<p>  进入mediapipe的源码根目录开始编译运行CPU版本。</p>
<pre class="line-numbers language-none"><code class="language-none">bazel build --define MEDIAPIPE_DISABLE_GPU&#x3D;1 --copt -DMESA_EGL_NO_X11_HEADERS --copt -DEGL_NO_X11 mediapipe&#x2F;examples&#x2F;desktop&#x2F;holistic_tracking:holistic_tracking_cpu --local_ram_resources&#x3D;1500  --local_cpu_resources&#x3D;1

.&#x2F;bazel-bin&#x2F;mediapipe&#x2F;examples&#x2F;desktop&#x2F;holistic_tracking:holistic_tracking_cpu -calculator_graph_config_file&#x3D;.&#x2F;mediapipe&#x2F;graphs&#x2F;holistic_tracking&#x2F;holistic_tracking_cpu.pbtxt -input_video_path&#x3D;.&#x2F;TestVideos&#x2F;out.mp4
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>  进入mediapipe的源码根目录开始编译运行GPU版本。</p>
<pre class="line-numbers language-none"><code class="language-none">bazel build --copt -DMESA_EGL_NO_X11_HEADERS --copt -DEGL_NO_X11 mediapipe&#x2F;examples&#x2F;desktop&#x2F;holistic_tracking:holistic_tracking_gpu --local_ram_resources&#x3D;1500  --local_cpu_resources&#x3D;1

.&#x2F;bazel-bin&#x2F;mediapipe&#x2F;examples&#x2F;desktop&#x2F;holistic_tracking:holistic_tracking_gpu -calculator_graph_config_file&#x3D;.&#x2F; mediapipe&#x2F;graphs&#x2F;holistic_tracking&#x2F;holistic_tracking_gpu.pbtxt -input_video_path&#x3D;.&#x2F;TestVideos&#x2F;out.mp4
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>   运行之后，就会弹一个框开始检测了。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="RK3399pro-可能遇到的坑">RK3399pro 可能遇到的坑</h3>
<hr>
<h5 id="Opencv-问题">Opencv 问题</h5>
<p>  如上文所说，如果不修改，将会出现undefined symbol xxx 或者 找不到opencv_xxx的库的问题。</p>
<br/>
<br/>
<h5 id="关于Opengl-ES-版本问题">关于Opengl ES 版本问题</h5>
<p>  根据官方说明，需要Opengl ES 3.1 或者 Opengl ES 3.1+的版本，我这里遇到的问题是，如果版本比这个低，运行GPU版本的demo 的时候，会报错。<br>
  注意：rk的libmali-rk-midgard-t86x-r14p0版本就支持 Opengl ES 3.1及以上，现在rk已经更新了libmali-rk-midgard-t86x-r18p0，可以暂时不更新也可以用。因为一旦更新了gpu驱动，内核也必须更新，配套的文件系统也得更新。因为我 xxxxxxxxxxxxxx 踩过.</p>
<p>  关于Opengl ES 版本查看问题，可以使用glxinfo，如果没有这个命令推荐安装。如果使用的ssh来运行glxinfo，保证启用X11-forwarding. 查看到的版本如下图(glxinfo|grep “OpenGL ES”)：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_103/opengles_ver.png" alt="opengles_ver"/></center>
    </div>
</div>   
<br/>
<br/>
<h5 id="SSH-模式下运行GPU-Demo报错问题">SSH 模式下运行GPU Demo报错问题</h5>
<p>   可能会出现以下问题，这个问题好像是多个xclient和xserver连接导致的问题，我也不确定。但是要不报这个错误，请直接将板卡接显示器使用。</p>
<pre class="line-numbers language-none"><code class="language-none">I20210417 17:49:08  4016 demo_run_graph_main_gpu.cc:58] Initialize the calculator graph.
I20210417 17:49:08  4016 demo_run_graph_main_gpu.cc:62] Initialize the GPU.
XIO:  fatal IO error 11 (Resource temporarily unavailable) on X server &quot;localhost:12.0&quot;
      after 6 requests (6 known processed) with 0 events remaining.
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="关于Mediapipe里面glog-在RK3399pro上无法输出问题">关于Mediapipe里面glog 在RK3399pro上无法输出问题</h5>
<p>   请在gflags::ParseCommandLineFlags之后，设置如下三个变量的值。。。，这个值是调试出来的。</p>
<pre class="line-numbers language-none"><code class="language-none">gflags::ParseCommandLineFlags(&amp;argc, &amp;argv, true);

FLAGS_minloglevel &#x3D; 0;
FLAGS_stderrthreshold &#x3D; 0;
FLAGS_alsologtostderr &#x3D; 1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="关于libEGL的导致编译报错问题">关于libEGL的导致编译报错问题</h5>
<p>   关于这个问题，我这里只想问问Firefly的厂家，咋们修改开源库的时候，能不能认真点？?? “尽量添加，不要删除”，难道这不是修改开源库的一大原则吗？看下边两个文件内容：</p>
<p>EGL/eglplatform.h 来至于deb包 libmali-rk-dev 1.7-1 <a target="_blank" rel="noopener" href="http://wiki.t-firefly.com/firefly-rk3399-repo">http://wiki.t-firefly.com/firefly-rk3399-repo</a> bionic/main arm64 Packages</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__eglplatform_h_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__eglplatform_h_</span></span>

<span class="token comment">/*
** Copyright (c) 2007-2016 The Khronos Group Inc.
**
** Permission is hereby granted, free of charge, to any person obtaining a
** copy of this software and/or associated documentation files (the
** "Materials"), to deal in the Materials without restriction, including
** without limitation the rights to use, copy, modify, merge, publish,
** distribute, sublicense, and/or sell copies of the Materials, and to
** permit persons to whom the Materials are furnished to do so, subject to
** the following conditions:
**
** The above copyright notice and this permission notice shall be included
** in all copies or substantial portions of the Materials.
**
** THE MATERIALS ARE PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
** EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
** MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
** IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
** CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
** TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
** MATERIALS OR THE USE OR OTHER DEALINGS IN THE MATERIALS.
*/</span>

<span class="token comment">/* Platform-specific types and definitions for egl.h
 * $Revision: 30994 $ on $Date: 2015-04-30 13:36:48 -0700 (Thu, 30 Apr 2015) $
 *
 * Adopters may modify khrplatform.h and this file to suit their platform.
 * You are encouraged to submit all modifications to the Khronos group so that
 * they can be included in future versions of this file.  Please submit changes
 * by sending them to the public Khronos Bugzilla (http://khronos.org/bugzilla)
 * by filing a bug against product "EGL" component "Registry".
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;KHR/khrplatform.h></span></span>

<span class="token comment">/* Macros used in EGL function prototype declarations.
 *
 * EGL functions should be prototyped as:
 *
 * EGLAPI return-type EGLAPIENTRY eglFunction(arguments);
 * typedef return-type (EXPAPIENTRYP PFNEGLFUNCTIONPROC) (arguments);
 *
 * KHRONOS_APICALL and KHRONOS_APIENTRY are defined in KHR/khrplatform.h
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">EGLAPI</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EGLAPI</span> <span class="token expression">KHRONOS_APICALL</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">EGLAPIENTRY</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EGLAPIENTRY</span>  <span class="token expression">KHRONOS_APIENTRY</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EGLAPIENTRYP</span> <span class="token expression">EGLAPIENTRY<span class="token operator">*</span></span></span>

<span class="token comment">/* The types NativeDisplayType, NativeWindowType, and NativePixmapType
 * are aliases of window-system-dependent types, such as X Display * or
 * Windows Device Context. They must be defined in platform-specific
 * code below. The EGL-prefixed versions of Native*Type are the same
 * types, renamed in EGL 1.3 so all types in the API start with "EGL".
 *
 * Khronos STRONGLY RECOMMENDS that you use the default definitions
 * provided below, since these changes affect both binary and source
 * portability of applications using EGL running on different EGL
 * implementations.
 */</span>

<span class="token keyword">struct</span> <span class="token class-name">gbm_device</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">gbm_surface</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>WL_EGL_PLATFORM<span class="token punctuation">)</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">wl_display</span>     <span class="token operator">*</span>EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">wl_egl_pixmap</span>  <span class="token operator">*</span>EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">wl_egl_window</span>  <span class="token operator">*</span>EGLNativeWindowType<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__GBM__<span class="token punctuation">)</span></span></span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">gbm_device</span> <span class="token operator">*</span> EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">gbm_surface</span> <span class="token operator">*</span> EGLNativeWindowType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token operator">*</span> EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__unix__<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;X11/Xlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;X11/Xutil.h></span></span>
<span class="token keyword">typedef</span> Display <span class="token operator">*</span>EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> Pixmap EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> Window EGLNativeWindowType<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* EGL 1.2 types, renamed for consistency in EGL 1.3 */</span>
<span class="token keyword">typedef</span> EGLNativeDisplayType NativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> EGLNativePixmapType  NativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> EGLNativeWindowType  NativeWindowType<span class="token punctuation">;</span>


<span class="token comment">/* Define EGLint. This must be a signed integral type large enough to contain
 * all legal attribute names and values passed into and out of EGL, whether
 * their type is boolean, bitmask, enumerant (symbolic constant), integer,
 * handle, or other.  While in general a 32-bit integer will suffice, if
 * handles are 64 bit types, then EGLint should be defined as a signed 64-bit
 * integer type.
 */</span>
<span class="token keyword">typedef</span> khronos_int32_t EGLint<span class="token punctuation">;</span>


<span class="token comment">/* C++ / C typecast macros for special EGL handle values */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__cplusplus<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EGL_CAST</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>type<span class="token operator">></span></span></span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EGL_CAST</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __eglplatform_h */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>EGL/eglplatform.h 来至于deb包 libegl1-mesa-dev ubuntu 官方，甚至 <a target="_blank" rel="noopener" href="https://github.com/rockchip-linux/libmali">https://github.com/rockchip-linux/libmali</a> 人家rockchip官方带的东西至少没有乱删东西吧。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__eglplatform_h_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__eglplatform_h_</span></span>

<span class="token comment">/*
** Copyright (c) 2007-2016 The Khronos Group Inc.
**
** Permission is hereby granted, free of charge, to any person obtaining a
** copy of this software and/or associated documentation files (the
** "Materials"), to deal in the Materials without restriction, including
** without limitation the rights to use, copy, modify, merge, publish,
** distribute, sublicense, and/or sell copies of the Materials, and to
** permit persons to whom the Materials are furnished to do so, subject to
** the following conditions:
**
** The above copyright notice and this permission notice shall be included
** in all copies or substantial portions of the Materials.
**
** THE MATERIALS ARE PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
** EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
** MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
** IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
** CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
** TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
** MATERIALS OR THE USE OR OTHER DEALINGS IN THE MATERIALS.
*/</span>

<span class="token comment">/* Platform-specific types and definitions for egl.h
 * $Revision: 30994 $ on $Date: 2015-04-30 13:36:48 -0700 (Thu, 30 Apr 2015) $
 *
 * Adopters may modify khrplatform.h and this file to suit their platform.
 * You are encouraged to submit all modifications to the Khronos group so that
 * they can be included in future versions of this file.  Please submit changes
 * by sending them to the public Khronos Bugzilla (http://khronos.org/bugzilla)
 * by filing a bug against product "EGL" component "Registry".
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;KHR/khrplatform.h></span></span>

<span class="token comment">/* Macros used in EGL function prototype declarations.
 *
 * EGL functions should be prototyped as:
 *
 * EGLAPI return-type EGLAPIENTRY eglFunction(arguments);
 * typedef return-type (EXPAPIENTRYP PFNEGLFUNCTIONPROC) (arguments);
 *
 * KHRONOS_APICALL and KHRONOS_APIENTRY are defined in KHR/khrplatform.h
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">EGLAPI</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EGLAPI</span> <span class="token expression">KHRONOS_APICALL</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">EGLAPIENTRY</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EGLAPIENTRY</span>  <span class="token expression">KHRONOS_APIENTRY</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EGLAPIENTRYP</span> <span class="token expression">EGLAPIENTRY<span class="token operator">*</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>MESA_EGL_NO_X11_HEADERS<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>EGL_NO_X11<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">warning</span> <span class="token string">"`MESA_EGL_NO_X11_HEADERS` is deprecated, and doesn't work with the unmodified Khronos header"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">warning</span> <span class="token string">"Please use `EGL_NO_X11` instead, as `MESA_EGL_NO_X11_HEADERS` will be removed soon"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EGL_NO_X11</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* The types NativeDisplayType, NativeWindowType, and NativePixmapType
 * are aliases of window-system-dependent types, such as X Display * or
 * Windows Device Context. They must be defined in platform-specific
 * code below. The EGL-prefixed versions of Native*Type are the same
 * types, renamed in EGL 1.3 so all types in the API start with "EGL".
 *
 * Khronos STRONGLY RECOMMENDS that you use the default definitions
 * provided below, since these changes affect both binary and source
 * portability of applications using EGL running on different EGL
 * implementations.
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_WIN32<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__VC32__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>__CYGWIN__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>__SCITECH_SNAP__<span class="token punctuation">)</span> </span><span class="token comment">/* Win32 and WinCE */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">WIN32_LEAN_AND_MEAN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WIN32_LEAN_AND_MEAN</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span>

<span class="token keyword">typedef</span> HDC     EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> HBITMAP EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> HWND    EGLNativeWindowType<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__EMSCRIPTEN__<span class="token punctuation">)</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">int</span> EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span> EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span> EGLNativeWindowType<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__WINSCW__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__SYMBIAN32__<span class="token punctuation">)</span>  </span><span class="token comment">/* Symbian */</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">int</span>   EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token operator">*</span>EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token operator">*</span>EGLNativeWindowType<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>WL_EGL_PLATFORM<span class="token punctuation">)</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">wl_display</span>     <span class="token operator">*</span>EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">wl_egl_pixmap</span>  <span class="token operator">*</span>EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">wl_egl_window</span>  <span class="token operator">*</span>EGLNativeWindowType<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__GBM__<span class="token punctuation">)</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">gbm_device</span>  <span class="token operator">*</span>EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">gbm_bo</span>      <span class="token operator">*</span>EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span>               <span class="token operator">*</span>EGLNativeWindowType<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__ANDROID__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>ANDROID<span class="token punctuation">)</span></span></span>

<span class="token keyword">struct</span> <span class="token class-name">ANativeWindow</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">egl_native_pixmap_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">void</span><span class="token operator">*</span>                           EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">egl_native_pixmap_t</span><span class="token operator">*</span>     EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">ANativeWindow</span><span class="token operator">*</span>           EGLNativeWindowType<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>USE_OZONE<span class="token punctuation">)</span></span></span>

<span class="token keyword">typedef</span> intptr_t EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> intptr_t EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> intptr_t EGLNativeWindowType<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__unix__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>EGL_NO_X11<span class="token punctuation">)</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">void</span>             <span class="token operator">*</span>EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> khronos_uintptr_t EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> khronos_uintptr_t EGLNativeWindowType<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__unix__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>USE_X11<span class="token punctuation">)</span></span></span>

<span class="token comment">/* X11 (tentative)  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;X11/Xlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;X11/Xutil.h></span></span>

<span class="token keyword">typedef</span> Display <span class="token operator">*</span>EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> Pixmap   EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> Window   EGLNativeWindowType<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__APPLE__<span class="token punctuation">)</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">int</span>   EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token operator">*</span>EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token operator">*</span>EGLNativeWindowType<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__HAIKU__<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;kernel/image.h></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">void</span>              <span class="token operator">*</span>EGLNativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> khronos_uintptr_t  EGLNativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> khronos_uintptr_t  EGLNativeWindowType<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">error</span> <span class="token string">"Platform not recognized"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* EGL 1.2 types, renamed for consistency in EGL 1.3 */</span>
<span class="token keyword">typedef</span> EGLNativeDisplayType NativeDisplayType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> EGLNativePixmapType  NativePixmapType<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> EGLNativeWindowType  NativeWindowType<span class="token punctuation">;</span>


<span class="token comment">/* Define EGLint. This must be a signed integral type large enough to contain
 * all legal attribute names and values passed into and out of EGL, whether
 * their type is boolean, bitmask, enumerant (symbolic constant), integer,
 * handle, or other.  While in general a 32-bit integer will suffice, if
 * handles are 64 bit types, then EGLint should be defined as a signed 64-bit
 * integer type.
 */</span>
<span class="token keyword">typedef</span> khronos_int32_t EGLint<span class="token punctuation">;</span>


<span class="token comment">/* C++ / C typecast macros for special EGL handle values */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__cplusplus<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EGL_CAST</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>type<span class="token operator">></span></span></span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EGL_CAST</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __eglplatform_h */</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这文件被删改的谁都不认识了好吧！！！你说气不气，关键是Mediapipe编译GPU 版本的时候，还得用到这个EGL_NO_X11宏。我真的是无fuck说。</p>
<p>出现问题的根源是：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*
  In file EGL/egl.h: #include &lt;EGL/eglplatform.h>

  In file EGL/eglplatform.h: #include &lt;X11/Xlib.h>

  In file X11/Xlib.h(line:83): #define Status int

  当我们include 了 egl.h 这个文件后，会引入一个Status的宏。

  在我们使用google的工程的时候，还有一个class 叫做 absl::Status。

  如果项目中定义一个变量：
  absl::Status TestVal;

  会被预编译为:
  absl::int TestVal;
  
  然后就会编译报错。
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  好了，这就是我初探Mediapipe的故事。初次接触的话，我觉得最恼火的还是它的编译问题（对我来说：bazel是真的难用），其实编译问题解决了，还是很友好的，这些代码都封装的很好。</p>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2021/03/07/blog_idx_102/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/07/blog_idx_102/" class="post-title-link" itemprop="url">Linux Kernel 0.12 启动简介，调试记录(Ubuntu1804, Bochs, gdb)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-07 17:39:44" itemprop="dateCreated datePublished" datetime="2021-03-07T17:39:44+08:00">2021-03-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%B8%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">常识</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%B8%E8%AF%86/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%B8%E8%AF%86/C-CPP/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>23 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2023-04-08 11:04:42
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=102）
&emsp;&emsp;本文发布于 2021-03-07 17:39:44     （BlogID=102） -->
<h6 id="环境说明">环境说明</h6>
<ul class="lvl-0">
<li class="lvl-2">
<p>Ubuntu 18.04</p>
</li>
<li class="lvl-2">
<p>gcc version 7.5.0 (Ubuntu 7.5.0-3ubuntu1~18.04)</p>
</li>
<li class="lvl-2">
<p>Bochs 2.6</p>
</li>
<li class="lvl-2">
<p>As86 version: 0.16.17</p>
</li>
</ul>
<h3 id="前言">前言</h3>
<hr>
<p>  自从我近段时间开始温习一些基础知识以来，其中觉得以前学的很浅的就是OS原理。为啥这样说呢？因为就是浅，知道一些琐碎的知识。以前我自负的认为OS就是硬件的抽象，然后把这些硬件资源合理的分配给用户使用就完了，因为我觉得合理的整合这些硬件资源是非常‘简单’的。</p>
<p>  由于我本身对底层是非常着迷的。带着觉得OS很简单的想法，想着去看看LinuxKernel的源码。在以前，我对LinuxKernel的认知很肤浅，就知道一些驱动移植的事情。如果硬要说一件我在LinuxKernel中玩的很深的事情，那就是自己理解并实现了一个类似Anonymous Shared Memory的Linux驱动，详见以下两篇文章。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>《Android匿名共享内存(Anonymous Shared Memory) — 瞎折腾记录 (驱动程序篇)》 <a target="_blank" rel="noopener" href="https://blog.csdn.net/u011728480/article/details/88420467">https://blog.csdn.net/u011728480/article/details/88420467</a></p>
</li>
<li class="lvl-2">
<p>《linux kernel 中进程间描述符的传递方法及原理》 <a target="_blank" rel="noopener" href="https://blog.csdn.net/u011728480/article/details/88553602">https://blog.csdn.net/u011728480/article/details/88553602</a></p>
</li>
</ul>
<p>  带着这样的想法其实已经很久了，由于现在的LinuxKernel太大了，对新手不友好。我就想着去找一个老一点的版本内核看看。结果去网上一找，就发现了前人已经做了许多许多了，比如这个之前就有了解的《linux 0.11内核完全注释》，还比如其他许许多多前人种的‘树’，看到了许多，最终我决定跟着国内现在比较好和新的资料从‘远古’开始学习它。它就是《Linux内核完全注释(PDF) v5.0 by 赵炯.pdf》。它是基于LinuxKernel0.12 讲述的，它是我在ubuntu1804上编译通过LinuxKernel0.12的主要参考和学习资料，同时也是我在Bochs上运行成功的主要参考和学习资料。</p>
<p>  好的多说无益，直接看运行效果。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_102/result.png" alt="result_img"/></center>
    </div>
</div>    
<p>  说来也惭愧，利用断断续续的时间，我花了约2月，把LinuxKernel0.12在Ubuntu1804上编译通过，并在1804上通过Bochs运行成功。而且要命的事情是我其实只加了一些打印调试函数，和根据实际的调试情况修改了一些代码，却花了那么久的时间，搞得我很不自信了QAQ。</p>
<p>  我修改好的源码已经开源，立即想要源码的请直接去文末两个rep clone即可。</p>
<p>  本文主要还是简单介绍LinuxKernel从上电到进入sh的中间的简要流程。这些流程网上已经有很多了，可能我会挑选一些我觉得比较重要的来说。</p>
<p>  本文适用于：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>会编译和使用bochs的人。不会可以去网上找找，很多这方面的资料。</p>
</li>
<li class="lvl-2">
<p>对Intel AT&amp;T 汇编有点了解的人。</p>
</li>
<li class="lvl-2">
<p>会GDB调试的人。</p>
</li>
<li class="lvl-2">
<p>知道C语言常识的人。</p>
</li>
<li class="lvl-2">
<p>对LinuxKernel感兴趣的人。</p>
</li>
</ul>
<br/>
<br/>
<br/>
<br/>
<h3 id="搭环境">搭环境</h3>
<hr>
<p>  工欲善其事必先利其器。本文主要是在Ubuntu1804上编译生成LinuxKernel，然后用Bochs运行我们的内核。</p>
<br/>
<br/>
<h5 id="Ubuntu18-04环境安装">Ubuntu18.04环境安装</h5>
<p>我们应该首先安装make,gcc,gcc-multilib,bin86。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>sudo apt install build-essential cmake make gcc-multilib g+±multilib module-assistant bin86</p>
</li>
</ul>
<p>然后进入源码目录。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>cd my_src</p>
</li>
<li class="lvl-2">
<p>make disk</p>
</li>
</ul>
<p>更多的详情信息查看开源的rep。</p>
<br/>
<br/>
<h5 id="编译两个bochs版本备用">编译两个bochs版本备用</h5>
<p>  我们首先就得把Linux0.12的运行环境搭建起来，方便我们调试。我们使用的是Bochs2.6 和 GDB远程调试。并编译出两个bochs版本，一个是带本身调试功能（命名为：bochs），一个是和gdb联调（命名为：bochsdbg）。bochs 主要是调试在init/main()函数之前的内容以及查看更多的x86寄存器。 bochsdbg主要是调试进入init/main()函数之后到sh成功执行的事情。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>通过 ./configure  --enable-debugger 生成bochs。</p>
</li>
<li class="lvl-2">
<p>通过 ./configure  --enable-gdb-stub 生成bochsdbg。</p>
</li>
</ul>
<br/>
<br/>
<h5 id="运行我们编译的内核">运行我们编译的内核</h5>
<p>  通过本文介绍生成的文件是Linux内核镜像，稍微懂点行的人都知道还差一个RootFS。这个文件系统我们在网上下载的例如： <a target="_blank" rel="noopener" href="http://oldlinux.org/Linux.old/bochs/linux-0.12-080324.zip">http://oldlinux.org/Linux.old/bochs/linux-0.12-080324.zip</a> 。本文生成的Linux内核镜像使用的是rootimage-0.12-hd这个文件系统。</p>
<p>  我建议这里自己配置两个.bxrc文件，一个对应bochs，一个对应bochsdbg远程调试。这样在遇到问题的时候我们可以很方便的调试。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="LinuxKernel启动简介">LinuxKernel启动简介</h3>
<hr>
<p>  本节简述LinuxKernel的启动流程。根据我近段时间的学习来看，这里包含了许多的历史性的东西，大家不要去细究为啥是这样，很多都是为了兼容。</p>
<p>  此外在整个学习期间，由于涉及到许多的x86 硬件体系知识，除了参考上文我说的文档以外，还必须参考以下Intel官方文档：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>Intel® 64 and IA-32 architectures software developer’s manual combined volumes 2A, 2B, 2C, and 2D:Instruction set reference, A-Z</p>
</li>
<li class="lvl-2">
<p>Intel® 64 and IA-32 architectures software developer’s manual combined volumes 3A,<br>
3B, 3C, and 3D: System programming guide</p>
</li>
<li class="lvl-2">
<p>《Linux内核完全注释(PDF) v5.0 by 赵炯.pdf》 第4章，全篇精华。</p>
</li>
</ul>
<br/>
<br/>
<h5 id="boot-bootsect-S-阶段">boot/bootsect.S 阶段</h5>
<p>  当我们的计算机上电以后，IntelCPU进入实模式，并且PC指向了0xfff0整个地址，如下图。什么意思呢？就是开机的时候执行的第一句指令放在0xffff0这个地方，通常这里有一个很重要的东西叫做BIOS。我们可以看到下图，cs=0xf000,base=0xffff0000,在实模式下面，cs:pc 就是真实的指向地址0xffff0。到了这里不知道大家发现没有，这里还差一个东西，那就是bios本来是放在rom里面的，怎么被指向了内存地址0xffff0的地方呢？是谁在之前自动搬运的吗？经过查询后发现，大部分人说开机的时候，对特殊地址的访问会被仲裁器件指向BIOS-ROM器件。仲裁器还可以把地址翻译并指向我们熟悉的MEM和IO。所以这里我理解对0xffff0的访问就是对BIOS-ROM器件的直接访问和执行。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_102/poweron.png" alt="poweron_img"/></center>
    </div>
</div>    
<p>  BIOS主要是做自检，并且在物理地址0x0开始初始化BIOS的中断向量，同时通过BIOS访问存储设备的中断，将可启动设备的第一个扇区512字节给搬运到绝对地址0x7c00(31k)处。然后跳转到0x7c00继续执行，这里被搬运的512字节就是bootsect.S生成的指令。这一段没啥营养，都是一些约定好的，到了CPU执行到绝对地址0x7c00的时候，才是真正的我们能控制的地方。其实这里也能够看到，我们的bootsect.S生成的指令最大只能够512字节，超过了就会出问题。下图为我们的0x7c00处的开始几句指令和bootsect.S的几句指令,同时也能够看到BIOS初始化和自检打印的一些内容：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_102/7c00.png" alt="7c00_img"/></center>
    </div>
</div>   
&emsp;&emsp;在上图的图中，我打印了0x7c00开始的一部分反汇编代码。可以看到和下面的bootsect.S的代码是一致的。
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">entry start
start:
! start at 0x07c0:0
! add by sky
	mov ax,#BOOTSEG
	mov es,ax
	mov	bp,#msg2	  ! sky-notes: src-str is es:bp
	mov	si,#15        ! sky-notes: src-str-len is cx
	call pirnt_str
! add by sky

	mov	ax,#BOOTSEG
	mov	ds,ax
	mov	ax,#INITSEG
	mov	es,ax
	mov	cx,#256
	sub	si,si
	sub	di,di
	rep
	movw
	jmpi	go,INITSEG<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  从0x7c00开始，就是我们自己的可以编程的领域了，也开始有了一些我自己特有的内容。主要是各种方法实现的print语句。这种调试方法简直不要太好。</p>
<p>  下面简要说明一下bootsect.S的功能：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>首先用rep movw把自己从0x7c00搬运到0x90000，并跳转cs=0x9000, pc=go 标号的地址。继续执行剩下的内容。</p>
</li>
<li class="lvl-2">
<p>通过读取0x1E号中断向量位置的软驱参数（由BIOS初始化时候通过BIOS中断读取的）到内存，然后修改其中的最大扇区数，并重新写回到0x1E中断向量位置绝对地址0x78去。最后重置软驱，使其加载最新的参数。</p>
</li>
<li class="lvl-2">
<p>使用BIOS INT 0x13的2号功能，将第一个软盘第2，3，4，5扇区读取到0x90200开始的位置。这里读取的就是setup.S的指令内容，最大共2k（4*512）。0x90000-0x90200存放的是bootsect.S， 0x90200-0x90A00 为setup.S。</p>
</li>
<li class="lvl-2">
<p>使用BIOS INT 0x13的8号功能，读取磁盘参数：每磁道扇区数。并保存到变量sectors中。</p>
</li>
<li class="lvl-2">
<p>使用BIOS INT 0x13的2号功能，使用刚刚的参数，读取system模块到0x10000，我们的bootsect.S放在0x90000,所以我们system模块最大只能够占用0x10000~0x8ffff。这里的system模块就是除了bootsect和setup模块之外的所有内核代码。</p>
</li>
<li class="lvl-2">
<p>判断bootsect模块第508，509字节是否为0，来判断我们是否指定根文件系统的设备号。我们的内核定义为0x0301，代表第一个磁盘第一个分区为我们的根文件系统。</p>
</li>
<li class="lvl-2">
<p>然后通过jmpi 0:9020跳转到cs=0x9020，pc=0的地方去执行setup.S的代码。</p>
</li>
</ul>
<p>  在我的bootsect模块，我定义了一个打印字符串的函数，主要是通过使用BIOS INT 0x10的0x13号功能实现。主要还是为了调试，注意，这里不能够随意添加代码，因为生成的代码超过512byte后，链接器会报错。只能够少量的添加我们的调试代码。</p>
<p>  至此，我们就执行完了bootsect模块。本模块的主要内容还是加载setup和system到指定位置。bootsect执行的一些调试日志如下图（在0x90200下断点）：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_102/bootsect_log.png" alt="bootsect_log_img"/></center>
    </div>
</div>   
注意：图中话框的部分就是我们上文贴出的call pirnt_str打印的。
<br/>
<br/>
<h5 id="boot-setup-S-阶段">boot/setup.S 阶段</h5>
<p>  首先我们还是来看一下0x90200的位置是否是setup.S，换句话来说是否加载好了setup模块。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_102/90200.png" alt="90200_img"/></center>
    </div>
</div>   
&emsp;&emsp;这里和bootsect一样，我也弄了一个prtstr函数，这个prtstr和bootsect里面的是一样的，原理也是一致的。
<p>  刚刚我们提到，setup是从0x90200开始存放的。那么0x90000~0x901ff中的bootsect已经无用了，于是我们setup中，用这里的内存存放一些参数。下面简要说明一下setup.S的功能：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>用BIOS INT 0x15功能号0x88取系统所含扩展内存大小并保存在内存0x90002~0x90003处。共两个字节。</p>
</li>
<li class="lvl-2">
<p>用BIOS INT 0x10功能号0x12读取显卡参数，0x9000A 显存大小，0x9000B 显卡类型（单色/彩色）,0x9000C显卡特性参数。</p>
</li>
<li class="lvl-2">
<p>用BIOS中断读取屏幕的行列存放到0x9000E 0x9000F</p>
</li>
<li class="lvl-2">
<p>用BIOS INT 0x10功能号0x03读取当前光标位置存放到0x90000 0x90001</p>
</li>
<li class="lvl-2">
<p>用BIOS INT 0x10功能号0x0f读取当前显示页，显示模式，字符列数。 0x90004~0x90005 存放当前显示页。 0x90006 显示模式， 0x90007 字符列数。</p>
</li>
<li class="lvl-2">
<p>读取第一个硬盘参数表和第二个硬盘参数表，并放到0x90080 0x90090。每个表共16byte。注意，这里和之前的软盘参数一样，在BIOS自检过程中，就被放到了中断向量0x41 0x46 的位置。</p>
</li>
<li class="lvl-2">
<p>用BIOS INT 0x13功能号0x15读取当前硬盘设备情况，如果硬盘2不存在，则把0x90090之后的16byte清零。</p>
</li>
</ul>
<p>  下面我们将使CPU从实模式变更为保护模式，下面继续说明一下setup.S的功能：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>禁用中断。</p>
</li>
<li class="lvl-2">
<p>然后我们把system模块0x10000~0x8ffff整体下移到0x0开始的位置。就是把最大0x80000(512k)的system模块向下移动0x10000(64k)。</p>
</li>
<li class="lvl-2">
<p>首先加载LDT和GDT。</p>
</li>
<li class="lvl-2">
<p>开启A20地址线，支持1M以上的内存。</p>
</li>
<li class="lvl-2">
<p>初始化两个8259A中断控制器。</p>
</li>
<li class="lvl-2">
<p>通过lmsw 设置cr0最低位位1，进入保护模式。</p>
</li>
<li class="lvl-2">
<p>通过jmpi 0:0x8跳转到绝对地址0x0开始执行system的代码。system是从boot/head.s开始的。</p>
</li>
</ul>
<p>  这里需要说明几个事情：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>我们在下移system模块的时候，覆盖了BIOS中断向量表。所以通过BIOS中断打印字符串是行不通的。</p>
</li>
<li class="lvl-2">
<p>在实模式中，cs:pc就是真实执行的地址。但是在保护模式中，cs是一个选择符号，根据选择符号值不同，分表在GDT或者LDT中查找对应的CS段描述符，其中最重要的就是base地址，当未开启分页的时候，这里的base+pc就是我们真实的执行地址。上面我们加载了LDT和GDT。这里的LDT是空，GDT有3项，第零项是空，第一项是代码段描述符，第二项是数据段描述符，他们的基地址都是0x0。当cs=0x08,ds=0x10时，分别指向这里的第一项和第二项。</p>
</li>
</ul>
<p>  刚刚说了，system下移导致BIOS中断向量表被冲掉了，于是我们不能够通过BIOS打印字符串，于是这里我们使用的是直接操作显存内存地址显示字符，这个原理和LinuxKernel tty显示原理差别不是很大。</p>
<p>  这里我们设计了print_str函数，通过直接操控显存然后写入字符进行显示，这里还使用到了刚刚我们保存的当前光标位置（0x90000 0x90001）。写这个主要还是为了调试。</p>
<p>  到此，我们已经开始去执行system的内容，其中head.s是入口。下图是在0x0下断点得到的setup模块的一些打印日志。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_102/setup_log.png" alt="setup_log_img"/></center>
    </div>
</div>   
&emsp;&emsp;这里我们可以看到，红框还是BIOS中断打印的，黄框是通过直接操纵显存显示的。注意，我这里设计的直接操作显存的函数，是通过循环在当前显存页显示的，并不是我们常见的整页上移的方式。
<br/>
<br/>
<h5 id="boot-head-s-阶段">boot/head.s 阶段</h5>
<p>  首先我们还是来看一下0x0的位置是否是head.s，换句话来说是否加载好了system模块。并且，从这里开始，我们就是进入了真正的LinuxKernel的世界，前面都是做一些环境初始化，都是一些固定的内容。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_102/head_start.png" alt="head_start_img"/></center>
    </div>
</div>   
<p>  这里我们需要说明的是，bootsect.S和setup.S用的是intel汇编，而从head.s开始，我们用的都是AT&amp;T汇编。同理，这里我也弄了一个safe_mode_print_str_no_page，打印字符串，为了调试，还是用的直接操作显存的方式。</p>
<p>  从这里开始，CPU开始工作于保护模式，下面简要介绍一下工作流程：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>刚刚我们通过jmpi切换到0x0开始执行，这时cs=0x8,根据setup设置好的GDT，base为0x0，同理我们设置其他段寄存器。</p>
</li>
<li class="lvl-2">
<p>设置堆栈为stack_start，这个就是内核堆栈。此符号定义于kernel/sched.c中，如下文。</p>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> user_stack <span class="token punctuation">[</span> PAGE_SIZE<span class="token operator">>></span><span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">long</span> <span class="token operator">*</span> a<span class="token punctuation">;</span>
	<span class="token keyword">short</span> b<span class="token punctuation">;</span>
	<span class="token comment">// &#125; stack_start = &#123; &amp; user_stack [PAGE_SIZE>>2] , 0x10 &#125;;</span>
	<span class="token punctuation">&#125;</span> stack_start <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token operator">&amp;</span> user_stack <span class="token punctuation">,</span> <span class="token number">0x10</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul class="lvl-0">
<li class="lvl-2">
<p>设置IDT，所有的中断向量指向ignore_int，一个预定义的中断服务程序。共256项，每项8byte。</p>
</li>
<li class="lvl-2">
<p>重新设置GDT。共256项，每项8byte。重新设置GDT的原因是setup的GDT可能会被冲掉，于是把GDT设置到合理的内存位置。这里设置好的GDT有4个。和setup中类似。第0，3个为0.第1，2项为cs和ds的段描述符。</p>
</li>
<li class="lvl-2">
<p>检查A20是否开通，主要是通过判断0x100000 和 0x0值是否相等。</p>
</li>
<li class="lvl-2">
<p>检查数学协处理器是否存在。</p>
</li>
</ul>
<p>  到这里，我们就开始准备正式进入到init/main.c中的main函数了，但是还差最后一个重要的事情，那就是启用分页机制，下面继续介绍其工作流程：</p>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">after_page_tables:
	# sky print
	push %ebp
	lea msg5, %ebp
	call safe_mode_print_str_no_page
	pop %ebp	
	#
	pushl $0		# These are the parameters to main :-)
	pushl $0
	pushl $0
	pushl $L6		# return address for main, if it decides to.
	pushl $main
	jmp setup_paging<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul class="lvl-0">
<li class="lvl-2">
<p>从上面的代码我们可只，我们在启用分页前，把init/main.c中的main函数地址设置到了堆栈中。</p>
</li>
<li class="lvl-2">
<p>首先我们把从0x0开始的5页内存清零。每页4096字节。其中第一页为页表目录，第2-5页为页表。</p>
</li>
<li class="lvl-2">
<p>设置页表目录的前4项为第2-5页页表地址。注意页表目录为1024项，每项4字节。</p>
</li>
<li class="lvl-2">
<p>倒序设置每一个页表的每一项内容，第5页最后一项为0xfff000。映射之后，2-5页分别映射好了16MB内存的空间。</p>
</li>
<li class="lvl-2">
<p>操作cr0，开启分页</p>
</li>
<li class="lvl-2">
<p>通过ret指令，从堆栈中把main地址弹出去执行。</p>
</li>
</ul>
<p>  到这里，我们正式进入到init/main.c中的main函数中，进入c语言相关代码的地界。下面是进入main之前的一些日志输出。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_102/head_log.png" alt="head_log_img"/></center>
    </div>
</div>   
<br/>
<br/>
<h5 id="init-main-c-到进入shell">init/main.c 到进入shell</h5>
<p>  这里我们进入了init/main.c中的main函数，可从下图看到。从这里开始，也是我们大家都熟知的Linux内核部分。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_102/init_main.png" alt="init_main_img"/></center>
    </div>
</div>   
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>		<span class="token comment">/* This really IS void, no error here. */</span>
<span class="token punctuation">&#123;</span>			<span class="token comment">/* The startup routine assumes (well, ...) this */</span>
<span class="token comment">/*
 * Interrupts are still disabled. Do necessary setups, then
 * enable them
 */</span>
	<span class="token keyword">char</span> _my_msg_buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>_my_msg_buf<span class="token punctuation">,</span> <span class="token string">"kernel main() start, root_dev=%x, swap_dev=%x ... ...\0"</span><span class="token punctuation">,</span> ORIG_ROOT_DEV<span class="token punctuation">,</span> ORIG_SWAP_DEV<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__asm__</span> <span class="token punctuation">(</span>
	<span class="token string">"push %%ebp\n\t"</span>
	<span class="token string">"mov %0, %%ebp\n\t"</span>
	<span class="token string">"call safe_mode_print_str_after_page\n\t"</span> 
	<span class="token string">"pop %%ebp\n\t"</span>
	<span class="token operator">:</span>
	<span class="token operator">:</span><span class="token string">"p"</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_my_msg_buf<span class="token punctuation">)</span>
	<span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



 	ROOT_DEV <span class="token operator">=</span> ORIG_ROOT_DEV<span class="token punctuation">;</span>
 	SWAP_DEV <span class="token operator">=</span> ORIG_SWAP_DEV<span class="token punctuation">;</span>

	<span class="token function">sprintf</span><span class="token punctuation">(</span>term<span class="token punctuation">,</span> <span class="token string">"TERM=con%dx%d"</span><span class="token punctuation">,</span> CON_COLS<span class="token punctuation">,</span> CON_ROWS<span class="token punctuation">)</span><span class="token punctuation">;</span>

	envp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> term<span class="token punctuation">;</span>	
	envp_rc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> term<span class="token punctuation">;</span>
 	drive_info <span class="token operator">=</span> DRIVE_INFO<span class="token punctuation">;</span>

	memory_end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>EXT_MEM_K<span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	memory_end <span class="token operator">&amp;=</span> <span class="token number">0xfffff000</span><span class="token punctuation">;</span><span class="token comment">//align 4k</span>



	<span class="token keyword">if</span> <span class="token punctuation">(</span>memory_end <span class="token operator">></span> <span class="token number">16</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token comment">//if memory_end > 16MB, set it to be 16 MB</span>
		memory_end <span class="token operator">=</span> <span class="token number">16</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>memory_end <span class="token operator">></span> <span class="token number">12</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> 
		buffer_memory_end <span class="token operator">=</span> <span class="token number">4</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>memory_end <span class="token operator">></span> <span class="token number">6</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span>
		buffer_memory_end <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		buffer_memory_end <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span>

	main_memory_start <span class="token operator">=</span> buffer_memory_end<span class="token punctuation">;</span>

	<span class="token function">sprintf</span><span class="token punctuation">(</span>_my_msg_buf<span class="token punctuation">,</span> <span class="token string">"Mem size is %x, buf-mem size is %x, main-mem start %x ... ...\0"</span><span class="token punctuation">,</span> memory_end<span class="token punctuation">,</span> main_memory_start<span class="token punctuation">,</span> buffer_memory_end<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__asm__</span> <span class="token punctuation">(</span>
	<span class="token string">"push %%ebp\n\t"</span>
	<span class="token string">"mov %0, %%ebp\n\t"</span>
	<span class="token string">"call safe_mode_print_str_after_page\n\t"</span> 
	<span class="token string">"pop %%ebp\n\t"</span>
	<span class="token operator">:</span>
	<span class="token operator">:</span><span class="token string">"p"</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_my_msg_buf<span class="token punctuation">)</span>
	<span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">RAMDISK</span></span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>_my_msg_buf<span class="token punctuation">,</span> <span class="token string">"ramdisk init ... ...\0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__asm__</span> <span class="token punctuation">(</span>
	<span class="token string">"push %%ebp\n\t"</span>
	<span class="token string">"mov %0, %%ebp\n\t"</span>
	<span class="token string">"call safe_mode_print_str_after_page\n\t"</span> 
	<span class="token string">"pop %%ebp\n\t"</span>
	<span class="token operator">:</span>
	<span class="token operator">:</span><span class="token string">"p"</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_my_msg_buf<span class="token punctuation">)</span>
	<span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	main_memory_start <span class="token operator">+=</span> <span class="token function">rd_init</span><span class="token punctuation">(</span>main_memory_start<span class="token punctuation">,</span> RAMDISK<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token function">sprintf</span><span class="token punctuation">(</span>_my_msg_buf<span class="token punctuation">,</span> <span class="token string">"memory init ... ...\0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__asm__</span> <span class="token punctuation">(</span>
	<span class="token string">"push %%ebp\n\t"</span>
	<span class="token string">"mov %0, %%ebp\n\t"</span>
	<span class="token string">"call safe_mode_print_str_after_page\n\t"</span> 
	<span class="token string">"pop %%ebp\n\t"</span>
	<span class="token operator">:</span>
	<span class="token operator">:</span><span class="token string">"p"</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_my_msg_buf<span class="token punctuation">)</span>
	<span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">mem_init</span><span class="token punctuation">(</span>main_memory_start<span class="token punctuation">,</span>memory_end<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">sprintf</span><span class="token punctuation">(</span>_my_msg_buf<span class="token punctuation">,</span> <span class="token string">"trap init ... ...\0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__asm__</span> <span class="token punctuation">(</span>
	<span class="token string">"push %%ebp\n\t"</span>
	<span class="token string">"mov %0, %%ebp\n\t"</span>
	<span class="token string">"call safe_mode_print_str_after_page\n\t"</span> 
	<span class="token string">"pop %%ebp\n\t"</span>
	<span class="token operator">:</span>
	<span class="token operator">:</span><span class="token string">"p"</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_my_msg_buf<span class="token punctuation">)</span>
	<span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">trap_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">sprintf</span><span class="token punctuation">(</span>_my_msg_buf<span class="token punctuation">,</span> <span class="token string">"blk init ... ...\0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__asm__</span> <span class="token punctuation">(</span>
	<span class="token string">"push %%ebp\n\t"</span>
	<span class="token string">"mov %0, %%ebp\n\t"</span>
	<span class="token string">"call safe_mode_print_str_after_page\n\t"</span> 
	<span class="token string">"pop %%ebp\n\t"</span>
	<span class="token operator">:</span>
	<span class="token operator">:</span><span class="token string">"p"</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_my_msg_buf<span class="token punctuation">)</span>
	<span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">blk_dev_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">sprintf</span><span class="token punctuation">(</span>_my_msg_buf<span class="token punctuation">,</span> <span class="token string">"chr init ... ...\0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__asm__</span> <span class="token punctuation">(</span>
	<span class="token string">"push %%ebp\n\t"</span>
	<span class="token string">"mov %0, %%ebp\n\t"</span>
	<span class="token string">"call safe_mode_print_str_after_page\n\t"</span> 
	<span class="token string">"pop %%ebp\n\t"</span>
	<span class="token operator">:</span>
	<span class="token operator">:</span><span class="token string">"p"</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_my_msg_buf<span class="token punctuation">)</span>
	<span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">chr_dev_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">sprintf</span><span class="token punctuation">(</span>_my_msg_buf<span class="token punctuation">,</span> <span class="token string">"tty init ... ...\0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__asm__</span> <span class="token punctuation">(</span>
	<span class="token string">"push %%ebp\n\t"</span>
	<span class="token string">"mov %0, %%ebp\n\t"</span>
	<span class="token string">"call safe_mode_print_str_after_page\n\t"</span> 
	<span class="token string">"pop %%ebp\n\t"</span>
	<span class="token operator">:</span>
	<span class="token operator">:</span><span class="token string">"p"</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_my_msg_buf<span class="token punctuation">)</span>
	<span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">tty_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"time init ... ...\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">time_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"sched init ... ...\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sched_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	After sched_init()

	gdt[0] = NULL
	gdt[1] = kernel cs
	gdt[2] = kernel ds
	gdt[3] = NULL
	
	gdt[4] = task0.tss
	gdt[5] = task0.ldt

	tr=task0.tss
	ldtr=task0.ldt
	*/</span>

	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"buffer init ... ...\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">buffer_init</span><span class="token punctuation">(</span>buffer_memory_end<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"hd init ... ...\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">hd_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"floppy init ... ...\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">floppy_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"enable interrupts ... ...\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sti</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"go to user mode ... ...\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	movl %%esp,%%eax
	pushl $0x17
	pushl %%eax
	pushfl
	pushl $0x0f
	pushl $1f
	iret
	1:
	movl $0x17,%%eax
	mov %%ax,%%ds
	mov %%ax,%%es
	mov %%ax,%%fs
	mov %%ax,%%gs

	iret instruction will do follow op:
	popl eip
	popl cs
	popl eflag
	popl esp
	popl ss
	*/</span>
	<span class="token function">move_to_user_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"user_mode: fork() task0 ... ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>		<span class="token comment">/* we count on this going ok */</span>

		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"user_mode: task1 call init ... ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token comment">/*
 *   NOTE!!   For any other task 'pause()' would mean we have to get a
 * signal to awaken, but task0 is the sole exception (see 'schedule()')
 * as task 0 gets activated at every idle moment (when no other tasks
 * can run). For task0 'pause()' just means we go check if some other
 * task can run, and if not we return here.
 */</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"user_mode: task0 call sys_pause() in while ... ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
		<span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">"int $0x80"</span><span class="token operator">::</span><span class="token string">"a"</span> <span class="token punctuation">(</span>__NR_pause<span class="token punctuation">)</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  注意，这里我们仍然设计了一个函数为safe_mode_print_str_after_page，通过直接操作显存进行显示字符串，知道tty_init之后，我们才能够调用printk类似的函数进行打印。</p>
<p>  下面简要介绍一下main函数主要做的事情：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>根据我们在setup中保存到内存中的内存参数初始化高速缓冲区和主存的位置。</p>
</li>
<li class="lvl-2">
<p>然后就是我们常见的初始化mm模块。</p>
</li>
<li class="lvl-2">
<p>初始化中断向量。</p>
</li>
<li class="lvl-2">
<p>初始化块设备。</p>
</li>
<li class="lvl-2">
<p>初始化字符串设备。</p>
</li>
<li class="lvl-2">
<p>初始化tty设备。</p>
</li>
<li class="lvl-2">
<p>初始化时间。</p>
</li>
<li class="lvl-2">
<p>初始化调度模块。</p>
</li>
<li class="lvl-2">
<p>初始化缓冲区。</p>
</li>
<li class="lvl-2">
<p>初始化硬盘。</p>
</li>
<li class="lvl-2">
<p>初始化软盘。</p>
</li>
<li class="lvl-2">
<p>开启中断。</p>
</li>
<li class="lvl-2">
<p>把当前任务切换到用户态。</p>
</li>
</ul>
<p>  当我们切换到用户态之后，并且当前我们的进程是0号进程，我们内核的一些重要初始化基本设置完毕。然后就像我们常见的linux编程那样，通过fork，创建我们的1号进程。然后我们继续进行下面的事情：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>task0在fork出task1之后，就循环调用sys_pause, 这里主要还是执行schedule()开始执行进程调度。</p>
</li>
<li class="lvl-2">
<p>task1成功创建后，调用setup，开始加载根文件系统。然后task1 通过fork创建了task2。</p>
</li>
<li class="lvl-2">
<p>task2通过execve开始运行/bin/sh，进入shell。后续就是一些其他的事情。</p>
</li>
</ul>
<p>  到这里，我们已经把kernel跑起来了。在我调试的过程中，主要还是mm模块和schedule模块有些问题，可能和编译器版本有关系，反正我生成的代码，总会报错。哪怕到现在，我开源出来的我修改的内核，也非常的不稳定，经常崩溃。但是好在正常工作了。</p>
<p>  下面给出两种不同打印的日志：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_102/main_log0.png" alt="main_log0_img"/></center>
    </div>
</div>   
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_102/main_log1.png" alt="main_log1_img"/></center>
    </div>
</div>   
<br/>
<br/>
<h5 id="tool-build-c">tool/build.c</h5>
<p>  此工具是生成LinuxKernel镜像的手段。但是我们在Ubuntu上生成的内核，由于gcc版本变更的原因，需要做一些变更。主要还是把生成的elf格式system模块通过objcopy 生成二进制内存镜像。主要原因就是elf格式需要一个elf加载器进行各个段的重定位，但是由于我们是内核，所以没有。详情，请查看tool/build.c 及 Makefile。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="开源">开源</h3>
<hr>
<p>  <a target="_blank" rel="noopener" href="https://github.com/flyinskyin2013/LinuxKernel-src0.12">https://github.com/flyinskyin2013/LinuxKernel-src0.12</a></p>
<p>  <a target="_blank" rel="noopener" href="https://gitee.com/sky-X/LinuxKernel-src0.12">https://gitee.com/sky-X/LinuxKernel-src0.12</a> （镜像）</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  为啥想要在ubuntu1804环境下弄这个东西呢？一方面是想学习一下，通过踩坑的方式加深自己的理解。另一方面还是太懒了，我只想在我的ubuntu1804上编译内核，不想安装其他虚拟机了，我的电脑太卡了（毕竟8年的电脑了QAQ）。</p>
<p>  经过了这一波调试，我对LinuxKernel有了更深的认知，我觉得很不错，如果以后有必要，我还可以分别对这些模块进行详细的查看，在这里，我只是简单的说明了init/main中的内容，其实，还有许多其他的内容是运行在背后的。比如system_call,sys_table等等内容。还有do_fork do_execve等等内容都是我在调试过程中踩过的坑。</p>
<p>  这里还是要说明，深入调试学习这个的原因还是想看看OS是怎么运行起来，虽然不能说已经100%的熟知，但是也可管中窥豹。</p>
<p>  注意，这个版本的内核和现代的2.0，4.0，5.0还缺了一些主要的知识，比如网络栈，VFS等。但是其他的一些内容，在现在的最新内核中，多多少少都能够看到这个版本的一些影子。这也是学习这个内核的原因之一。</p>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2020/10/20/blog_idx_101/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/10/20/blog_idx_101/" class="post-title-link" itemprop="url">字符集、字符编码、国际化、本地化简要总结(UNICODE/UTF/ASCII/GB2312/GBK/GB18030)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-10-20 18:21:27" itemprop="dateCreated datePublished" datetime="2020-10-20T18:21:27+08:00">2020-10-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%B8%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">常识</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%B8%E8%AF%86/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>17 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2023-04-08 11:03:57
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=101）
&emsp;&emsp;本文发布于 2020-10-20 18:21:27    （BlogID=101）  -->
<h6 id="环境说明">环境说明</h6>
<p>  普通的linux 和 普通的windows。<br>
  VS2015 和 GCC 7.0</p>
<h3 id="前言">前言</h3>
<hr>
<p>  曾记得，我在(<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011728480/article/details/100277582">https://blog.csdn.net/u011728480/article/details/100277582</a>  《数与计算机 （编码、原码、反码、补码、移码、IEEE 754、定点数、浮点数）》)里面说过，计算机里面存储了数值和符号。数值包含定点数和浮点数。符号包含文字及其他符号。</p>
<p>  那符号在计算机中是怎么表示的呢？这里首先就要引出一个概念叫做字符集，就是“人为”记录归纳的某种文字或者符号在这个集合中的索引(例如：Ascii 中的’a’ 的索引为97)。有了这个字符集合后，我们怎么在计算机中表示这个字符集合呢？毕竟我们设计这个字符集合就是为了在计算机里面显示相关的符号的。这里我们就要引出一个字符编码的概念，就是在计算机中怎么表示相关的符号（例如：Ascii 我们发现基本的字符集只规定了128个。于是我们用一个字节来标识这个字符集中的字符即可。）。注意这里提到的Ascii即可指字符编码也可指字符集，至少我是这样理解的。</p>
<p>  一直以来，我反正只是大概模糊的记得，ascii 代表字母及其他基本字符。 gb2312/gbk/gb18030/big5 … 代表的就是多字节的中文及其他字符。unicode 和 utf-8 可以代表世界上大部分国家及地区的字符符号，同时unicode是两字节的，utf-8是多字节的(注意，关于unicode的说法其实有点小毛病，详见下文)。我早就想详细的了解和记录一下这些说法的含义，但是一直没有一个较好的机会。</p>
<p>  最近做的一个项目里面，要在内存里面查找和对比中文（c++ 里面存的中文，lua要去找和对比），这NM可把我苦惨了，于是我一狠心，就要把这个问题搞明白，不求全部搞清楚，但求我能够怎么解决这个问题，以及以后遇到这些问题怎么处理。</p>
<p>  下面是一些常见及不常见短语说明：</p>
<ol>
<li class="lvl-3">
<p>UNICODE（The Unicode Consortium（统一码联盟，是大公司组合的联盟），一种字符集）</p>
</li>
<li class="lvl-3">
<p>UCS（Universal Multiple Octet Coded Character Set（通用多字符编码集，是ISO标准委员会提出的），一种字符集）</p>
</li>
<li class="lvl-3">
<p>UTF/UTF-8/UTF-16（一种基于UNICODE的字符编码格式，UTF是UCS Transfer Format的简写）</p>
</li>
<li class="lvl-3">
<p>GB2312/GBK/GB18030（全国信息技术标准化技术委员会出版的3个版本的字符集及字符编码格式）</p>
</li>
<li class="lvl-3">
<p>ASCII(American Standard Code for Information Interchange，常见的基本英文编码)</p>
</li>
<li class="lvl-3">
<p>DBCS(Double-byte character set)</p>
</li>
<li class="lvl-3">
<p>ANSI(不知道是什么的简写，但是只会出现在windows平台)</p>
</li>
<li class="lvl-3">
<p>本地化/国际化(本地化和国际化是一个比较坑的概念，本地化可以简单理解为把文字和符号显示给对应区域的人。 国际化就是把文字和符号显示给尽量多的人。我也不知道这样翻译对不对QAQ)</p>
</li>
</ol>
<br/>
<br/>
<br/>
<br/>
<h3 id="常见的字符集及对应的字符编码规则说明">常见的字符集及对应的字符编码规则说明</h3>
<hr>
<p>  字符集是存放的人为定义的一个字符索引集合。 字符编码是考虑怎么把这个字符集合在计算机中表示出来。</p>
<br/>
<br/>
<h5 id="常见中文字符集及字符编码-GB2312-GBK-GB18030">常见中文字符集及字符编码(GB2312/GBK/GB18030)</h5>
<p>  关于GB2312/GBK/GB18030的详细说明大家可以去网上找找资料详细了解，他们有许多的历史因素在里面。我这里就只做简单的说明。</p>
<p>  首先GB2312/GBK/GB18030是三个国标的简称。是全国信息技术标准化技术委员会参考或者说是对接ISO提出的字符集/字符编码方法，然后出版的适合中国特色的字符集/字符编码标准。注意这里的GB2312/GBK/GB18030既可以称作字符集也可以称作字符编码，我们好像常用是把这个三个当做字符编码，但是没有强调字符集是什么，所以我觉得这个是三个即是字符集又是字符编码。下面对这三个字符编码规则进行简单的说明，这些规则里面可能有些历史原因小故事在里面，感兴趣的人去网上找找看，我这里不做无用功了。</p>
<p>  GB2312是我国第一个字符集/字符编码。其使用2个字节代表一个汉字，而且为了兼容Ascii，约定两个编码字符都必须大于0xA0（每个字节都大于127，可以区分出Ascii与GB2312）。也就是说，GB2312的编码范围为：0xA1A1~0xF7FE。而且由于标注出版的比较早，里面只包含了常见的汉字和非汉字内容。</p>
<p>  GBK是对GB2312的扩展。同样也是使用2个字节代表一个汉字。首先GBK原封不动的继承了GB2312的编码，同时编码范围由0xA1A1~0xF7FE 扩展到0x8140~0xFEFE。多余GB2312的这些编码，又添加了一些cjk的汉字和符号，同时也提供了自定义文字区域编码的。</p>
<p>  GB18030是2005年出的最新的中文字符集/中文字符编码。它是变长字节编码方式，和utf系列很像。下面进行简略的说明：</p>
<ol>
<li class="lvl-3">
<p>1字节，0x00~0x7F  兼容Ascii</p>
</li>
<li class="lvl-3">
<p>2字节，0x8140~0xFEFE  兼容GBK</p>
</li>
<li class="lvl-3">
<p>4字节，0x81308130~0xFE39FE39 存放其他文字和符号，例如我国的少数民族的文字、繁体汉字、日韩汉字等等。</p>
</li>
</ol>
<p>  这里多说一句，采用变长编码的原因是节约字符存储空间或者说是为了节约网络传输带宽。</p>
<br/>
<br/>
<h5 id="常见的Unicode字符集与UTF系列编码">常见的Unicode字符集与UTF系列编码</h5>
<p>  上面我们介绍了中文的字符集及字符编码，可以想象的是，非中文，非英文地区的人，也会做和我们同样的事情，他们会定义适合他们自己的字符集，并定义适合他们自己的字符编码。那就直接炸裂了，因为每个地区都有自己的字符集和字符编码，非常不适合各个地方的人们文字交流。与此同时，网络使得各个地方的人们交流更加的频繁，于是有些人就不爽了，想定义一个字符集来包含全世界的所有字符，这样人们交流的时候就不需要对字符进行专门的转码。</p>
<p>  于是国际标准委员会和一个叫做统一码联盟的组织分别起草了一个字符集，分别是UCS 和 UNICODE。后面考虑到大家都是做的同样的事情，于是两个字符集合并了，叫做UCS/UNICODE。我们常见的是UCS-2/UNICODE。这个字符集里面包含了全世界大部分的文字和符号。其表示范围大概是0x000000 到 0x10FFFF。 UNICODE 字符索引一般表示为U+0x00AAAA</p>
<p>  在定义UCS/UNICODE这个超大字符集后，肯定想定义一个字符编码才符合这些组织的身份。于是产生了UTF字符编码系列的格式。我们常见的就是UTF-8/UTF-16 BE/UTF-16 LE/UTF-32 BE/UTF-32 LE格式。</p>
<p>  UTF-32简要说明：直接用4个字节表示UNICODE字符串， 例如索引U+0xABCDEFAA  就表示为0xABCDEFAA(BE 大端)  或者 0xAAEFCDAB(LE 小端)。</p>
<p>  UTF-16简要说明（windows常用编码，与UTF-32一样有类似的字节序存在）：</p>
<ol>
<li class="lvl-3">
<p>U+0x0000 到 U+0xFFFF 用2个字节表示。</p>
</li>
<li class="lvl-3">
<p>U+0x1 0000 到 U+0x10 FFFF 用4个字节表示。</p>
</li>
</ol>
<p>  下面对UTF-8进行简要的说明：</p>
<ol>
<li class="lvl-3">
<p>1字节，0000/0000-0000/007F(hex), 二进制填充方式：0xxx xxxx(binary)</p>
</li>
<li class="lvl-3">
<p>2字节，0000/0080-0000/07FF(hex), 二进制填充方式：110x xxxx/10xx xxxx(binary)</p>
</li>
<li class="lvl-3">
<p>3字节，0000/0800-0000/7FFF(hex), 二进制填充方式：1110 xxxx/10xx xxxx/10xx xxxx(binary)</p>
</li>
<li class="lvl-3">
<p>4字节，0001/0000-0010/FFFF(hex), 二进制填充方式：1111 0xxx/10xx xxxx/10xx xxxx/10xx xxxx(binary)</p>
</li>
</ol>
<p>  对应的编码范围是:</p>
<ol>
<li class="lvl-3">
<p>0~127</p>
</li>
<li class="lvl-3">
<p>128~2047</p>
</li>
<li class="lvl-3">
<p>2048~65535</p>
</li>
<li class="lvl-3">
<p>65536以上</p>
</li>
</ol>
<p>  UTF-8的实现方式就是查出字符索引：U+0xABCD(U+43981) ,可以看到落在的编码范围是3字节范围，也就是2048~65535。于是我们看到的二进制还有16个位置，恰好，我们的编码的二进制也是16个。从左到右依次放入对应位置的x即可。0xABCD二进制为：1010 1011 1100 1101, 对应的UTF-8编码为: 1110 (1010)/10(10) (1111)/10(00) (1101)<br>
<br/><br>
<br/><br>
<br/><br>
<br/></p>
<h3 id="本地化和国际化">本地化和国际化</h3>
<hr>
<p>  上面我们介绍了两个系列的字符集和对应常用的字符编码。GBXXX系列是CJK区域的多字节编码，UNICDOE/UTF系列是全球大多数通用字符集及编码。那么为了我们发布的计算机文件能够在全世界方便的使用，我们有两种方案：</p>
<ol>
<li class="lvl-3">
<p>使用区域性多字节编码，例如我们发布的文件，携带多种区域性字符编码文件(GBXXX/阿拉伯的编码等等)，在不同地区的电脑上，根据系统的地区（win和linux都有，很重要，设置区域），使用不同的区域字符编码文件进行显示。</p>
</li>
<li class="lvl-3">
<p>直接使用UNICDOE/UTF系列，全球通用。</p>
</li>
</ol>
<p>  看起来，直接使用UNICDOE/UTF系列就完事儿了，花里胡哨，弄那么多。其实不然，你看了UTF-8，对我们中文区来说不公平，因为大部分都是3字节，而对于Ascii区域来说，他们的UTF-8，大部分都是1字节。这NM就坑了撒，难道我大中华的硬盘或者带宽就无限了？其次，可能有些我们可以在GB系列里面定义的偏门字符内容，可能UNICODE里面没有，对于一个足够大的市场来说，如果连他们的文字符号都表示不完，那还玩个D。于是也需要有GB系列这种区域性的来补充，换句话说，就是看实际应用。这就是软件本地化和国际化的意义，里面最要命的就是字符问题。</p>
<h3 id="生活中常见的几个有趣小实验-猜到就让你嘿嘿嘿">生活中常见的几个有趣小实验(猜到就让你嘿嘿嘿)</h3>
<hr>
<p>  下面我们做一些比较有趣，而且常见的小实验。</p>
<br/>
<br/>
<h5 id="VS的Unicode字符集-和-多字符集选项-cl-exe">VS的Unicode字符集 和 多字符集选项(cl.exe)</h5>
<p>  在我们编程的时候，特别是要涉及中文编程的时候，很多时候需要和这个选项打交道，也就是如图。那么这两个选项有啥区别呢？请听我慢慢道来。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_101/character_set_vs.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  这个选项的主要作用是用来帮助 cl.exe 确认启用什么样的Api，也就是我们常说的W结尾的还是A结尾的Api。下面我们用下面的小程序来实验一波。</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">#include &lt;cstdio&gt;
#include &lt;windows.h&gt;
int main(int argc, char * argv[]) &#123;

	const char *_str &#x3D; &quot;卧槽&quot;;
	printf(&quot;_str&#39;s mem &#x3D; %x %x %x %x\n&quot;, 0xFF &amp; _str[0], 0xFF &amp; _str[1], 0xFF &amp; _str[2], 0xFF &amp; _str[3]);
	const wchar_t *_str_1 &#x3D; L&quot;卧槽&quot;;
	printf(&quot;_str&#39;s mem &#x3D; %x %x\n&quot;, 0xFFFF &amp; _str_1[0], 0xFFFF &amp; _str_1[1]);
	
	&#x2F;&#x2F;MessageBoxW(NULL, L&quot;卧槽&quot;, L&quot;U&quot;, MB_OK);
	&#x2F;&#x2F;MessageBoxA(NULL, &quot;卧槽&quot;, &quot;M&quot;, MB_OK);

	system(&quot;pause&quot;);
	return 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  运行以上代码我们可以得到下图的内容。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_101/str_mem_data.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  然后我们根据以上的内容，通过二进制编辑器，构造了两个txt文件。然后通过vs code 不同解码下打开。才能够得到正确文字内容。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_101/str_mem_data_infile.png" alt="rep_img"/></center>
    </div>
</div>    
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_101/example0.png" alt="rep_img"/></center>
    </div>
</div>   
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_101/example1.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  下面我们来解释Window Api中 A系列和W系列的区别。 例如在MessageBoxW(NULL, L&quot;卧槽&quot;, L&quot;U&quot;, MB_OK)和 MessageBoxA(NULL, “卧槽”, “M”, MB_OK)中，我们传入的参数一个是char *的，一个是wchar_t *,通过我们打印，可以发现对应的内存数据是完全不一样的，也就是说对应的文字编码是完全不同的。A系列对应的GB18030编码（多字节，区域编码，不同地区，可能就不是gb系列的编码了），W系列对应的UTF-16 BE编码（UNICODE）。那么，它们代表啥意思呢？</p>
<p>  如果我们用A系列的Api，那么就是用的多字节编码，也就是对应的本地区域编码，在我们这个CJK区域，能够正常显示文字，但是如果不在我们CJK区域的话，极有可能就出现乱码。也就是说，通过A系列弄出来的程序，很有可能就只能够在我们CJK区域使用，其他区域可能需要用源代码，在其他对应区域的VS编译一下，才能够正常使用程序。</p>
<p>  如果我们用W系列的Api，那么用的就是UTF-16 BE编码，由于UNICODE是针对全球大多数语言来做的一个字符集，那么意味着，我们这个程序只需要编译一次，把二进制分发到全世界大多数区域也能够正常使用的。</p>
<h5 id="GCC的-finput-charset-fexec-charset-gbk选项">GCC的-finput-charset/-fexec-charset=gbk选项</h5>
<p>  首先GCC的默认把源文件用UTF-8解码，如果遇到不支持的字符，需要使用-finput-charset来帮助才行。然后，我们分别带和不带-fexec-charset=gbk编译如下程序，并运行。</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">#include &lt;cstdio&gt;

int main(int argc, char * argv[]) &#123;

	const char *_str &#x3D; &quot;卧槽&quot;;
	printf(&quot;_str&#39;s mem &#x3D; %x %x %x %x %x %x\n&quot;, 0xFF &amp; _str[0], 0xFF &amp; _str[1], 0xFF &amp; _str[2], 0xFF &amp; _str[3], 0xFF &amp; _str[4], 0xFF &amp; _str[5]);
	const wchar_t *_str_1 &#x3D; L&quot;卧槽&quot;;
	printf(&quot;_str&#39;s mem &#x3D; %x %x\n&quot;, 0xFFFF &amp; _str_1[0], 0xFFFF &amp; _str_1[1]);
	return 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  得到如图的结果。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_101/str_mem_data_linux.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  从图片结果我们可以知道，GCC对待字符串的方式和CL.exe不是很一致，但是通过传入相关参数，即可得到同样的结果。这里强调一下，-fexec-charset 参数相当于cl.exe的解码设置，类似上文vs选项，我们可以知道GCC的多字节默认编码是UTF-8。同时，GCC和CL.exe一样，对于char_t类型，都是使用的UTF-16 BE格式。</p>
<p>  这里，我们通过如图的编码输出，手动来转换一下UTF-8和UNICODE，验证我们之前说的规则是否正确。</p>
<ol>
<li class="lvl-3">
<p>“卧” 对应的是U+005367,十进制为U+21351，二进制U+0101 0011 0110 0111，根据区域值，是3字节模式，对应填入得到UTF-8二进制 1110 0101 1000 1101 1010 0111,十六进制为0xE58DA7</p>
</li>
<li class="lvl-3">
<p>“槽” 对应的是U+0069FD,十进制为U+27133，二进制U+0110 1001 1111 1101‬，根据区域值，是3字节模式，对应填入得到UTF-8二进制 1110 0110 1010 0111 1011 1101,十六进制为0xE6A7BD</p>
</li>
<li class="lvl-3">
<p>参考模式：1110 xxxx/10xx xxxx/10xx xxxx(binary)</p>
</li>
</ol>
<p>  这里，我们发现，算出来的值，完全和我们的前面说的规则一样。</p>
<h5 id="VS-Debug模式下的“烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫”-看似搞笑行为">VS Debug模式下的“烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫” 看似搞笑行为</h5>
<p>  首先，我们在vs的debug模式下，运行如下程序。</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">#include &lt;cstdio&gt;

int main(int argc, char * argv[]) &#123;
    
	const char *_str &#x3D; &quot;卧槽&quot;;
	printf(&quot;_str&#39;s mem &#x3D; %x %x %x %x\n&quot;, 0xFF &amp; _str[0], 0xFF &amp; _str[1], 0xFF &amp; _str[2], 0xFF &amp; _str[3]);
	const wchar_t *_str_1 &#x3D; L&quot;卧槽&quot;;
	printf(&quot;_str&#39;s mem &#x3D; %x %x\n&quot;, 0xFFFF &amp; _str_1[0], 0xFFFF &amp; _str_1[1]);
	char _test[10];
	for (int i &#x3D; 0; i &lt; 10; i++)
		printf(&quot;%x &quot;, 0xFF&amp;_test[i]);

	printf(&quot;\n%s&quot;, _test);
	return 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  得到如图的结果。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_101/vs_tangtangtang.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  其实是由于vs 在debug模式下，会把我们为初始化的内存初始化为0xCC。而0xCCCC恰好是“烫”的GB18030编码，所以在我们CJK区域打印是“烫”，在其他区域可能是其他的字符。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  其实到了这里，我已经解决了我想要解决的问题。因为我只要知道目标程序的内存中中文的具体编码（OD或者CE等等），然后我就可以进行我想要的文字查找。</p>
<p>  其实本文也解决了gcc生成的程序和cl.exe生成的程序字符串交换的问题。一个默认用的utf-8，一个是本地编码，对我们来说，就是GB系列。</p>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2020/08/24/blog_idx_100/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/08/24/blog_idx_100/" class="post-title-link" itemprop="url">博客调整为MarkDown和图床外链、配置Gitee作为图床</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-08-24 22:02:00" itemprop="dateCreated datePublished" datetime="2020-08-24T22:02:00+08:00">2020-08-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%B8%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">常识</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky
 * @LastEditTime: 2020-08-26 11:19:30
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=100）
&emsp;&emsp;本文发布于 2020-08-24 22:02:00    （BlogID=100）-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  一直以来，我都想把我写的文章CSDN给备份下来，一个是我想做一些本地备份，保护我的创作文章，二一个是方便的移植发布到其他的平台，可能接触过的朋友知道，这是一个头疼的事情，其中最麻烦的事情就是图片问题。最近因为做了一些总结性的工作，于是想把这个问题解决掉。</p>
<p>  这里我采取的方案是MarkDown+图床外链的方式。其实以前也了解过这种方式，一直以来没有时间去整理。</p>
<p>  MarkDown是一种比较不错的语言，我们常见是用于rep的readme文件，其次就是写文章用来做格式控制比较不错，而且兼容一些html语法。图床就是可以通过http链接显示图片的网站，目前有许多的网站，有的收费，有的访问慢，有的不稳定。于是我这里根据我的喜好，选择了gitee pages功能作为我的blog文章的图床。类似的还有github也可以作为图床。</p>
<p>  有了图床+MarkDown写的文章，我的文章就可以很方便的本地浏览以及发布到多个平台，而不用担心图片的问题，就像我们写的程序源码那样，保证可移植性。最最最最重要的是，我们可以备份自己的文章，在离线状态下，通过MarkDown浏览器，可以正常查看自己的文章，包括查看图片。</p>
<p>  于是从这篇文章开始，我的所有文章将会启用这种方式，同时，本文也算是一个配置实例。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="通过Gitee-Pages功能创建一个属于自己的图床">通过Gitee Pages功能创建一个属于自己的图床</h3>
<hr>
<p>  其实图床搭建是很简单的，就是一个简单的http服务器，只是考虑到各种cdn加速，资源访问问题，所以我们要选用一个稳定的、较大的服务商作为我们图床。从本质来说，图床就是一个http服务器，我们可以通过http链接，访问我们存储的图片。</p>
<p>  GiteePages功能就是把我们gitee rep 根目录作为一个http服务根目录，然后提供链接，我们就可以访问到我们的仓库文件，包括文本、二进制、图片等。</p>
<br/>
<br/>
<h5 id="Gitee-创建一个公开仓库">Gitee 创建一个公开仓库</h5>
<p>  首先注册一个Gitee账号，登录到Gitee。如图点击新建rep，然后填写rep 名字，注意选择开源为公开，选择一个开源协议，点击初始化readme，点击创建即可。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_100/create_rep.png" alt="rep_img"/></center>
    </div>
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_100/create_rep1.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<h5 id="Gitee-开启GiteePage功能">Gitee 开启GiteePage功能</h5>
<p>  这个功能就是开启一个http服务器，http根目录指向我们的仓库根目录，然后即可通过url加上相对路径，即可访问我们的文件。<br>
  首先点击如图的地方，切换到gitee pages页面，然后点击如图的启动按钮，然后等待一会儿，就会到最终的目录，画框中的url就是图床的http url。如果你更新了rep，一定要点击更新，重新启动一下gitee pages 服务，然后才会应用你push 的最新maser分支。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_100/gitee_pages.png" alt="rep_img"/></center>
    </div>
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_100/gitee_pages_enable.png" alt="rep_img"/></center>
    </div>
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_100/gitee_pages_update.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<h5 id="Gitee-Page配置及使用示例">Gitee Page配置及使用示例</h5>
<p>  在这个仓库根目录创建index.html 和 404.html，gitee给的http服务器将会把域名首页指向index.html，如果访问出错，将会指向404.html。html怎么写，这里就略过了。<br>
  比如这里的两个链接，这个是我创建的图床index（ <a target="_blank" rel="noopener" href="http://sky-x.gitee.io/image-bed0/">http://sky-x.gitee.io/image-bed0/</a> ）和错误访问的404网页（ <a target="_blank" rel="noopener" href="http://sky-x.gitee.io/image-bed0/no-exsit">http://sky-x.gitee.io/image-bed0/no-exsit</a> ）。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_100/index.png" alt="rep_img"/></center>
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_100/404.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  然后在这个仓库里面存放自己的图片就行，访问的路径就是对应的rep文件路径，参考下图和图床地址。例如本文创建仓库的实例图片（图床地址： <a target="_blank" rel="noopener" href="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_100/create_rep.png">https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_100/create_rep.png</a> ）<br>
  注意：image-bed0 是你刚刚创建仓库的地址，blogs/blog_idx_100/create_rep.png是你仓库中要显示文件的相对路径。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_100/rep_img_example.png" alt="rep_img"/></center>
    </div>
</div>  
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  由于我们这里的图片外链放的是我们的原图，最好还是加一加水印，然后放外链，避免盗图情况的发生。<br>
  由于本文的这些操作只能够对新的blog文章生效，对于旧的文章，暂时没有好的解决方案。我可能采取一个比较笨的方案，下载已有文章中的markdown文件，下载文章对于的图片。这又是一个比较大的工程，只有慢慢的弄了。</p>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2020/06/16/blog_idx_094/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/16/blog_idx_094/" class="post-title-link" itemprop="url">ModuleNotFoundError: No module named xxx 的原因和解决办法（附带新大陆）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-16 14:22:07" itemprop="dateCreated datePublished" datetime="2020-06-16T14:22:07+08:00">2020-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C-CPP/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C-CPP/python/%E5%B8%B8%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">常识</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-31 10:49:24
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=094） 
&emsp;&emsp;本文发布于 2020-06-16 14:22:07，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=094） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="ModuleNotFoundError-No-module-named-‘xxx’-分析">ModuleNotFoundError: No module named ‘xxx’ 分析</h3>
<hr>
<p>  这个问题只要是用过python的人，一般或多或少都会遇到过这个问题，这个问题其实很明确，就是你import的module找不到。</p>
<p>  关于为啥找不到的原因，倒是有很多花里胡哨原因。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Python-module的搜索路径">Python module的搜索路径</h3>
<hr>
<p>  python的module搜索路径，其实是编译python的时候就有相关的默认配置的。例如：</p>
<blockquote>
<p>python -m sysconfig</p>
</blockquote>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_094/pycfg.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  这里面就包含了相应的搜索路径。但是我们执行如下命令看真实的搜索路径，就会发现一些奇怪的东西。</p>
<blockquote>
<p>python3 -c “import sys;print(sys.path)”</p>
</blockquote>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_094/pypath.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  其实这里可以看出多了一些不常见的搜索目录，其实出了我们常见的site-packages外，python还有其他builtin 和一些独立的自带的模块。site-packages在约定中，是用来存放第三方库的，也就是你pip install安装的module.</p>
<p>  这里有个重要的目录是/usr/lib/python3.6/lib-dynload/，里面的so是python 自带模块的底层实现，比如ctype 对应的实现是 _ctype.</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_094/pym.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  上面sys.path包含的路径，就是python import 模块时的全部搜索路径了。当然，还包含一个当前路径，也就是你执行python命令的路径，也会被默认搜索。</p>
<p>  此外，通过环境变量PYTHONPATH也可以向sys.path添加值。</p>
<p>  正常情况下，我们就可以通过在这些目录里面放置我们的模块，然后在python里面import即可。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="ModuleNotFoundError-No-module-named-‘xxx’-可能原因和解决方案">ModuleNotFoundError: No module named ‘xxx’ 可能原因和解决方案</h3>
<hr>
<br/>
<br/>
<h5 id="s1">s1</h5>
<p>   原因：sys.path 所包含的所有目录中，确实无对应的xxx模块。</p>
<p>   解决方法：这个时候，通过pip install安装即可解决。</p>
<br/>
<br/>
<h5 id="s2">s2</h5>
<p>  原因：sys.path 所包含的所有目录中，有对应的xxx模块，但是有多个地方都存在（可能是同样的版本，可能是不一样的版本）。</p>
<p>  解决方法：所有的目录中，只保留一个xxx模块即可，其他的都uninstall了。（小提示：这里推荐使用虚拟环境，这样就很少出现这种情况，出现这种情况的本质原因还是一个系统配置了太多的python版本）</p>
<br/>
<br/>
<h5 id="s3-（新大陆）">s3 （新大陆）</h5>
<p>  这种情况也是我最近遇到的新坑。具体表现是sys.path目录中有xxx模块，而且还有且只有一个。根据我们上文的s1，s2情况来看，这就应该解决的问题了呀，可是并没有。这就让我很懵逼。</p>
<p>  情况复现：我手动编译了一个python3，需要使用python c interface功能。我同时生成了debug和release的python3的库。在我尝试import numpy的时候，release的库一直ok，但是debug的python库一直报找不到numpy的库。（我确定numpy在sys.path中，而且只有一个）</p>
<p>  经过我大量的寻找，在如下的一个链接（<a target="_blank" rel="noopener" href="https://bugs.python.org/issue36716%EF%BC%89">https://bugs.python.org/issue36716）</a> 里面，找到了答案。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_094/py_i.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  原来python 的debug和release版本，import 的时候，一些库的命名上面是有区别的。</p>
<p>  我们分别在linux和win下执行如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">import</span> importlib.machinery
print<span class="token punctuation">(</span>importlib.machinery.all_suffixes<span class="token punctuation">(</span><span class="token punctuation">))</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>  linux:</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_094/linux.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  windows:</p>
<p>  release：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_094/win_r.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  debug:</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_094/win_d.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  可以看到，这里的.pyd（类似windows dll）<a target="_blank" rel="noopener" href="http://xn--0tr.so">和.so</a>（类似linux so）分别是不通平台下，python import 需要的库的后缀。</p>
<p>  同时我们也可以看到，同一平台下，release 和 debug版本的python import的时候，需要的module名字可能有些诧异，最直白的就是多了_d。</p>
<p>  <font color = red size = 3>注意：windows-debug图中画红框部分，是由于我改了python的源码，它才会认识不带_d的module。哪怕这个module命名不带_d，但是它必须是debug版本的module才行，换句话说，仅仅是命名上的区别。如果你弄一个release的库，我这个python的debug版本依然不会import成功。改原因的原因也很苦逼，就是通过编译生成的debug module，它不会自动的给你加上_d，坑爹，如果这种模块多，需要你自己重命名的module太多了，于是，直接该源码才是很爽的方法。</font></p>
<p>  解决方法也很简单的：直接编译一个debug版本的xxx模块即可。同时修改生成的module库，加上_d即可解决。</p>
<p>  原因也很简单就是库的名字没有对上，导致找不到。</p>
<p>  <font color = red size = 3>一般来说，s3这种情况大家都不会碰见的，除非和我一样，用python c interface的时候，在debug模式下使用，就可能会出现这种情况。找起答案来，也比较麻烦。</font></p>
<h3 id="未完待续（以后遇到新的再补充）">未完待续（以后遇到新的再补充）</h3>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2020/04/23/blog_idx_093/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/04/23/blog_idx_093/" class="post-title-link" itemprop="url">Linux 串口驱动实例简单分析(x86 8250驱动(16550A),TIOCMGET, TIOCMSET, RTS)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-23 16:44:18" itemprop="dateCreated datePublished" datetime="2020-04-23T16:44:18+08:00">2020-04-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>13 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-31 00:15:18
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=093） 
&emsp;&emsp;本文发布于 2020-04-23 16:44:18，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=093） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  在我们一个一年前的项目里，由于对方的485串口硬件发生了变更，不能够通过默认的termios相关内容去read和write了，这里需要控制串口16550A芯片的RTS脚，然后去控制ADM2486 485 modem芯片RTS相关脚的收发。简单的理解为ADM485需要控制RTS和相关的引脚的高低电平，才能够控制485的收发。原理图我就不贴出来了，简单说明就是16550A的RTS脚接一个反相器然后直连到ADM2486的RTS脚。</p>
<p>  首先我这里考虑，这里如果是arm板卡的话，我是非常熟悉的，直接控制gpio就完事儿了。但是这个是个x86板卡，这就是最坑的，x86的io脚我没有控制过。当然，和对方硬件沟通后，一种方案确实是控制x86的通用gpio，而他们的一套方案是通过串口芯片的RTS脚控制485 modem的RTS脚，因为x86的通用引脚是非常昂贵的，而且，电路也麻烦。</p>
<p>  那么问题来了，怎么控制16550A芯片的RTS脚？</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="相关信息探索">相关信息探索</h3>
<hr>
<p>  因为以前我们写了串口程序，操控的是/dev/ttyS0，那么必然现在也是从这个设备下手，我们看看系统启动日志。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s1.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  从这里我们知道串口芯片是16550A，也就是说我们之前通过termios相关的接口实现的老版本串口通信程序也是操作的这个芯片。那么意味着os里面已经自带了这个芯片的相关驱动。到这里，可以预想到后面会有两种情况：</p>
<ol>
<li class="lvl-4">
<p>根据os自带的16550A驱动，里面如果包含了关于RTS脚的操作方法，那么直接通过驱动提供的接口就可以完成RTS电平控制。而且这个方法成功的可能性比较大，因为硬件说过，16550A这种芯片基本是x86-intel主板的标配，那么说明这个芯片用的比较广泛，那么驱动也极有可能带了RTS相关操作。（而且我查了16550A的驱动就是8250驱动，是一个builtin模块）</p>
</li>
<li class="lvl-4">
<p>直接操作intel cpu的gpio控制，感觉不是很科学，但是也有这种需求的。</p>
</li>
</ol>
<p>  同时，我查看了相关的串口编程相关内容，发现了一点内容，可以进行一些串口的高级操作，主要还是ioctl这个syscall的这两个宏定义TIOCMGET, TIOCMSET，但是还是有点迷糊，于是根据以上的这些准备，我去看了linux对应内核的内核源码。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="8250驱动源码分析">8250驱动源码分析</h3>
<hr>
<p>  直接打开linux/drivers/char/8250.c 和 linux/drivers/char/8250.h分析了一番，在驱动里面找到了RTS相关控制位的操作</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s2.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  从这里知道，8250驱动确实带了相关的芯片mctrl引脚控制相关的接口，如图所示，分别是查询mctrl引脚状态和设置mctrl引脚状态。</p>
<p>  到这里，我隐约知道怎么做了，就是用ioctl 这个call的TIOCMSET来控制RTS引脚功能。熟悉linux驱动编写的人都知道为啥会这样，因为一个驱动带了open，close，read，write基本功能，其他的选项功能一般都是ioctl基本syscall里面实现的。</p>
<p>  于是带着这些疑问，我又继续看源码分析，不然心里面总是觉得虚的。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="linux-tty-驱动框架简单分析">linux tty 驱动框架简单分析</h3>
<hr>
<p>  等我看完一系列的8250驱动的调用结构后，我才发现要介绍的应该是linux tty 驱动框架，下面我这里简单分析一下这个框架（没必要全懂，知道大概就行，毕竟我们也不写这个驱动，基本都是改再改）</p>
<p>  首先，我们这个串口是一个字符设备。那就是说，应该有类似字符驱动的流程去打开、操作、关闭。（这里不了解的，可以去查一下linux 字符驱动相关的简单说明）。字符驱动有主设备号和次设备号，对应我们的串口的话，如下图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s3.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  tty设备的主设备为4</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s4.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  我们的串口设备次设备号为64，也就是第0个serial。</p>
<p>  下面我们从字符设备开始，一步步看怎么调用起来8250里面的serial8250_get_mctrl() serial8250_set_mctrl()</p>
<br/>
<br/>
<h5 id="8250-串口驱动简单说明">8250 串口驱动简单说明</h5>
<p>  linux/drivers/serial/8250.c</p>
<p>  下面是8250驱动的初始化部分，就是把重要的serial8250_reg驱动（uart_register_driver（））注册到uart驱动链表上去</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s5.png" alt="rep_img"/></center>
    </div>
</div>    
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s6.png" alt="rep_img"/></center>
    </div>
</div>     
<p>  我们在内核的启动日志中，也看见了printk的打印信息。</p>
<p>  同时我们看一下uart_ops结构体在8250中的定义</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s7.png" alt="rep_img"/></center>
    </div>
</div>     
<p>  这里我们就成功的看到了serial8250_get_mctrl() serial8250_set_mctrl()这俩的上一层接口名字。</p>
<p>  在linux中，一个uart_driver对应多个uart_port，相当于一个串口驱动可以同时用于多个串口设备。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s8.png" alt="rep_img"/></center>
    </div>
</div>   
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s9.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  其中在serial8250_register_ports()中的serial8250_isa_init_ports()接口就是关联uart_port结构体中的ops和serial_8250_pops的。这里我们其实就可以根据uart_port结构体中的set_mctrl和get_mctrl访问serial8250_get_mctrl() serial8250_set_mctrl()。</p>
<p>  然后通过uart_add_one_port把uart_driver中state成员的port成员赋值我们刚刚初始化好的uart_port.</p>
<p>  这样我们就可以通过uart_driver.state.port.ops来访问我们的函数指针即可。</p>
<p>  同时通过tty_register_device在/dev下面创建我们的设备节点。</p>
<p>  到这里，我们就成功的把调用serial8250_get_mctrl() serial8250_set_mctrl()这两个api转换为可以通过uart_driver来调用了。</p>
<p>  我们通过上述说明，基本可以看到一些内容，下面我们来看一个我们现在未讲到的东西，就是uart_register_driver</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s10.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  我们可以看到，这里把uart_driver和一个叫做tty_driver的结构体关联了起来。特别是通过tty_set_operations()把uart_driver中的8250相关的api和tty_driver中的相关api关联了。</p>
<p>  而且通过tty_register_driver()把一个重要内容联系起来。至于为啥和怎么关联，我们继续往下面看。</p>
<br/>
<br/>
<h5 id="serial-core简单说明">serial_core简单说明</h5>
<p>  linux/drivers/serial/serial_core.c</p>
<p>  其实查看这里的源码后发现，8250.c就是基于serial_core.c的内容进行串口驱动编程。</p>
<p>  在serial_core.h里面我们可以看到上述我们见到的大量的uart_*的有用的结构体。</p>
<br/>
<br/>
<h5 id="tty-drivers-简单说明">tty_drivers 简单说明</h5>
<p>  linux/drivers/char/tty_io.c</p>
<p>  我们知道一个简单的字符串驱动，肯定有个init入口，如图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s11.png" alt="rep_img"/></center>
    </div>
</div>   
&emsp;&emsp;我们看最后的vt部分，这里创建了一个设备号为4,0的/dev/tty0的一个设备。
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s12.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  这里一个tty_core核心驱动就完事儿了。</p>
<p>  写过字符驱动的人都应该知道，我们还应该关注一个file_operations的结构体，因为我们在用户态熟悉的open/close/read/write/ioctl都是通过这个结构体关联的。</p>
<p>  具体怎么关联的，可以看一下我这里的这个比较水的记录：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011728480/article/details/51547405">https://blog.csdn.net/u011728480/article/details/51547405</a></p>
<p>  我简单来说，linux下一切皆是文件，包括我们要操作的串口设备，类似上面的/dev/tty0这种设备。在linux的vfs里面，一个文件对应一个inode结构体，同时内核维护一个file结构体和inode对应。inode结构体里面有个i_cdev成员，这个成员就是我们cdev结构体，就是我们在如图的初始化入口中的vc0_cdev，这个结构体里面有个重要的成员就是ops，这里面存放的就是各种open/close/read/write/ioctl的实际函数指针。</p>
<p>  在《8250 串口驱动简单说明》小节中，我们说明了serial8250_init（）通过调用tty_register_device在/dev中创建了对应的设备节点。并把tty_driver和uart_driver关联起来，我们可以通过tty_driver去访问serial8250_get_mctrl() serial8250_set_mctrl()这两个我想要的东西。</p>
<p>  <strong>那file_operations结构体和tty_driver是怎么关联起来的呢？如果我们知道了的话，整个驱动的调用链路就理清楚了，也好处理我们遇到的问题。</strong></p>
<p>  在《8250 串口驱动简单说明》小节最后部分提到了8250的初始化调用了tty_register_driver()这个重要的接口，这个结构就是把我们想要的两个结构体关联起来的关键。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s13.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  我们在初始化一个字符设备的时候，在这里关联了file_operations结构体和tty_driver。</p>
<p>  我们看看tty_fops的定义：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s14.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  到了这里，我们的整个调用链路都打通了。</p>
<p>  这里我们直接看tty_ioctl这个接口，我们就可以看到调用8250的方法了serial8250_get_mctrl() serial8250_set_mctrl()。最后我们在文末总结一下。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="8250调用实例分析">8250调用实例分析</h3>
<hr>
<p>  我们这里通过调用通过8250驱动设置16550A的 RTS脚电平来回顾一下我们的整个调用链路。</p>
<p>  当我们调用ioctl的时候，通过传入参数TIOCMGET或者TIOCMSET，默认我们会调用tty_ioctl方法，然后进一步会调用tty_tiocmget 和tty_tiocmset。如下图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s15.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s16.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  在tty_tiocmget 和tty_tiocmset中，分别调用tty_driver中的tiocmset和tiocmget</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s17.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s18.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  然后我们上文说了，tty_driver和uart_driver是通过uart_register_driver和tty_set_operations关联起来的</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s19.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  也就是说，对tty_driver的tiocmget和tiocmset的调用，就是直接对tty_operations的tiocmget和tiocmset的调用。</p>
<p>  我们在《8250 串口驱动简单说明》小节最后部分，说调用tty_set_operations()关联起来了一个tty_driver和一个tty_operations,而这里注册的uart_ops就很明显了</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s20.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  也就是说tty_operations的tiocmget和tiocmset的调用，就是对uart_tiocmget和uart_tiocmset的调用。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s21.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s22.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  uart_tiocmget和uart_tiocmset的调用就是对uart_driver.state.port.ops.set_mctrl和uart_driver.state.port.ops.get_mctrl的调用，而这里就是对serial8250_set_mctrl和serial8250_get_mctrl的调用。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_093/s23.png" alt="rep_img"/></center>
    </div>
</div>  
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  总结</p>
<p>  我们可以看到，这里，我们在用户层对相关vfs的接口进行调用，都会映射为相应的驱动ops。</p>
<p>  在这里，用户态的ioctl转换为内核态的tty_ioctl，最终一步步到我们要的地方。</p>
<p>  因为我是要读这个驱动是不是有这个功能，而不是写一个驱动，所以看起来要简单很多了。</p>
<p>  我查了tty相关的驱动框架，内容还是挺多的，特别是tty_read和tty_write和我们这里的调用流程是完全不一致的，但是我这里暂时不需要去看，因为我要的功能有了，如果有需求，我会去看这部分内容。最终，我通过ioctl加上特定的命令，成功的控制了16550A的RTS脚。而且这里通了的话，不需要通过gpio去处理。</p>
<p>  其实这个还是挺有意思的，虽然好的抽象的东西看起来很不爽，但是了解通了整个调用流程，我感觉就特别的舒服。</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2020/03/12/blog_idx_092/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/03/12/blog_idx_092/" class="post-title-link" itemprop="url">undefined symbol: PyFPE_jbuf 问题分析并处理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-03-12 14:59:49" itemprop="dateCreated datePublished" datetime="2020-03-12T14:59:49+08:00">2020-03-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/%E5%B5%8C%E5%85%A5%E5%BC%8F/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-30 23:51:58
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=092） 
&emsp;&emsp;本文发布于 2020-03-12 14:59:49，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=092） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前景提要">前景提要</h3>
<hr>
<p>  最近在某平台撸（学习）npu一个解决方案，既然要学习，就重头开始呗。首先我们就刷板子，没啥毛病，刷机正常。然后就开始配置环境，配置环境虽然有点小打小闹的问题，后面可能会记录过程吧，还是成功躺过，然后我就</p>
<p>  运行其自带的例子。然后得到以下毛病：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_092/problem.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<br/>
<br/>
<h3 id="探索">探索</h3>
<hr>
<p>  因为我写过c/c++调用python的程序，所以我看到这个未定义的符号命名规则，我就知道，肯定是我TNND在编译python3.5的时候，少了点什么东西。下面查看系统python3的符号和我自己编译的python3的符号就证明了我的猜测：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_092/sym.png" alt="rep_img"/></center>
    </div>
</div>    
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_092/sym1.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  既然这样我就去看看Python3.5的源码，还是发现了这个符号的踪迹：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_092/sym2.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  哟西，直接排除fpectlmodule.c文件的，因为其是一个static，未export的变量。看看pyfpe.h呢？</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_092/sym3.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  soga，那么几乎可以确定是这个WANT_SIGFPE_HANDLER没有启用。既然这个宏未启用那么一定有一个开关可以打开？</p>
<p>  我们先来看看这个头文件的说明，可以得到的是这个模块是用来处理linux上的SIGFPE信号的。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_092/sym4.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  简单说明：SIGFPE信号就是floating-point exception（浮点异常），比如除0试试，好玩！</p>
<p>  我们继续看看帮助文档呢？</p>
<p>  ./configure --help看看呢？</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_092/sym5.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  找到了，发现了这个。应该是要添加这个选项，虽然我不知道为啥py要把这个选项独立出来。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="解决方案">解决方案</h3>
<hr>
<p>  我看了网上的大部分方案都是说python版本过多的问题导致的。怎么说呢？原因确实可以这样说版本错误，因为你自己编译的版本和系统直接安装的版本编译参数是不一样的，所以有这个错。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#重新编译python即可</span>
./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/python3 --enable-shared --with-fpectl   
<span class="token function">make</span> <span class="token parameter variable">-j16</span>
<span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_092/sym6.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  出来啦，然后解决问题，完结散花。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2020/01/09/blog_idx_091/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/01/09/blog_idx_091/" class="post-title-link" itemprop="url">C++ 调用 Python 总结(一)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-01-09 18:39:55" itemprop="dateCreated datePublished" datetime="2020-01-09T18:39:55+08:00">2020-01-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-30 23:43:18
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=091） 
&emsp;&emsp;本文发布于 2020-01-09 18:39:55，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=091） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  本文所有实例环境为：win10+py35</p>
<h3 id="序">序</h3>
<hr>
<p>  我们有个任务，需要在C<ins>里面调用pycaffe的算法来做相关的检测。（不要问我为啥不直接用caffe的c</ins>接口，因为后面还要调tensorflow和pytorch，导致了算法组为了统(偷)一（懒），就直接怼了一个pycaffe）。</p>
<p>  我还是第一次遇到这类问题，我去查了查，还真的有相关的内容，真的是存在即合理。</p>
<p>  本文大部分内容都是主要参考python官方手册，其次也看了网络上的一些资料，我这里做了一些汇总和衍生。(官方手册<a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/c-api/index.html">https://docs.python.org/zh-cn/3/c-api/index.html</a>)</p>
<p>  阅读本文需要一定的c++基本‘’姿势‘’和了解一些最最最简单的py‘’姿势‘’。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Python-C-Hello-World">Python C Hello World</h3>
<hr>
<p>  先来一个全世界通用的例子。(没做异常处理)</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span><span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//</span></span>
<span class="token comment">/*
Note Since Python may define some pre-processor definitions which affect the standard headers on some systems, you must include Python.h before any standard headers are included.
It is recommended to always define PY_SSIZE_T_CLEAN before including Python.h. See Parsing arguments and building values for a description of this macro.
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PY_SSIZE_T_CLEAN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Python.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token comment">//This function works like Py_Initialize() if initsigs is 1. </span>
    <span class="token comment">//If initsigs is 0, it skips initialization registration of signal handlers, which might be useful when Python is embedded.</span>
    <span class="token function">Py_InitializeEx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"print('hello world.')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_WIN32 <span class="token operator">||</span> _WIN64</span></span>

    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">__linux__ <span class="token operator">||</span> __linux</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//    </span></span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  编译，设定python的头文件和库文件路径。（注意python的库名字），我这里是在win上做的演示，实际是部署到linux.相关结果如图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/com.png" alt="rep_img"/></center>
    </div>
</div>    
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/run.png" alt="rep_img"/></center>
    </div>
</div>   
<br/>
<br/>
<br/>
<br/>
<h3 id="Python-C-常用接口">Python C 常用接口</h3>
<hr>
<br/>
<br/>
<h5 id="python-基本数据类型对象">python 基本数据类型对象</h5>
<p>  更加详细的，请查看官方doc中关于Py_BuildValue()接口的描述。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">    PyObject <span class="token operator">*</span> func_name <span class="token operator">=</span> <span class="token function">Py_BuildValue</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">,</span><span class="token string">"test_add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    PyObject <span class="token operator">*</span> arg1 <span class="token operator">=</span> <span class="token function">Py_BuildValue</span><span class="token punctuation">(</span><span class="token string">"l"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
```  

<span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">></span>

##### python 序列或者容器对象
<span class="token operator">&amp;</span>emsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>emsp<span class="token punctuation">;</span>更多内容，详见官方doc
```cpp
<span class="token comment">//tuple</span>
PyObject<span class="token operator">*</span> <span class="token function">PyTuple_New</span><span class="token punctuation">(</span>Py_ssize_t len<span class="token punctuation">)</span>
<span class="token comment">//Return value: New reference.</span>
<span class="token comment">//Return a new tuple object of size len, or NULL on failure.</span>

PyObject<span class="token operator">*</span> <span class="token function">PyTuple_GetItem</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>p<span class="token punctuation">,</span> Py_ssize_t pos<span class="token punctuation">)</span>
<span class="token comment">//Return value: Borrowed reference.</span>
<span class="token comment">//Return the object at position pos in the tuple pointed to by p. If pos is out of bounds, return NULL and set an IndexError exception.</span>

<span class="token keyword">int</span> <span class="token function">PyTuple_SetItem</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>p<span class="token punctuation">,</span> Py_ssize_t pos<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>o<span class="token punctuation">)</span>
<span class="token comment">//Insert a reference to object o at position pos of the tuple pointed to by p. Return 0 on success. If pos is out of bounds, return -1 and set an IndexError exception.</span>
<span class="token comment">//list</span>
<span class="token comment">//原理同tuple</span>
PyObject<span class="token operator">*</span> <span class="token function">PyList_New</span><span class="token punctuation">(</span>Py_ssize_t len<span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">PyList_SetItem</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>list<span class="token punctuation">,</span> Py_ssize_t index<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>item<span class="token punctuation">)</span>
PyObject<span class="token operator">*</span> <span class="token function">PyList_GetItem</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>list<span class="token punctuation">,</span> Py_ssize_t index<span class="token punctuation">)</span>
<span class="token comment">//dict</span>
<span class="token comment">//原理同tuple</span>
PyObject<span class="token operator">*</span> <span class="token function">PyDict_New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">PyDict_SetItem</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>p<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>key<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>val<span class="token punctuation">)</span>
PyObject<span class="token operator">*</span> <span class="token function">PyDict_GetItem</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>p<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>key<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  对于这些python中的数据类型对象，都有相关的c api来创建、操作，更多的内容可以查看官方doc。这部分内容较简单，不做示例。</p>
<br/>
<br/>
<h5 id="python-模块对象">python 模块对象</h5>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">PyObject<span class="token operator">*</span> <span class="token function">PyImport_ImportModuleEx</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>globals<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>locals<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>fromlist<span class="token punctuation">)</span>
<span class="token comment">/*
Return value: New reference.
Import a module. This is best described by referring to the built-in Python function __import__().

The return value is a new reference to the imported module or top-level package, or NULL with an exception set on failure. Like for __import__(), the return value when a submodule of a package was requested is normally the top-level package, unless a non-empty fromlist was given.

Failing imports remove incomplete module objects, like with PyImport_ImportModule().
*/</span>
PyObject<span class="token operator">*</span> <span class="token function">PyModule_GetDict</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token keyword">module</span><span class="token punctuation">)</span>
<span class="token comment">/*
Return value: Borrowed reference.
Return the dictionary object that implements module's namespace; this object is the same as the __dict__ attribute of the module object. If module is not a module object (or a subtype of a module object), SystemError is raised and NULL is returned.

It is recommended extensions use other PyModule_*() and PyObject_*() functions rather than directly manipulate a module's __dict__.
*/</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  这些api主要是导入python模块，类似关键字import，同时返回模块的属性dict。这些属性包含当前命名空间下的：全局变量，全局函数，类等等。</p>
<br/>
<br/>
<h5 id="python-callable-object-python-class-object-python-object-function">python callable object , python class object, python object function</h5>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*
Return value: New reference.
Call a callable Python object callable, with arguments given by the tuple args. If no arguments are needed, then args can be NULL.

Return the result of the call on success, or raise an exception and return NULL on failure.

This is the equivalent of the Python expression: callable(*args).
*/</span>
PyObject<span class="token operator">*</span> <span class="token function">PyObject_CallObject</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>callable<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>args<span class="token punctuation">)</span>


<span class="token comment">/*
Return value: New reference.
Return a new instance method object, with func being any callable object func is the function that will be called when the instance method is called.
*/</span>
PyObject<span class="token operator">*</span> <span class="token function">PyInstanceMethod_New</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>func<span class="token punctuation">)</span>

<span class="token comment">//call obj.func</span>
PyObject<span class="token operator">*</span> <span class="token function">PyObject_CallMethod</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>obj<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
PyObject<span class="token operator">*</span> <span class="token function">PyObject_CallMethodObjArgs</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>obj<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="PyObject-对象">PyObject 对象</h3>
<hr>
<p>  这个对象是pythonc c api 所有对象的wrapper，有许许多多需要注意的事项，其中最重要的就是其内存管理问题。详细细节参考官方doc，这里给出最重要的几条我遇到的结论：</p>
<ol>
<li class="lvl-3">
<p>pyobject 是依靠引用计数来管理对象的。</p>
</li>
<li class="lvl-3">
<p>pyobject 的创建者需要对这个obj负责，创建者可以传递，存储，和调用 Py_DECREF()</p>
</li>
<li class="lvl-3">
<p>python c api 都有关于pyobject的处理说明，比如：借用，新建。如下图。</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/pyobj1.png" alt="rep_img"/></center>
    </div>
</div>   
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/pyobj2.png" alt="rep_img"/></center>
    </div>
</div>   
<p><front color = red size = 4>本章特别重要，有兴趣的去看官方文档。当你乱用Py_INCREF和Py_DECREF时，你写的程序会在调用Py_Finalize时崩溃，这个时候，你需要看下文，去看看你哪个地方用错了。（<a target="_blank" rel="noopener" href="https://docs.python.org/3.8/extending/extending.html#ownership-rules%EF%BC%89">https://docs.python.org/3.8/extending/extending.html#ownership-rules）</a></front></p>
<br/>
<br/>
<br/>
<br/>
<h3 id="实例">实例</h3>
<hr>
<p>  上一个实例来展示本文所有内容。</p>
<p>  这是我要调用的python module</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''
'''</span>
<span class="token decorator annotation punctuation">@Description</span><span class="token punctuation">:</span> 
<span class="token decorator annotation punctuation">@Author</span><span class="token punctuation">:</span> Sky
<span class="token decorator annotation punctuation">@Date</span><span class="token punctuation">:</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">:</span><span class="token number">29</span>
<span class="token decorator annotation punctuation">@LastEditors</span>  <span class="token punctuation">:</span> Sky
<span class="token decorator annotation punctuation">@LastEditTime</span> <span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">09</span> <span class="token number">18</span><span class="token punctuation">:</span><span class="token number">04</span><span class="token punctuation">:</span><span class="token number">41</span>
<span class="token decorator annotation punctuation">@FilePath</span><span class="token punctuation">:</span> \Test_C_Call_Python\py_modules\py_normal_test<span class="token punctuation">.</span>py
<span class="token string">''</span>'
<span class="token keyword">import</span> sys

<span class="token keyword">class</span> <span class="token class-name">TestPythonNormal</span><span class="token punctuation">:</span>
    cls_attr <span class="token operator">=</span> <span class="token string">'I am cls attr'</span>
    <span class="token comment"># def __new__(class_ins):</span>
    <span class="token comment">#     print('call TestPythonNormal.__new__')</span>
    <span class="token comment">#     return class_ins</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'call TestPythonNormal.__init__'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>obj_attr <span class="token operator">=</span> <span class="token string">'I am obj attr'</span>

    <span class="token keyword">def</span> <span class="token function">test_add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"a = "</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"b = "</span><span class="token punctuation">,</span>  b<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"a + b = "</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span>


g_num <span class="token operator">=</span> <span class="token number">22222</span>
g_str <span class="token operator">=</span> <span class="token string">'hello f***'</span>

<span class="token keyword">def</span> <span class="token function">g_func</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"g_func arg = "</span><span class="token punctuation">,</span> a <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    test <span class="token operator">=</span> TestPythonNormal<span class="token punctuation">(</span><span class="token punctuation">)</span>
    test<span class="token punctuation">.</span>test_add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>TestPythonNormal<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>
    <span class="token comment"># print(TestPythonNormal.__dir__(test))</span>


<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*
 * @Description: 
 * @Author: Sky
 * @Date: 2020-01-09 11:26:28
 * @LastEditors  : Sky
 * @LastEditTime : 2020-01-09 18:21:53
 * @FilePath: \Test_C_Call_Python\test_tmp.cpp
 * @Github: 
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span><span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PY_SSIZE_T_CLEAN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Python.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token comment">//This function works like Py_Initialize() if initsigs is 1. </span>
    <span class="token comment">//If initsigs is 0, it skips initialization registration of signal handlers, which might be useful when Python is embedded.</span>
    <span class="token function">Py_InitializeEx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"print('hello world.')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//add path of module-py_normal_test to sys.path</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"import sys"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"import numpy as np"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"sys.path.append('E://TestDir//Test_C_Call_Python//py_modules')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"print(sys.path)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//import </span>
    <span class="token comment">//Return value: New reference.</span>
    PyObject <span class="token operator">*</span> p_module <span class="token operator">=</span> <span class="token function">PyImport_ImportModuleEx</span><span class="token punctuation">(</span><span class="token string">"py_normal_test"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//import module</span>

    <span class="token comment">//get module attr, they are g_var, g_func, class and so on.</span>
    <span class="token comment">//Return value: Borrowed reference.</span>
    PyObject <span class="token operator">*</span> p_dict_mo <span class="token operator">=</span> <span class="token function">PyModule_GetDict</span><span class="token punctuation">(</span>p_module<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//get module's all attr</span>
    <span class="token comment">//Return value: Borrowed reference.</span>
    PyObject <span class="token operator">*</span> p_module_g_num <span class="token operator">=</span> <span class="token function">PyDict_GetItemString</span><span class="token punctuation">(</span>p_dict_mo<span class="token punctuation">,</span> <span class="token string">"g_num"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// global var</span>

    PyObject <span class="token operator">*</span> p_module_cls <span class="token operator">=</span> <span class="token function">PyDict_GetItemString</span><span class="token punctuation">(</span>p_dict_mo<span class="token punctuation">,</span> <span class="token string">"TestPythonNormal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//class</span>

    PyObject <span class="token operator">*</span> p_module_g_func <span class="token operator">=</span> <span class="token function">PyDict_GetItemString</span><span class="token punctuation">(</span>p_dict_mo<span class="token punctuation">,</span> <span class="token string">"g_func"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// global function</span>

    <span class="token comment">//print g_var</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"g_num is "</span><span class="token operator">&lt;&lt;</span><span class="token function">PyLong_AsLong</span><span class="token punctuation">(</span>p_module_g_num<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token comment">//call g_func</span>
    <span class="token comment">//Return value: New reference.</span>
    PyObject <span class="token operator">*</span> arg_tuple <span class="token operator">=</span> <span class="token function">PyTuple_New</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyTuple_SetItem</span><span class="token punctuation">(</span>arg_tuple<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p_module_g_num<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//prepare arg</span>
    <span class="token function">PyObject_CallObject</span><span class="token punctuation">(</span>p_module_g_func<span class="token punctuation">,</span> arg_tuple<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//call g_func</span>
    

    <span class="token comment">//instance a class</span>
    <span class="token comment">//Return value: New reference.</span>
    PyObject <span class="token operator">*</span> p_cls_instance <span class="token operator">=</span> <span class="token function">PyInstanceMethod_New</span><span class="token punctuation">(</span>p_module_cls<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//call builtin.__new__, new a instance</span>
    <span class="token comment">//Return value: New reference.</span>
    p_cls_instance <span class="token operator">=</span> <span class="token function">PyObject_CallObject</span><span class="token punctuation">(</span>p_cls_instance<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//call __init__,construct function,return None</span>
    <span class="token comment">// Py_XDECREF(p_none);</span>

    <span class="token comment">//print class-var</span>
    <span class="token comment">//Return value: New reference.</span>
    <span class="token comment">//PyObject* PyObject_GetAttrString(PyObject *o, const char *attr_name)</span>
    PyObject <span class="token operator">*</span> cls_attr <span class="token operator">=</span> <span class="token function">PyObject_GetAttrString</span><span class="token punctuation">(</span>p_module_cls<span class="token punctuation">,</span> <span class="token string">"cls_attr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"cls_attr is "</span><span class="token operator">&lt;&lt;</span><span class="token function">PyUnicode_AsUTF8</span><span class="token punctuation">(</span>cls_attr<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    
    <span class="token comment">//print obj.var</span>
    PyObject <span class="token operator">*</span> obj_attr <span class="token operator">=</span> <span class="token function">PyObject_GetAttrString</span><span class="token punctuation">(</span>p_cls_instance<span class="token punctuation">,</span> <span class="token string">"obj_attr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"obj_attr is "</span><span class="token operator">&lt;&lt;</span><span class="token function">PyUnicode_AsUTF8</span><span class="token punctuation">(</span>obj_attr<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token comment">//call obj.func</span>
    <span class="token comment">//Way0: This is the equivalent of the Python expression: obj.name(arg1, arg2, ...).</span>
    <span class="token comment">//Return value: New reference.Return value: New reference.</span>
    PyObject <span class="token operator">*</span> ret0 <span class="token operator">=</span> <span class="token function">PyObject_CallMethod</span><span class="token punctuation">(</span>p_cls_instance<span class="token punctuation">,</span> <span class="token string">"test_add"</span><span class="token punctuation">,</span> <span class="token string">"ii"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//test_add(self, 10, 10)</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"call obj.func, Way0 ret =  "</span><span class="token operator">&lt;&lt;</span><span class="token function">PyLong_AsLong</span><span class="token punctuation">(</span>ret0<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    
    <span class="token comment">//Return value: New reference.</span>
    PyObject <span class="token operator">*</span> func_name <span class="token operator">=</span> <span class="token function">Py_BuildValue</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">,</span><span class="token string">"test_add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>
    PyObject <span class="token operator">*</span> arg1 <span class="token operator">=</span> <span class="token function">Py_BuildValue</span><span class="token punctuation">(</span><span class="token string">"l"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    PyObject <span class="token operator">*</span> arg2 <span class="token operator">=</span> <span class="token function">Py_BuildValue</span><span class="token punctuation">(</span><span class="token string">"l"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//Return value: New reference.</span>
    PyObject <span class="token operator">*</span> ret1 <span class="token operator">=</span> <span class="token function">PyObject_CallMethodObjArgs</span><span class="token punctuation">(</span>p_cls_instance<span class="token punctuation">,</span> func_name<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span>  <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//test_add(self, 3, 3)</span>
    <span class="token function">PyErr_PrintEx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"call obj.func, Way1 ret =  "</span><span class="token operator">&lt;&lt;</span><span class="token function">PyLong_AsLong</span><span class="token punctuation">(</span>ret1<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        
    



    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>ret1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>func_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>ret0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>obj_attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>cls_attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>p_cls_instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>p_module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//Py_XDECREF(ret0);</span>

    <span class="token function">Py_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_WIN32 <span class="token operator">||</span> _WIN64</span></span>

    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">__linux__ <span class="token operator">||</span> __linux</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//    </span></span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  效果：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_091/eg.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  以下的内容希望重点关注：</p>
<font color = red size = 4>
<ol>
<li class="lvl-3">
<p>其实这个看起来是很简单的，如果有一定的c++基础，整个流程就是导入模块，获取模块中的属性，这些属性包括函数，全局变量，类等等。</p>
</li>
<li class="lvl-3">
<p>操作全局的函数和变量</p>
</li>
<li class="lvl-3">
<p>这里最难的还是对于python class 的操作，第1点中获取的类属性是一个callable object，这个时候需要实例化class(这里调用了builtin的__new__，而不是class中重载的__new__)，然后需要手动调用__init__方法。到此，class的实例化完成</p>
</li>
<li class="lvl-3">
<p>通过api获取class的属性，就是class的变量</p>
</li>
<li class="lvl-3">
<p>通过api调用object method，传入obj和函数名，包括参数，直接调用即可，主要某些api要关注self这个参数。</p>
</li>
</ol>
</font>
<br/>
<br/>
<br/>
<br/>
<h3 id="调试常用手段">调试常用手段</h3>
<hr>
<ol>
<li class="lvl-3">
<p>如果Py_Finalize()调用时，崩溃了，请检查自己的Py_INCREF和Py_DECREF各个引用增减是否正确。</p>
</li>
<li class="lvl-3">
<p>如果某些python c api调用失败了，可以尝试使用 PyErr_PrintEx(1);</p>
</li>
</ol>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2019/12/20/blog_idx_090/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/12/20/blog_idx_090/" class="post-title-link" itemprop="url">软件开发、持续集成（CI）、持续交付(CD)、持续部署（CD） 和 版本管理(Version Control) 的理解和思考</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-12-20 16:52:54" itemprop="dateCreated datePublished" datetime="2019-12-20T16:52:54+08:00">2019-12-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%B8%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">常识</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-31 10:39:57
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=090） 
&emsp;&emsp;本文发布于 2019-12-20 16:52:54，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=090） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  软件开发，水很深。</p>
<p>  做了两年有余的攻城狮，做了代码开发，技术框架搭建，环境搭建，项目管理，用户沟通等工作，我从代码开发者的角度来看，我们的写的内容到用户实际使用往往中间有许多的内容的，作为开发者，千万别人为自己写的代码就是整个项目周期的全部，其实code部分只占很少的时间，从code后到交付给用户使用的中间部分才是非常大的一个时间占比。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="软件开发思考">软件开发思考</h3>
<hr>
<p>  在学校里面，当我们学习软件工程这门课时，教授的内容是比较传统的软件开发流程，它们大概是如下的流程：</p>
<ol>
<li class="lvl-4">
<p>获取到大致项目需求</p>
</li>
<li class="lvl-4">
<p>需求评估</p>
</li>
<li class="lvl-4">
<p>需求文档整理</p>
</li>
<li class="lvl-4">
<p>概要设计（技术框架设计）</p>
</li>
<li class="lvl-4">
<p>编码</p>
</li>
<li class="lvl-4">
<p>测试</p>
</li>
<li class="lvl-4">
<p>交付</p>
</li>
</ol>
<p>  当交付给用户后，实际情况是不可能一次性交付成功的，都会涉及到相关的需求细化和变更，于是又要重复5-7的步骤。</p>
<p>  到了实际工作中后，会出现一种现象，项目交付的时间尽可能短，项目需求变更和交付时间也需要尽可能的短，于是就出现了传统按部就班的开发模式不能够完成相关的项目，于是出现了一些快速开发的方法，如敏捷开发。</p>
<p>  在实际过程中，敏捷开发只是加速开发迭代部分，如果没有控制好，就会出现开发速度加快了，但是测试，交付会出现问题，为啥会出现呢？其实很简单，就是都是独立串行的，这会导致从整体看，项目开发时间拖长。</p>
<p>  为了解决类似的问题，又提出了类似Devops的说法，就是大家都坐一起，相互依赖的做事，因为都是站在整体考虑的，所以可以对整个流程（开发、测试、交付）的情况进行协调，效率会比较好。</p>
<p>  为了把上述的问题处理好，我们必须要引入一些工具（VCS,CI,CD,CD）来帮助我们做事，否则是处理不好的这些事的，就会出现：要不效率低，能完成。要不效率高，就是容易出错。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="版本管理系统（Version-Control-System）">版本管理系统（Version Control System）</h3>
<hr>
<p>  版本管理系统，这个不用介绍了，大家平常工作中都会用，常用的有svn和git，如果没有接触过，有兴趣的可以多去网上找找资料学习学习，它们可以提供代码管理、溯源等功能。</p>
<p>  版本管理系统除了本身的属性外，它自身带的一些特性可以用来做一些其他的事情，比如它的push事件可以用来触发一些其他的工作。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="持续集成（Continuous-Integration）">持续集成（Continuous Integration）</h3>
<hr>
<p>  持续集成其实对于开发者来说，是很简单的一件事情。就相当于你code完，然后手动编译，测试这样的一个流程。平常比如你用vs写了一个程序，然后你右键编译，然后f5运行测试，最后到相应的目录去打包发布程序。这种方式在软件规模比较小的时候，完全可以采用，流程可控的，当软件规模过大，而且需要持续维护修改时，这种方式会让人炸裂的。</p>
<p>  所以持续集成简单的归纳为通过一些工具来自动化编译，单元测试，并生成相关的报告。至于什么时候自动开始编译，这里就是上文说的VCS的相关事件来触发就行。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="持续交付（Continuous-Delivery）">持续交付（Continuous Delivery）</h3>
<hr>
<p>  持续交付其实由相关QA质量保证团队来手动或者自动的方式，检测刚刚持续集成的程序版本，在模拟生产环境下，是否能够正常工作。</p>
<p>  这里强调的还是内部测试，只是相关测试更贴近于实际生产环境。注意这里没有部署到生产环境。对于很多公司来说，其实QA软件部门是等于没有的。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="持续部署（Continuous-Deployment）">持续部署（Continuous Deployment）</h3>
<hr>
<p>  持续部署就是通过一些工具，自动化的把经过单元测试，QA测试后，打包，自动化部署到生产环境这么一个过程。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="关于ci，cd，cd，vcs的说明">关于ci，cd，cd，vcs的说明</h3>
<hr>
<p>  其实就以上而言，你可以直接认为就是，使用工具，自动化从vcs拉取代码，自动化编译测试程序，（半）自动化QA保证，自动化部署程序到生产环境这么一个过程。这里借助了很多自动化工具，大大节约了程序多次迭代的时间。所以对于软件开发来说，哪怕是敏捷开发，devops等模式都可以很好的建立起来。</p>
<p>  但是不是说以上的就是最好的呢？因为在软件第一次发布的时候，如果借用以上的自动化流程，需要一个人或者团队来建立这个自动化逻辑，这是比较烦的一件事情，所以如果软件迭代次数少，规模不大，不要硬搬硬套上述整个流程，实在是不合适。但是里面的vcs，我还是希望每个项目都能够用起来，真的很不错。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Jenkins-，-Travis-，Github-Action-等ci，cd工具说明">Jenkins ， Travis  ，Github Action 等ci，cd工具说明</h3>
<hr>
<p>  这些工具是我用过的，世界上还有许多这样的工具，看个人喜好了。这里要对这些工具分一个类，按照他们的部署位置分一下，一种是需要自己搭建相关服务的，并完成cicd的事情，一种是自己提供相关配置文件（yml），由云端给你解析这个配置文件并完成相关功能。</p>
<p>  这里Jenkins是属于需要自己搭建服务的，需要自己定义相关的流程并完成cicd的事情。</p>
<p>  Travis，GitHub Action这种是输入云端的功能，基本上算是属于SaaS，你只需要提供遵循相关语法的配置文件，它们就会自动完成你定义的流程。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  总结</p>
<p>  合适的事情，选择合适的工具。不是所有的情况都能够把上面的整套给怼到团队中去，但是整个软件开发的流程和内容还是值得我们大家思考和借鉴的。</p>
<p>  比如我们的团队就引入了git和jenkins就够了，能够做简单的版本管理和基本的软件集成测试。其他的手动介入性价比比较好。</p>
<p>  比如我自己封装的一些开源小功能，我引入git，travis， github action就已经足够了。</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2019/11/04/blog_idx_089/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/11/04/blog_idx_089/" class="post-title-link" itemprop="url">大端(big endian) 小端(little endian) --- 在多字节存储 和 多字节通信中的含义（我还是太年轻了）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-11-04 16:44:48" itemprop="dateCreated datePublished" datetime="2019-11-04T16:44:48+08:00">2019-11-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%B8%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">常识</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%B8%E8%AF%86/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%B8%E8%AF%86/C-CPP/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-12-30 23:18:51
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=089） 
&emsp;&emsp;本文发布于 2019-11-04 16:44:48，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=089） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="背景">背景</h3>
<hr>
<p>  出来工作了两年有余了，其中有很多次接触到大小端的问题，每次都是拍一下脑袋，按照记忆中的内容做东西。（小端：高地址存高字节，低地址存低字节；大端：高地址存低字节，低地址存高字节）没有做深入的理解，导致我最近遇到一个通信接口文档，文档标注的是大端模式，但是我按照自己的记忆中的大端去做，却写错了，这不是我记忆有问题，只是我没有理解到位而已。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Big-endian-And-Little-endian-大小端">Big endian And Little endian(大小端)</h3>
<hr>
<p>  在多个字节读写或者传输过程中，哪个字节作为高字节，哪个字节作为低字节，需要我们人为定义的。于是人们定义了大端模式和小端模式。但是我们常见的一句话：“小端：高地址存高字节，低地址存低字节；大端：高地址存低字节，低地址存高字节。”是指的多字节存储中的定义。对于多字节传输中，大端小端这样记忆或者说理解可能会出问题。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iomanip></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdint></span></span>

<span class="token keyword">union</span> test_byte_order<span class="token punctuation">&#123;</span>

	<span class="token keyword">uint16_t</span> a<span class="token punctuation">;</span>
	<span class="token keyword">uint8_t</span> b<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>test0<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	test0<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">0xAAFF</span><span class="token punctuation">;</span>
	
	<span class="token comment">//byte-order-check based on union </span>
	<span class="token comment">//Notice that the basefield flag only affects the insertion/extraction of integer values (floating-point values are always interpreted in decimal base).</span>
	std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"addr of test0.a is "</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>hex <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>test0<span class="token punctuation">.</span>a <span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>string union_ret <span class="token operator">=</span> <span class="token punctuation">(</span>test0<span class="token punctuation">.</span>b <span class="token operator">==</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token string">"little endian"</span><span class="token operator">:</span><span class="token string">"big endian"</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span>union_ret<span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>


	<span class="token comment">//byte-order-check based on pointer </span>
	<span class="token keyword">uint16_t</span> a <span class="token operator">=</span> <span class="token number">0xAAFF</span><span class="token punctuation">;</span>
	<span class="token keyword">uint8_t</span> <span class="token operator">*</span> b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>a<span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"addr of a is "</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>hex <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>a <span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>string pointer_ret <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>b <span class="token operator">==</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token string">"little endian"</span><span class="token operator">:</span><span class="token string">"big endian"</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span>pointer_ret<span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  gdb调试结果（符合预期）</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_089/gdb1.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  常见的x86 是小端模式</p>
<p>  现在常见的arm 支持大小端模式</p>
<br/>
<br/>
<h5 id="多字节通信（人为约定）">多字节通信（人为约定）</h5>
<p>  多字节通信的问题的话，其实就是你是先发送高字节，还是先发送低字节位的问题。其实如果通信文档中一般都定义了先发送高还是低字节，但是如果通信文档中换一种说法（大端模式、小端模式）的话，可能就需要思考一下，或者说需要理解一下才行。</p>
<p>  例如tcp/ip协议中，对于ip地址和端口号，要求的必须是网络字节序，也就是大端字节序模式。那我们到底是先发送高字节还是先发送低字节呢？其实在其他的232/485/can/蓝牙/等等通信方式中，也有同样的概念。</p>
<p>  那对于多字节通信中，人为定义了（注意，这里的定义的概念和多字节存储中的是同等级的，你可以理解为他们两个没有关系）：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>大端序模式：先发送高字节，后发送低字节。</p>
</li>
<li class="lvl-2">
<p>小端序模式：先发送低字节，后发送高字节。</p>
</li>
</ul>
<p>  既然上述概念是大多数人为约定的，那么可能就有这样那样的误解。所以，一般通信文档上说明了大端模式、还是小端模式外，还需要标注MSB or LSB first，或者直接注明先发高或者是低字节，避免双方出现误解。</p>
<p>  当然，有没有方法可以记忆多字节通信中，这种大多数人定义的概念呢？下文提供了一种我的记忆方案吧。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//x86-64 ubuntu 18.04</span>
<span class="token keyword">uint16_t</span> ttt <span class="token operator">=</span> <span class="token number">0xAABB</span><span class="token punctuation">;</span>
<span class="token keyword">uint16_t</span> ttt_hton <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>ttt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把ttt转换为网络字节序，大端模式</span>
<span class="token keyword">uint8_t</span> array<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0xAA</span><span class="token punctuation">,</span> <span class="token number">0xBB</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xDD</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_089/gdb2.png" alt="rep_img"/></center>
    </div>
</div> 
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_089/gdb3.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  在c&amp;&amp;c++数组中，数组名字是指向的这个数组的低地址。假如我要按地址自增方向发送这个数组的数据，如果数组中先存放高字节（也就是说低地址存放高字节，或者说先发送高字节），那么这种通信方案中，字节序为大端模式。小端模式同理可得。</p>
<p>  但是，这仅仅是一种记忆方案。而且这是一种通用的约定，具体还是要看通信文档的定义，例如tcp/ip中的ip和端口号字节序定义就是MSB first。如果某一天，哪个人可能直接定义大端模式就是先发送低字节，也是有可能的。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  总结</p>
<p>  大小端对于存储和通信来说，我个人认为有着不同的含义。虽然可以通过一些方法联系起来记忆。</p>
<p>  但是我认为，以上的内容都不是重点，是一些概念的东西，重点的是，你要明白为啥会出现这个大小端的问题？什么是字节序？为什么会有字节序这个概念就行了？</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/NO_EXSIT.XXXXXXX/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/NO_EXSIT.XXXXXXX/">1</a><span class="space">&hellip;</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/14/">14</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/NO_EXSIT.XXXXXXX/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Sky</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">286k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">17:19</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":250,"hOffset":50,"vOffset":5},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
</html>
