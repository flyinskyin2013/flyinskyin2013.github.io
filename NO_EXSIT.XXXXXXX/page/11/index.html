<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"e-x.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Sky&#39;s Blogs">
<meta property="og:url" content="https://e-x.top/NO_EXSIT.XXXXXXX/page/11/index.html">
<meta property="og:site_name" content="Sky&#39;s Blogs">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Sky">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://e-x.top/NO_EXSIT.XXXXXXX/page/11/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"NO_EXSIT.XXXXXXX/page/11/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Sky's Blogs</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  




<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8677552300382028"
     crossorigin="anonymous"></script>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Sky's Blogs</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A normal star</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Sky</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">92</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">222</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/08/23/blog_idx_038/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/08/23/blog_idx_038/" class="post-title-link" itemprop="url">GCC&&G++ C && C++ 内嵌汇编和调用汇编函数的方法(x86，ARM自己对照改)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-08-23 16:42:38" itemprop="dateCreated datePublished" datetime="2017-08-23T16:42:38+08:00">2017-08-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 15:33:47
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=038） 
&emsp;&emsp;本文发布于 2017-08-23 16:42:38，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=038） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  测试环境：Linux  4.8.0-36-generic #36~16.04.1-Ubuntu SMP Sun Feb 5 09:39:57 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</p>
<p>  gcc:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Using built-in specs.
<span class="token assign-left variable">COLLECT_GCC</span><span class="token operator">=</span>gcc
<span class="token assign-left variable">COLLECT_LTO_WRAPPER</span><span class="token operator">=</span>/usr/lib/gcc/x86_64-linux-gnu/5/lto-wrapper
Target: x86_64-linux-gnu
Configured with: <span class="token punctuation">..</span>/src/configure <span class="token parameter variable">-v</span> --with-pkgversion<span class="token operator">=</span><span class="token string">'Ubuntu 5.4.0-6ubuntu1~16.04.4'</span> --with-bugurl<span class="token operator">=</span>file:///usr/share/doc/gcc-5/README.Bugs --enable-languages<span class="token operator">=</span>c,ada,c++,java,go,d,fortran,objc,obj-c++ <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr --program-suffix<span class="token operator">=</span>-5 --enable-shared --enable-linker-build-id <span class="token parameter variable">--libexecdir</span><span class="token operator">=</span>/usr/lib --without-included-gettext --enable-threads<span class="token operator">=</span>posix <span class="token parameter variable">--libdir</span><span class="token operator">=</span>/usr/lib --enable-nls --with-sysroot<span class="token operator">=</span>/ --enable-clocale<span class="token operator">=</span>gnu --enable-libstdcxx-debug --enable-libstdcxx-time<span class="token operator">=</span>yes --with-default-libstdcxx-abi<span class="token operator">=</span>new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --with-system-zlib --disable-browser-plugin --enable-java-awt<span class="token operator">=</span>gtk --enable-gtk-cairo --with-java-home<span class="token operator">=</span>/usr/lib/jvm/java-1.5.0-gcj-5-amd64/jre --enable-java-home --with-jvm-root-dir<span class="token operator">=</span>/usr/lib/jvm/java-1.5.0-gcj-5-amd64 --with-jvm-jar-dir<span class="token operator">=</span>/usr/lib/jvm-exports/java-1.5.0-gcj-5-amd64 --with-arch-directory<span class="token operator">=</span>amd64 --with-ecj-jar<span class="token operator">=</span>/usr/share/java/eclipse-ecj.jar --enable-objc-gc --enable-multiarch --disable-werror --with-arch-32<span class="token operator">=</span>i686 --with-abi<span class="token operator">=</span>m64 --with-multilib-list<span class="token operator">=</span>m32,m64,mx32 --enable-multilib --with-tune<span class="token operator">=</span>generic --enable-checking<span class="token operator">=</span>release <span class="token parameter variable">--build</span><span class="token operator">=</span>x86_64-linux-gnu <span class="token parameter variable">--host</span><span class="token operator">=</span>x86_64-linux-gnu <span class="token parameter variable">--target</span><span class="token operator">=</span>x86_64-linux-gnu
Thread model: posix
gcc version <span class="token number">5.4</span>.0 <span class="token number">20160609</span> <span class="token punctuation">(</span>Ubuntu <span class="token number">5.4</span>.0-6ubuntu1~16.04.4<span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="gcc-cpp-c内嵌汇编">gcc/cpp/c内嵌汇编</h3>
<hr>
<ol>
<li class="lvl-3">
<p>内嵌汇编格式和编译器息息相关，对于不同的编译器，有不同的内嵌规则，这里以gcc为例。（此外，基本的一些知识点，我这里就不重复说了，有需要可以去百度相关的东西，此文的面向读者为了解一些汇编知识的人，比如知道一些基本的寄存器等等）</p>
</li>
<li class="lvl-3">
<p>gcc内嵌汇编格式，基本内嵌汇编寄存器等引用为%，带C&amp;&amp;C++的寄存器等引用为%%</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__asm__ <span class="token punctuation">[</span>__volatile__<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">"instruction list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//基本内嵌汇编</span>
__asm__ <span class="token punctuation">[</span>__volatile__<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"instruction list"</span><span class="token operator">:</span>Output<span class="token operator">:</span>Input<span class="token operator">:</span>Clobber<span class="token operator">/</span>Modify<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//带C&amp;C++相关内容的内嵌汇编</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol start="3">
<li class="lvl-4">
<p>以c=a+b为例</p>
</li>
</ol>
<p>    在代码段中内嵌汇编</p>
<p>      根据第二节的第二种格式，一一对应，就知道，我把a给了ebx,b给了eax，求和后放入eax，把eax传给变量ret</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">user_add1</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	__asm__ <span class="token function">__volatile__</span><span class="token punctuation">(</span><span class="token string">"movl %2, %%eax;movl %1, %%ebx;addl %%ebx, %%eax;movl %%eax, %0"</span>		
				<span class="token operator">:</span><span class="token string">"=m"</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
				<span class="token operator">:</span><span class="token string">"m"</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"m"</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
				<span class="token operator">:</span><span class="token string">"eax"</span><span class="token punctuation">,</span><span class="token string">"ebx"</span><span class="token punctuation">,</span><span class="token string">"memory"</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>    在代码中调用汇编子程序</p>
<p>      这里先开辟一个栈帧，然后读到两个传入参数a,b在栈中的位置，并放入寄存器，并对寄存器进行操作求和，函数返回值放在eax中</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//xxx.c文件中</span>
c<span class="token operator">=</span><span class="token function">user_add</span><span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//xxx.s文件中</span>
<span class="token punctuation">.</span>text
<span class="token punctuation">.</span>globl	user_add
<span class="token punctuation">.</span>type	user_add<span class="token punctuation">,</span> @function
user_add<span class="token operator">:</span>
	<span class="token punctuation">.</span>cfi_startproc
	pushq	<span class="token operator">%</span>rbp
	<span class="token punctuation">.</span>cfi_def_cfa_offset <span class="token number">16</span>
	<span class="token punctuation">.</span>cfi_offset <span class="token number">6</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">16</span>
	movq	<span class="token operator">%</span>rsp<span class="token punctuation">,</span> <span class="token operator">%</span>rbp
	<span class="token punctuation">.</span>cfi_def_cfa_register <span class="token number">6</span>
	movl	<span class="token operator">%</span>edi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
	movl	<span class="token operator">%</span>esi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">24</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
	addl    <span class="token operator">%</span>esi<span class="token punctuation">,</span> <span class="token operator">%</span>edi
	movl	<span class="token operator">%</span>edi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
	movl	<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>eax
	popq	<span class="token operator">%</span>rbp
	<span class="token punctuation">.</span>cfi_def_cfa <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span>
	ret
	<span class="token punctuation">.</span>cfi_endproc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>    在内嵌汇编代码中调用汇编子程序</p>
<p>      由于调用的时候，我先吧参数传给了eax，ebx，通过call，我直接对eax，ebx求和，得到结果</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//xxx.c文件中</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	__asm__ <span class="token function">__volatile__</span><span class="token punctuation">(</span><span class="token string">"movl %2, %%eax;movl %1, %%ebx;call user_add2"</span>		
				<span class="token operator">:</span><span class="token string">"=a"</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
				<span class="token operator">:</span><span class="token string">"m"</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"m"</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
				<span class="token operator">:</span><span class="token string">"ebx"</span><span class="token punctuation">,</span><span class="token string">"memory"</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
				
<span class="token comment">//xxx.s文件中</span>
<span class="token punctuation">.</span>text
<span class="token punctuation">.</span>globl	user_add2
<span class="token punctuation">.</span>type	user_add2<span class="token punctuation">,</span> @function
user_add2<span class="token operator">:</span>
	addl <span class="token operator">%</span>ebx<span class="token punctuation">,</span><span class="token operator">%</span>eax
	ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li class="lvl-3">
<p>总结与分析</p>
<ol>
<li class="lvl-7">首先这是x86下面的汇编指令格式，如果是ARM或者MIPS等平台，请根据各自的指令格式进行修改。</li>
<li class="lvl-7">这里需要注意的是，从这三种方式来看，前两种方式里面，我们必须要注意，在通过c的方式调用函数时，其参数的存放位置在哪里，参数的存放顺序，同时我们还必须知道gcc的默认调用约定是什么。这是极其重要的</li>
<li class="lvl-7">第三种方式的调用的最简单粗暴的，但是可能会隐含一些问题，如果gcc没有帮你很好的保护现场，那么可能会出现程序崩溃的情况。</li>
</ol>
</li>
<li class="lvl-3">
<p>源代码和测试</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//t.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">extern</span> <span class="token keyword">int</span>  <span class="token function">user_add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span>  <span class="token function">user_add2</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">user_add1</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	__asm__ <span class="token function">__volatile__</span><span class="token punctuation">(</span><span class="token string">"movl %2, %%eax;movl %1, %%ebx;addl %%ebx, %%eax;movl %%eax, %0"</span>		
				<span class="token operator">:</span><span class="token string">"=m"</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
				<span class="token operator">:</span><span class="token string">"m"</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"m"</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
				<span class="token operator">:</span><span class="token string">"eax"</span><span class="token punctuation">,</span><span class="token string">"ebx"</span><span class="token punctuation">,</span><span class="token string">"memory"</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>


	<span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"user_add1 sum(a+b)=%d\n"</span><span class="token punctuation">,</span><span class="token function">user_add1</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"user_add sum(a+b)=%d\n"</span><span class="token punctuation">,</span><span class="token function">user_add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	__asm__ <span class="token function">__volatile__</span><span class="token punctuation">(</span><span class="token string">"movl %2, %%eax;movl %1, %%ebx;call user_add2"</span>		
				<span class="token operator">:</span><span class="token string">"=a"</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
				<span class="token operator">:</span><span class="token string">"m"</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"m"</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
				<span class="token operator">:</span><span class="token string">"ebx"</span><span class="token punctuation">,</span><span class="token string">"memory"</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"user_add2 sum(a+b)=%d\n"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//t1.s</span>

<span class="token punctuation">.</span>text
<span class="token punctuation">.</span>globl	user_add
<span class="token punctuation">.</span>type	user_add<span class="token punctuation">,</span> @function
user_add<span class="token operator">:</span>
	<span class="token punctuation">.</span>cfi_startproc
	pushq	<span class="token operator">%</span>rbp
	<span class="token punctuation">.</span>cfi_def_cfa_offset <span class="token number">16</span>
	<span class="token punctuation">.</span>cfi_offset <span class="token number">6</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">16</span>
	movq	<span class="token operator">%</span>rsp<span class="token punctuation">,</span> <span class="token operator">%</span>rbp
	<span class="token punctuation">.</span>cfi_def_cfa_register <span class="token number">6</span>
	movl	<span class="token operator">%</span>edi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
	movl	<span class="token operator">%</span>esi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">24</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
	addl    <span class="token operator">%</span>esi<span class="token punctuation">,</span> <span class="token operator">%</span>edi
	movl	<span class="token operator">%</span>edi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
	movl	<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>eax
	popq	<span class="token operator">%</span>rbp
	<span class="token punctuation">.</span>cfi_def_cfa <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span>
	ret
	<span class="token punctuation">.</span>cfi_endproc


<span class="token punctuation">.</span>text
<span class="token punctuation">.</span>globl	user_add2
<span class="token punctuation">.</span>type	user_add2<span class="token punctuation">,</span> @function
user_add2<span class="token operator">:</span>
	addl <span class="token operator">%</span>ebx<span class="token punctuation">,</span><span class="token operator">%</span>eax
	ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 编译及运行效果：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_038/run.png" alt="rep_img"/></center>
    </div>
</div>  
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/08/21/blog_idx_037/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/08/21/blog_idx_037/" class="post-title-link" itemprop="url">毕设系列之JrtpLib H264(裸视频数据) 实时视频传输(发送与接受)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-08-21 17:00:39" itemprop="dateCreated datePublished" datetime="2017-08-21T17:00:39+08:00">2017-08-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 15:48:55
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=037） 
&emsp;&emsp;本文发布于 2017-08-21 17:00:39，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=037） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  Linux  4.8.0-36-generic #36~16.04.1-Ubuntu SMP Sun Feb 5 09:39:57 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="JRtp">JRtp</h3>
<hr>
<ol>
<li class="lvl-3">
<p>首先直接下载源代码，查看其中的example1和2，里面有关于字符串的发送和接收的例子。先研究一下这个例子中JRTPlib的基本用法。然后就可以接着看下面的部分。（了解的忽略这一部分）</p>
</li>
<li class="lvl-3">
<p>JRTPLib的使用心得。</p>
<ol>
<li class="lvl-7">
<p>首先我实现的所有的主要功能都来至于这些类，那就是RTPSession ，RTPSessionParams。其中RTPSession 是核心，所有的其他类都是为这个服务的。它的主要作用是管理一个rtp会话，而另外一个是设置这个会话的参数。</p>
</li>
<li class="lvl-7">
<p>这个库使用的主要流程是建立一个会话对象，为这个会话设置参数，创建会话，循环等待响应和处理会话（也就是发送和接收）。所以这个库的核心就在循环等待这一块，其他的都是约定好的东西，照搬就可以。</p>
</li>
<li class="lvl-7">
<p>现在我们进入正题，也就是循环等待部分（JRTPLib的核心）</p>
<ul class="lvl-4">
<li class="lvl-10">发送部分<br>
RTPSession .SendPacket（buf,len）用来发送数据</li>
<li class="lvl-10">接收部分<br>
RTPSession .BeginDataAccess();RTPSession .EndDataAccess();之间的部分就是接收和处理RTP数据。</li>
</ul>
</li>
</ol>
</li>
<li class="lvl-3">
<p>正题，H264裸视频的传输，以实际代码为例。</p>
</li>
</ol>
<p>    a. 首先是H264相关是设定，如果对RTP协议不太了解，可去找找相关资料来看一看就OK了。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetDefaultPayloadType</span><span class="token punctuation">(</span><span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置传输类型 ,来至于rtp协议规范 </span>
this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetDefaultMark</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//设置位，true标志此分包是最后一个包，false反之  </span>
this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetTimestampUnit</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">9000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置采样间隔  </span>
this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetDefaultTimestampIncrement</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置时间戳增加间隔  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>    b. 然后是传输参数的设定</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">	sessparams<span class="token punctuation">.</span><span class="token function">SetOwnTimestampUnit</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//时间戳单位  </span>
    sessparams<span class="token punctuation">.</span><span class="token function">SetAcceptOwnPackets</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//接收自己发送的数据包，这里必须设定为true，否则不能够接收到相关的包。 </span>
    sessparams<span class="token punctuation">.</span><span class="token function">SetUsePredefinedSSRC</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//设置使用预先定义的SSRC,同步源ID，不明白的去看看相关资料</span>
    sessparams<span class="token punctuation">.</span><span class="token function">SetPredefinedSSRC</span><span class="token punctuation">(</span>SSRC<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//定义SSRC</span>
```    
<span class="token operator">&amp;</span>emsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>emsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>emsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>emsp<span class="token punctuation">;</span>c<span class="token punctuation">.</span> h264裸视频数据的实时传输（这里有一个非常重要的东西，叫做拆包，学过《计算机网络》的人都应该知道这么一个东西吧），宏CODE_M部分的拆包算法是我写的，另外一部分的是网上传播最宽的一个拆包算法，我没有找到最开始的出处，所以就见谅啦，那位大神，我用来做对照。此外对于H264的传输，一定要知道什么是NALU（header，data），如果不知道去查资料<span class="token punctuation">,</span>同时最好去看看RTP协议发送相关的知识。这部分传入的参数为Libx264编码之后生成的Nalu

```c
<span class="token comment">//Internet 对 pkg-len>1400丢包概率很大（出之于某一篇论文），RTP header 12bytes,RTP pkg-max-len &lt;= 1388</span>
<span class="token comment">//MTU 48~1500, UDP data max len = 1500 - 20(IP header) - 8(UDP header)</span>
<span class="token comment">//上面的东西看不懂，请回去翻翻计算机网络</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> NaluSize <span class="token operator">&lt;=</span> MAX_RTP_PKT_LENGTH <span class="token punctuation">)</span>  
    <span class="token punctuation">&#123;</span>    
        <span class="token function">memcpy</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">,</span>p_Nalu<span class="token punctuation">,</span>NaluSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    
        status <span class="token operator">=</span> this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SendPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>Sbuf<span class="token punctuation">,</span>NaluSize<span class="token punctuation">)</span><span class="token punctuation">;</span>  
     
        <span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>   
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>NaluSize <span class="token operator">></span> MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
        this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetDefaultMark</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//mark that this is not finall pkg</span>
		<span class="token keyword">int</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>l<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    
        k <span class="token operator">=</span> NaluSize <span class="token operator">/</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">;</span>  <span class="token comment">//k>=1</span>
        l <span class="token operator">=</span> NaluSize <span class="token operator">%</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">;</span>  <span class="token comment">//l>=0</span>
		<span class="token keyword">int</span> t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//用指示当前发送的是第几个分片RTP包</span>
		<span class="token keyword">int</span> SendLen<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CODE_M</span></span>
		<span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> k<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">==</span> k<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>l <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span> t <span class="token operator">&lt;</span> k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//0~k-2,total k - 1 pkgs</span>
				
				<span class="token function">memcpy</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">,</span><span class="token punctuation">(</span>p_Nalu<span class="token operator">+</span><span class="token punctuation">(</span> t <span class="token operator">*</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
				status <span class="token operator">=</span> this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SendPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>Sbuf<span class="token punctuation">,</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                  
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//last pkg, t == k,l > 0, or (k -1)'th pkg</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> l <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>l <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> t <span class="token operator">==</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
					
					this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetDefaultMark</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">if</span> <span class="token punctuation">(</span> l <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>
						SendLen <span class="token operator">=</span> l<span class="token punctuation">;</span>
					<span class="token keyword">else</span>
						SendLen <span class="token operator">=</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">;</span>

					<span class="token function">memcpy</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">,</span><span class="token punctuation">(</span>p_Nalu<span class="token operator">+</span><span class="token punctuation">(</span> t <span class="token operator">*</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SendLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
					status <span class="token operator">=</span> this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SendPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>Sbuf<span class="token punctuation">,</span>SendLen<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                	<span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                	
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//(t == k-1) &amp;&amp; ( l > 0 )</span>
					
					<span class="token function">memcpy</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">,</span><span class="token punctuation">(</span>p_Nalu<span class="token operator">+</span><span class="token punctuation">(</span> t <span class="token operator">*</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
					status <span class="token operator">=</span> this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SendPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>Sbuf<span class="token punctuation">,</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                	<span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                	
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			t<span class="token operator">++</span><span class="token punctuation">;</span>
			
		<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
 <span class="token keyword">while</span><span class="token punctuation">(</span> t <span class="token operator">&lt;</span> k <span class="token operator">||</span> <span class="token punctuation">(</span> t<span class="token operator">==</span>k <span class="token operator">&amp;&amp;</span> l<span class="token operator">></span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>    
        <span class="token punctuation">&#123;</span>    
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> t <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> t<span class="token operator">&lt;</span>k <span class="token operator">&amp;&amp;</span> <span class="token number">0</span><span class="token operator">!=</span>t <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">//第一包到最后包的前一包  </span>
            <span class="token punctuation">&#123;</span>  
                <span class="token comment">/*sendbuf[0] = (nalHeader &amp; 0x60)|28;   
                sendbuf[1] = (nalHeader &amp; 0x1f); 
                if ( 0 == t ) 
                &#123; 
                    sendbuf[1] |= 0x80; 
                &#125; 
                memcpy(sendbuf+2,&amp;pSendbuf[t*MAX_RTP_PKT_LENGTH],MAX_RTP_PKT_LENGTH); 
                status = this->SendPacket((void *)sendbuf,MAX_RTP_PKT_LENGTH+2);*/</span>  
                <span class="token function">memcpy</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">,</span><span class="token operator">&amp;</span>p_Nalu<span class="token punctuation">[</span>t<span class="token operator">*</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">]</span><span class="token punctuation">,</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                status <span class="token operator">=</span> this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SendPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>Sbuf<span class="token punctuation">,</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                t<span class="token operator">++</span><span class="token punctuation">;</span>  
            <span class="token punctuation">&#125;</span>  
            <span class="token comment">//最后一包  </span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> k<span class="token operator">==</span>t <span class="token operator">&amp;&amp;</span> l<span class="token operator">></span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> t<span class="token operator">==</span> <span class="token punctuation">(</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> l<span class="token operator">==</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>  
            <span class="token punctuation">&#123;</span>  
                <span class="token comment">//设置标志位Mark为1  </span>
                this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetDefaultMark</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
                <span class="token keyword">int</span> iSendLen<span class="token punctuation">;</span>  
                <span class="token keyword">if</span> <span class="token punctuation">(</span> l <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>  
                <span class="token punctuation">&#123;</span>  
                    iSendLen <span class="token operator">=</span> NaluSize <span class="token operator">-</span> t<span class="token operator">*</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">;</span>  
                <span class="token punctuation">&#125;</span>  
                <span class="token keyword">else</span>  
                    iSendLen <span class="token operator">=</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">;</span>  
  
                <span class="token comment">//sendbuf[0] = (nalHeader &amp; 0x60)|28;    </span>
                <span class="token comment">//sendbuf[1] = (nalHeader &amp; 0x1f);  </span>
                <span class="token comment">//sendbuf[1] |= 0x40;  </span>
  
                <span class="token comment">//memcpy(sendbuf+2,&amp;pSendbuf[t*MAX_RTP_PKT_LENGTH],iSendLen);  </span>
                <span class="token comment">//status = this->SendPacket((void *)sendbuf,iSendLen+2);  </span>
     
                <span class="token function">memcpy</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">,</span><span class="token operator">&amp;</span>p_Nalu<span class="token punctuation">[</span>t<span class="token operator">*</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">]</span><span class="token punctuation">,</span>iSendLen<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                status <span class="token operator">=</span> this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SendPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>Sbuf<span class="token punctuation">,</span>iSendLen<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
                <span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                t<span class="token operator">++</span><span class="token punctuation">;</span>  
            <span class="token punctuation">&#125;</span>  
			
        <span class="token punctuation">&#125;</span>  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>    d. h264数据的接收部分,就是通过一个函数来对包进行组包操作，然后得到了传输数据，这部分代码和传输时拆包部分，息息相关。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">	<span class="token keyword">if</span><span class="token punctuation">(</span>pack<span class="token punctuation">.</span><span class="token function">GetPayloadType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> H264<span class="token punctuation">)</span>  
    <span class="token punctuation">&#123;</span>  
        <span class="token comment">//std::cout&lt;&lt;"Got H264 packet：êo " &lt;&lt; rtppack.GetExtendedSequenceNumber() &lt;&lt; " from SSRC " &lt;&lt; srcdat.GetSSRC() &lt;&lt;std::endl;  </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pack<span class="token punctuation">.</span><span class="token function">HasMarker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//如果是最后一包则进行组包  </span>
        <span class="token punctuation">&#123;</span>  
           	  
			<span class="token comment">//printf("Got a nal unit \n");</span>
			<span class="token function">memcpy</span><span class="token punctuation">(</span>this<span class="token operator">-></span>rframe<span class="token operator">-></span>pframe <span class="token operator">+</span> this<span class="token operator">-></span>cur_size<span class="token punctuation">,</span>pack<span class="token punctuation">.</span><span class="token function">GetPayloadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pack<span class="token punctuation">.</span><span class="token function">GetPayloadLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  		
			this<span class="token operator">-></span>cur_size <span class="token operator">+=</span> pack<span class="token punctuation">.</span><span class="token function">GetPayloadLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			this<span class="token operator">-></span>rframe<span class="token operator">-></span>use_len <span class="token operator">=</span> this<span class="token operator">-></span>cur_size<span class="token punctuation">;</span>


<span class="token comment">//***************************</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DO_WRITE_FILE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DO_WRITE_FILE</span></span>
			<span class="token keyword">int</span> fd_out <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"rec.h264"</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span>S_IRWXU<span class="token operator">|</span>S_IRWXO<span class="token operator">|</span>S_IRWXG<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">lseek</span><span class="token punctuation">(</span>fd_out<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">write</span><span class="token punctuation">(</span>fd_out<span class="token punctuation">,</span> this<span class="token operator">-></span>rframe<span class="token operator">-></span>pframe<span class="token punctuation">,</span>this<span class="token operator">-></span>rframe<span class="token operator">-></span>use_len<span class="token punctuation">)</span><span class="token punctuation">;</span> 
			<span class="token function">close</span><span class="token punctuation">(</span>fd_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token comment">//***************************</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> cir_buf<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> this<span class="token operator">-></span>rframe<span class="token operator">-></span>use_len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> this<span class="token operator">-></span>rframe<span class="token operator">-></span>use_len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

                    cir_buf<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>this<span class="token operator">-></span>rframe<span class="token operator">-></span>pframe <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>



           	<span class="token function">memset</span><span class="token punctuation">(</span>this<span class="token operator">-></span>rframe<span class="token operator">-></span>pframe<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>this<span class="token operator">-></span>rframe<span class="token operator">-></span>use_len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清空缓存，为下次做准备  </span>
			
            this<span class="token operator">-></span>cur_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
        <span class="token punctuation">&#125;</span>  
        <span class="token keyword">else</span><span class="token comment">//放入缓冲区，在此必须确保有序  </span>
        <span class="token punctuation">&#123;</span>  
            <span class="token comment">//unsigned char* p = rtppack.GetPayloadData();  </span>
  
  
            <span class="token function">memcpy</span><span class="token punctuation">(</span>this<span class="token operator">-></span>rframe<span class="token operator">-></span>pframe <span class="token operator">+</span> this<span class="token operator">-></span>cur_size<span class="token punctuation">,</span>pack<span class="token punctuation">.</span><span class="token function">GetPayloadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pack<span class="token punctuation">.</span><span class="token function">GetPayloadLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            this<span class="token operator">-></span>cur_size <span class="token operator">+=</span> pack<span class="token punctuation">.</span><span class="token function">GetPayloadLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">&#125;</span>  
    <span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  这里只提供发送部分的代码，我的接收部分的代码和服务端写在一起的不好抽离。<br>
y_jrtp.cpp</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"y_jrtp.h"</span></span>

<span class="token keyword">static</span> bool <span class="token function">CheckError</span><span class="token punctuation">(</span><span class="token keyword">int</span> rtperr<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rtperr <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        std<span class="token operator">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"ERROR: "</span><span class="token operator">&lt;&lt;</span><span class="token function">RTPGetErrorString</span><span class="token punctuation">(</span>rtperr<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


yJRTPLIB<span class="token operator">::</span><span class="token function">yJRTPLIB</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>
yJRTPLIB<span class="token operator">::</span><span class="token operator">~</span><span class="token function">yJRTPLIB</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> yJRTPLIB<span class="token operator">::</span><span class="token function">SendX264NalUnit</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token keyword">const</span> p_payload<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> i_payload<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token class-name">uint8_t</span> <span class="token operator">*</span>p_Nalu<span class="token punctuation">;</span>
    <span class="token keyword">int</span> NaluSize<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> Sbuf<span class="token punctuation">[</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> status<span class="token punctuation">;</span>


    p_Nalu <span class="token operator">=</span> p_payload<span class="token punctuation">;</span>
    NaluSize <span class="token operator">=</span> i_payload<span class="token punctuation">;</span>
    <span class="token function">CLEAR_MEM</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Nal unit length is %d \n"</span><span class="token punctuation">,</span>NaluSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//去除前导码0x000001 或者0x00000001</span>
    <span class="token comment">//if( 0x01 == m_h264Buf[2] )</span>
    <span class="token comment">//&#123;</span>
    <span class="token comment">//  pSendbuf = &amp;m_h264Buf[3];</span>
    <span class="token comment">//  buflen -= 3;</span>
    <span class="token comment">//&#125;</span>
    <span class="token comment">//else</span>
    <span class="token comment">//&#123;</span>
    <span class="token comment">//  pSendbuf = &amp;m_h264Buf[4];</span>
    <span class="token comment">//  buflen -= 4;</span>
    <span class="token comment">//&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> NaluSize <span class="token operator">&lt;=</span> MAX_RTP_PKT_LENGTH <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">,</span>p_Nalu<span class="token punctuation">,</span>NaluSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SendPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>Sbuf<span class="token punctuation">,</span>NaluSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>NaluSize <span class="token operator">></span> MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

        this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetDefaultMark</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//mark that this is not finall pkg</span>
        <span class="token keyword">int</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>l<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        k <span class="token operator">=</span> NaluSize <span class="token operator">/</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">;</span>  <span class="token comment">//k>=1</span>
        l <span class="token operator">=</span> NaluSize <span class="token operator">%</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">;</span>  <span class="token comment">//l>=0</span>
        <span class="token keyword">int</span> t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//用指示当前发送的是第几个分片RTP包</span>
        <span class="token keyword">int</span> SendLen<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CODE_M</span></span>
        <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> k<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">==</span> k<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>l <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span> t <span class="token operator">&lt;</span> k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//0~k-2,total k - 1 pkgs</span>

                <span class="token function">memcpy</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">,</span><span class="token punctuation">(</span>p_Nalu<span class="token operator">+</span><span class="token punctuation">(</span> t <span class="token operator">*</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
                status <span class="token operator">=</span> this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SendPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>Sbuf<span class="token punctuation">,</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//last pkg, t == k,l > 0, or (k -1)'th pkg</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> l <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>l <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> t <span class="token operator">==</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

                    this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetDefaultMark</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span> l <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>
                        SendLen <span class="token operator">=</span> l<span class="token punctuation">;</span>
                    <span class="token keyword">else</span>
                        SendLen <span class="token operator">=</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">;</span>

                    <span class="token function">memcpy</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">,</span><span class="token punctuation">(</span>p_Nalu<span class="token operator">+</span><span class="token punctuation">(</span> t <span class="token operator">*</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SendLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    status <span class="token operator">=</span> this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SendPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>Sbuf<span class="token punctuation">,</span>SendLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//(t == k-1) &amp;&amp; ( l > 0 )</span>

                    <span class="token function">memcpy</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">,</span><span class="token punctuation">(</span>p_Nalu<span class="token operator">+</span><span class="token punctuation">(</span> t <span class="token operator">*</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    status <span class="token operator">=</span> this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SendPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>Sbuf<span class="token punctuation">,</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            t<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
 <span class="token keyword">while</span><span class="token punctuation">(</span> t <span class="token operator">&lt;</span> k <span class="token operator">||</span> <span class="token punctuation">(</span> t<span class="token operator">==</span>k <span class="token operator">&amp;&amp;</span> l<span class="token operator">></span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> t <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> t<span class="token operator">&lt;</span>k <span class="token operator">&amp;&amp;</span> <span class="token number">0</span><span class="token operator">!=</span>t <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">//第一包到最后包的前一包</span>
            <span class="token punctuation">&#123;</span>
                <span class="token comment">/*sendbuf[0] = (nalHeader &amp; 0x60)|28;
                sendbuf[1] = (nalHeader &amp; 0x1f);
                if ( 0 == t )
                &#123;
                    sendbuf[1] |= 0x80;
                &#125;
                memcpy(sendbuf+2,&amp;pSendbuf[t*MAX_RTP_PKT_LENGTH],MAX_RTP_PKT_LENGTH);
                status = this->SendPacket((void *)sendbuf,MAX_RTP_PKT_LENGTH+2);*/</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">,</span><span class="token operator">&amp;</span>p_Nalu<span class="token punctuation">[</span>t<span class="token operator">*</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">]</span><span class="token punctuation">,</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
                status <span class="token operator">=</span> this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SendPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>Sbuf<span class="token punctuation">,</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                t<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//最后一包</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> k<span class="token operator">==</span>t <span class="token operator">&amp;&amp;</span> l<span class="token operator">></span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> t<span class="token operator">==</span> <span class="token punctuation">(</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> l<span class="token operator">==</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token comment">//设置标志位Mark为1</span>
                this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetDefaultMark</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> iSendLen<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span> l <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    iSendLen <span class="token operator">=</span> NaluSize <span class="token operator">-</span> t<span class="token operator">*</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span>
                    iSendLen <span class="token operator">=</span> MAX_RTP_PKT_LENGTH<span class="token punctuation">;</span>

                <span class="token comment">//sendbuf[0] = (nalHeader &amp; 0x60)|28;</span>
                <span class="token comment">//sendbuf[1] = (nalHeader &amp; 0x1f);</span>
                <span class="token comment">//sendbuf[1] |= 0x40;</span>

                <span class="token comment">//memcpy(sendbuf+2,&amp;pSendbuf[t*MAX_RTP_PKT_LENGTH],iSendLen);</span>
                <span class="token comment">//status = this->SendPacket((void *)sendbuf,iSendLen+2);</span>

                <span class="token function">memcpy</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">,</span><span class="token operator">&amp;</span>p_Nalu<span class="token punctuation">[</span>t<span class="token operator">*</span>MAX_RTP_PKT_LENGTH<span class="token punctuation">]</span><span class="token punctuation">,</span>iSendLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                status <span class="token operator">=</span> this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SendPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>Sbuf<span class="token punctuation">,</span>iSendLen<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                t<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> yJRTPLIB<span class="token operator">::</span><span class="token function">SetX264Parm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetDefaultPayloadType</span><span class="token punctuation">(</span>H264<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置传输类型</span>
    this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetDefaultMark</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//设置位</span>
    this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetTimestampUnit</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">9000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置采样间隔</span>
    this<span class="token operator">-></span>sess<span class="token punctuation">.</span><span class="token function">SetDefaultTimestampIncrement</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置时间戳增加间隔</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span> yJRTPLIB<span class="token operator">::</span><span class="token function">SetRtpParm</span><span class="token punctuation">(</span>std<span class="token operator">::</span>string <span class="token operator">&amp;</span>d_ip<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token keyword">int</span> status<span class="token punctuation">;</span>
    std<span class="token operator">::</span>string ipstr <span class="token operator">=</span> d_ip<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> destip<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>destip <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ipstr<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> INADDR_NONE<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        std<span class="token operator">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad IP address specified"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    RTPUDPv4TransmissionParams transparams<span class="token punctuation">;</span>
    RTPSessionParams sessparams<span class="token punctuation">;</span>

    <span class="token comment">//sessparams.SetOwnTimestampUnit(1.0/9000.0); //时间戳单位</span>
    sessparams<span class="token punctuation">.</span><span class="token function">SetOwnTimestampUnit</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//时间戳单位</span>
    sessparams<span class="token punctuation">.</span><span class="token function">SetAcceptOwnPackets</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//接收自己发送的数据包</span>
    sessparams<span class="token punctuation">.</span><span class="token function">SetUsePredefinedSSRC</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//设置使用预先定义的SSRC</span>
    sessparams<span class="token punctuation">.</span><span class="token function">SetPredefinedSSRC</span><span class="token punctuation">(</span>SSRC<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//定义SSRC</span>

    transparams<span class="token punctuation">.</span><span class="token function">SetPortbase</span><span class="token punctuation">(</span>PORTBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    status <span class="token operator">=</span> sess<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>sessparams<span class="token punctuation">,</span><span class="token operator">&amp;</span>transparams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>

    destip <span class="token operator">=</span> <span class="token function">ntohl</span><span class="token punctuation">(</span>destip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    RTPIPv4Address <span class="token function">addr</span><span class="token punctuation">(</span>destip<span class="token punctuation">,</span>DESTPORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    status <span class="token operator">=</span> sess<span class="token punctuation">.</span><span class="token function">AddDestination</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CheckError</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>y_jrtp.h</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">Y_JRTP_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Y_JRTP_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;rtpsession.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;rtpudpv4transmitter.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;rtpipv4address.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;rtpsessionparams.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;rtperrors.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;rtplibraryversion.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token comment">//port必须是偶数</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PORTBASE</span> <span class="token expression"><span class="token number">6000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DESTPORT</span> <span class="token expression"><span class="token number">6002</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DESTIP</span> <span class="token string">"127.0.0.1"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">H264</span> <span class="token expression"><span class="token number">96</span></span></span>

<span class="token comment">/*
SSRC：同步源标识。
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SSRC</span> <span class="token expression"><span class="token number">1</span></span></span>

<span class="token comment">//Internet 对 pkg-len>1400丢包概率很大，RTP header 12bytes,RTP pkg-max-len &lt;= 1388</span>
<span class="token comment">//MTU 48~1500, UDP data max len = 1500 - 20(IP header) - 8(UDP header)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_RTP_PKT_LENGTH</span> <span class="token expression"><span class="token number">1300</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CLEAR_MEM</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">CLEAR_MEM</span><span class="token expression"><span class="token punctuation">(</span>mem<span class="token punctuation">)</span> <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

using namespace jrtplib<span class="token punctuation">;</span>



class yJRTPLIB<span class="token punctuation">&#123;</span>

    public<span class="token operator">:</span>
        <span class="token function">yJRTPLIB</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">~</span><span class="token function">yJRTPLIB</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">SendX264NalUnit</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token keyword">const</span> p_payload<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> i_payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">SetX264Parm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">SetRtpParm</span><span class="token punctuation">(</span>std<span class="token operator">::</span>string <span class="token operator">&amp;</span>d_ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    private<span class="token operator">:</span>
        RTPSession sess<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// Y_JRTP_H</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  首先，这里面的一些代码我直接使用的网上的某些教程，每一处用了一点，然后自己整理成这样的，这里再次说明，拆包部分的宏CODE_M是我的，另外一部分是网友的，不知道是谁，找不到最开始的出处。</p>
<p>  好了JrtpLib就这些东西了，没有啥新鲜的，对于我这种小白用户，我也只需要了解这么多，如果想要优化RTP传输或者其他的想法，你就得好好的去读读这些代码，并深入的了解RTP协议。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/08/07/blog_idx_036/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/08/07/blog_idx_036/" class="post-title-link" itemprop="url">Qt HTTP网络相关GET，POST（HTTP 模拟POST 表单(multipartform)最简单和正式的方法）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-08-07 17:32:52" itemprop="dateCreated datePublished" datetime="2017-08-07T17:32:52+08:00">2017-08-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GUI%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">GUI开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GUI%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GUI%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 15:15:59
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=036） 
&emsp;&emsp;本文发布于 2017-08-07 17:32:52，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=036） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  Ubuntu 16.04 LTS<br>
  抓包工具：wireshark</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Qt-HTTP">Qt HTTP</h3>
<hr>
<ol>
<li class="lvl-3">
<p>Qt网络相关的三个主要类QNetworkAccessManager,QNetworkRequest,QNetworkReply。一般的使用方法就是：QNetworkRequest添加头和地址等信息，QNetworkAccessManager发起请求，QNetworkReply对服务器回应的响应。</p>
</li>
<li class="lvl-3">
<p>关于Qt实现一般的POST和GET，其实我们去看帮助文档就可以了，如下图所示。</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_036/http.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  通过这里我们可以发现，get的话只需要把request信息填好，交给manager提交就好了。重点我们需要关注post的几个重载函数。本文只分析第二个和第三个，第一个没用过，不清楚。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">
QNetworkReply <span class="token operator">*</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">const</span> QNetworkRequest <span class="token operator">&amp;</span>request<span class="token punctuation">,</span> <span class="token keyword">const</span> QByteArray <span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token comment">//此函数，就是非常裸奔的模拟表单请求，虽然比较复杂，但是绝对直观有效。</span>

QNetworkReply <span class="token operator">*</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">const</span> QNetworkRequest <span class="token operator">&amp;</span>request<span class="token punctuation">,</span> QHttpMultiPart <span class="token operator">*</span>multiPart<span class="token punctuation">)</span><span class="token comment">//此函数就是Qt官方带的多表单的Post正式的方法</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li class="lvl-3">
<p>在具体分析之前，我不得不说一说HTTP协议的部分内容。（这里本人强烈建议，如果要分析各种网络协议，请使用wireshark，她会在网络五层结构中清晰的展现内容）</p>
</li>
</ol>
<p>    3.1 下面是一个普通http请求的抓包截图(打开csdn官网)</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_036/cap.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  图中是典型的HTTP GET请求的内容。我们要关注的就是User-Agent、Accept、Get这几个域就可以了</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_036/cap1.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  上图就是一个典型的POST 多表单请求抓包分析。我们只需要关注：Content-type这个最重要的域。后面MIME multipart部分就是上传的图片。这里最重要的是type中的boundary这是一个唯一的字符串，做标识使用，也做为表单的不同域的分隔符。</p>
<p>    3.2 对于详细的HTTP 协议的分析，请自行百度，这里就不做详细的分析。</p>
<ol start="4">
<li class="lvl-3">
<p>关于Qt 官方正式 multipartform 实例代码(其实这里就是：QHttpMultiPart、QHttpPart)(主体部分来至于Qt帮助文档，但是这个example有点毛病的)</p>
</li>
</ol>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">    proc_request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QNetworkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	proc_manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QNetworkAccessManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	      
	<span class="token function">connect</span><span class="token punctuation">(</span>proc_manager<span class="token punctuation">,</span><span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">finished</span><span class="token punctuation">(</span>QNetworkReply<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\
		<span class="token keyword">this</span><span class="token punctuation">,</span><span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">YOUR_SLOT_FUNCTION</span><span class="token punctuation">(</span>QNetworkReply<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//连接槽函数</span>

	  QHttpMultiPart <span class="token operator">*</span>multiPart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QHttpMultiPart</span><span class="token punctuation">(</span>QHttpMultiPart<span class="token double-colon punctuation">::</span>FormDataType<span class="token punctuation">)</span><span class="token punctuation">;</span>

  QHttpPart textPart<span class="token punctuation">;</span>
  textPart<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>QNetworkRequest<span class="token double-colon punctuation">::</span>ContentDispositionHeader<span class="token punctuation">,</span> <span class="token function">QVariant</span><span class="token punctuation">(</span><span class="token string">"form-data; name=\"text\""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  textPart<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token string">"my text"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  QHttpPart imagePart<span class="token punctuation">;</span>
  imagePart<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>QNetworkRequest<span class="token double-colon punctuation">::</span>ContentTypeHeader<span class="token punctuation">,</span> <span class="token function">QVariant</span><span class="token punctuation">(</span><span class="token string">"image/jpeg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  imagePart<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>QNetworkRequest<span class="token double-colon punctuation">::</span>ContentDispositionHeader<span class="token punctuation">,</span> <span class="token function">QVariant</span><span class="token punctuation">(</span><span class="token string">"form-data; name=\"image\""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  QFile <span class="token operator">*</span>file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QFile</span><span class="token punctuation">(</span><span class="token string">"image.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  file<span class="token operator">-></span><span class="token function">open</span><span class="token punctuation">(</span>QIODevice<span class="token double-colon punctuation">::</span>ReadOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
  imagePart<span class="token punctuation">.</span><span class="token function">setBodyDevice</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  file<span class="token operator">-></span><span class="token function">setParent</span><span class="token punctuation">(</span>multiPart<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// we cannot delete the file now, so delete it with the multiPart</span>

  multiPart<span class="token operator">-></span><span class="token function">append</span><span class="token punctuation">(</span>textPart<span class="token punctuation">)</span><span class="token punctuation">;</span>
  multiPart<span class="token operator">-></span><span class="token function">append</span><span class="token punctuation">(</span>imagePart<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  proc_request<span class="token operator">-></span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">"http://xxxxxxxxxxxxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//**************自我添加部分****************************</span>
QString bd <span class="token operator">=</span> <span class="token string">"fasdlkfjaslkdgj;lkadjglk;"</span><span class="token punctuation">;</span>
multipart<span class="token operator">-></span><span class="token function">setBoundary</span><span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">toLatin1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
proc_request<span class="token operator">-></span><span class="token function">setHeader</span><span class="token punctuation">(</span>QNetworkRequest<span class="token double-colon punctuation">::</span>ContentTypeHeader<span class="token punctuation">,</span>\
<span class="token string">"multipart/form-data;boundary="</span><span class="token operator">+</span>bd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//****************自我添加部分*************************</span>
proc_manager<span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token operator">*</span>proc_request<span class="token punctuation">,</span>multiPart<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  对于上面代码的分析：我不知道为何，只有我显示指定Boundary之后，才能够正确提交post，所以自我添加部分是非常重要的，不加就是不行，这是在实际分析出的。（官方关于这个问题的说明：Usually, you do not need to generate a boundary yourself; upon construction the boundary is initiated with the string “boundary_.oOo._” followed by random characters, and provides enough uniqueness to make sure it does not occur inside the parts itself.）（上面说其实我们不显示指定，它也是会自动给你添加boundary的，但是我的项目中就不行，估计是我项目中哪里没弄对吧，不去折腾了，我就显示指定了，如果有那个童鞋去实验一波，不用指定也可以成功post，请来告诉我一声，哎，真特么蛋疼，下班了~~~~~~~~~）</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/08/07/blog_idx_035/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/08/07/blog_idx_035/" class="post-title-link" itemprop="url">毕设系列之Libx264实时视频流（YUV 420P转H264视频编码篇）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-08-07 16:30:54" itemprop="dateCreated datePublished" datetime="2017-08-07T16:30:54+08:00">2017-08-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux%E5%BC%80%E5%8F%91/%E6%B5%81%E5%AA%92%E4%BD%93%E5%A4%84%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">流媒体处理</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 15:02:38
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=035） 
&emsp;&emsp;本文发布于 2017-08-07 16:30:54，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=035） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  Ubuntu 16.04 LTS</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Libx264实时视频流">Libx264实时视频流</h3>
<hr>
<p>  本文的技术实现部分参考雷博士的这篇文章。<a target="_blank" rel="noopener" href="http://blog.csdn.net/leixiaohua1020/article/details/42078645">http://blog.csdn.net/leixiaohua1020/article/details/42078645</a></p>
<ol>
<li class="lvl-3">
<p>现在网上关于H264的文章有很多，但是我个人认为最好的就是雷霄骅博士的x264部分的文章最详细。所以许多的细节部分，我推荐大家去雷博士的blog去看。本文只提及我们使用Libx264时候，我们要注意的问题。</p>
</li>
<li class="lvl-3">
<p>使用Libx264时候，我们需要关注的东西（下面用我的代码来说明假如我们要使用Libx264,那么我们需要注意的几个事情）。</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//encoder</span>
	<span class="token class-name">x264_t</span> <span class="token operator">*</span> pX264Handle<span class="token punctuation">;</span><span class="token comment">//结构体是一个编码器实例句柄,要使用这个编码库，我们必须有一个这种变量，没有为啥。</span>
<span class="token comment">//param</span>
	<span class="token class-name">x264_param_t</span> <span class="token operator">*</span> pX264Param<span class="token punctuation">;</span><span class="token comment">//这个结构体就比较重要了，他是我们设置编码器参数的载体，我们必须具体的了解各种参数的意义。具体参数在下一节进行分析。</span>
<span class="token comment">//input,output pic</span>
	<span class="token class-name">x264_picture_t</span> <span class="token operator">*</span>pPic_In<span class="token punctuation">;</span><span class="token comment">//这就是YUV输入图像和输出图像的载体，这里面有一个pts参数需要注意，下面小节进行说明。</span>
	<span class="token class-name">x264_picture_t</span> <span class="token operator">*</span>pPic_Out<span class="token punctuation">;</span>
<span class="token comment">//output h264 stream</span>
	<span class="token class-name">x264_nal_t</span> <span class="token operator">*</span> pNals<span class="token punctuation">;</span><span class="token comment">//这个也是比较重要的一个东西，他的作用是用来保存编码后，网络抽象层所保存的数据(NAL HEADER,NAL BODY),想具体了解，可以去看H264编码原理。</span>
<span class="token comment">//user config callback</span>
	<span class="token comment">//UESER_CONF_CALLBACK yX264_UserConfig;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>yX264_UserConfig<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ymx264</span> <span class="token operator">*</span> mvl<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//私有，忽略</span>
<span class="token comment">//pi_nal is the number of NAL units </span>
	<span class="token keyword">int</span> pi_nal<span class="token punctuation">;</span><span class="token comment">//网络抽象单元个数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li class="lvl-3">
<p>编码器参数分析</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//* cpuFlags  </span>
   mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_threads  <span class="token operator">=</span> X264_SYNC_LOOKAHEAD_AUTO<span class="token punctuation">;</span><span class="token comment">//* 取空缓冲区继续使用不死锁的保证. </span>
<span class="token comment">//* 视频选项  </span>
   mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_width   <span class="token operator">=</span> FRAME_WIDTH<span class="token punctuation">;</span> <span class="token comment">//* 要编码的图像宽度.  </span>
   mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_height  <span class="token operator">=</span> FRAME_HEIGHT<span class="token punctuation">;</span> <span class="token comment">//* 要编码的图像高度  </span>
mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_frame_total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//* 编码总帧数.不知道用0.  </span>
<span class="token comment">/* Force an IDR keyframe at this interval */</span>
   mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_keyint_max <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">//这个参数很重要,控制i帧的频率</span>
 
mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>b_repeat_headers <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 重复SPS/PPS 放到关键帧前面//做实时流播放，此参数必须ENABLE</span>
<span class="token comment">//* 流参数  </span>
<span class="token comment">//* how many b-frame between 2 references pictures */</span>
   mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_bframe  <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>  
<span class="token comment">//</span>
   mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>b_open_gop  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token comment">//* Keep some B-frames as references: 0=off, 1=strict hierarchical, 2=normal */</span>
   mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_bframe_pyramid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token comment">//</span>
   mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_bframe_adaptive <span class="token operator">=</span> X264_B_ADAPT_TRELLIS<span class="token punctuation">;</span>  
 
 
<span class="token comment">//* Log参数，不需要打印编码信息时直接注释掉就行  </span>
   <span class="token comment">//mvl->pX264Param->i_log_level  = X264_LOG_DEBUG; </span>

<span class="token comment">//* 速率控制参数  </span>
   <span class="token comment">//pX264Param->rc.i_bitrate = 1024 * 10;//* 码率(比特率,单位Kbps) ，重要</span>

<span class="token comment">//* muxing parameters  帧率控制，重要。</span>
   mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_fps_den  <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//* 帧率分母</span>
   mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_fps_num  <span class="token operator">=</span> Y_STREAM_FPS<span class="token punctuation">;</span><span class="token comment">//* 帧率分子  </span>

   mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_timebase_den <span class="token operator">=</span> mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_fps_num<span class="token punctuation">;</span>  
   mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_timebase_num <span class="token operator">=</span> mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_fps_den<span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  最后，我们需要注意一点：关于我们设置的帧率的问题，不一定是设置多少，播放的时候就是多少，只是一个参考值，编码器会尽量的把视频编码为这个帧率。</p>
<ol start="4">
<li class="lvl-3">
<p>x264_picture_t * pPic_In-&gt;i_pts += 1; 此参数非常重要。如果不进行设置，视频流将不会正常播放。</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/*
PTS：Presentation Time Stamp。PTS主要用于度量解码后的视频帧什么时候被显示出来
DTS：Decode Time Stamp。DTS主要是标识读入内存中的ｂｉｔ流在什么时候开始送入解码器中进行解码。
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="5">
<li class="lvl-3">
<p>关于颜色空间的问题，大家可以去百度YUV 420 ,YUV 422，YUV 444等这些原始图像的存储问题。具体来说，他们分为两类，一种是分组存储（例如：YYY<em>UUU</em>VVV*），一种是交叉存储(例如：YUYV)</p>
</li>
<li class="lvl-3">
<p>此模块我的源代码<br>
ym_x264.h</p>
</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
	FileName:ym_x264.h
	Version:1.0
	Description:
	Created On: 2017-3-19
	Modified date:
	Author:Sky
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_YM_X264_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_YM_X264_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">__cplusplus</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span><span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __cplusplus */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ym_x264_config.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;x264.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>




<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">CLEAR_MEM</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">enum</span> <span class="token class-name">yX264Cmd</span><span class="token punctuation">&#123;</span>

	DO_DEFAULT_PRESET <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
	DO_DEFAULT_USERCONF <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
	DO_PARAM_APPLY_PROFILE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
	OPEN_ENCODER <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
	ENCODER_ENCODE <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
	
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">enum</span> <span class="token class-name">yX264ColorSpace</span><span class="token punctuation">&#123;</span>
	
	Y_CSP_I444 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
	Y_CSP_I422 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
	Y_CSP_I420 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
	Y_CSP_YUYV <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">//typedef struct ymx264 yMX264;</span>



<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">ymx264</span><span class="token punctuation">&#123;</span>
		
<span class="token comment">//encoder</span>
	<span class="token class-name">x264_t</span> <span class="token operator">*</span> pX264Handle<span class="token punctuation">;</span>
<span class="token comment">//param</span>
	<span class="token class-name">x264_param_t</span> <span class="token operator">*</span> pX264Param<span class="token punctuation">;</span>
<span class="token comment">//input,output pic</span>
	<span class="token class-name">x264_picture_t</span> <span class="token operator">*</span>pPic_In<span class="token punctuation">;</span>
	<span class="token class-name">x264_picture_t</span> <span class="token operator">*</span>pPic_Out<span class="token punctuation">;</span>
<span class="token comment">//output h264 stream</span>
	<span class="token class-name">x264_nal_t</span> <span class="token operator">*</span> pNals<span class="token punctuation">;</span>
<span class="token comment">//user config callback</span>
	<span class="token comment">//UESER_CONF_CALLBACK yX264_UserConfig;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>yX264_UserConfig<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ymx264</span> <span class="token operator">*</span> mvl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//pi_nal is the number of NAL units </span>
	<span class="token keyword">int</span> pi_nal<span class="token punctuation">;</span>
	
	<span class="token keyword">long</span> cur_pts<span class="token punctuation">;</span>
	
<span class="token punctuation">&#125;</span>yMX264<span class="token punctuation">;</span> 

<span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>UESER_CONF_CALLBACK<span class="token punctuation">)</span><span class="token punctuation">(</span>yMX264 <span class="token operator">*</span> mvl<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">yInitMX264</span><span class="token punctuation">(</span>yMX264 <span class="token operator">*</span> mvl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">yDestroyMX264</span><span class="token punctuation">(</span>yMX264 <span class="token operator">*</span> mvl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">yIoctlX264</span><span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">yX264Cmd</span> cmd<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//CSC = ColorSpaceCovert,FIP = Fill In_Pic</span>
<span class="token keyword">int</span> <span class="token function">yDoCSC_And_FIP</span><span class="token punctuation">(</span>yMX264 <span class="token operator">*</span> mvl<span class="token punctuation">,</span><span class="token keyword">enum</span> <span class="token class-name">yX264ColorSpace</span> t_csp<span class="token punctuation">,</span> <span class="token keyword">int</span> cache_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">yDo_Default_UserConf</span><span class="token punctuation">(</span>yMX264 <span class="token operator">*</span> mvl<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">__cplusplus</span></span>
<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __cplusplus */</span> </span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ym_x264.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
	FileName:ym_x264.c
	Version:1.0
	Description:
	Created On: 2017-3-19
	Modified date:
	Author:Sky
*/</span>

<span class="token comment">/*
x264_param_default()：设置参数集结构体x264_param_t的缺省值。
x264_picture_alloc()：为图像结构体x264_picture_t分配内存。
x264_encoder_open()：打开编码器。
x264_encoder_encode()：编码一帧图像。
x264_encoder_close()：关闭编码器。
x264_picture_clean()：释放x264_picture_alloc()申请的资源。
 
存储数据的结构体如下所示。
x264_picture_t：存储压缩编码前的像素数据。
x264_nal_t：存储压缩编码后的码流数据。
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ym_x264.h></span></span>

<span class="token class-name">uint8_t</span> ImgCache<span class="token punctuation">[</span>ImageCacheNum<span class="token punctuation">]</span><span class="token punctuation">[</span>FRAME_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">yInitMX264</span><span class="token punctuation">(</span>yMX264 <span class="token operator">*</span> mvl<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>


	mvl<span class="token operator">-></span>pX264Param <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">x264_param_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">x264_param_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token comment">//	for (int i = 0; i &lt; ImageCacheNum; i++)&#123;</span>

		mvl<span class="token operator">-></span>pPic_In <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">x264_picture_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">x264_picture_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		mvl<span class="token operator">-></span>pPic_Out <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">x264_picture_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">x264_picture_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		mvl<span class="token operator">-></span>pNals <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

		mvl<span class="token operator">-></span>pi_nal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		<span class="token function">x264_picture_init</span><span class="token punctuation">(</span>mvl<span class="token operator">-></span>pPic_Out<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    	<span class="token function">x264_picture_alloc</span><span class="token punctuation">(</span>mvl<span class="token operator">-></span>pPic_In<span class="token punctuation">,</span> FRAME_COLORSPACE<span class="token punctuation">,</span> FRAME_WIDTH<span class="token punctuation">,</span> FRAME_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// PTS FROM 0,AND AUTO INCRESE 1</span>
		mvl<span class="token operator">-></span>pPic_In<span class="token operator">-></span>i_pts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//	&#125;</span>

	mvl<span class="token operator">-></span>cur_pts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>




	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span> <span class="token function">yDestroyMX264</span><span class="token punctuation">(</span>yMX264 <span class="token operator">*</span> mvl<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	<span class="token comment">// 清除图像区域  </span>
	<span class="token comment">//for (int i = 0; i &lt; ImageCacheNum; i++)</span>
	<span class="token function">x264_picture_clean</span><span class="token punctuation">(</span>mvl<span class="token operator">-></span>pPic_In<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">x264_encoder_close</span><span class="token punctuation">(</span>mvl<span class="token operator">-></span>pX264Handle<span class="token punctuation">)</span><span class="token punctuation">;</span>  


	<span class="token function">free</span><span class="token punctuation">(</span>mvl<span class="token operator">-></span>pX264Param<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//for (int i = 0; i &lt; ImageCacheNum; i++)&#123;</span>
	
		<span class="token function">free</span><span class="token punctuation">(</span>mvl<span class="token operator">-></span>pPic_In<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">free</span><span class="token punctuation">(</span>mvl<span class="token operator">-></span>pPic_Out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//&#125;</span>


	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">yIoctlX264</span><span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">yX264Cmd</span> cmd<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	va_list arg<span class="token punctuation">;</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    yMX264 <span class="token operator">*</span>mx264<span class="token punctuation">;</span>
    mx264 <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span>yMX264 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

		<span class="token keyword">case</span> DO_DEFAULT_PRESET<span class="token operator">:</span>
		<span class="token punctuation">&#123;</span>
			<span class="token comment">/* Get default params for preset/tuning */</span>
			<span class="token comment">//x264_param_default(pParam);  //this do default set for x264,but can not config some info</span>
    		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">x264_param_default_preset</span><span class="token punctuation">(</span> mx264<span class="token operator">-></span>pX264Param<span class="token punctuation">,</span> <span class="token string">"veryfast"</span><span class="token punctuation">,</span> <span class="token string">"zerolatency"</span> <span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"x264_param_default_preset failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> DO_DEFAULT_USERCONF<span class="token operator">:</span>
		<span class="token punctuation">&#123;</span>
			<span class="token comment">//va_list arg;</span>
    		<span class="token comment">//va_start(arg,cmd);</span>
    		<span class="token comment">//mx264->yX264_UserConfig = va_arg(arg,UESER_CONF_CALLBACK);</span>
			<span class="token comment">//mx264->yX264_UserConfig = NULL;</span>
			
    		<span class="token comment">//va_end(arg);</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token operator">*</span>mx264<span class="token operator">-></span>yX264_UserConfig<span class="token punctuation">)</span><span class="token punctuation">(</span>mx264<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
				
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Do user conf callback failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> DO_PARAM_APPLY_PROFILE<span class="token operator">:</span>
		<span class="token punctuation">&#123;</span>
			<span class="token comment">//x264_profile_names[0] = baseline , to set stream-quality</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">x264_param_apply_profile</span><span class="token punctuation">(</span>mx264<span class="token operator">-></span>pX264Param<span class="token punctuation">,</span> x264_profile_names<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"x264_param_apply_profile failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span> 
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> OPEN_ENCODER<span class="token operator">:</span>
		<span class="token punctuation">&#123;</span>
			<span class="token comment">//open encoder</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>mx264<span class="token operator">-></span>pX264Handle <span class="token operator">=</span> <span class="token function">x264_encoder_open</span><span class="token punctuation">(</span>mx264<span class="token operator">-></span>pX264Param<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
				
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"x264_encoder_open failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>				
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> ENCODER_ENCODE<span class="token operator">:</span>
		<span class="token punctuation">&#123;</span>
<span class="token comment">/*
	x264_encoder_encode:
 *      encode one picture.
 *      *pi_nal is the number of NAL units outputted in pp_nal.
 *      returns the number of bytes in the returned NALs.
 *      returns negative on error and zero if no NAL units returned.
 *      the payloads of all output NALs are guaranteed to be sequential in memory. 
	int     x264_encoder_encode( x264_t *, x264_nal_t **pp_nal, int *pi_nal, x264_picture_t *pic_in, x264_picture_t *pic_out );
*/</span>



			<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">x264_encoder_encode</span><span class="token punctuation">(</span>mx264<span class="token operator">-></span>pX264Handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mx264<span class="token operator">-></span>pNals<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mx264<span class="token operator">-></span>pi_nal<span class="token punctuation">,</span> mx264<span class="token operator">-></span>pPic_In<span class="token punctuation">,</span> mx264<span class="token operator">-></span>pPic_Out<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
				
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"x264_encoder_encode failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>					
				
			<span class="token punctuation">&#125;</span>
<span class="token comment">/*
PTS：Presentation Time Stamp。PTS主要用于度量解码后的视频帧什么时候被显示出来
DTS：Decode Time Stamp。DTS主要是标识读入内存中的ｂｉｔ流在什么时候开始送入解码器中进行解码。
*/</span>
			<span class="token comment">//Presentation Time Stamp。PTS主要用于度量解码后的视频帧什么时候被显示出来</span>
			<span class="token comment">//MUST DO THIS ,IT DECIDE ,主要用于度量解码后的视频帧什么时候被显示出来</span>
			<span class="token comment">//mx264->pPic_In->i_pts += 1;</span>
			mx264<span class="token operator">-></span>pPic_In<span class="token operator">-></span>i_pts <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pts = %d\n"</span><span class="token punctuation">,</span>mx264<span class="token operator">-></span>pPic_In<span class="token operator">-></span>i_pts<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> 
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">default</span> <span class="token operator">:</span>
		<span class="token punctuation">&#123;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No this cmd to analyse\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">yDoCSC_And_FIP</span><span class="token punctuation">(</span>yMX264 <span class="token operator">*</span> mvl<span class="token punctuation">,</span><span class="token keyword">enum</span> <span class="token class-name">yX264ColorSpace</span> t_csp<span class="token punctuation">,</span> <span class="token keyword">int</span> cache_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	<span class="token keyword">switch</span><span class="token punctuation">(</span>t_csp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
        <span class="token keyword">case</span> Y_CSP_I444<span class="token operator">:</span>
		<span class="token punctuation">&#123;</span>  
<span class="token comment">/*
            read(fd_in,pPic_In->img.plane[0],FRAME_SIZE);         //Y  
            read(fd_in,pPic_In->img.plane[1],FRAME_SIZE);         //U  
            read(fd_in,pPic_In->img.plane[2],FRAME_SIZE);         //V  
*/</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>  
        <span class="token keyword">case</span> Y_CSP_I420<span class="token operator">:</span>
		<span class="token punctuation">&#123;</span>  
<span class="token comment">/*
			#ifndef ENABLE_YUYVTOI420 
            read(fd_in,pPic_In->img.plane[0],FRAME_SIZE);         //Y  
            read(fd_in,pPic_In->img.plane[1],FRAME_SIZE/4);     //U  
            read(fd_in,pPic_In->img.plane[2],FRAME_SIZE/4);     //V  
			#else
			//YUYV to I420
			read(fd_in,Cache,FRAME_SIZE*2);         //read one frame to cache 
			//must set to 0
			int id_u = 0,  id_v = 0 , id_y = 0;
			for (int i = 0; i &lt; FRAME_SIZE*2 ;i+=4)&#123; 
				
				pPic_In->img.plane[0][id_y] = Cache[i];//get Y
				id_y++;
				pPic_In->img.plane[0][id_y] = Cache[i+2];//get Y
				id_y++;
				if ( ((int)((i)/1280)%2) == 0 )&#123;
					pPic_In->img.plane[1][id_u] = Cache[i+1];//get U
					pPic_In->img.plane[2][id_v] = Cache[i+3];//get V
					id_u++;
					id_v++;
				&#125;
			&#125;
	
			#endif
*/</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> 
		<span class="token keyword">case</span> Y_CSP_YUYV<span class="token operator">:</span><span class="token punctuation">&#123;</span>
			<span class="token comment">// firstly,Do YUYV to I420 ,then, Fill in_pic</span>
			<span class="token keyword">int</span> id_u <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>  id_v <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">,</span> id_y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> FRAME_SIZE <span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> 
				
				mvl<span class="token operator">-></span>pPic_In<span class="token operator">-></span>img<span class="token punctuation">.</span>plane<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id_y<span class="token punctuation">]</span> <span class="token operator">=</span> ImgCache<span class="token punctuation">[</span>cache_id<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//get Y</span>
				id_y<span class="token operator">++</span><span class="token punctuation">;</span>
				mvl<span class="token operator">-></span>pPic_In<span class="token operator">-></span>img<span class="token punctuation">.</span>plane<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id_y<span class="token punctuation">]</span> <span class="token operator">=</span> ImgCache<span class="token punctuation">[</span>cache_id<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//get Y</span>
				id_y<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1280</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

					mvl<span class="token operator">-></span>pPic_In<span class="token operator">-></span>img<span class="token punctuation">.</span>plane<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id_u<span class="token punctuation">]</span> <span class="token operator">=</span> ImgCache<span class="token punctuation">[</span>cache_id<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//get U</span>
					mvl<span class="token operator">-></span>pPic_In<span class="token operator">-></span>img<span class="token punctuation">.</span>plane<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id_v<span class="token punctuation">]</span> <span class="token operator">=</span> ImgCache<span class="token punctuation">[</span>cache_id<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//get V</span>
					id_u<span class="token operator">++</span><span class="token punctuation">;</span>
					id_v<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> Y_CSP_I422<span class="token operator">:</span>
		<span class="token punctuation">&#123;</span>  
<span class="token comment">/*
			
            read(fd_in,pPic_In->img.plane[0],FRAME_SIZE);         //Y  
            read(fd_in,pPic_In->img.plane[1],FRAME_SIZE/2);     //U  
            read(fd_in,pPic_In->img.plane[2],FRAME_SIZE/2);     //V 
*/</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> 

        <span class="token keyword">default</span><span class="token operator">:</span>
		<span class="token punctuation">&#123;</span>  
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Colorspace Not Support.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>  
	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">yDo_Default_UserConf</span><span class="token punctuation">(</span>yMX264 <span class="token operator">*</span> mvl<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>


	<span class="token comment">//* cpuFlags  </span>
    mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_threads  <span class="token operator">=</span> X264_SYNC_LOOKAHEAD_AUTO<span class="token punctuation">;</span><span class="token comment">//* 取空缓冲区继续使用不死锁的保证. </span>
	<span class="token comment">//* 视频选项  </span>
    mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_width   <span class="token operator">=</span> FRAME_WIDTH<span class="token punctuation">;</span> <span class="token comment">//* 要编码的图像宽度.  </span>
    mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_height  <span class="token operator">=</span> FRAME_HEIGHT<span class="token punctuation">;</span> <span class="token comment">//* 要编码的图像高度  </span>
	mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_frame_total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//* 编码总帧数.不知道用0.  </span>
	<span class="token comment">/* Force an IDR keyframe at this interval */</span>
    mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_keyint_max <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> 
  
	mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>b_repeat_headers <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 重复SPS/PPS 放到关键帧前面</span>
	<span class="token comment">//* 流参数  </span>
	<span class="token comment">//* how many b-frame between 2 references pictures */</span>
    mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_bframe  <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>  
	<span class="token comment">//</span>
    mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>b_open_gop  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
	<span class="token comment">//* Keep some B-frames as references: 0=off, 1=strict hierarchical, 2=normal */</span>
    mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_bframe_pyramid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
	<span class="token comment">//</span>
    mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_bframe_adaptive <span class="token operator">=</span> X264_B_ADAPT_TRELLIS<span class="token punctuation">;</span>  
	 
	 
	<span class="token comment">//* Log参数，不需要打印编码信息时直接注释掉就行  </span>
    <span class="token comment">//mvl->pX264Param->i_log_level  = X264_LOG_DEBUG; </span>
 
	<span class="token comment">//* 速率控制参数  </span>
    <span class="token comment">//pX264Param->rc.i_bitrate = 1024 * 10;//* 码率(比特率,单位Kbps) </span>

	<span class="token comment">//* muxing parameters  </span>
    mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_fps_den  <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//* 帧率分母</span>
    mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_fps_num  <span class="token operator">=</span> Y_STREAM_FPS<span class="token punctuation">;</span><span class="token comment">//* 帧率分子  </span>

    mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_timebase_den <span class="token operator">=</span> mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_fps_num<span class="token punctuation">;</span>  
    mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_timebase_num <span class="token operator">=</span> mvl<span class="token operator">-></span>pX264Param<span class="token operator">-></span>i_fps_den<span class="token punctuation">;</span>  

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/leixiaohua1020/article/details/42078645">http://blog.csdn.net/leixiaohua1020/article/details/42078645</a></p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/07/02/blog_idx_034/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/07/02/blog_idx_034/" class="post-title-link" itemprop="url">毕设系列之Linux V4L2（图形图像采集篇）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-07-02 14:12:38" itemprop="dateCreated datePublished" datetime="2017-07-02T14:12:38+08:00">2017-07-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 14:52:33
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=034） 
&emsp;&emsp;本文发布于 2017-07-02 14:12:38，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=034） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  Ubuntu 16.04 LTS</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="V4L2">V4L2</h3>
<hr>
<br/>
<br/>
<h5 id="V4L2-介绍">V4L2 介绍</h5>
<p>  虽然介绍Linux V4L2的文章已经满大街了，但是这里我也还要讲一些基本的东西。</p>
<ol>
<li class="lvl-3">
<p>v4l2 是Video for Linux 2的简称。</p>
</li>
<li class="lvl-3">
<p>v4l2 不仅仅支持图像类设备，还支持音频等设备类型。</p>
</li>
<li class="lvl-3">
<p>能够使用v4l2的前提是Linux内核已经识别并注册了了相关的设备，常见的就是/dev/videox类似的设备文件存在。（如果是做图像类的采集，说白了你得有个摄像头，这个摄像头还得被Linux 内核识别）</p>
</li>
<li class="lvl-3">
<p>从上文可知，一个设备要被内核识别必须要由驱动才行，而对于我们常用的图像采集来说，就是要有一个摄像头驱动才行。对于这个问题，linux内核工作者根据UVC这个标准开发了一个通用的驱动程序，并且整合到linux内核中。只要是支持UVC这个通用标准的摄像头芯片，就能够使用这个驱动。（非图像类也有类似的存在，具体这里不做多余阐述）</p>
</li>
<li class="lvl-3">
<p>一般来说，常用的Linux平台是的内核是已经编译进去了UVC驱动的。如果是自己移植的嵌入式Linux 内核，请在配置内核选项时候打开UVC驱动的选项。如下图：</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_034/uvc.png" alt="rep_img"/></center>
    </div>
</div>  
<br/>
<br/>
<h5 id="V4L2框架简介">V4L2框架简介</h5>
<p>  V4L2这个框架的原理简述（这里我们只需要关注几个结构体就可以,要深入，去看内核源代码）</p>
<ol>
<li class="lvl-3">
<p>struct v4l2_device v4l2框架中的根节点，主要是用来管理和遍历其它子节点。</p>
</li>
<li class="lvl-3">
<p>struct v4l2_subdev v4l2框架中的子节点，在v4l2_device下可以有多个v4l2_subdev存在，这里主要是区分设备类型，如图像或者音频等等。</p>
</li>
<li class="lvl-3">
<p>struct video_device 具体设备的结构体，并在/dev/下创建相关的设备文件。</p>
</li>
<li class="lvl-3">
<p>struct v4l2_buffer 为设备数据交换提供空间。</p>
</li>
</ol>
<p>  原理（这里以USB摄像头为例）：当一个设备接入内核，首先根据USB标准协议对USB进行初始化，最终完成USB设备信息探测。根据USB设备信息，内核给其分配相应的驱动。这里内核知道我们的USB设备是一个图像设备，这时内核开始初始化v4l2_subdev结构体，并且类型设置为图形图像设备。当初始化好后，内核继续初始化一个video_device结构体，并插入到v4l2_subdev的管理链表中。这里的初始化过程中，就要涉及摄像头驱动的加载，设备文件的创建等等。到这里，整个注册环节就结束了，意味着我们可以使用v4l2框架来操作我们的设备。操作的话，就是各种ops的调用就ok了。（这里涉及到usb设备驱动的初始化和字符型设备驱动等等相关知识，需要更多，自行查阅资料）</p>
<br/>
<br/>
<h5 id="V4L2的使用">V4L2的使用</h5>
<p>  V4L2的使用（没啥可讲的，各种资料烂大街了，我直接贴源代码）<br>
ym_v4l2.c文件</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
	FileName:m_v4l2.c
	Version:1.5
	Description:
	Created On: 2017-2-21
	Modified date:2017-3-14
	Author:Sky
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ym_v4l2.h></span></span>
<span class="token keyword">int</span> <span class="token function">yInitMV4l2</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> pathname<span class="token punctuation">,</span> yMV4L2 <span class="token operator">*</span> mv4l2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	
	<span class="token comment">//mv4l2 = mvl;</span>
	<span class="token comment">//request alloc IMG_BUFF_NUM DATA_BUF size mem</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>img_buf <span class="token operator">=</span> <span class="token punctuation">(</span>IMG_BUF <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span>IMG_BUFF_NUM<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>IMG_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"calloc  failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//open video device</span>
    
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Open video device faild"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
	
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span> <span class="token function">yIoctlV4l2</span><span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">yV4l2Cmd</span> cmd<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    va_list arg<span class="token punctuation">;</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    yMV4L2 <span class="token operator">*</span>mv4l2<span class="token punctuation">;</span>
    mv4l2 <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span>yMV4L2 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
        <span class="token keyword">case</span> yVIDIOC_QUERYCAP<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
    	    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span> VIDIOC_QUERYCAP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mv4l2<span class="token operator">-></span>cap<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        
                 <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"QUERY VIDEO CAP FAILED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"DriverName:%s/nCard Name:%s/nBusinfo:%s/nDriverVersion:%u.%u.%u\n"</span><span class="token punctuation">,</span>mv4l2<span class="token operator">-></span>cap<span class="token punctuation">.</span>driver<span class="token punctuation">,</span>mv4l2<span class="token operator">-></span>cap<span class="token punctuation">.</span>card<span class="token punctuation">,</span>mv4l2<span class="token operator">-></span>cap<span class="token punctuation">.</span>bus_info<span class="token punctuation">,</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>cap<span class="token punctuation">.</span>version<span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0XFF</span><span class="token punctuation">,</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>cap<span class="token punctuation">.</span>version<span class="token operator">>></span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">,</span>mv4l2<span class="token operator">-></span>cap<span class="token punctuation">.</span>version<span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>cap<span class="token punctuation">.</span>capabilities <span class="token operator">&amp;</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The device is not a video capture\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>cap<span class="token punctuation">.</span>capabilities <span class="token operator">&amp;</span> V4L2_CAP_STREAMING<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        
                 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The device can not support streaming i/o\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> 
        <span class="token keyword">case</span> yVIDIOC_ENUM_FMT<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
        	<span class="token function">CLEAR_MEM</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>desc_fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mv4l2<span class="token operator">-></span>desc_fmt<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            mv4l2<span class="token operator">-></span>desc_fmt<span class="token punctuation">.</span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span> VIDIOC_ENUM_FMT<span class="token punctuation">,</span><span class="token operator">&amp;</span>mv4l2<span class="token operator">-></span>desc_fmt<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index : %d, format:%s \n"</span><span class="token punctuation">,</span> mv4l2<span class="token operator">-></span>desc_fmt<span class="token punctuation">.</span>index<span class="token punctuation">,</span>mv4l2<span class="token operator">-></span>desc_fmt<span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>
		        mv4l2<span class="token operator">-></span>desc_fmt<span class="token punctuation">.</span>index<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> 
        <span class="token keyword">case</span> yVIDIOC_S_FMT<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
			<span class="token comment">// set data format for dev</span>
    		mv4l2<span class="token operator">-></span>stream_fmt<span class="token punctuation">.</span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>
    		mv4l2<span class="token operator">-></span>stream_fmt<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span>pix<span class="token punctuation">.</span>width <span class="token operator">=</span> IMAGE_WIDTH<span class="token punctuation">;</span>
    		mv4l2<span class="token operator">-></span>stream_fmt<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span>pix<span class="token punctuation">.</span>height <span class="token operator">=</span> IMAGE_HEIGHT<span class="token punctuation">;</span>
    		mv4l2<span class="token operator">-></span>stream_fmt<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span>pix<span class="token punctuation">.</span>pixelformat <span class="token operator">=</span> V4L2_PIX_FMT_YUYV<span class="token punctuation">;</span>
    		<span class="token comment">//mv4l2->stream_fmt.fmt.pix.field = V4L2_FIELD_INTERLACED;</span>
			mv4l2<span class="token operator">-></span>stream_fmt<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span>pix<span class="token punctuation">.</span>field <span class="token operator">=</span> V4L2_FIELD_ANY<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span> VIDIOC_S_FMT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mv4l2<span class="token operator">-></span>stream_fmt<span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
       			<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Set data format failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    		<span class="token punctuation">&#125;</span>
           	<span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> 
        <span class="token keyword">case</span> yVIDIOC_G_FMT<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
			<span class="token function">CLEAR_MEM</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>stream_fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
			mv4l2<span class="token operator">-></span>stream_fmt<span class="token punctuation">.</span>type<span class="token operator">=</span>V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>  
			<span class="token function">ioctl</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span>VIDIOC_G_FMT<span class="token punctuation">,</span><span class="token operator">&amp;</span>mv4l2<span class="token operator">-></span>stream_fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Currentdata format information: width:%d   height:%d\n"</span><span class="token punctuation">,</span>mv4l2<span class="token operator">-></span>stream_fmt<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span>pix<span class="token punctuation">.</span>width<span class="token punctuation">,</span>mv4l2<span class="token operator">-></span>stream_fmt<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span>pix<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span> 
           	<span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> 
        <span class="token keyword">case</span> yVIDIOC_REQBUFS<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
	    <span class="token comment">//bzero(&amp;reqbuf, sizeof(reqbuf));</span>
			<span class="token function">CLEAR_MEM</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>reqbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			mv4l2<span class="token operator">-></span>reqbuf<span class="token punctuation">.</span>count <span class="token operator">=</span> IMG_BUFF_NUM<span class="token punctuation">;</span>
    		mv4l2<span class="token operator">-></span>reqbuf<span class="token punctuation">.</span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>
    		mv4l2<span class="token operator">-></span>reqbuf<span class="token punctuation">.</span>memory <span class="token operator">=</span> V4L2_MEMORY_MMAP<span class="token punctuation">;</span>
    
    		<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span> VIDIOC_REQBUFS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mv4l2<span class="token operator">-></span>reqbuf<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
        		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ioctl REQBUFS failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    		<span class="token punctuation">&#125;</span>
           	<span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>    
        <span class="token keyword">case</span> yVIDIOC_STREAMON<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
			mv4l2<span class="token operator">-></span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>
    		<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span> VIDIOC_STREAMON<span class="token punctuation">,</span><span class="token operator">&amp;</span>mv4l2<span class="token operator">-></span>type<span class="token punctuation">)</span><span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            
            	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to ioctl:VIDIOC_STREAMON"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    		<span class="token punctuation">&#125;</span>
           	<span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">case</span> yVIDIOC_STREAMOFF<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
    		mv4l2<span class="token operator">-></span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>
    		<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span> VIDIOC_STREAMOFF<span class="token punctuation">,</span><span class="token operator">&amp;</span>mv4l2<span class="token operator">-></span>type<span class="token punctuation">)</span><span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            
            	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to ioctl:VIDIOC_STREAMOFF"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    		<span class="token punctuation">&#125;</span>
           	<span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> 
        <span class="token keyword">case</span> yVIDIOC_S_PARM<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
			<span class="token function">CLEAR_MEM</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>stream_parm<span class="token punctuation">)</span><span class="token punctuation">;</span>
			mv4l2<span class="token operator">-></span>stream_parm<span class="token punctuation">.</span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span> 
	
			mv4l2<span class="token operator">-></span>stream_parm<span class="token punctuation">.</span>parm<span class="token punctuation">.</span>capture<span class="token punctuation">.</span>timeperframe<span class="token punctuation">.</span>numerator <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			mv4l2<span class="token operator">-></span>stream_parm<span class="token punctuation">.</span>parm<span class="token punctuation">.</span>capture<span class="token punctuation">.</span>timeperframe<span class="token punctuation">.</span>denominator <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span> VIDIOC_S_PARM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mv4l2<span class="token operator">-></span>stream_parm<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

				<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to ioctl:VIDIOC_S_PARM"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
           	<span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> 
        <span class="token keyword">case</span> yVIDIOC_G_PARM<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
			<span class="token function">CLEAR_MEM</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>stream_parm<span class="token punctuation">)</span><span class="token punctuation">;</span>
			mv4l2<span class="token operator">-></span>stream_parm<span class="token punctuation">.</span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span> VIDIOC_G_PARM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mv4l2<span class="token operator">-></span>stream_parm<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

				<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to ioctl:VIDIOC_G_PARM"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>  mv4l2<span class="token operator">-></span>stream_parm<span class="token punctuation">.</span>parm<span class="token punctuation">.</span>capture<span class="token punctuation">.</span>capability <span class="token operator">==</span> V4L2_CAP_TIMEPERFRAME <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This Video Support Set Fps,Now-Fps is : %d\n"</span><span class="token punctuation">,</span>mv4l2<span class="token operator">-></span>stream_parm<span class="token punctuation">.</span>parm<span class="token punctuation">.</span>capture<span class="token punctuation">.</span>timeperframe<span class="token punctuation">.</span>denominator<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">else</span><span class="token punctuation">&#123;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This Video Un-Support Set Fps\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
           	<span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">case</span> yVIDIOC_DQBUF<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
			<span class="token comment">//bzero(&amp;normal_buf, sizeof(normal_buf));</span>
			<span class="token function">CLEAR_MEM</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">.</span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>
    		mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">.</span>memory <span class="token operator">=</span> V4L2_MEMORY_MMAP<span class="token punctuation">;</span>
    		<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span> VIDIOC_DQBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

        		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to ioctl:VIDIOC_DQBUF"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    
    		<span class="token punctuation">&#125;</span> 
           	<span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> 
        <span class="token keyword">case</span> yVIDIOC_QBUF<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span> VIDIOC_QBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

             	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to ioctl:VIDIOC_QBUF"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    		<span class="token punctuation">&#125;</span> 
           	<span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> yMMAPTOVEDIOBUF<span class="token operator">:</span>
		<span class="token punctuation">&#123;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> IMG_BUFF_NUM<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
        		<span class="token comment">//bzero(&amp;normal_buf, sizeof(normal_buf));</span>
				<span class="token function">CLEAR_MEM</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        		mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">.</span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>
        		mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">.</span>memory <span class="token operator">=</span> V4L2_MEMORY_MMAP<span class="token punctuation">;</span>
        		mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">.</span>index <span class="token operator">=</span> i<span class="token punctuation">;</span>
        		<span class="token comment">//get kernel cache information</span>
        
        		<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span> VIDIOC_QUERYBUF<span class="token punctuation">,</span><span class="token operator">&amp;</span>mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            
            		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to ioctl:VIDIOC_QUERYBUF"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        		<span class="token punctuation">&#125;</span>
        		mv4l2<span class="token operator">-></span>img_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">=</span> mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        		mv4l2<span class="token operator">-></span>img_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
                	PROT_READ<span class="token operator">|</span>PROT_WRITE<span class="token punctuation">,</span>
                    MAP_SHARED<span class="token punctuation">,</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span>
                    mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">.</span>m<span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>

        		<span class="token keyword">if</span> <span class="token punctuation">(</span> MAP_FAILED <span class="token operator">==</span> mv4l2<span class="token operator">-></span>img_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            
            		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        		<span class="token punctuation">&#125;</span>
    		<span class="token punctuation">&#125;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> yPUTVEDIOALLBUFTOQUEUE<span class="token operator">:</span>
		<span class="token punctuation">&#123;</span>
			    <span class="token comment">//bzero(&amp;normal_buf, sizeof(normal_buf));</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> IMG_BUFF_NUM<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        
				<span class="token function">CLEAR_MEM</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    			mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">.</span>index <span class="token operator">=</span> i<span class="token punctuation">;</span>
    			mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">.</span>type <span class="token operator">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="token punctuation">;</span>
    			mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">.</span>memory <span class="token operator">=</span> V4L2_MEMORY_MMAP<span class="token punctuation">;</span>
    			<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">,</span> VIDIOC_QBUF<span class="token punctuation">,</span><span class="token operator">&amp;</span>mv4l2<span class="token operator">-></span>normal_buf<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            
        			<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to ioctl:VIDIOC_QBUF"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    			<span class="token punctuation">&#125;</span>
          
			<span class="token punctuation">&#125;</span>  
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> yUNMMAPTOVEDIOBUF<span class="token operator">:</span>
		<span class="token punctuation">&#123;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> IMG_BUFF_NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    			<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">munmap</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>img_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>start<span class="token punctuation">,</span>mv4l2<span class="token operator">-></span>img_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

            	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Failed to munmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    			<span class="token punctuation">&#125;</span>

    		<span class="token punctuation">&#125;</span>  
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
        <span class="token keyword">default</span> <span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> 

        
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">yDestroyMV4l2</span><span class="token punctuation">(</span>yMV4L2 <span class="token operator">*</span>mv4l2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	
	<span class="token comment">//StopStream();</span>
	<span class="token function">yIoctlV4l2</span><span class="token punctuation">(</span>yVIDIOC_STREAMOFF<span class="token punctuation">,</span>mv4l2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//UnMMapToVedioBUf(mv4l2);</span>
	<span class="token function">yIoctlV4l2</span><span class="token punctuation">(</span>yUNMMAPTOVEDIOBUF<span class="token punctuation">,</span>mv4l2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>camera_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>mv4l2<span class="token operator">-></span>img_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ym_v4l2.h</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
	FileName:ym_v4l2.h
	Version:1.5
	Description:
	Created On: 2017-2-21
	Modified date:2017-3-14
	Author:Sky
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_YM_V4L2_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_YM_V4L2_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">__cplusplus</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span><span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __cplusplus */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ym_v4l2_config.h></span></span>
<span class="token comment">//open</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token comment">//memset</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token comment">//v4l2</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/videodev2.h></span></span>
<span class="token comment">//errno</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token comment">//perror</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token comment">//calloc,free</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token comment">//close</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token comment">//ioctl</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span>
<span class="token comment">//mmap,munmap</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">CLEAR_MEM</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">enum</span> <span class="token class-name">yV4l2Cmd</span><span class="token punctuation">&#123;</span>

    yVIDIOC_QUERYCAP <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">//Get Camera Capability</span>
    yVIDIOC_ENUM_FMT <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token comment">//Get Camera all support-format</span>
    yVIDIOC_S_FMT <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token comment">//Set Img Format</span>
    yVIDIOC_G_FMT <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token comment">//Get Img Format</span>
    yVIDIOC_REQBUFS <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token comment">//Req Video buf</span>
    yVIDIOC_STREAMON <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token comment">//Start stream</span>
    yVIDIOC_STREAMOFF <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span><span class="token comment">//Stop stream</span>
    yVIDIOC_S_PARM <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span><span class="token comment">//Set Fps info</span>
    yVIDIOC_G_PARM <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span><span class="token comment">//Get Fps info</span>
    yVIDIOC_DQBUF <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">,</span><span class="token comment">//delete buf from out queue</span>
    yVIDIOC_QBUF <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token comment">//put buf to in queue</span>
	yMMAPTOVEDIOBUF <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">,</span>
	yUNMMAPTOVEDIOBUF <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">,</span>
	yPUTVEDIOALLBUFTOQUEUE <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">,</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">void</span> <span class="token operator">*</span> start<span class="token punctuation">;</span>
    <span class="token keyword">long</span> len<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> IMG_BUF<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">ymv4l2</span><span class="token punctuation">&#123;</span>
	
	<span class="token keyword">int</span> camera_fd<span class="token punctuation">;</span><span class="token comment">//camara file descriptor</span>
	IMG_BUF <span class="token operator">*</span>img_buf<span class="token punctuation">;</span><span class="token comment">//img buf head</span>
	
	<span class="token keyword">struct</span> <span class="token class-name">v4l2_buffer</span> normal_buf<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">v4l2_fmtdesc</span> desc_fmt<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">v4l2_capability</span> cap<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">v4l2_format</span> stream_fmt<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">v4l2_requestbuffers</span> reqbuf<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">v4l2_streamparm</span> stream_parm<span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token class-name">v4l2_buf_type</span> type<span class="token punctuation">;</span>
	
<span class="token punctuation">&#125;</span>yMV4L2<span class="token punctuation">;</span> 



<span class="token keyword">int</span> <span class="token function">yInitMV4l2</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> pathname<span class="token punctuation">,</span> yMV4L2 <span class="token operator">*</span> mvl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">yDestroyMV4l2</span><span class="token punctuation">(</span>yMV4L2 <span class="token operator">*</span> mvl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">yIoctlV4l2</span><span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">yV4l2Cmd</span> cmd<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//int OpenCamera(const char * pathname);</span>
<span class="token comment">//int GetCapability(void);</span>
<span class="token comment">//int GetAllSupportFormat(void);</span>
<span class="token comment">//int SetFrameInfo(void);//to set fps</span>
<span class="token comment">//int GetFrameInfo(void);</span>
<span class="token comment">//int SetImgFormat(void);</span>
<span class="token comment">//int GetImgFormat(void);</span>
<span class="token comment">//int RequestVedioBuf(void);</span>
<span class="token comment">//int MMapToVedioBuf(void);</span>
<span class="token comment">//int PutVedioBufToQueue(void);</span>
<span class="token comment">//int UnMMapToVedioBUf(void);</span>
<span class="token comment">//int StartStream(void);</span>
<span class="token comment">//int StopStream(void);</span>
<span class="token comment">//int ConfigV4l2(void);</span>
<span class="token comment">//int GetVedioBufFromQueue(void);</span>
<span class="token comment">//int PutVedioBufToQueue(void);</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">__cplusplus</span></span>
<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __cplusplus */</span> </span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/03/27/blog_idx_033/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/03/27/blog_idx_033/" class="post-title-link" itemprop="url">Linux DISPLAY环境变量的妙用(error:QXcbConnection: Could not connect to display) ,xhost 命令, 通过ssh连接显示界面</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-03-27 18:03:28" itemprop="dateCreated datePublished" datetime="2017-03-27T18:03:28+08:00">2017-03-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 14:43:35
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=033） 
&emsp;&emsp;本文发布于 2017-03-27 18:03:28，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=033） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="DISPLAY-变量">DISPLAY 变量</h3>
<hr>
<p>  最近由于特殊原因，要在字符终端中的bash运行一个带GUI的PyQT程序。报了一个错误为：QXcbConnection: Could not connect to display</p>
<p>  我在GUI桌面中的bash能够执行此PyQt程序，但是在字符终端中的bash执行就会报错</p>
<p>  想到是由于无图形界面的原因，在网上找了一下午，想实现一个功能就是在tty1中指定tty7来运行这个程序，但是没有找到解决办法，最后发现一个环境变量可以很Ok的解决此问题。</p>
<br/>
<br/>
<h5 id="问题说明">问题说明</h5>
<p>  此类问题可以归结于:在非图形终端执行了一个GUI程序，导致X11Server在此终端的环境下无法显示图形，需要手动指定X11Server把图形显示到其他的带图形界面的终端。</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">DISPLAY 变量
eg:DISPLAY=hostip:NumA.NumB
（注意当显示到本机的其他tty时，hostip 为空，一般情况下NumA,NumB为0）
eg:DISPLAY=:0.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="2019-03-25更新">2019/03/25更新</h3>
<hr>
<br/>
<br/>
<h5 id="有意栽花花不发，无心插柳柳成荫。">有意栽花花不发，无心插柳柳成荫。</h5>
<p>  原文的本意只是简单记录了我的一个试验成功的实验，没想到那么多人关注这个。</p>
<p>  原试验内容：你按ctrl+atl+F1进入tty1，然后你在tty1中执行带GUI功能的程序，一般就会报相应的显示错误。这个错误的原因就是DISPLAY变量没有设置的原因。你可以通过：echo ${DISPLAY}</p>
<p>  简单来说，当你在终端执行一个带GUI功能的程序的时候，如果DISPLAY变量没有定义，就会报相应的错误。至少对于Xserver的系统是这样的。</p>
<br/>
<br/>
<h5 id="DISPLAY-简单说明">DISPLAY 简单说明</h5>
<p>  我就是简单翻译此网页的某些我们关注的段落（如有侵权，联系我立即删除）：<a target="_blank" rel="noopener" href="https://gerardnico.com/ssh/x11/display">https://gerardnico.com/ssh/x11/display</a></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">The magic word in the X window system is DISPLAY.
在X视窗系统中，这个比较神奇的SHELL变量是DISPLAY。

The X display server install itself normally as display number 0 on your local machine. 
在你的本地机器上，X显示服务程序在安装的时候，会把自己设置为“显示0”。

A display consists (simplified) of:
a keyboard,
a mouse
and a screen.
一个“显示”一般由以下内容组成：
一个键盘
一个鼠标
一个显示器。

A display is managed by a server program, known as an X server. The server serves displaying capabilities to other programs that connect to it.
一个“显示”被一个叫做X服务的服务程序管理。这个服务为连接它的其他程序提供“显示“服务。

The SSH protocol has the ability to securely forward X Window System applications over an encrypted SSH connection, so that you can run an application on the SSH server machine and have it put its windows up on your local machine without sending any X network traffic in the clear. $DISPLAY on the remote machine should point to localhost. SSH does the forwarding.
SSH协议通过一个加密的SSH连接，能够安全地传输X桌面系统程，因此，在没有发送任何X网络传输的时候，你可以毫无阻碍地在SSH所在的服务器运行你的程序并让其界面在你本地电脑启动起来。DISPLAY变量必须在远程机器上设置为localhost，SSH配置为启用X11转发。

The value of the display environment variable is:
这个DISPLAY环境变量的值是：

hostname:D.S
主机名:"显示号".“屏幕号”

where:
说明：

hostname is the name of the computer where the X server runs. An omitted hostname means the localhost.
一个运行了X服务的计算机的名字是主机名。一个缺省的主机名是localhost。

D is a sequence number (usually 0). It can be varied if there are multiple displays connected to one computer.
D 是一个通常为0的序列号。它可以区分这个有多少个“显示”连接到了这个计算机。

S is the screen number. A display can actually have multiple screens. Usually there's only one screen though where 0 is the default.
S 是一个屏幕号。一个“显示“能够有多个屏幕。通常，一个计算机有一个屏幕，其序号默认是0。

hostname:D.S means screen S on display D of host hostname; the X server for this display is listening at TCP port 6000+D.
hostname:D.S这种格式的定义是：“显示D”显示到一个主机为hostname的屏幕上。X服务对于这个“显示”是通过监听TCP端口6000+D 这个端口号实现的。(如：localhost:4.0,  对于这个显示实例，Xserver监听的就是6004这个端口.)

host/unix:D.S means screen S on display D of host host; the X server for this display is listening at UNIX domain socket /tmp/.X11-unix/XD (so it's only reachable from host).
host/unix:D.S这种格式的定义是：“显示D”显示到一个主机地址为host的屏幕上。X服务对于这个“显示”是通过监听UNIX本地socket实现的。因此host必须是可以连接的。

:D.S is equivalent to host/unix:D.S, where host is the local hostname.
:D.S 和host/unix:D.S是一样的。这里是一种简写方式，host是本地的主机名，如localhost.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  以上翻译可能不太准确，我翻译很屁的。</p>
<h3 id="2019-09-26更新-，补充xhost命令">2019/09/26更新 ，补充xhost命令</h3>
<hr>
<p>  今天再ubuntu 18.04上，切换root，运行/snap/bin/gnome-system-monitor程序，显示如下：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_033/xhost0.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  我首先说明，这里我已经设置了DISPLAY环境变量，但是发现我被拒绝连接了。于是查了查，和xhost命令有关，xhost简单来说就是控制其他用户或者其他ip是否可以访问当前用户启动的xserver。</p>
<p>  于是我解除其他用户访问限制：xhost +</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_033/xhost1.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  然后再次root重新运行，可以正常打开了。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_033/xhost2.png" alt="rep_img"/></center>
    </div>
</div>  
<br/>
<br/>
<br/>
<br/>
<h3 id="2020-03-13更新-用xshell，putty等ssh链接工具链接时，显示图形界面">2020/03/13更新 用xshell，putty等ssh链接工具链接时，显示图形界面</h3>
<hr>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_033/xshell0.png" alt="rep_img"/></center>
    </div>
</div>  
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_033/putty0.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  勾选后，你再次进入shell（重连ssh），echo $DISPLAY 会发现变量已经被定义了。下面用xshell为例。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_033/xshell1.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  如果没有DISPLAY变量还是空，则配置sshd_config文件。如下图打开x11转发：<br>
/etc/ssh/sshd_config文件 如果画框为no改为yes</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_033/sshd0.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  sudo service ssh restart 重启sshd服务</p>
<p>  再次通过xshell连接linux目标。就可得到如下的图：（如未得到，多检查，多学习）</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_033/xshell2.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  图中画框的tcp就是转发出来的x11链接，你如果再开一个ssh链接，你会发现DISPLAY变量又变了：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_033/xshell3.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  这个时候你在xshell终端中输入任何一个gui 程序，会弹出如下框，安装好后，就可以正常显示GUI界面了。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_033/xshell4.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  xmanager是收钱的，我这里用另外一个MobaXterm但是道理都是一样的。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_033/xshell5.png" alt="rep_img"/></center>
    </div>
</div>  
<p><font color = red size = 4><strong>其实这里的更新内容，在我翻译的那段文字里面有，只是不知道多少人看了！！！！哎！！！</strong></font></p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  一句话来说，对于桌面是由x服务的图形系统来说,只有设置了DISPLAY变量，才能够让GUI程序正常的显示起来。</p>
<p>  对于我们经常进入的桌面，然后开一个terminal，你会发现，DISPLAY已经被自动设置了。所以才没有问题。而对于我们进的不是桌面terminal来说，DISPLAY变量是没有设置的。需要我们手动设置，GUI程序才能够正常启动。</p>
<p>  2019/09/26更新，如果无法正常显示， xserver安全访问系统可能会阻止你访问xserver，当设置了正确的DISPLAY变量后无法显示，请尝试xhost 命令解除访问控制。</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/03/14/blog_idx_032/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/03/14/blog_idx_032/" class="post-title-link" itemprop="url">C 可变参数函数分析(va_start,va_end,va_list...)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-03-14 17:12:28" itemprop="dateCreated datePublished" datetime="2017-03-14T17:12:28+08:00">2017-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 14:17:58
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=032） 
&emsp;&emsp;本文发布于  2017-03-14 17:12:28，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=032） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  在几年前，由于兴趣需要，去研究了c的不定参数问题，当时由于太懒，没有记录任何资料，导致现在实际需要的时候，又要重新来过。呜呼哀哉，太烦了～～～～～～～</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="c-cpp不定参数">c/cpp不定参数</h3>
<hr>
<p>  首先，c不定参数所定义的宏的头文件在 stdarg.h中。在我的系统中在这里：/usr/lib/gcc/x86_64-linux-gnu/5/include/stdarg.h,源码我就不贴了，就简要分析几个重要宏的原理。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//va_list  //此宏依赖与不同的平台和操作系统。</span>
    <span class="token comment">//常用定义:(具体和编译器有关，其实了解透后，都差不多)</span>
    <span class="token keyword">typedef</span> <span class="token keyword">char</span> <span class="token operator">*</span>  __builtin_va_list<span class="token punctuation">;</span><span class="token comment">//（注意可能是这样定义的）</span>
    <span class="token punctuation">(</span>or<span class="token punctuation">)</span>
    <span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token operator">*</span>  __builtin_va_list<span class="token punctuation">;</span><span class="token comment">//（注意可能是这样定义的）</span>
    <span class="token keyword">typedef</span> __builtin_va_list __gnuc_va_list<span class="token punctuation">;</span>  
    <span class="token keyword">typedef</span> __gnuc_va_list va_list；


<span class="token comment">//_INTSIZEOF(n) //此宏是windows上定义的，目的是为了考虑兼容一些内存地址对齐的系统，n应该占多少字节，如：arm指令集是4字节对齐访问，Thumb指令集是24字节对齐访问.在linux上，gcc编译器会内部定义一个类似的宏，来代表对齐的字节数。其用法是为了根据一个确定的参数，来依次确定不定参数中的每一个参数。</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name function">_INTSIZEOF</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span></span></span>
    <span class="token comment">//一般在一个操作系统中，int类型所占的字节数即为当前对齐的字节数，一般为4或者8。关于此宏的详细分析，以下的分析来至于网上，带入sizeof(n) = 4,8即可明白：</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name function">_INTSIZEOF</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
    x <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">=</span> <span class="token number">0000</span> <span class="token number">0000</span> <span class="token number">0000</span> <span class="token number">0011</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token operator">~</span>x <span class="token operator">=</span> <span class="token number">1111</span> <span class="token number">1111</span> <span class="token number">1111</span> <span class="token number">1100</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>

<span class="token comment">//va_start(v,l) //此宏获取的是可变参数中的第一个参数的地址</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__builtin_va_start</span><span class="token expression"><span class="token punctuation">(</span>v<span class="token punctuation">,</span>l<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token punctuation">(</span> v <span class="token operator">=</span> <span class="token punctuation">(</span>va_list<span class="token punctuation">)</span><span class="token operator">&amp;</span>l <span class="token operator">+</span> <span class="token function">_INTSIZEOF</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token punctuation">)</span></span><span class="token comment">//（注意可能是这样定义的），l的地址加上l地址所占的空间</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">va_start</span><span class="token expression"><span class="token punctuation">(</span>v<span class="token punctuation">,</span>l<span class="token punctuation">)</span>   <span class="token function">__builtin_va_start</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>l<span class="token punctuation">)</span></span></span>
	
<span class="token comment">//va_arg(v,l)//此宏是使下一个可变参数的地址赋值给v,同时返回开始时v地址所指向的值，注意：此时v已经指向下一个参数地址，但是表达式返回的值是初始v的值，《《这里只需要搞清楚括号优先级就能够明白》》。</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__builtin_va_arg</span><span class="token expression"><span class="token punctuation">(</span>v<span class="token punctuation">,</span>l<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>l <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v <span class="token operator">+=</span> <span class="token function">_INTSIZEOF</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">_INTSIZEOF</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span></span><span class="token comment">//（注意可能是这样定义的）</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">va_arg</span><span class="token expression"><span class="token punctuation">(</span>v<span class="token punctuation">,</span>l<span class="token punctuation">)</span> <span class="token function">__builtin_va_arg</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>l<span class="token punctuation">)</span></span></span>
		
<span class="token comment">//va_end(v)//此宏处理va_list声明的一个指针，防止出现野指针。有始有终。</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__builtin_va_end</span><span class="token expression"><span class="token punctuation">(</span>v<span class="token punctuation">)</span></span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span> v <span class="token operator">=</span> <span class="token punctuation">(</span>va_list<span class="token punctuation">)</span><span class="token number">0</span> <span class="token punctuation">)</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">va_end</span><span class="token expression"><span class="token punctuation">(</span>v<span class="token punctuation">)</span>   <span class="token function">__builtin_va_end</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="来个例子-t-c">来个例子(t.c)</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">ttt</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> fuk<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">ttt</span><span class="token punctuation">(</span><span class="token string">"fuk"</span><span class="token punctuation">,</span><span class="token number">2333</span><span class="token punctuation">,</span><span class="token string">"this is 23333333333333333"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">void</span> <span class="token function">ttt</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> fuk<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

	va_list arg<span class="token punctuation">;</span>
	<span class="token keyword">int</span> a<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>
	<span class="token function">va_start</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span>fuk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	a <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	b <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">va_end</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d,%s\n"</span><span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>编译</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc t.c
./a.out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_032/run.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>最后的注意：</p>
<ol>
<li class="lvl-3">
<p>变参函数必须有一个以上的指定参数</p>
</li>
<li class="lvl-3">
<p>变参的《《类型》》必须通过一定方式已知（如格式化字符串,&quot;%d,%s&quot;等等），否则就是定死的</p>
</li>
<li class="lvl-3">
<p>变参的《《个数》》也必须通过一定方式已知（如格式化字符串,&quot;%d,%s&quot;等等），否则就是定死的</p>
</li>
<li class="lvl-3">
<p>c的函数参数入栈方式是从右到左，栈的地址一般是从高到底。</p>
</li>
</ol>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2017/02/27/blog_idx_031/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/02/27/blog_idx_031/" class="post-title-link" itemprop="url">FAT32 文件系统详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-02-27 12:27:29" itemprop="dateCreated datePublished" datetime="2017-02-27T12:27:29+08:00">2017-02-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%B8%B8%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">常识</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-16 14:03:56
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=031） 
&emsp;&emsp;本文发布于 2017-02-27 12:27:29，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=031） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  最近有个项目是做STM32裸机开发的，由于需要用到USB向android系统传输数据，先考虑USB HID Class，但是考虑到驱动和后续要支持读取SD问题，进而采用USB MS Class作为传输数据的载体。模拟一个带FAT32文件系统的存储设备。</p>
<p>  模拟设备基本信息:总容量8MB，除去MBR,DBR,FSINFO,FAT,等，大概还有7.8MB左右的容量。</p>
<p>  这篇文章主要用于讲解FAT32的详细结构，同时也详解存储介质和文件系统的关系。读这篇文章时，以假设你对FAT32 具备一定的了解，至少你知道FAT32由哪些地方组成。现在网上的资料，就我查询来看，都没有介绍MBR，大部分都直接从DBR开始讲起来,而模拟一个存储设备，MBR是一切的起点，只要搞清楚MBR，我们就可以顺着线，了解所有。如果对文中的一些词语不了解，请多百度。</p>
<p>  <strong>此外，此文章是我查看许多资料而融合而来，向前人致敬！！！</strong></p>
<br/>
<br/>
<br/>
<br/>
<h3 id="FAT-FileSystem">FAT FileSystem</h3>
<hr>
<br/>
<br/>
<h5 id="存储介质">存储介质</h5>
<p>  由于我们的存储介质是由存储载体（磁面或者存储芯片）和 读写机构组成。如硬盘的磁面和磁头部分等等。这就解决了怎么物理级读取数据的问题，而操作系统的存储驱动正是做这个事情的。驱动提供接口让我们可以在存储介质上读写数。</p>
<p>  我们虽然可以通过驱动向存储介质写数据，但是都是很低级的写，同时，我们写入的大部分是文件，而很少有人直接往磁盘保存文件中的二进制数据吧，而不保存文件的其他信息吧，并且这样是很难管理的（如：我要取一个文件，就是说我要的是人记住这个文件在存储介质的那个位置，是那几个字节）。为了方便管理，有了文件系统的概念，文件系统可以提供方便的存储文件各种信息的方法。</p>
<p>  FAT文件系统是一个小容量类常用的文件系统，容量太大了就不太适合使用FAT系文件系统。FAT有FAT12，FAT16,FAT32，我们今天主要就是介绍FAT32.</p>
<br/>
<br/>
<h5 id="FAT32">FAT32</h5>
<p>  由于网上这方面的资料很多，我主要是介绍一些网上现有资料让我迷惑的一些地方。同时通过代码的方式，让我们知道各个组成部分到底是怎么回事。</p>
<p>  FAT32 由 MBR,DBR,FSINFO,FAT1,FAT2,DATA(DATA = DIR + FILE_DATA) 组成。</p>
<p>  MBR是主引导记录，主要作用是为了标示一个分区的信息而设立的。MBR结构如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//0 扇区</span>
<span class="token class-name">uint8_t</span> FAT32_MBR<span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span>
	<span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token comment">/*DPT 开始位*/</span><span class="token number">0x80</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token comment">/**/</span><span class="token punctuation">,</span>
	<span class="token number">0x01</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x0B</span><span class="token punctuation">,</span><span class="token number">0xFE</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x3F</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span>  <span class="token number">0x3F</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*4bytes下个分区的扇区地址*/</span><span class="token punctuation">,</span>  <span class="token number">0x82</span><span class="token punctuation">,</span><span class="token number">0x3e</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*4bytes为SD卡总的扇区个数(16002个)*/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span>
	<span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span>
	<span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span>
	<span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x55</span><span class="token punctuation">,</span><span class="token number">0xAA</span><span class="token comment">/**/</span><span class="token punctuation">,</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  MBR决定DBR的起始位置,DBR存储FAT表信息。DBR如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//DOS BOOT RECORD</span>
<span class="token comment">//DBR=引导代码+BPB+扩展BPB+校验</span>
<span class="token comment">//FAT1 = 63+34</span>
<span class="token comment">//FAT2 = 63+34+123 = 220</span>
<span class="token comment">//DATA = 63+34+123+123 = 343</span>
<span class="token comment">//ROOT-DIR = 343</span>
<span class="token class-name">uint8_t</span> FAT32_DBR<span class="token punctuation">[</span><span class="token number">96</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span>
	
	<span class="token number">0xEB</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x90</span><span class="token comment">/*(0x0-0x2)跳转指令*/</span><span class="token punctuation">,</span><span class="token number">0x4D</span><span class="token punctuation">,</span><span class="token number">0x53</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x4F</span><span class="token punctuation">,</span><span class="token number">0x53</span><span class="token punctuation">,</span><span class="token number">0x35</span><span class="token punctuation">,</span><span class="token number">0x2E</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token comment">/*（0x3-0xA）OEM区域:MSDOS5.0*/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token comment">/*（0xB-0xC）每扇区字节数*/</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token comment">/*（0xD）每簇扇区数*/</span><span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0xE-0xF)保留扇区数*/</span><span class="token punctuation">,</span>
	<span class="token number">0x02</span><span class="token comment">/*(0x10)FAT数(Number of FAT) 该分区上FAT的副本数*/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*（0x11-0x12）FAT32必须等于0，FAT12/FAT16为根目录中目录的个数；*/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x13-0x14)FAT32必须等于0，FAT12/FAT16为扇区总数*/</span><span class="token punctuation">,</span><span class="token number">0xF8</span><span class="token comment">/*(0x15),哪种存储介质，0xF8标准值，可移动存储介质，常用的 0xF0*/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x16-0x17)FAT32必须为0，FAT12/FAT16为一个FAT 表所占的扇区数*/</span><span class="token punctuation">,</span><span class="token number">0x3F</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x18-0x19)每磁道扇区数，只对于有“特殊形状”（由磁头和柱面每 分割为若干磁道）的存储介质有效，63（0x00 3F）*/</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x1A-0x1B)磁头数，只对特殊的介质才有效，255（0x00 FF）。*/</span><span class="token punctuation">,</span><span class="token number">0x3F</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x1C-0x1F)DBR分区之前所隐藏的扇区数，63，与MBR中地址0x1C6开始的4个字节数值相等*/</span><span class="token punctuation">,</span>
	<span class="token number">0x82</span><span class="token punctuation">,</span><span class="token number">0x3E</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x20-0x23)文件系统总扇区数，16002*/</span><span class="token punctuation">,</span><span class="token number">0x7B</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x24-0x27)每个FAT表占用扇区数，123*/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x28-0x29),标记，此域FAT32 特有*/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x2A-0x2B)FAT32版本号0.0，FAT32特有*/</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x2C-0x2F),根目录所在第一个簇的簇号，2。（虽然在FAT32文件系统 下，根目录可以存放在数据区的任何位置，但是通常情况下还是起始于2号簇） */</span><span class="token punctuation">,</span>
	<span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x30-0x31),FSINFO（文件系统信息扇区）扇区号1，该扇区为操作 系统提供关于空簇总数及下一可用簇的信息*/</span><span class="token punctuation">,</span><span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x32-0x33),备份引导扇区的位置。备份引导扇区总是位于文件系统 的6号扇区*/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x34-0x3F),用于以后FAT 扩展使用*/</span><span class="token punctuation">,</span>
	<span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*(0x40-0x41),与FAT12/16 的定义相同，只不过两者位于启动扇区不同的位置而已*/</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token comment">/*(0x42),扩展引导标志，0x29。与FAT12/16 的定义相同*/</span><span class="token punctuation">,</span><span class="token number">0xAF</span><span class="token punctuation">,</span><span class="token number">0xE3</span><span class="token punctuation">,</span><span class="token number">0xB5</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token comment">/*(0x43-0x46),卷序列号。通常为一个随机值*/</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span>
	<span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token comment">/*(0x47-0x51)卷标（ASCII码），如果建立文件系统的时候指定了卷 标，会保存在此*/</span><span class="token punctuation">,</span><span class="token number">0x46</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x54</span><span class="token punctuation">,</span><span class="token number">0x33</span><span class="token punctuation">,</span><span class="token number">0x32</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token comment">/*(0x52-0x59)文件系统格式的ASCII码，FAT32*/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  FSINFO如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//文件系统信息扇区，位于DBR 后一个扇区</span>
<span class="token comment">//64扇区</span>
<span class="token class-name">uint8_t</span> FAT32_FSINFO<span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span>
	<span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token comment">/*扩展引导标签*/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span>
	<span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token comment">/*FSINFO签名“0x72724161”*/</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x3D</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*文件系统的空簇数，15788*/</span><span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/*下一可用簇号（0x 00 00 00 15）*/</span><span class="token punctuation">,</span>
	<span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token comment">/**/</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x55</span><span class="token punctuation">,</span><span class="token number">0xAA</span><span class="token comment">/**/</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  FAT表存储哪些簇已经被分配, FAT表如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//97扇区，FAT1</span>
<span class="token comment">//220,FAT2</span>
<span class="token class-name">uint8_t</span> FAT32_FAT<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span>
	<span class="token number">0xF8</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x0F</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x0F</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span> <span class="token punctuation">,</span> 
	<span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x0F</span>
	
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  同理通过DBR和FAT表我们可以推算出DIR所在的扇区，同时，也可以推算出DATA所在的扇区，然后我们就可以模拟一个带FAT32文件系统的存储设备。</p>
<p>  注意:文中的一些地方要结合其他的FAT32文章基础来看，我只是很直白的表达了，到底介质上存了什么才会让OS认出这就是FAT32，容量多大。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2016/12/01/blog_idx_030/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/12/01/blog_idx_030/" class="post-title-link" itemprop="url">Ubuntu(Linux) PyQt5 QtUIFile 转换为 PythonModule (pyuic.py/pyuic脚本)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-12-01 17:16:41" itemprop="dateCreated datePublished" datetime="2016-12-01T17:16:41+08:00">2016-12-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GUI%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">GUI开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GUI%E5%BC%80%E5%8F%91/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GUI%E5%BC%80%E5%8F%91/python/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>692</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-09-11 15:02:09
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=030） 
&emsp;&emsp;本文发布于 2016-12-01 17:16:41，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=030） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="PyQt5">PyQt5</h3>
<hr>
<p>  在我的《PyQt5 Ubuntu 16.04/14.04 环境配置》（<a target="_blank" rel="noopener" href="https://sky-x.blog.csdn.net/article/details/53422190%EF%BC%89">https://sky-x.blog.csdn.net/article/details/53422190）</a> 中配置和测试了pyqt5，但是在我们实际开发GUI时，我们要借助QtCreator这个非常好的工具来画出我们UI的初始样子。</p>
<p>  之后我们会得到一个UI文件，这时候我们需要借助PyQt5所带的一个工具Pyuic脚本将UI文件转换为PythonModule文件。</p>
<p>  在我的教程安装之后，pyuic脚本位置在/usr/lib/python3/dist-packages/PyQt5/uic 目录。如图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_030/pyuic.png" alt="rep_img"/></center>
    </div>
</div>    
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bash中执行：
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">pyuic5</span><span class="token operator">=</span><span class="token string">"python3 -m PyQt5.uic.pyuic"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>  这下，你就可以在bash中使用pyuic5 来转换ui文件为 pythonmodule</p>
<p>  如图实例：<br>
  QtCreator：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_030/qtcreator.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  pyuic转换:</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_030/pyuic_convert.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  form.py，module文件:</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_030/form_py.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  测试文件，<a target="_blank" rel="noopener" href="http://my.py">my.py</a>：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_030/my_py.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  最后效果：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_030/performance.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  所有文件打包下载：<a target="_blank" rel="noopener" href="http://download.csdn.net/detail/u011728480/9699105">http://download.csdn.net/detail/u011728480/9699105</a></p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>无</p>
<h3 id="参考文献">参考文献</h3>
<p>无</p>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2016/12/01/blog_idx_029/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/12/01/blog_idx_029/" class="post-title-link" itemprop="url">PyQt5 Ubuntu 16.04/14.04 环境配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-12-01 16:17:37" itemprop="dateCreated datePublished" datetime="2016-12-01T16:17:37+08:00">2016-12-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/GUI%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">GUI开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/GUI%E5%BC%80%E5%8F%91/linux%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">linux开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/GUI%E5%BC%80%E5%8F%91/linux%E5%BC%80%E5%8F%91/Ubuntu%E4%BD%BF%E7%94%A8/" itemprop="url" rel="index"><span itemprop="name">Ubuntu使用</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>549</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-09-11 14:51:59
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=029） 
&emsp;&emsp;本文发布于 2016-12-01 16:17:37，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=029） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  起因，最近要用到PyQt5，所以想安装来写一个小程序，去网上查了半天，我发现网上的教程时间和空间复杂度爆炸，于是有了这个教程。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="PyQt5">PyQt5</h3>
<hr>
<ol>
<li class="lvl-3">
<p>我查了查Ubuntu的库</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_029/pythonqt.png" alt="rep_img"/></center>
    </div>
</div>  
<ol start="2">
<li class="lvl-3">
<p>居然没有，好伤心，继续查</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_029/python3qt.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  卧槽，好神奇，居然pyqt4,pyqt5都有耶。那就安装呗.</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python3-pyqt5<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol start="3">
<li class="lvl-3">
<p>开始测试</p>
</li>
</ol>
<p>先上效果图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_029/test.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  测试脚本下载（不直接提供文本的原因是CSDN这个编辑器的锅，这个锅我不背）:<a target="_blank" rel="noopener" href="http://download.csdn.net/detail/u011728480/9699116">http://download.csdn.net/detail/u011728480/9699116</a></p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>无</p>
<h3 id="参考文献">参考文献</h3>
<p>无</p>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/NO_EXSIT.XXXXXXX/page/10/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/NO_EXSIT.XXXXXXX/">1</a><span class="space">&hellip;</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/14/">14</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/NO_EXSIT.XXXXXXX/page/12/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Sky</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">286k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">17:19</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":250,"hOffset":50,"vOffset":5},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
</html>
