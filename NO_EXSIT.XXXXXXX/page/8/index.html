<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"e-x.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Sky&#39;s Blogs">
<meta property="og:url" content="https://e-x.top/NO_EXSIT.XXXXXXX/page/8/index.html">
<meta property="og:site_name" content="Sky&#39;s Blogs">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Sky">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://e-x.top/NO_EXSIT.XXXXXXX/page/8/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"NO_EXSIT.XXXXXXX/page/8/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Sky's Blogs</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  




<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8677552300382028"
     crossorigin="anonymous"></script>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Sky's Blogs</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A normal star</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Sky</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">92</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">222</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/07/19/blog_idx_068/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/07/19/blog_idx_068/" class="post-title-link" itemprop="url">《TencentNCNN系列》 之工作原理简要解析（以LeNet-5为例）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-07-19 11:05:52" itemprop="dateCreated datePublished" datetime="2018-07-19T11:05:52+08:00">2018-07-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DL/" itemprop="url" rel="index"><span itemprop="name">DL</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 17:31:22
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=068） 
&emsp;&emsp;本文发布于 2018-07-19 11:05:52，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=068） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  时间：2018.07.19</p>
<p>  ncnn master commit id:b3e24cafc37483dcc97ee61e6f0f6ff1b094300e</p>
<h3 id="前言">前言</h3>
<hr>
<p>  前面两篇文章我们分析了ncnn的加载参数和网络的基本工作流程。其实这一切只是为了给这篇文章做准备。因为我觉得ncnn作为一个前向框架，写的还是比较简单的，方便我们这些小菜鸟对其工作原理进行分析。而分析的方法，还是得从哪里来，从哪里去（读源码）。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="前置内容（非常重要的）">前置内容（非常重要的）</h3>
<hr>
<br/>
<br/>
<h5 id="本文作为例子的网络">本文作为例子的网络</h5>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">7767517
9 9
Input            data             0 1 data 0=28 1=28 2=1
Convolution      conv1            1 1 data conv1 0=20 1=5 2=1 3=1 4=0 5=1 6=500
Pooling          pool1            1 1 conv1 pool1 0=0 1=2 2=2 3=0 4=0
Convolution      conv2            1 1 pool1 conv2 0=50 1=5 2=1 3=1 4=0 5=1 6=25000
Pooling          pool2            1 1 conv2 pool2 0=0 1=2 2=2 3=0 4=0
InnerProduct     ip1              1 1 pool2 ip1 0=500 1=1 2=400000
ReLU             relu1            1 1 ip1 ip1_relu1
InnerProduct     ip2              1 1 ip1_relu1 ip2 0=10 1=1 2=5000
Softmax          prob             1 1 ip2 prob 0=0
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="ncnn的基本调用流程">ncnn的基本调用流程</h5>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"net.h"</span></span>
ncnn<span class="token double-colon punctuation">::</span>Net abc_net<span class="token punctuation">;</span>
ncnn<span class="token double-colon punctuation">::</span>Mat in_img<span class="token punctuation">;</span>
ncnn<span class="token double-colon punctuation">::</span>Mat out_img<span class="token punctuation">;</span>

abc_net<span class="token punctuation">.</span><span class="token function">load_param</span><span class="token punctuation">(</span>param_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
abc_net<span class="token punctuation">.</span><span class="token function">load_model</span><span class="token punctuation">(</span>model_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

ncnn<span class="token double-colon punctuation">::</span>Extractor ex <span class="token operator">=</span> abc_net<span class="token punctuation">.</span><span class="token function">create_extractor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ex<span class="token punctuation">.</span><span class="token function">set_num_threads</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ex<span class="token punctuation">.</span><span class="token function">set_light_mode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ex<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> in_img<span class="token punctuation">)</span><span class="token punctuation">;</span>

ex<span class="token punctuation">.</span><span class="token function">extract</span><span class="token punctuation">(</span><span class="token string">"prob"</span><span class="token punctuation">,</span> out_img<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  这里简要说明一下：</p>
<p>    前两篇文章分别介绍了load_param load_model的基本工作原理，这里要介绍的就是剩下的所有内容。<br>
<br/><br>
<br/></p>
<h5 id="相关数据结构准备（此小节内容可作为前两篇文章的内容补充）">相关数据结构准备（此小节内容可作为前两篇文章的内容补充）</h5>
<p>  在load_param时：</p>
<p>    ncnn::Net::blobs存放着每一个blob的相关信息，主要信息为name、producer、consumers，含义分别为：名字、产生这个blob数据的层、消费这个blob数据的层。</p>
<p>  ncnn::Net::layers存放的是：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>ncnn::Net::layers::type</p>
</li>
<li class="lvl-2">
<p>ncnn::Net::layers::name</p>
</li>
<li class="lvl-2">
<p>ncnn::Net::layers::bottoms 存的是此层需要的输入blob的idx</p>
</li>
<li class="lvl-2">
<p>ncnn::Net::layers::tops 存的是此层输出的blob的idx</p>
</li>
</ul>
<p>  在load_param中会根据我们读入的type来create_layer，这里建立这个layer也挺有意思的。</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_068/create.png" alt="rep_img"/></center>
    </div>
</div>    
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_068/struct.png" alt="rep_img"/></center>
    </div>
</div>    
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//这里的layer_to_index会去layer_registry去查找对应的层类型的idx，这里的layer_registry数组是我们在编译ncnn的时候初始化的，里面存放的是如下的东西。</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">NCNN_STRING</span></span>
<span class="token punctuation">&#123;</span><span class="token string">"Convolution"</span><span class="token punctuation">,</span>Convolution_x86_layer_creator<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token punctuation">&#123;</span>Convolution_x86_layer_creator<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

<span class="token comment">//这个数组的作用就是用来查询具体层的idx和其提供的构造接口creator。每个层都会实现这个creator，比如Convolution层在x86架构下，其构造接口名字叫做Convolution_x86_layer_creator。其原理如下：</span>
<span class="token function">DEFINE_LAYER_CREATOR</span><span class="token punctuation">(</span>Convolution_x86<span class="token punctuation">)</span><span class="token comment">//通过宏定义Convolution_x86_layer_creator这个全局函数</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DEFINE_LAYER_CREATOR</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token double-colon punctuation">::</span>ncnn<span class="token double-colon punctuation">::</span>Layer<span class="token operator">*</span> name</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">_layer_creator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">new</span> name<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="以前文网络为例分析">以前文网络为例分析</h5>
<p>  这里的分析入口为:</p>
<p>    ncnn::Extractor::input()</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_068/input.png" alt="rep_img"/></center>
    </div>
</div>    
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//图中blob_mats 就是整个框架工作时的数据存放向量。</span>
std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Mat<span class="token operator">></span> blob_mats<span class="token punctuation">;</span><span class="token comment">//blob_mats 定义</span>


<span class="token comment">//blob_mats的大小初始化在ncnn::Net::create_extractor()中完成,这里唯一需要注意的是，此函数是类Extractor的友元类成员函数，这样写的原因是为了访问其protect的构造函数。</span>
Extractor <span class="token class-name">Net</span><span class="token double-colon punctuation">::</span><span class="token function">create_extractor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">Extractor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> blobs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token class-name">Extractor</span><span class="token double-colon punctuation">::</span><span class="token function">Extractor</span><span class="token punctuation">(</span><span class="token keyword">const</span> Net<span class="token operator">*</span> _net<span class="token punctuation">,</span> <span class="token keyword">int</span> blob_count<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">net</span><span class="token punctuation">(</span>_net<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    blob_mats<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>blob_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lightmode <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    num_threads <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//find_blob_index_by_name 就是在ncnn::Net::blobs中去循环遍历，得到其idx。</span>
<span class="token comment">//然后把输入的mat数据，放入到blob_mats中相应的位置去。到这里，输入数据就填充完了。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>    ncnn::Extractor::extract()</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_068/extract.png" alt="rep_img"/></center>
    </div>
</div>    
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//此调用的开始时，根据名字通过find_blob_index_by_name 查找我们需要的输出层的idx，然后把blob_mats(携带输入数据)、lightmode、我们需要的输出层的idx一起传入给ncnn::Net::forward_layer()。然后将上述调用处理好的数据放入feature返回。一个网络的前向计算就完成了。</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>    ncnn::Net::forward_layer()</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_068/forward.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  上图这个if语句是这层网络只有一个输入和输出</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_068/forward1.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  此图的else是这层网络非一个输入和输出</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//这里我只分析只有一个输入和输出的情况，另外一种和它非常相近。</span>
<span class="token comment">//图中line 637-line 642,这里通过递归调用一层层倒推回去，直到我们的网络输入层。因为这一层在input的时候给blob_mats赋值，其dims不为零。</span>

<span class="token comment">//图中line646-line 655是set_light_mode的作用，其作用为是否释放计算过程中，存入blob_mats中，在前面层计算的得到的数据</span>

<span class="token comment">//图中line 658-line 691是开始前向计算。这里的计算分为两类，一类是在输入数据上计算，并把输出数据放入到输入数据的变量中。另外一种就是分别传入两个变量，一个存输入，一个存输出。至于为啥这样写，不知道，节约内存？</span>

<span class="token comment">//后续只会分析一种情况，分别传入两个变量，一个存输入，一个存输入。这里以前文网络中的第二层Convolution层为例。在line 677-line 690中，layer->forward()就是执行具体层的计算。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>    ncnn::Convolution::forward()</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_068/forward2.png" alt="rep_img"/></center>
    </div>
</div>  
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//这里只分析kernel为1*1*1的这种卷积</span>
<span class="token comment">//这里构造了一个InnerProduct层操作，这里简短的几句话，其实就是我前面几篇文章中的部分内容，load_param做了什么，load_model做了什么</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>    ncnn::InnerProduct::forward()</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_068/forward3.png" alt="rep_img"/></center>
    </div>
</div>  
<p>  这里核心是计算两个向量的内积。</p>
<p>  到这里为止，一个卷积操作就完成了。然后forward_layer会从递归中一级级返回，最后得到我们需要的那一层的值。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/07/18/blog_idx_067/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/07/18/blog_idx_067/" class="post-title-link" itemprop="url">《TencentNCNN系列》 之bin文件（网络参数文件）格式分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-07-18 11:27:50" itemprop="dateCreated datePublished" datetime="2018-07-18T11:27:50+08:00">2018-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DL/" itemprop="url" rel="index"><span itemprop="name">DL</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>992</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 17:20:32
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=067） 
&emsp;&emsp;本文发布于 2018-07-18 11:27:50，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=067） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  时间：2018.07.18</p>
<p>  ncnn master commit id:b3e24cafc37483dcc97ee61e6f0f6ff1b094300e</p>
<h3 id="前言">前言</h3>
<hr>
<p>  最近一段时间全在ncnn这个框架上折腾，现在有一点空闲时间，对之前的东西做一个总结。这里主要是对ncnn的参数加载做一个简要的分析。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="格式分析（主要基于其源码）">格式分析（主要基于其源码）</h3>
<hr>
<br/>
<br/>
<h5 id="前置的一些内容">前置的一些内容</h5>
<p>  核心加载参数的代码如图所示：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_067/load.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  这里靠一个for循环遍历所有在load_param中已经注册好的网络，每个特殊的网络继承于Layer基类，此类有以下的重要接口：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_067/layer.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  分别是加载模型，和加载网络，以及前向计算。</p>
<br/>
<br/>
<h5 id="model文件对应的param文件举例">model文件对应的param文件举例</h5>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_067/param.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  虽然在load_model中，遍历每一层layer，其会调用基类或者当前类的load_model，这里和load_param唯一的区别是，某些layer没有任何参数，但是还是会调用一遍基类的load_model（是一个空函数）。</p>
<p>  对于上图来说，Input 、Pooling 等层是没有任何参数的。但是Convolution层就有参数，在convolution.cpp中，就会实现一个具体的load_model方法覆盖父的load_model，其实现如下图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_067/load_model.png" alt="rep_img"/></center>
    </div>
</div>   
<br/>
<br/>
<h5 id="基于上图的Convolution层分析">基于上图的Convolution层分析</h5>
<p>  首先我们知道，在此层中，load_model 调用了mb.load加载具体的参数</p>
<p>  这里的参数分为三类：</p>
<ol>
<li class="lvl-3">
<p>float32</p>
</li>
</ol>
<p>  相关读取如下：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_067/read_fp32.png" alt="rep_img"/></center>
    </div>
</div>   
<ol start="2">
<li class="lvl-3">
<p>float16<br>
  相关读取如下：</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_067/read_fp16.png" alt="rep_img"/></center>
    </div>
</div>   
<ol start="3">
<li class="lvl-3">
<p>int8 的量化类型</p>
</li>
</ol>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_067/read_int8.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  这里重点介绍 int8的量化类型，其他的都是按照字节对齐的size进行读取</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>它会先读量化表（256的float数组）</p>
</li>
<li class="lvl-2">
<p>然后读取量化表的索引</p>
</li>
<li class="lvl-2">
<p>最后根据索引引索量化表，并建立mat数组，并返回</p>
</li>
</ul>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  对于不同的层，参数含义不太一样，若有需求，可针对分析。上文例子中，参数主要是卷积层的权重（weight），以及偏移量（blas）</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/06/25/blog_idx_066/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/06/25/blog_idx_066/" class="post-title-link" itemprop="url">《TencentNCNN系列》 之param文件（网络结构文件）格式分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-06-25 11:25:09" itemprop="dateCreated datePublished" datetime="2018-06-25T11:25:09+08:00">2018-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DL/" itemprop="url" rel="index"><span itemprop="name">DL</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 17:12:27
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=066） 
&emsp;&emsp;本文发布于 2018-06-25 11:25:09，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=066） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  2018.06.25</p>
<p>  ncnn master commit id:b3e24cafc37483dcc97ee61e6f0f6ff1b094300e</p>
<h3 id="前言">前言</h3>
<hr>
<p>  由于公司算法组的算法在某些arm板子的表现不佳，于是需要使用此框架进行优化，初步测试得出的结论为:此框架表现不错，于是需要对此框架进行深入学习。根据相关源码分析，要学习此框架的，最好的开始（突破口）应该在模型参数加载和网络加载部分。今天本文介绍网络文件的格式相关信息（根据其源码分析得出）。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="格式分析">格式分析</h3>
<hr>
<br/>
<br/>
<h5 id="param文件举例：">param文件举例：</h5>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_066/param.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<h5 id="上文例图中第一行（版本信息）：">上文例图中第一行（版本信息）：</h5>
<p>  其数值其实代表的是此param文件的版本。</p>
<p>  相关源码说明：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> magic <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">fscanf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>magic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>magic <span class="token operator">!=</span> <span class="token number">7767517</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"param is too old, please regenerate\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="上文例图中第二行（层与数据交换结构数量）：">上文例图中第二行（层与数据交换结构数量）：</h5>
<p>  第一个数：层（layer）数量</p>
<p>  第二个数：数据交换结构(blob)数量</p>
<p>  相关源码说明：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// parse</span>
<span class="token keyword">int</span> layer_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> blob_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">fscanf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"%d %d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>layer_count<span class="token punctuation">,</span> <span class="token operator">&amp;</span>blob_count<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="上文例图第三四行（相关层的信息）：">上文例图第三四行（相关层的信息）：</h5>
<p>  前4个值的含义固定：</p>
<ol>
<li class="lvl-3">
<p>层的类型</p>
</li>
<li class="lvl-3">
<p>层的名称</p>
</li>
<li class="lvl-3">
<p>输入数据结构（blob）数量（bottom）（input层特殊点）</p>
</li>
<li class="lvl-3">
<p>输出数据结构（blob）数量（top）</p>
</li>
</ol>
<p>  后面有三种类型的值《《《严格按照顺序排序》》》：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>第一种：网络输入层名（一个层可能有多个输入，于是有多个网络输入层名）</p>
</li>
<li class="lvl-2">
<p>第二种：网络输出层名（一个层可能有多个输出，于是有多个网络输出层名）</p>
</li>
<li class="lvl-2">
<p>第三种(可能没有)：特殊参数层，一是k=v的类型存在。二是k=len,v1,v2,v3…（数组类型）。此层在ncnn中是存放到paramDict结构中，不同类型层，各种参数意义不一样，需要具体分析。</p>
</li>
</ul>
<br/>
<br/>
<h5 id="这里就上文图中第四行的BinaryOp层进行举例分析（其他不同的分析需要具体看不同层的源码）">这里就上文图中第四行的BinaryOp层进行举例分析（其他不同的分析需要具体看不同层的源码）</h5>
<p>  层类型：BinaryOp</p>
<p>  层名称：_minusscalar0</p>
<p>  输入数据结构数量（bottom blob）:1</p>
<p>  输出数据结构数量（top blob）:1</p>
<p>  特殊参数1（第一个k=v）:id=0,op_type=1（代表加法Operation_SUB）</p>
<p>  特殊参数2（第二个k=v）:id=1,scale val=1</p>
<p>  特殊参数3（第三个k=v）:id=2,b=127.50000（因为操作类型为减法，所以此值代表减数）</p>
<p>  By the way:上文图中第五行是做乘法。第四五行合在一起代表的是对输入图像进行归一化。</p>
<p>  相关源码：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">op_type <span class="token operator">=</span> pd<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
with_scalar <span class="token operator">=</span> pd<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b <span class="token operator">=</span> pd<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.f</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/06/21/blog_idx_065/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/06/21/blog_idx_065/" class="post-title-link" itemprop="url">图像归一化、特征向量的距离（欧式距离、余弦相似性）的理解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-06-21 17:04:28" itemprop="dateCreated datePublished" datetime="2018-06-21T17:04:28+08:00">2018-06-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/" itemprop="url" rel="index"><span itemprop="name">计算机视觉</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/DL/" itemprop="url" rel="index"><span itemprop="name">DL</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>832</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 17:05:20
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=065） 
&emsp;&emsp;本文发布于 2018-06-21 17:04:28，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=065） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  最近的大部分时间都在学习图像和DL相关知识，并做一定的应用，这里对我学习过程中的一些基础知识进行了整理。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="图像归一化">图像归一化</h3>
<hr>
<p>  归一化就是将图像像素值(列如：[0,255])经过一定的计算，使其所有的像素值变换到某一个特定的区间（列如：[0,1]或者[-1,1]）。</p>
<p>  我所理解的归一化的作用有以下：</p>
<ol>
<li class="lvl-3">
<p>减小对图像处理的计算量</p>
</li>
<li class="lvl-3">
<p>消除亮度对图片的影响，避免带来了亮度信息的干扰。</p>
</li>
<li class="lvl-4">
<p>消除图像中的极大特征对图像处理的影响，使的图像的特征更均匀，同时也使得图像中的极小特征能够表现出来，不会被抑制。</p>
</li>
<li class="lvl-3">
<p>加快神经网络的收敛，原理就是目标函数输入参数取值范围越小，其等高线近似圆，而不是椭圆，使得梯度下降更快。</p>
</li>
</ol>
<br/>
<br/>
<br/>
<br/>
<h3 id="特征向量距离">特征向量距离</h3>
<hr>
<p>  这里有两种方法把我搞懵逼了。</p>
<br/>
<br/>
<h5 id="欧氏距离">欧氏距离</h5>
<p>  我们常见的二维空间计算两点距离的公式：dst=sqrt((x1-x2)<sup>2+(y1-y2)</sup>2) 就是欧氏距离在二维空间的定义，多维空间同理。（我理解为：这个距离主要是用来计算两个向量中两个点之间的距离,结果对数值非常敏感，突出的是一种数值大小的感受，如判断图片的分类时，对图片进行打分）</p>
<br/>
<br/>
<h5 id="余弦相似性">余弦相似性</h5>
<p>  余弦定理：cosM=(向量A.向量B)/||A||*||B||，描述向量A、B的方向的差异。（我理解为：这个相似性是描述的两个向量的方向差异，对数值不敏感，突出的是一种相似性的感受，列如人脸特征向量的对比）</p>
<br/>
<br/>
<h5 id="其他还有很多方法，但是我没有用到">其他还有很多方法，但是我没有用到</h5>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/05/28/blog_idx_064/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/05/28/blog_idx_064/" class="post-title-link" itemprop="url">HISI3520DV300 折腾记录(三)之《终篇》</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-05-28 15:07:04" itemprop="dateCreated datePublished" datetime="2018-05-28T15:07:04+08:00">2018-05-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>975</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 19:02:38
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=064） 
&emsp;&emsp;本文发布于 2018-05-28 15:07:04，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=064） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  在本系列第一篇文章的开始，我提出了写本系列文章的原因，就是为了改变当前项目中用到的核心板的内存大小来满足当前的新需求，所以我得根据当前单板的芯片型号然后去判定这个板子的硬件情况。同时也算是在工作中第一次实际项目中用相关知识来处理这个问题，对我来说，也算是对学校中知识的复习吧！</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="海思的三个内存关系-MMZ-OSMEM-RAM">海思的三个内存关系(MMZ,OSMEM,RAM)</h3>
<hr>
<p>  OSMEM：就是我们的操作系统所用的内存，通过free可以看见</p>
<p>  MMZ（Media Memory Zone）：此内存是供海思的媒体业务模块使用的内存，常用在音视频编解码等地方。此内存是通过linux driver实现的，在驱动内部对OSMEM没有使用的RAM部分进行内存管理。</p>
<p>  RAM：RAM=OSMEM+MMZ</p>
<p>  下面是一个512MB内存板子的例子（来自于海思SDK）</p>
<p>  DDR:</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">
-----|-------|  0x80000000   # Memory managed by OS.              

64M  | OS    |                                                 

     |       |                                                 

-----|-------|  0x84000000   # Memory managed by MMZ block anonymous.          

448M | MMZ   |                                                 

     |       |                                                 

-----|-------|  0xA0000000   # Memory managed by MMZ block jpeg.      <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="内存调整">内存调整</h3>
<hr>
<p>  查看MMZ内存的使用情况：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">命令：cat /proc/media-mem
---MMZ_USE_INFO:
 total <span class="token assign-left variable">size</span><span class="token operator">=</span>159744KB<span class="token punctuation">(</span>156MB<span class="token punctuation">)</span>,used<span class="token operator">=</span>15164KB<span class="token punctuation">(</span>14MB + 828KB<span class="token punctuation">)</span>,remain<span class="token operator">=</span>144580KB<span class="token punctuation">(</span>141MB + 196KB<span class="token punctuation">)</span>,zone_number<span class="token operator">=</span><span class="token number">1</span>,block_number<span class="token operator">=</span><span class="token number">45</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>  从这里的情况来看，mmz大概只用了15M的样子，剩余了141M的样子，造成了极大的浪费，考虑到后续对MMZ的一些需求，我这里将MMZ大小调整为26M的样子，做一定的预留。然后OSMEM扩展到230MB（以前是100MB）。然后在对我们的程序里面的使用的内存进行仔细的调整和优化（能用1byte不用2byte，此时内存依然很紧张啊，跑的东西太多了），达到了项目部署要求，不用更换硬件，造成项目成本上升。（注意，MMZ内存占用情况会根据你使用的实际内容改变，比如：流的路数、分辨率、采样率等可能会改变MMZ的占用内存大小，一般板子起来后，用上文的命令查看实际的占用情况，根据实际占用预留一部分内存，然后根据RAM大小来计算即可。）</p>
<p>  现在的MMZ使用情况：</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">---MMZ_USE_INFO:
 total size=26624KB(26MB),used=15164KB(14MB + 828KB),remain=11460KB(11MB + 196KB),zone_number=1,block_number=45<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>  现在的内存示意图：</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">-----|-------|  0x8000 0000   # Memory managed by OS.              

230M  | OS    |                                                 

     |       |                                                 

-----|-------|  0x8E60 0000   # Memory managed by MMZ block anonymous.          

26M | MMZ   |                                                 

     |       |                                                 

-----|-------|  0x90000000   # Memory managed by MMZ block jpeg.      <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/05/22/blog_idx_063/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/05/22/blog_idx_063/" class="post-title-link" itemprop="url">关于全景（360）图片拼接的方法（Opencv3.0 Stitcher）----续（一）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-05-22 15:31:47" itemprop="dateCreated datePublished" datetime="2018-05-22T15:31:47+08:00">2018-05-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/" itemprop="url" rel="index"><span itemprop="name">计算机视觉</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">数据结构与算法</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>15 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 16:52:37
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=063） 
&emsp;&emsp;本文发布于 2018-05-22 15:31:47，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=063） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  在<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011728480/article/details/79609493%E6%96%87%E4%B8%AD%EF%BC%8C%E6%88%91%E5%B7%B2%E7%BB%8F%E5%AE%9E%E7%8E%B0%E4%BA%86%E4%BB%8E%E4%B8%80%E4%B8%AA%E5%8F%AF%E6%97%8B%E8%BD%AC%E7%9A%84%E7%9B%B8%E6%9C%BA%E4%B8%AD%E9%87%87%E5%9B%BE%E8%BF%9B%E8%A1%8C360%E5%BA%A6%E7%9A%84%E5%85%A8%E6%99%AF%E6%8B%BC%E6%8E%A5%E3%80%82%E4%BD%86%E6%98%AF%E6%9C%80%E8%BF%91%EF%BC%8C%E5%8F%88%E6%8E%A5%E5%88%B0%E4%BA%86%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E6%98%AF%E5%85%B3%E4%BA%8E%E4%BB%8E%E4%B8%89%E4%B8%AA%E4%B8%8D%E5%90%8C%E7%9B%B8%E6%9C%BA%EF%BC%88%E5%90%8C%E5%9E%8B%E5%8F%B7%EF%BC%89%E9%87%87%E9%9B%86%E5%9B%BE%E5%83%8F%E8%BF%9B%E8%A1%8C%E6%8B%BC%E6%8E%A5%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%97%B6%E5%80%99%E5%B0%B1%E5%87%BA%E7%8E%B0%E4%BA%86%E4%B8%80%E4%B8%AA%E8%AE%A9%E6%88%91%E5%B4%A9%E6%BA%83%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C99.99999999999999999999999999%25%E9%83%BD%E6%8B%BC%E6%8E%A5%E4%B8%8D%E4%B8%8A%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%97%B6%E5%80%99%EF%BC%8C%E5%B0%B1%E9%9C%80%E8%A6%81%E6%88%91%E4%BB%AC%E6%8E%A2%E7%B4%A2%E4%B8%8E%E5%8F%91%E7%8E%B0%E4%B8%80%E4%B8%8B">https://blog.csdn.net/u011728480/article/details/79609493文中，我已经实现了从一个可旋转的相机中采图进行360度的全景拼接。但是最近，又接到了一个任务是关于从三个不同相机（同型号）采集图像进行拼接，这个时候就出现了一个让我崩溃的问题，99.99999999999999999999999999%都拼接不上，这个时候，就需要我们探索与发现一下</a> Stitcher的工作原理，看能不能找到相关的解决办法或者出现这些问题的原因。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Stitcher-大致工作原理（主要根据网上的资料结合其官方的例子来分析）">Stitcher 大致工作原理（主要根据网上的资料结合其官方的例子来分析）</h3>
<hr>
<ol>
<li class="lvl-4">
<p>首先就是通过算法找特征点</p>
</li>
<li class="lvl-3">
<p>其次就是计算图片之间的特征点的匹配程度</p>
</li>
<li class="lvl-3">
<p>… …（这里的省略号的原因是我也没有太懂后面的流程）</p>
</li>
<li class="lvl-3">
<p>拼接</p>
</li>
</ol>
<p>opencv  example :stitching_detailed.cpp(<a target="_blank" rel="noopener" href="https://github.com/opencv/opencv/blob/master/samples/cpp/stitching_detailed.cpp">https://github.com/opencv/opencv/blob/master/samples/cpp/stitching_detailed.cpp</a>)</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*M///////////////////////////////////////////////////////////////////////////////////////
//
//  IMPORTANT: READ BEFORE DOWNLOADING, COPYING, INSTALLING OR USING.
//
//  By downloading, copying, installing or using the software you agree to this license.
//  If you do not agree to this license, do not download, install,
//  copy or use the software.
//
//
//                          License Agreement
//                For Open Source Computer Vision Library
//
// Copyright (C) 2000-2008, Intel Corporation, all rights reserved.
// Copyright (C) 2009, Willow Garage Inc., all rights reserved.
// Third party copyrights are property of their respective owners.
//
// Redistribution and use in source and binary forms, with or without modification,
// are permitted provided that the following conditions are met:
//
//   * Redistribution's of source code must retain the above copyright notice,
//     this list of conditions and the following disclaimer.
//
//   * Redistribution's in binary form must reproduce the above copyright notice,
//     this list of conditions and the following disclaimer in the documentation
//     and/or other materials provided with the distribution.
//
//   * The name of the copyright holders may not be used to endorse or promote products
//     derived from this software without specific prior written permission.
//
// This software is provided by the copyright holders and contributors "as is" and
// any express or implied warranties, including, but not limited to, the implied
// warranties of merchantability and fitness for a particular purpose are disclaimed.
// In no event shall the Intel Corporation or contributors be liable for any direct,
// indirect, incidental, special, exemplary, or consequential damages
// (including, but not limited to, procurement of substitute goods or services;
// loss of use, data, or profits; or business interruption) however caused
// and on any theory of liability, whether in contract, strict liability,
// or tort (including negligence or otherwise) arising in any way out of
// the use of this software, even if advised of the possibility of such damage.
//
//
//M*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/opencv_modules.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/core/utility.hpp></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/imgcodecs.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/highgui.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/autocalib.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/blenders.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/timelapsers.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/camera.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/exposure_compensate.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/matchers.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/motion_estimators.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/seam_finders.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/detail/warpers.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/stitching/warpers.hpp"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENABLE_LOG</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG</span><span class="token expression"><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> msg</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGLN</span><span class="token expression"><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> msg <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token double-colon punctuation">::</span>detail<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    cout <span class="token operator">&lt;&lt;</span>
        <span class="token string">"Rotation model images stitcher.\n\n"</span>
        <span class="token string">"stitching_detailed img1 img2 [...imgN] [flags]\n\n"</span>
        <span class="token string">"Flags:\n"</span>
        <span class="token string">"  --preview\n"</span>
        <span class="token string">"      Run stitching in the preview mode. Works faster than usual mode,\n"</span>
        <span class="token string">"      but output image will have lower resolution.\n"</span>
        <span class="token string">"  --try_cuda (yes|no)\n"</span>
        <span class="token string">"      Try to use CUDA. The default value is 'no'. All default values\n"</span>
        <span class="token string">"      are for CPU mode.\n"</span>
        <span class="token string">"\nMotion Estimation Flags:\n"</span>
        <span class="token string">"  --work_megapix &lt;float>\n"</span>
        <span class="token string">"      Resolution for image registration step. The default is 0.6 Mpx.\n"</span>
        <span class="token string">"  --features (surf|orb)\n"</span>
        <span class="token string">"      Type of features used for images matching. The default is surf.\n"</span>
        <span class="token string">"  --matcher (homography|affine)\n"</span>
        <span class="token string">"      Matcher used for pairwise image matching.\n"</span>
        <span class="token string">"  --estimator (homography|affine)\n"</span>
        <span class="token string">"      Type of estimator used for transformation estimation.\n"</span>
        <span class="token string">"  --match_conf &lt;float>\n"</span>
        <span class="token string">"      Confidence for feature matching step. The default is 0.65 for surf and 0.3 for orb.\n"</span>
        <span class="token string">"  --conf_thresh &lt;float>\n"</span>
        <span class="token string">"      Threshold for two images are from the same panorama confidence.\n"</span>
        <span class="token string">"      The default is 1.0.\n"</span>
        <span class="token string">"  --ba (no|reproj|ray|affine)\n"</span>
        <span class="token string">"      Bundle adjustment cost function. The default is ray.\n"</span>
        <span class="token string">"  --ba_refine_mask (mask)\n"</span>
        <span class="token string">"      Set refinement mask for bundle adjustment. It looks like 'x_xxx',\n"</span>
        <span class="token string">"      where 'x' means refine respective parameter and '_' means don't\n"</span>
        <span class="token string">"      refine one, and has the following format:\n"</span>
        <span class="token string">"      &lt;fx>&lt;skew>&lt;ppx>&lt;aspect>&lt;ppy>. The default mask is 'xxxxx'. If bundle\n"</span>
        <span class="token string">"      adjustment doesn't support estimation of selected parameter then\n"</span>
        <span class="token string">"      the respective flag is ignored.\n"</span>
        <span class="token string">"  --wave_correct (no|horiz|vert)\n"</span>
        <span class="token string">"      Perform wave effect correction. The default is 'horiz'.\n"</span>
        <span class="token string">"  --save_graph &lt;file_name>\n"</span>
        <span class="token string">"      Save matches graph represented in DOT language to &lt;file_name> file.\n"</span>
        <span class="token string">"      Labels description: Nm is number of matches, Ni is number of inliers,\n"</span>
        <span class="token string">"      C is confidence.\n"</span>
        <span class="token string">"\nCompositing Flags:\n"</span>
        <span class="token string">"  --warp (affine|plane|cylindrical|spherical|fisheye|stereographic|compressedPlaneA2B1|compressedPlaneA1.5B1|compressedPlanePortraitA2B1|compressedPlanePortraitA1.5B1|paniniA2B1|paniniA1.5B1|paniniPortraitA2B1|paniniPortraitA1.5B1|mercator|transverseMercator)\n"</span>
        <span class="token string">"      Warp surface type. The default is 'spherical'.\n"</span>
        <span class="token string">"  --seam_megapix &lt;float>\n"</span>
        <span class="token string">"      Resolution for seam estimation step. The default is 0.1 Mpx.\n"</span>
        <span class="token string">"  --seam (no|voronoi|gc_color|gc_colorgrad)\n"</span>
        <span class="token string">"      Seam estimation method. The default is 'gc_color'.\n"</span>
        <span class="token string">"  --compose_megapix &lt;float>\n"</span>
        <span class="token string">"      Resolution for compositing step. Use -1 for original resolution.\n"</span>
        <span class="token string">"      The default is -1.\n"</span>
        <span class="token string">"  --expos_comp (no|gain|gain_blocks)\n"</span>
        <span class="token string">"      Exposure compensation method. The default is 'gain_blocks'.\n"</span>
        <span class="token string">"  --blend (no|feather|multiband)\n"</span>
        <span class="token string">"      Blending method. The default is 'multiband'.\n"</span>
        <span class="token string">"  --blend_strength &lt;float>\n"</span>
        <span class="token string">"      Blending strength from [0,100] range. The default is 5.\n"</span>
        <span class="token string">"  --output &lt;result_img>\n"</span>
        <span class="token string">"      The default is 'result.jpg'.\n"</span>
        <span class="token string">"  --timelapse (as_is|crop) \n"</span>
        <span class="token string">"      Output warped images separately as frames of a time lapse movie, with 'fixed_' prepended to input file names.\n"</span>
        <span class="token string">"  --rangewidth &lt;int>\n"</span>
        <span class="token string">"      uses range_width to limit number of images to match with.\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">// Default command line args</span>
vector<span class="token operator">&lt;</span>String<span class="token operator">></span> img_names<span class="token punctuation">;</span>
<span class="token keyword">bool</span> preview <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span> try_cuda <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> work_megapix <span class="token operator">=</span> <span class="token number">0.6</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> seam_megapix <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> compose_megapix <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> conf_thresh <span class="token operator">=</span> <span class="token number">1.f</span><span class="token punctuation">;</span>
string features_type <span class="token operator">=</span> <span class="token string">"surf"</span><span class="token punctuation">;</span>
string matcher_type <span class="token operator">=</span> <span class="token string">"homography"</span><span class="token punctuation">;</span>
string estimator_type <span class="token operator">=</span> <span class="token string">"homography"</span><span class="token punctuation">;</span>
string ba_cost_func <span class="token operator">=</span> <span class="token string">"ray"</span><span class="token punctuation">;</span>
string ba_refine_mask <span class="token operator">=</span> <span class="token string">"xxxxx"</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span> do_wave_correct <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
WaveCorrectKind wave_correct <span class="token operator">=</span> detail<span class="token double-colon punctuation">::</span>WAVE_CORRECT_HORIZ<span class="token punctuation">;</span>
<span class="token keyword">bool</span> save_graph <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>string save_graph_to<span class="token punctuation">;</span>
string warp_type <span class="token operator">=</span> <span class="token string">"spherical"</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> expos_comp_type <span class="token operator">=</span> ExposureCompensator<span class="token double-colon punctuation">::</span>GAIN_BLOCKS<span class="token punctuation">;</span>
<span class="token keyword">float</span> match_conf <span class="token operator">=</span> <span class="token number">0.3f</span><span class="token punctuation">;</span>
string seam_find_type <span class="token operator">=</span> <span class="token string">"gc_color"</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> blend_type <span class="token operator">=</span> Blender<span class="token double-colon punctuation">::</span>MULTI_BAND<span class="token punctuation">;</span>
<span class="token keyword">int</span> timelapse_type <span class="token operator">=</span> Timelapser<span class="token double-colon punctuation">::</span>AS_IS<span class="token punctuation">;</span>
<span class="token keyword">float</span> blend_strength <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
string result_name <span class="token operator">=</span> <span class="token string">"result.jpg"</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span> timelapse <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> range_width <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>


<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">parseCmdArgs</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--help"</span> <span class="token operator">||</span> <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"/?"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--preview"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            preview <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--try_cuda"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"no"</span><span class="token punctuation">)</span>
                try_cuda <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"yes"</span><span class="token punctuation">)</span>
                try_cuda <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad --try_cuda flag value\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--work_megapix"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            work_megapix <span class="token operator">=</span> <span class="token function">atof</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--seam_megapix"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            seam_megapix <span class="token operator">=</span> <span class="token function">atof</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--compose_megapix"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            compose_megapix <span class="token operator">=</span> <span class="token function">atof</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--result"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            result_name <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--features"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            features_type <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>features_type <span class="token operator">==</span> <span class="token string">"orb"</span><span class="token punctuation">)</span>
                match_conf <span class="token operator">=</span> <span class="token number">0.3f</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--matcher"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"homography"</span> <span class="token operator">||</span> <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"affine"</span><span class="token punctuation">)</span>
                matcher_type <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad --matcher flag value\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--estimator"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"homography"</span> <span class="token operator">||</span> <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"affine"</span><span class="token punctuation">)</span>
                estimator_type <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad --estimator flag value\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--match_conf"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            match_conf <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">atof</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--conf_thresh"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            conf_thresh <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">atof</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--ba"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            ba_cost_func <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--ba_refine_mask"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            ba_refine_mask <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_refine_mask<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">5</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Incorrect refinement mask length.\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--wave_correct"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"no"</span><span class="token punctuation">)</span>
                do_wave_correct <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"horiz"</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                do_wave_correct <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                wave_correct <span class="token operator">=</span> detail<span class="token double-colon punctuation">::</span>WAVE_CORRECT_HORIZ<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"vert"</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                do_wave_correct <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                wave_correct <span class="token operator">=</span> detail<span class="token double-colon punctuation">::</span>WAVE_CORRECT_VERT<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad --wave_correct flag value\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--save_graph"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            save_graph <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            save_graph_to <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--warp"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            warp_type <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--expos_comp"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"no"</span><span class="token punctuation">)</span>
                expos_comp_type <span class="token operator">=</span> ExposureCompensator<span class="token double-colon punctuation">::</span>NO<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"gain"</span><span class="token punctuation">)</span>
                expos_comp_type <span class="token operator">=</span> ExposureCompensator<span class="token double-colon punctuation">::</span>GAIN<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"gain_blocks"</span><span class="token punctuation">)</span>
                expos_comp_type <span class="token operator">=</span> ExposureCompensator<span class="token double-colon punctuation">::</span>GAIN_BLOCKS<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad exposure compensation method\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--seam"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"no"</span> <span class="token operator">||</span>
                <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"voronoi"</span> <span class="token operator">||</span>
                <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"gc_color"</span> <span class="token operator">||</span>
                <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"gc_colorgrad"</span> <span class="token operator">||</span>
                <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"dp_color"</span> <span class="token operator">||</span>
                <span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"dp_colorgrad"</span><span class="token punctuation">)</span>
                seam_find_type <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad seam finding method\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--blend"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"no"</span><span class="token punctuation">)</span>
                blend_type <span class="token operator">=</span> Blender<span class="token double-colon punctuation">::</span>NO<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"feather"</span><span class="token punctuation">)</span>
                blend_type <span class="token operator">=</span> Blender<span class="token double-colon punctuation">::</span>FEATHER<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"multiband"</span><span class="token punctuation">)</span>
                blend_type <span class="token operator">=</span> Blender<span class="token double-colon punctuation">::</span>MULTI_BAND<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad blending method\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--timelapse"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            timelapse <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"as_is"</span><span class="token punctuation">)</span>
                timelapse_type <span class="token operator">=</span> Timelapser<span class="token double-colon punctuation">::</span>AS_IS<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"crop"</span><span class="token punctuation">)</span>
                timelapse_type <span class="token operator">=</span> Timelapser<span class="token double-colon punctuation">::</span>CROP<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bad timelapse method\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--rangewidth"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            range_width <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--blend_strength"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            blend_strength <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">atof</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"--output"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            result_name <span class="token operator">=</span> argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
            img_names<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>preview<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        compose_megapix <span class="token operator">=</span> <span class="token number">0.6</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOG</span></span>
    int64 app_start_time <span class="token operator">=</span> <span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">setBreakOnError</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token keyword">int</span> retval <span class="token operator">=</span> <span class="token function">parseCmdArgs</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
        <span class="token keyword">return</span> retval<span class="token punctuation">;</span>

    <span class="token comment">// Check if have enough images</span>
    <span class="token keyword">int</span> num_images <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>img_names<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_images <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Need more images"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">double</span> work_scale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> seam_scale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> compose_scale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> is_work_scale_set <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> is_seam_scale_set <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> is_compose_scale_set <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Finding features..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOG</span></span>
    int64 t <span class="token operator">=</span> <span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    Ptr<span class="token operator">&lt;</span>FeaturesFinder<span class="token operator">></span> finder<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>features_type <span class="token operator">==</span> <span class="token string">"surf"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_OPENCV_XFEATURES2D</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>try_cuda <span class="token operator">&amp;&amp;</span> cuda<span class="token double-colon punctuation">::</span><span class="token function">getCudaEnabledDeviceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>SurfFeaturesFinderGpu<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>SurfFeaturesFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>features_type <span class="token operator">==</span> <span class="token string">"orb"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>OrbFeaturesFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Unknown 2D features type: '"</span> <span class="token operator">&lt;&lt;</span> features_type <span class="token operator">&lt;&lt;</span> <span class="token string">"'.\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    Mat full_img<span class="token punctuation">,</span> img<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>ImageFeatures<span class="token operator">></span> <span class="token function">features</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Mat<span class="token operator">></span> <span class="token function">images</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Size<span class="token operator">></span> <span class="token function">full_img_sizes</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> seam_work_aspect <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_images<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        full_img <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>img_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        full_img_sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> full_img<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>full_img<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Can't open image "</span> <span class="token operator">&lt;&lt;</span> img_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>work_megapix <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            img <span class="token operator">=</span> full_img<span class="token punctuation">;</span>
            work_scale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            is_work_scale_set <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_work_scale_set<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                work_scale <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>work_megapix <span class="token operator">*</span> <span class="token number">1e6</span> <span class="token operator">/</span> full_img<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                is_work_scale_set <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">resize</span><span class="token punctuation">(</span>full_img<span class="token punctuation">,</span> img<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> work_scale<span class="token punctuation">,</span> work_scale<span class="token punctuation">,</span> INTER_LINEAR_EXACT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_seam_scale_set<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            seam_scale <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>seam_megapix <span class="token operator">*</span> <span class="token number">1e6</span> <span class="token operator">/</span> full_img<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            seam_work_aspect <span class="token operator">=</span> seam_scale <span class="token operator">/</span> work_scale<span class="token punctuation">;</span>
            is_seam_scale_set <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token punctuation">(</span><span class="token operator">*</span>finder<span class="token punctuation">)</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> features<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        features<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>img_idx <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Features in image #"</span> <span class="token operator">&lt;&lt;</span> i<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span> <span class="token operator">&lt;&lt;</span> features<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>keypoints<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">resize</span><span class="token punctuation">(</span>full_img<span class="token punctuation">,</span> img<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seam_scale<span class="token punctuation">,</span> seam_scale<span class="token punctuation">,</span> INTER_LINEAR_EXACT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        images<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    finder<span class="token operator">-></span><span class="token function">collectGarbage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    full_img<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    img<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Finding features, time: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" sec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOG</span><span class="token punctuation">(</span><span class="token string">"Pairwise matching"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOG</span></span>
    t <span class="token operator">=</span> <span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    vector<span class="token operator">&lt;</span>MatchesInfo<span class="token operator">></span> pairwise_matches<span class="token punctuation">;</span>
    Ptr<span class="token operator">&lt;</span>FeaturesMatcher<span class="token operator">></span> matcher<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher_type <span class="token operator">==</span> <span class="token string">"affine"</span><span class="token punctuation">)</span>
        matcher <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>AffineBestOf2NearestMatcher<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> try_cuda<span class="token punctuation">,</span> match_conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>range_width<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        matcher <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>BestOf2NearestMatcher<span class="token operator">></span></span></span><span class="token punctuation">(</span>try_cuda<span class="token punctuation">,</span> match_conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        matcher <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>BestOf2NearestRangeMatcher<span class="token operator">></span></span></span><span class="token punctuation">(</span>range_width<span class="token punctuation">,</span> try_cuda<span class="token punctuation">,</span> match_conf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>matcher<span class="token punctuation">)</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> pairwise_matches<span class="token punctuation">)</span><span class="token punctuation">;</span>
    matcher<span class="token operator">-></span><span class="token function">collectGarbage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Pairwise matching, time: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" sec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check if we should save matches graph</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>save_graph<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Saving matches graph..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ofstream <span class="token function">f</span><span class="token punctuation">(</span>save_graph_to<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f <span class="token operator">&lt;&lt;</span> <span class="token function">matchesGraphAsString</span><span class="token punctuation">(</span>img_names<span class="token punctuation">,</span> pairwise_matches<span class="token punctuation">,</span> conf_thresh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Leave only images we are sure are from the same panorama</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> indices <span class="token operator">=</span> <span class="token function">leaveBiggestComponent</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> pairwise_matches<span class="token punctuation">,</span> conf_thresh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Mat<span class="token operator">></span> img_subset<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>String<span class="token operator">></span> img_names_subset<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Size<span class="token operator">></span> full_img_sizes_subset<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> indices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        img_names_subset<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>img_names<span class="token punctuation">[</span>indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        img_subset<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>images<span class="token punctuation">[</span>indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        full_img_sizes_subset<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>full_img_sizes<span class="token punctuation">[</span>indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    images <span class="token operator">=</span> img_subset<span class="token punctuation">;</span>
    img_names <span class="token operator">=</span> img_names_subset<span class="token punctuation">;</span>
    full_img_sizes <span class="token operator">=</span> full_img_sizes_subset<span class="token punctuation">;</span>

    <span class="token comment">// Check if we still have enough images</span>
    num_images <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>img_names<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_images <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Need more images"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    Ptr<span class="token operator">&lt;</span>Estimator<span class="token operator">></span> estimator<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>estimator_type <span class="token operator">==</span> <span class="token string">"affine"</span><span class="token punctuation">)</span>
        estimator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>AffineBasedEstimator<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        estimator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>HomographyBasedEstimator<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    vector<span class="token operator">&lt;</span>CameraParams<span class="token operator">></span> cameras<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>estimator<span class="token punctuation">)</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> pairwise_matches<span class="token punctuation">,</span> cameras<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Homography estimation failed.\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cameras<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        Mat R<span class="token punctuation">;</span>
        cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>R<span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R <span class="token operator">=</span> R<span class="token punctuation">;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Initial camera intrinsics #"</span> <span class="token operator">&lt;&lt;</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token string">":\nK:\n"</span> <span class="token operator">&lt;&lt;</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">K</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\nR:\n"</span> <span class="token operator">&lt;&lt;</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    Ptr<span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>BundleAdjusterBase<span class="token operator">></span> adjuster<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_cost_func <span class="token operator">==</span> <span class="token string">"reproj"</span><span class="token punctuation">)</span> adjuster <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>BundleAdjusterReproj<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_cost_func <span class="token operator">==</span> <span class="token string">"ray"</span><span class="token punctuation">)</span> adjuster <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>BundleAdjusterRay<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_cost_func <span class="token operator">==</span> <span class="token string">"affine"</span><span class="token punctuation">)</span> adjuster <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>BundleAdjusterAffinePartial<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_cost_func <span class="token operator">==</span> <span class="token string">"no"</span><span class="token punctuation">)</span> adjuster <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>NoBundleAdjuster<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Unknown bundle adjustment cost function: '"</span> <span class="token operator">&lt;&lt;</span> ba_cost_func <span class="token operator">&lt;&lt;</span> <span class="token string">"'.\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    adjuster<span class="token operator">-></span><span class="token function">setConfThresh</span><span class="token punctuation">(</span>conf_thresh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat_<span class="token operator">&lt;</span>uchar<span class="token operator">></span> refine_mask <span class="token operator">=</span> <span class="token class-name">Mat</span><span class="token double-colon punctuation">::</span><span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> CV_8U<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_refine_mask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'x'</span><span class="token punctuation">)</span> <span class="token function">refine_mask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_refine_mask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'x'</span><span class="token punctuation">)</span> <span class="token function">refine_mask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_refine_mask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'x'</span><span class="token punctuation">)</span> <span class="token function">refine_mask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_refine_mask<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'x'</span><span class="token punctuation">)</span> <span class="token function">refine_mask</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ba_refine_mask<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'x'</span><span class="token punctuation">)</span> <span class="token function">refine_mask</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    adjuster<span class="token operator">-></span><span class="token function">setRefinementMask</span><span class="token punctuation">(</span>refine_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>adjuster<span class="token punctuation">)</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> pairwise_matches<span class="token punctuation">,</span> cameras<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Camera parameters adjusting failed.\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Find median focal length</span>

    vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> focals<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cameras<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Camera #"</span> <span class="token operator">&lt;&lt;</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token string">":\nK:\n"</span> <span class="token operator">&lt;&lt;</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">K</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\nR:\n"</span> <span class="token operator">&lt;&lt;</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">)</span><span class="token punctuation">;</span>
        focals<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>focal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">sort</span><span class="token punctuation">(</span>focals<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> focals<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> warped_image_scale<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>focals<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        warped_image_scale <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>focals<span class="token punctuation">[</span>focals<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        warped_image_scale <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>focals<span class="token punctuation">[</span>focals<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> focals<span class="token punctuation">[</span>focals<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>do_wave_correct<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        vector<span class="token operator">&lt;</span>Mat<span class="token operator">></span> rmats<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cameras<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            rmats<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">waveCorrect</span><span class="token punctuation">(</span>rmats<span class="token punctuation">,</span> wave_correct<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cameras<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R <span class="token operator">=</span> rmats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Warping images (auxiliary)... "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOG</span></span>
    t <span class="token operator">=</span> <span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    vector<span class="token operator">&lt;</span>Point<span class="token operator">></span> <span class="token function">corners</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>UMat<span class="token operator">></span> <span class="token function">masks_warped</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>UMat<span class="token operator">></span> <span class="token function">images_warped</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Size<span class="token operator">></span> <span class="token function">sizes</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>UMat<span class="token operator">></span> <span class="token function">masks</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Preapre images masks</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_images<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        masks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CV_8U<span class="token punctuation">)</span><span class="token punctuation">;</span>
        masks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span><span class="token class-name">Scalar</span><span class="token double-colon punctuation">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Warp images and their masks</span>

    Ptr<span class="token operator">&lt;</span>WarperCreator<span class="token operator">></span> warper_creator<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_OPENCV_CUDAWARPING</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>try_cuda <span class="token operator">&amp;&amp;</span> cuda<span class="token double-colon punctuation">::</span><span class="token function">getCudaEnabledDeviceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"plane"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>PlaneWarperGpu<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"cylindrical"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CylindricalWarperGpu<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"spherical"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>SphericalWarperGpu<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"plane"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>PlaneWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"affine"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>AffineWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"cylindrical"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CylindricalWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"spherical"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>SphericalWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"fisheye"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>FisheyeWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"stereographic"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>StereographicWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"compressedPlaneA2B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CompressedRectilinearWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">2.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"compressedPlaneA1.5B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CompressedRectilinearWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">1.5f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"compressedPlanePortraitA2B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CompressedRectilinearPortraitWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">2.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"compressedPlanePortraitA1.5B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CompressedRectilinearPortraitWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">1.5f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"paniniA2B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>PaniniWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">2.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"paniniA1.5B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>PaniniWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">1.5f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"paniniPortraitA2B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>PaniniPortraitWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">2.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"paniniPortraitA1.5B1"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>PaniniPortraitWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">1.5f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"mercator"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>MercatorWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_type <span class="token operator">==</span> <span class="token string">"transverseMercator"</span><span class="token punctuation">)</span>
            warper_creator <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>TransverseMercatorWarper<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>warper_creator<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Can't create the following warper '"</span> <span class="token operator">&lt;&lt;</span> warp_type <span class="token operator">&lt;&lt;</span> <span class="token string">"'\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    Ptr<span class="token operator">&lt;</span>RotationWarper<span class="token operator">></span> warper <span class="token operator">=</span> warper_creator<span class="token operator">-></span><span class="token function">create</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>warped_image_scale <span class="token operator">*</span> seam_work_aspect<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_images<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        Mat_<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span> K<span class="token punctuation">;</span>
        cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">K</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> swa <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>seam_work_aspect<span class="token punctuation">;</span>
        <span class="token function">K</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*=</span> swa<span class="token punctuation">;</span> <span class="token function">K</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*=</span> swa<span class="token punctuation">;</span>
        <span class="token function">K</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*=</span> swa<span class="token punctuation">;</span> <span class="token function">K</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*=</span> swa<span class="token punctuation">;</span>

        corners<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> warper<span class="token operator">-></span><span class="token function">warp</span><span class="token punctuation">(</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> K<span class="token punctuation">,</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> INTER_LINEAR<span class="token punctuation">,</span> BORDER_REFLECT<span class="token punctuation">,</span> images_warped<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> images_warped<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        warper<span class="token operator">-></span><span class="token function">warp</span><span class="token punctuation">(</span>masks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> K<span class="token punctuation">,</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> INTER_NEAREST<span class="token punctuation">,</span> BORDER_CONSTANT<span class="token punctuation">,</span> masks_warped<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    vector<span class="token operator">&lt;</span>UMat<span class="token operator">></span> <span class="token function">images_warped_f</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_images<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        images_warped<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>images_warped_f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Warping images, time: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" sec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Ptr<span class="token operator">&lt;</span>ExposureCompensator<span class="token operator">></span> compensator <span class="token operator">=</span> <span class="token class-name">ExposureCompensator</span><span class="token double-colon punctuation">::</span><span class="token function">createDefault</span><span class="token punctuation">(</span>expos_comp_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    compensator<span class="token operator">-></span><span class="token function">feed</span><span class="token punctuation">(</span>corners<span class="token punctuation">,</span> images_warped<span class="token punctuation">,</span> masks_warped<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Ptr<span class="token operator">&lt;</span>SeamFinder<span class="token operator">></span> seam_finder<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>seam_find_type <span class="token operator">==</span> <span class="token string">"no"</span><span class="token punctuation">)</span>
        seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>NoSeamFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seam_find_type <span class="token operator">==</span> <span class="token string">"voronoi"</span><span class="token punctuation">)</span>
        seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>VoronoiSeamFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seam_find_type <span class="token operator">==</span> <span class="token string">"gc_color"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_OPENCV_CUDALEGACY</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>try_cuda <span class="token operator">&amp;&amp;</span> cuda<span class="token double-colon punctuation">::</span><span class="token function">getCudaEnabledDeviceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>GraphCutSeamFinderGpu<span class="token operator">></span></span></span><span class="token punctuation">(</span>GraphCutSeamFinderBase<span class="token double-colon punctuation">::</span>COST_COLOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>GraphCutSeamFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span>GraphCutSeamFinderBase<span class="token double-colon punctuation">::</span>COST_COLOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seam_find_type <span class="token operator">==</span> <span class="token string">"gc_colorgrad"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_OPENCV_CUDALEGACY</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>try_cuda <span class="token operator">&amp;&amp;</span> cuda<span class="token double-colon punctuation">::</span><span class="token function">getCudaEnabledDeviceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>GraphCutSeamFinderGpu<span class="token operator">></span></span></span><span class="token punctuation">(</span>GraphCutSeamFinderBase<span class="token double-colon punctuation">::</span>COST_COLOR_GRAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>GraphCutSeamFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span>GraphCutSeamFinderBase<span class="token double-colon punctuation">::</span>COST_COLOR_GRAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seam_find_type <span class="token operator">==</span> <span class="token string">"dp_color"</span><span class="token punctuation">)</span>
        seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>DpSeamFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span>DpSeamFinder<span class="token double-colon punctuation">::</span>COLOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seam_find_type <span class="token operator">==</span> <span class="token string">"dp_colorgrad"</span><span class="token punctuation">)</span>
        seam_finder <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>detail<span class="token double-colon punctuation">::</span>DpSeamFinder<span class="token operator">></span></span></span><span class="token punctuation">(</span>DpSeamFinder<span class="token double-colon punctuation">::</span>COLOR_GRAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>seam_finder<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Can't create the following seam finder '"</span> <span class="token operator">&lt;&lt;</span> seam_find_type <span class="token operator">&lt;&lt;</span> <span class="token string">"'\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    seam_finder<span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span>images_warped_f<span class="token punctuation">,</span> corners<span class="token punctuation">,</span> masks_warped<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Release unused memory</span>
    images<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    images_warped<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    images_warped_f<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    masks<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Compositing..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_LOG</span></span>
    t <span class="token operator">=</span> <span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    Mat img_warped<span class="token punctuation">,</span> img_warped_s<span class="token punctuation">;</span>
    Mat dilated_mask<span class="token punctuation">,</span> seam_mask<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> mask_warped<span class="token punctuation">;</span>
    Ptr<span class="token operator">&lt;</span>Blender<span class="token operator">></span> blender<span class="token punctuation">;</span>
    Ptr<span class="token operator">&lt;</span>Timelapser<span class="token operator">></span> timelapser<span class="token punctuation">;</span>
    <span class="token comment">//double compose_seam_aspect = 1;</span>
    <span class="token keyword">double</span> compose_work_aspect <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> img_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> img_idx <span class="token operator">&lt;</span> num_images<span class="token punctuation">;</span> <span class="token operator">++</span>img_idx<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Compositing image #"</span> <span class="token operator">&lt;&lt;</span> indices<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Read image and resize it if necessary</span>
        full_img <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>img_names<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_compose_scale_set<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>compose_megapix <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                compose_scale <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>compose_megapix <span class="token operator">*</span> <span class="token number">1e6</span> <span class="token operator">/</span> full_img<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            is_compose_scale_set <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token comment">// Compute relative scales</span>
            <span class="token comment">//compose_seam_aspect = compose_scale / seam_scale;</span>
            compose_work_aspect <span class="token operator">=</span> compose_scale <span class="token operator">/</span> work_scale<span class="token punctuation">;</span>

            <span class="token comment">// Update warped image scale</span>
            warped_image_scale <span class="token operator">*=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>compose_work_aspect<span class="token punctuation">)</span><span class="token punctuation">;</span>
            warper <span class="token operator">=</span> warper_creator<span class="token operator">-></span><span class="token function">create</span><span class="token punctuation">(</span>warped_image_scale<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Update corners and sizes</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_images<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token comment">// Update intrinsics</span>
                cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>focal <span class="token operator">*=</span> compose_work_aspect<span class="token punctuation">;</span>
                cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ppx <span class="token operator">*=</span> compose_work_aspect<span class="token punctuation">;</span>
                cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ppy <span class="token operator">*=</span> compose_work_aspect<span class="token punctuation">;</span>

                <span class="token comment">// Update corner and size</span>
                Size sz <span class="token operator">=</span> full_img_sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">abs</span><span class="token punctuation">(</span>compose_scale <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1e-1</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    sz<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token function">cvRound</span><span class="token punctuation">(</span>full_img_sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>width <span class="token operator">*</span> compose_scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sz<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token function">cvRound</span><span class="token punctuation">(</span>full_img_sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>height <span class="token operator">*</span> compose_scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                Mat K<span class="token punctuation">;</span>
                cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">K</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Rect roi <span class="token operator">=</span> warper<span class="token operator">-></span><span class="token function">warpRoi</span><span class="token punctuation">(</span>sz<span class="token punctuation">,</span> K<span class="token punctuation">,</span> cameras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">)</span><span class="token punctuation">;</span>
                corners<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> roi<span class="token punctuation">.</span><span class="token function">tl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> roi<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>compose_scale <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1e-1</span><span class="token punctuation">)</span>
            <span class="token function">resize</span><span class="token punctuation">(</span>full_img<span class="token punctuation">,</span> img<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> compose_scale<span class="token punctuation">,</span> compose_scale<span class="token punctuation">,</span> INTER_LINEAR_EXACT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            img <span class="token operator">=</span> full_img<span class="token punctuation">;</span>
        full_img<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Size img_size <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Mat K<span class="token punctuation">;</span>
        cameras<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">K</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Warp the current image</span>
        warper<span class="token operator">-></span><span class="token function">warp</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> K<span class="token punctuation">,</span> cameras<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> INTER_LINEAR<span class="token punctuation">,</span> BORDER_REFLECT<span class="token punctuation">,</span> img_warped<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Warp the current image mask</span>
        mask<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>img_size<span class="token punctuation">,</span> CV_8U<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mask<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span><span class="token class-name">Scalar</span><span class="token double-colon punctuation">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        warper<span class="token operator">-></span><span class="token function">warp</span><span class="token punctuation">(</span>mask<span class="token punctuation">,</span> K<span class="token punctuation">,</span> cameras<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> INTER_NEAREST<span class="token punctuation">,</span> BORDER_CONSTANT<span class="token punctuation">,</span> mask_warped<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Compensate exposure</span>
        compensator<span class="token operator">-></span><span class="token function">apply</span><span class="token punctuation">(</span>img_idx<span class="token punctuation">,</span> corners<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> img_warped<span class="token punctuation">,</span> mask_warped<span class="token punctuation">)</span><span class="token punctuation">;</span>

        img_warped<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>img_warped_s<span class="token punctuation">,</span> CV_16S<span class="token punctuation">)</span><span class="token punctuation">;</span>
        img_warped<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mask<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">dilate</span><span class="token punctuation">(</span>masks_warped<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> dilated_mask<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resize</span><span class="token punctuation">(</span>dilated_mask<span class="token punctuation">,</span> seam_mask<span class="token punctuation">,</span> mask_warped<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> INTER_LINEAR_EXACT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mask_warped <span class="token operator">=</span> seam_mask <span class="token operator">&amp;</span> mask_warped<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>blender <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>timelapse<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            blender <span class="token operator">=</span> <span class="token class-name">Blender</span><span class="token double-colon punctuation">::</span><span class="token function">createDefault</span><span class="token punctuation">(</span>blend_type<span class="token punctuation">,</span> try_cuda<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Size dst_sz <span class="token operator">=</span> <span class="token function">resultRoi</span><span class="token punctuation">(</span>corners<span class="token punctuation">,</span> sizes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span> blend_width <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>dst_sz<span class="token punctuation">.</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> blend_strength <span class="token operator">/</span> <span class="token number">100.f</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>blend_width <span class="token operator">&lt;</span> <span class="token number">1.f</span><span class="token punctuation">)</span>
                blender <span class="token operator">=</span> <span class="token class-name">Blender</span><span class="token double-colon punctuation">::</span><span class="token function">createDefault</span><span class="token punctuation">(</span>Blender<span class="token double-colon punctuation">::</span>NO<span class="token punctuation">,</span> try_cuda<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>blend_type <span class="token operator">==</span> Blender<span class="token double-colon punctuation">::</span>MULTI_BAND<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                MultiBandBlender<span class="token operator">*</span> mb <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>MultiBandBlender<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>blender<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mb<span class="token operator">-></span><span class="token function">setNumBands</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token function">log</span><span class="token punctuation">(</span>blend_width<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Multi-band blender, number of bands: "</span> <span class="token operator">&lt;&lt;</span> mb<span class="token operator">-></span><span class="token function">numBands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>blend_type <span class="token operator">==</span> Blender<span class="token double-colon punctuation">::</span>FEATHER<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                FeatherBlender<span class="token operator">*</span> fb <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>FeatherBlender<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>blender<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fb<span class="token operator">-></span><span class="token function">setSharpness</span><span class="token punctuation">(</span><span class="token number">1.f</span><span class="token operator">/</span>blend_width<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Feather blender, sharpness: "</span> <span class="token operator">&lt;&lt;</span> fb<span class="token operator">-></span><span class="token function">sharpness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            blender<span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span>corners<span class="token punctuation">,</span> sizes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timelapser <span class="token operator">&amp;&amp;</span> timelapse<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            timelapser <span class="token operator">=</span> <span class="token class-name">Timelapser</span><span class="token double-colon punctuation">::</span><span class="token function">createDefault</span><span class="token punctuation">(</span>timelapse_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            timelapser<span class="token operator">-></span><span class="token function">initialize</span><span class="token punctuation">(</span>corners<span class="token punctuation">,</span> sizes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Blend the current image</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timelapse<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            timelapser<span class="token operator">-></span><span class="token function">process</span><span class="token punctuation">(</span>img_warped_s<span class="token punctuation">,</span> <span class="token class-name">Mat</span><span class="token double-colon punctuation">::</span><span class="token function">ones</span><span class="token punctuation">(</span>img_warped_s<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CV_8UC1<span class="token punctuation">)</span><span class="token punctuation">,</span> corners<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String fixedFileName<span class="token punctuation">;</span>
            size_t pos_s <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>img_names<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find_last_of</span><span class="token punctuation">(</span><span class="token string">"/\\"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pos_s <span class="token operator">==</span> String<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                fixedFileName <span class="token operator">=</span> <span class="token string">"fixed_"</span> <span class="token operator">+</span> img_names<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                fixedFileName <span class="token operator">=</span> <span class="token string">"fixed_"</span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span>img_names<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>pos_s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span>img_names<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> pos_s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">imwrite</span><span class="token punctuation">(</span>fixedFileName<span class="token punctuation">,</span> timelapser<span class="token operator">-></span><span class="token function">getDst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            blender<span class="token operator">-></span><span class="token function">feed</span><span class="token punctuation">(</span>img_warped_s<span class="token punctuation">,</span> mask_warped<span class="token punctuation">,</span> corners<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timelapse<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        Mat result<span class="token punctuation">,</span> result_mask<span class="token punctuation">;</span>
        blender<span class="token operator">-></span><span class="token function">blend</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> result_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Compositing, time: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" sec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">imwrite</span><span class="token punctuation">(</span>result_name<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">LOGLN</span><span class="token punctuation">(</span><span class="token string">"Finished, total time: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> app_start_time<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" sec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="不能拼接的原因">不能拼接的原因</h5>
<p>  从上面的流程我们可知，如果要拼接成功，则首要条件是保证图片间图像重叠部分的特征点重合（匹配）的地方比较多。我们分析例子可知，特征点提取用的是SURF算法，我查阅资料可知：我认为，SURF算法主要提取的是一些突出点，比如轮廓边缘，角点。也就是说，特征点出现位置，一般都在有形状的地方或者形状变化明显的地方。</p>
<p>  而我拼接不成功的原因是，我图像中大部分区域都为纯白色的天花板，导致整体特征点比较少，图像重叠部分的特征点也较少，导致其匹配特征点的时候失败了。而我，改变了几个相机之间的固定视角后，总算是Stitcher类的默认算法都能拼接了。</p>
<br/>
<br/>
<h5 id="解决思路">解决思路</h5>
<p>  用上面例子的提取特征点的源码，然后把每张图的特征点画出来，观察一下特征点的情况，根据实际情况分析和调整。</p>
<p>  例如下图：经过实验发现，Stitcher算法要拼接成功的要素是图间的重叠部分的特征点 重叠度和重叠数量要达到一个阈值才行。（此图就是用上面的源码，提取特征，并在原图上把图画出来）</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_063/img.png" alt="rep_img"/></center>
    </div>
</div>    
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  opencv关于图像拼接的东西基本上整个原理都在例子中的cpp中，需要的时候，可以对此cpp文件结合网上大多数资料进行分析。</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/05/15/blog_idx_062/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/05/15/blog_idx_062/" class="post-title-link" itemprop="url">NVIDIA Jestson TX2 配置cuda以及cudnn的坑 ( JetPack-L4T 、Error: downloading update lock、TX2,TX1,TK1相关资源信息)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-05-15 15:00:57" itemprop="dateCreated datePublished" datetime="2018-05-15T15:00:57+08:00">2018-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/DL/" itemprop="url" rel="index"><span itemprop="name">DL</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>889</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 16:46:17
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=062） 
&emsp;&emsp;本文发布于 2018-05-15 15:00:57，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=062） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  主机信息 Linux 4.13.0-41-generic #46~16.04.1-Ubuntu SMP Thu May 3 10:06:43 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</p>
<h3 id="前言">前言</h3>
<hr>
<p>  无</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="Jestson-TX2-配置">Jestson TX2 配置</h3>
<hr>
<br/>
<br/>
<h5 id="JetPack-L4T-资源信息（TX2-TX1-TK1）">JetPack-L4T 资源信息（TX2,TX1,TK1）</h5>
<p>  JetPack-L4T-3.0</p>
<p>  资源地址：<a target="_blank" rel="noopener" href="https://download.csdn.net/download/u011728480/10415628">https://download.csdn.net/download/u011728480/10415628</a></p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_062/jetpack.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  JetPack-L4T-3.1</p>
<p>  资源地址：<a target="_blank" rel="noopener" href="https://download.csdn.net/download/u011728480/10415640">https://download.csdn.net/download/u011728480/10415640</a></p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_062/jetpack1.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  JetPack-L4T-3.2，截止发文时，3.2用的依然是3.1的资源信息。</p>
<br/>
<br/>
<h5 id="官方配置流程">官方配置流程</h5>
<p>  就是使用JetPack-L4T工具按照流程进行相关的配置，即可完成全部安装。</p>
<br/>
<br/>
<h5 id="民间配置流程">民间配置流程</h5>
<p>  首先下载上面我提供的资源压缩包，解压，然后打开repository.json文件，这里面包含了此版本关于TX2,TX1,TK1的所有资源地址信息。（此文件稍微分析一下即可得到地址）</p>
<p>  这里我需要的是cuda8.0和cudnn5.1</p>
<p>  关于TX2，JetPack 3.0 的cuda和cudnn地址分别是：(在repository.json文件)</p>
<p>  cuda:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="http://developer.download.nvidia.com/devzone/devcenter/mobile/jetpack_l4t/009/linux-x64/cuda-repo-l4t-8-0-local_8.0.64-1_arm64.deb">http://developer.download.nvidia.com/devzone/devcenter/mobile/jetpack_l4t/009/linux-x64/cuda-repo-l4t-8-0-local_8.0.64-1_arm64.deb</a></p>
</li>
</ul>
<p>  cudnn:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="http://developer.download.nvidia.com/devzone/devcenter/mobile/jetpack_l4t/009/linux-x64/libcudnn5_5.1.10-1+cuda8.0_arm64.deb">http://developer.download.nvidia.com/devzone/devcenter/mobile/jetpack_l4t/009/linux-x64/libcudnn5_5.1.10-1+cuda8.0_arm64.deb</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="http://developer.download.nvidia.com/devzone/devcenter/mobile/jetpack_l4t/011/linux-x64/libcudnn5-dev_5.1.10-1+cuda8.0_arm64.deb">http://developer.download.nvidia.com/devzone/devcenter/mobile/jetpack_l4t/011/linux-x64/libcudnn5-dev_5.1.10-1+cuda8.0_arm64.deb</a></p>
</li>
</ul>
<p>  下载以上三个包，然后在tx2上，dpkg 安装这三个包,然后：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update

<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> cuda-toolkit-8-0 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>  最后把/usr/local/cuda/bin/添加到PATH变量</p>
<p>  这样cuda及cudnn就配置完成。其他相关包可参照如此配置。</p>
<p>  友情提示：</p>
<p>    下载以上包时最好使用迅雷或者开代理进行下载，否则可能会出现被墙的可能性。</p>
<br/>
<br/>
<h5 id="Error-downloading-update-lock">Error:  downloading update lock</h5>
<p>  错误：一直卡downloading update lock  ，最后Error原因：就是大中华防火墙给墙了此信息下载地址（某些电信运营商才会出现，比如我公司移动运营商）</p>
<p>  解决方案：</p>
<ol>
<li class="lvl-4">
<p>开启代理后，按照官方教程走。</p>
</li>
<li class="lvl-3">
<p>使用我上文提供的信息下载相关资源，按照民间教程进行配置。</p>
</li>
</ol>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/05/11/blog_idx_061/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/05/11/blog_idx_061/" class="post-title-link" itemprop="url">FFmpeg 基本操作摘要(一) （转流、解码、编码）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-05-11 15:47:25" itemprop="dateCreated datePublished" datetime="2018-05-11T15:47:25+08:00">2018-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E5%8F%8A%E6%B5%81%E5%AA%92%E4%BD%93/" itemprop="url" rel="index"><span itemprop="name">视频处理及流媒体</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 16:37:45
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=061） 
&emsp;&emsp;本文发布于 2018-05-11 15:47:25，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=061） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  近一段时间来，自己的主要工作都在是在做数据源端（设备端）音视频传输、编解码相关的事情，于是逐渐又和FFmpeg打上了交到，用到了其中的一些常见的内容，同时也解决了一些不常见的事情。</p>
<p><font color = red >同时这里表达对“”“”雷神“”“”的敬意（一路走好，雷神），其blog上相关的FFmpeg教程是我学习FFmpeg的启蒙教程，其的blog可以不夸张的说，是国内非常非常非常好非常非常非常好非常非常非常好的音视频相关入门教程了，建议搞音视频的人可以多参考。这里提供一个链接指向雷神的博客地址，供大家参考（需从零学习FFmpeg，请参考其FFmpeg专栏）：<a target="_blank" rel="noopener" href="https://blog.csdn.net/leixiaohua1020">https://blog.csdn.net/leixiaohua1020</a> </font></p>
<br/>
<br/>
<br/>
<br/>
<h3 id="FFmpeg-相关内容简介">FFmpeg 相关内容简介</h3>
<hr>
<br/>
<br/>
<h5 id="FFmpeg常用结构体">FFmpeg常用结构体</h5>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">AVFormatContext   
&#x2F;&#x2F;Format I&#x2F;O context.（FFmpeg中的IO流的格式容器，具体来说就是用来记录打开的流的格式相关信息，列如：记录打开的rtsp流中的音视频流格式信息、MP4
文件的流格式信息等等）
AVCodecContext    &#x2F;&#x2F;FFmpeg中记录编码器相关信息的容器

AVCodec  &#x2F;&#x2F;FFmpeg 中编码器容器

AVFrame &#x2F;&#x2F;This structure describes decoded (raw) audio or video data.（FFmpeg中用于描述裸音视频数据的容器，列如：视频中的YUV数据，音频中的PCM数据）

AVPacket  &#x2F;&#x2F; This structure stores compressed data. It is typically exported by demuxers
 &#x2F;&#x2F;and then passed as input to decoders, or received as output from encoders and
 &#x2F;&#x2F;then passed to muxers.(此结构体用于描述音视频编码后的数据，主要用在把编码后的数据送入解码器或者接收编码器输出的数据，列如：视频中的H264数据, 音频中的：G711A数据)

SwsContext &#x2F;&#x2F;图像缩放和变换的关键容器
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="FFmpeg中常见调用">FFmpeg中常见调用</h5>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">void av_register_all(void); &#x2F;&#x2F; Initialize libavformat and register all the muxers, demuxers and
 &#x2F;&#x2F; protocols. If you do not call this function, then you can select
 &#x2F;&#x2F; exactly which formats you want to support.
 &#x2F;&#x2F;FFmpeg 中用于初始化libavformat 库，注册音视频复用器，各种协议等等。 这里需要注意的是，许多没有用到了内容都注册了，可能造成浪费，若需要指定注册哪些内容，可参考av_register_output_format（）、av_register_input_format（）


int avformat_network_init(void); &#x2F;&#x2F;此函数用于初始化网络相关的组件，列如：你要解析RTSP流，需要先调用此函数
&#x2F;**
 * Do global initialization of network components. This is optional,
 * but recommended, since it avoids the overhead of implicitly
 * doing the setup for each session.
 *
 * Calling this function will become mandatory if using network
 * protocols at some major version bump.
 *&#x2F;

AVFormatContext *avformat_alloc_context(void); &#x2F;&#x2F;为AVFormatContext分配空间
void avformat_free_context(AVFormatContext *s); &#x2F;&#x2F;释放AVFormatContext空间

int avformat_open_input(AVFormatContext **ps, const char *filename, AVInputFormat *fmt, AVDictionary **options);&#x2F;&#x2F;Open an input stream and read the header.


int avio_open(AVIOContext **s, const char *url, int flags); &#x2F;&#x2F; 用于初始化AVIOContext，此结构体用于文件的读写操作
 &#x2F;&#x2F;* Create and initialize a AVIOContext for accessing the
 &#x2F;&#x2F;* resource indicated by url.

int avio_close(AVIOContext *s); &#x2F;&#x2F;释放一个AVIOContext对象

int avformat_find_stream_info(AVFormatContext *ic, AVDictionary **options); &#x2F;&#x2F;读取流数据，分析流信息
&#x2F;&#x2F;Read packets of a media file to get stream information. 

void av_dump_format(AVFormatContext *ic,
                    int index,
                    const char *url,
                    int is_output);&#x2F;&#x2F;就是打印一下AVFormatContext 里面存放的一些我们关心的信息
 &#x2F;*
  * Print detailed information about the input or output format, such as
 * duration, bitrate, streams, container, programs, metadata, side data,
 * codec and time base.
*&#x2F;


AVCodec *avcodec_find_decoder(enum AVCodecID id);查找一个解码器
&#x2F;&#x2F;Find a registered decoder with a matching codec ID.

int avcodec_open2(AVCodecContext *avctx, const AVCodec *codec, AVDictionary **options);&#x2F;&#x2F;初始化一个编码器，初始化此结构体AVCodecContext 

&#x2F;*
 * Initialize the AVCodecContext to use the given AVCodec. Prior to using this
 * function the context has to be allocated with avcodec_alloc_context3().
*&#x2F;

int avcodec_close(AVCodecContext *avctx);&#x2F;&#x2F;释放AVCodecContext 空间

int av_read_frame(AVFormatContext *s, AVPacket *pkt);&#x2F;&#x2F;返回下一帧，数据（编码后的数据）存放到pkt里面，这里会给AVPacket 分配空间，此处一定要释放，否则将会发生内存泄漏
&#x2F;&#x2F;Return the next frame of a stream.

int av_new_packet(AVPacket *pkt, int size);&#x2F;&#x2F;给AVPacket buf成员分配空间，同理上文
&#x2F;*
 * Allocate the payload of a packet and initialize its fields with
 * default values.
*&#x2F;
void av_free_packet(AVPacket *pkt);&#x2F;&#x2F;释放AVPacket 

AVFrame *av_frame_alloc(void);&#x2F;&#x2F;申请AVFrame空间 
void av_frame_free(AVFrame **frame);&#x2F;&#x2F;释放AVFrame空间 

void *av_malloc(size_t size);&#x2F;&#x2F;ffmpeg中申请一定大小的内存空间
void av_free(void *ptr);&#x2F;&#x2F;释放空间
&#x2F;&#x2F;av_malloc  av_free是对malloc和free的封装，本质就是基础内存操作

struct SwsContext *sws_getContext(int srcW, int srcH, enum AVPixelFormat srcFormat,
                                  int dstW, int dstH, enum AVPixelFormat dstFormat,
                                  int flags, SwsFilter *srcFilter,
                                  SwsFilter *dstFilter, const double *param);&#x2F;&#x2F;创建一个指定大小和颜色空间的SwsContext 
&#x2F;*
 * Allocate and return an SwsContext. You need it to perform
 * scaling&#x2F;conversion operations using sws_scale().
*&#x2F;

int sws_scale(struct SwsContext *c, const uint8_t *const srcSlice[],
              const int srcStride[], int srcSliceY, int srcSliceH,
              uint8_t *const dst[], const int dstStride[]);&#x2F;&#x2F;根据指定SwsContext ，来对原始图像进行变换
&#x2F;*
 * Scale the image slice in srcSlice and put the resulting scaled
 * slice in the image in dst. A slice is a sequence of consecutive
 * rows in an image.
*&#x2F;

int avcodec_decode_video2(AVCodecContext *avctx, AVFrame *picture,
                         int *got_picture_ptr,
                         const AVPacket *avpkt);&#x2F;&#x2F;对一帧数据进行解码
&#x2F; * Decode the video frame of size avpkt-&gt;size from avpkt-&gt;data into picture.
 * Some decoders may support multiple frames in a single AVPacket, such
 * decoders would then just decode the first frame.
 * &#x2F;
int avcodec_encode_video2(AVCodecContext *avctx, AVPacket *avpkt,
                          const AVFrame *frame, int *got_packet_ptr);&#x2F;&#x2F;对一帧数据进行编码
                          
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="FFmpeg中需要注意的事项">FFmpeg中需要注意的事项</h5>
<p>  FFmpeg中除了正常使用外，需要我们注意的就是内存泄漏的问题了。</p>
<p>  这里我们需要关注几个问题：</p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;*
对于以下的结构体，一定要重点关注，申请了内存，一定要释放，否则在循环调用一些内容时，一定会发生内存泄漏。
AVFormatContext   
AVCodecContext    
AVCodec  
AVFrame 
AVPacket  

其中我们需要核心关注AVPacket这个结构体，这个结构体很容易让我们懵逼，出现内存泄漏。
av_read_frame
av_new_packet
上面两个都会申请内存，需要我们释放内存
av_free_packet
av_packet_unref
由于AVPacket 设计为缓冲区计数的方式，实现了一定的数据共享，方便FFmpeg管理内存，但是这里也给我们埋下了地雷：那就是AVPacket的生命周期就不好确定了，因为你调用了以上的函数，而内存不一定释放了。关于AVPacket还有许多函数，比如av_copy_packet、av_packet_ref、av_init_packet等，使用它们一定要小心，如果需要深入研究，建议查看它们的源码，这样就能够对这些调用有了更深刻的理解。
*&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  这里我再多说一句：由于FFmpeg2 和FFmpeg3有巨大的区别，很多东西也发生了变化，网上的教程很多是FFmpeg3以后的，使用的时候需要注意。同时，FFmpeg真的一不留神就发生内存泄漏了，需要我们注意。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="FFmpeg-使用的一般流程">FFmpeg 使用的一般流程</h3>
<hr>
<br/>
<br/>
<h5 id="解码过程">解码过程</h5>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">av_register_all  
avformat_network_init
avformat_alloc_context&#x2F;&#x2F;初始化AVFormatContext
avformat_open_input &#x2F;&#x2F;打开流
avformat_find_stream_info &#x2F;&#x2F;读取流信息
avcodec_find_decoder &#x2F;&#x2F;根据上调用来确定编码器id，然后来查找相关编码器
avcodec_open2 &#x2F;&#x2F;打开编码器，初始化AVCodecContext    
av_read_frame &#x2F;&#x2F;读取一帧压缩数据
avcodec_decode_video2 &#x2F;&#x2F;解压一帧数据
sws_scale &#x2F;&#x2F;数据转换
&#x2F;&#x2F;后续对原始音视频数据进行相关处理<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="编码过程">编码过程</h5>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">av_register_all  
avformat_network_init
avformat_alloc_context
avio_open
avformat_new_stream
&#x2F;&#x2F;这里通过相关方法把原始音视频数据准备好
avcodec_find_decoder &#x2F;&#x2F;根据上调用来确定编码器id，然后来查找相关编码器
avcodec_open2 &#x2F;&#x2F;打开编码器，初始化AVCodecContext   
avcodec_encode_video2 &#x2F;&#x2F;编码
&#x2F;&#x2F;后续处理编码后的事情 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="转流过程">转流过程</h5>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">av_register_all  
avformat_network_init
avformat_alloc_context&#x2F;&#x2F;初始化AVFormatContext
avformat_open_input &#x2F;&#x2F;打开流
avformat_find_stream_info &#x2F;&#x2F;读取流信息
avcodec_find_decoder &#x2F;&#x2F;根据上调用来确定编码器id，然后来查找相关编码器
avcodec_open2 &#x2F;&#x2F;打开编码器，初始化AVCodecContext    
av_read_frame &#x2F;&#x2F;读取一帧压缩数据
&#x2F;&#x2F;这里对av_read_frame 中的pkt data数据域和size数据域进行处理即可<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/05/10/blog_idx_060/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/05/10/blog_idx_060/" class="post-title-link" itemprop="url">《基础数据结构-排序》之交换排序</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-05-10 11:21:42" itemprop="dateCreated datePublished" datetime="2018-05-10T11:21:42+08:00">2018-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">数据结构与算法</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 18:59:16
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=060） 
&emsp;&emsp;本文发布于 2018-05-10 11:21:42，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=060） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  MEM:2GB</p>
<p>  CPU:Intel® Core™ i5-7400 CPU @ 3.00GHz × 4</p>
<p>  SYSTEM:Linux 4.13.0-38-generic #43~16.04.1-Ubuntu SMP Wed Mar 14 17:48:43 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux（虚拟机）</p>
<p>  测试数据（100000条数据，数据范围1-100000）下载链接：<a target="_blank" rel="noopener" href="https://download.csdn.net/download/u011728480/10399194">https://download.csdn.net/download/u011728480/10399194</a></p>
<h3 id="前言">前言</h3>
<hr>
<p>  此系列大概会有三类文章，包括我在学校不太掌握的三种类型的相关算法，分别为排序、树、图中的基础算法。这里主要对这些算法进行一个巩固，期望使自己的相关技术有一定的提高。</p>
<p>  排序算法要解决的问题是：把一系列已存在的数据（乱序），按照一定规律（有序）进行存放。我们常见的就是数字的按照其大小进行排序。排序按照其实现的核心原理分为约4中类型：交换排序、插入排序、选择排序和归并排序。下面依次对这些排序进行说明和总结。</p>
<p>  ps：上面内容都是扯淡，大佬直接忽略。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="交换排序">交换排序</h3>
<hr>
<p>  交换排序有两种常见算法：冒泡排序和快速排序</p>
<br/>
<br/>
<h5 id="冒泡排序">冒泡排序</h5>
<p>  就是遍历，交换。把符合某规律的数据元素交换到数据顶端（有条件的末端），重复此过程，直到数据序列有序为止。</p>
<p>  使用上文数据进行排序，结果如图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_060/bubble_sort.png" alt="rep_img"/></center>
    </div>
</div>    
<p>  平均时间复杂度：O(n ^ 2)</p>
<p>  空间复杂度：O(1)</p>
<p>  实现代码（下面算法是未做任何优化的，一种优化方法为：如果为发生数据交换，则数据有序且退出整个循环）：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*

worst time:
surrounding loop=n-1
compare=n(n-1)/2  (等差数列求和，1,2....n-1)
exchange=3n(n-1)/2 (等差数列求和，1,2....n-1,每次交换3次)

best time:(针对此代码，未优化)
surrounding loop=n-1
compare=n(n-1)/2
exchange=0


average-time:O(n ^ 2)
space:O(1)

*/</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional></span></span>


<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">T1</span><span class="token operator">></span>
<span class="token keyword">int</span> <span class="token function">bubble_sort</span><span class="token punctuation">(</span>T <span class="token operator">*</span> <span class="token keyword">const</span> head<span class="token punctuation">,</span> <span class="token keyword">const</span> T1 <span class="token operator">&amp;</span>len<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span><span class="token punctuation">,</span> T<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">></span> swap_func <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//int bubble_sort(T * const head, const T1 &amp;len, void (*swap_func)(T&amp;,T&amp;) = nullptr)&#123;</span>

	<span class="token comment">//data_len data_tmp must init for type deduction</span>
	<span class="token keyword">auto</span> data_len <span class="token operator">=</span> len<span class="token punctuation">;</span><span class="token comment">//</span>
	<span class="token keyword">auto</span> data_tmp <span class="token operator">=</span> <span class="token operator">*</span>head<span class="token punctuation">;</span><span class="token comment">//</span>
	<span class="token keyword">auto</span> i <span class="token operator">=</span> len<span class="token punctuation">,</span>j <span class="token operator">=</span> len<span class="token punctuation">;</span>
	<span class="token comment">//len-1 traverse</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> data_len<span class="token punctuation">;</span> j <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//n-1</span>
		
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data_len <span class="token operator">-</span>j<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">nullptr</span> <span class="token operator">!=</span> swap_func <span class="token punctuation">)</span>
				<span class="token function">swap_func</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>head<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>head<span class="token operator">+</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span><span class="token punctuation">&#123;</span>
		
				<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>head<span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">*</span><span class="token punctuation">(</span>head<span class="token operator">+</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			
					data_tmp <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>head<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token operator">*</span><span class="token punctuation">(</span>head<span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>head<span class="token operator">+</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token operator">*</span><span class="token punctuation">(</span>head<span class="token operator">+</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> data_tmp<span class="token punctuation">;</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span> 
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DATA_LEN</span> <span class="token expression"><span class="token number">100000</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argv<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argc<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	
	<span class="token keyword">long</span> <span class="token operator">*</span> buffer<span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>filebuf <span class="token operator">*</span>pbuf<span class="token punctuation">;</span>  
	std<span class="token double-colon punctuation">::</span>ifstream in<span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>ofstream out<span class="token punctuation">;</span>
	in<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"data.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assert</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span>DATA_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

	std<span class="token double-colon punctuation">::</span>string data<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> idx <span class="token operator">&lt;</span> DATA_LEN<span class="token punctuation">;</span> idx<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			
		<span class="token function">getline</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token operator">*</span><span class="token punctuation">(</span>buffer<span class="token operator">+</span>idx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">atol</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>time_point<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>high_resolution_clock<span class="token operator">></span> p0 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>high_resolution_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">bubble_sort</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> DATA_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>time_point<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>high_resolution_clock<span class="token operator">></span> p1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>high_resolution_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"stitch high_resolution_clock time:"</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">duration_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>microseconds<span class="token operator">></span></span></span><span class="token punctuation">(</span>p1 <span class="token operator">-</span> p0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ms"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    	
	out<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"bubble_sort.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assert</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">for</span> <span class="token punctuation">(</span>idx <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> idx <span class="token operator">&lt;</span> DATA_LEN<span class="token punctuation">;</span> idx<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			
		out<span class="token operator">&lt;&lt;</span><span class="token operator">*</span><span class="token punctuation">(</span>buffer<span class="token operator">+</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
		out<span class="token operator">&lt;&lt;</span><span class="token string">"\n"</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
  	<span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>buffer<span class="token punctuation">;</span>  
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="快速排序">快速排序</h5>
<p>  选定一个基准数（一般为第一个数），然后把小于此数的数放到其左边，大于此数放到右边，这时，此数组被分为了两组。然后分别对这两组数进行同样的操作，直到数无法继续分组为止。</p>
<p>  使用上文数据进行排序，结果如图：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_060/quick_sort.png" alt="rep_img"/></center>
    </div>
</div>   
<p>  平均时间复杂度：O(nlog(n))<br>
  空间复杂度：O(log(n)~n)<br>
  实现代码：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*
worst time:O(n^2)
(每次我们指定的分割数是数列里面最大，或者最小，这样导致只会把一个数放到了正确的位置，类似选择排序或者冒泡排序，由于是递归调用，可参考二叉树结构分析)

（此时二叉树结构为最不平衡的二叉树，退化为一条线）
compare=n(n-1)/2(第一次比较n-1,第二次比较n-2  ...   1)
exchange=n(n-1)/2

best time: nlog(n) (注意，取的是数量级)
(参考平衡二叉树)
tree-deepth=log(n)
compare=(n/2)(1-(0.5^n))/(1-0.5) (等比数列求和,n/2 , n/4, ... n/2^n)
exchange=0


average-time:O(nlog(n)) (这里要用什么来证明一下，我搞不清楚原理了)
space:O(log(n)~n)(最坏时间为n(递归深度n)，最优时间为log(n)(递归深度log(n)))

*/</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional></span></span>


<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">T1</span><span class="token operator">></span>
<span class="token keyword">int</span> <span class="token function">quick_sort</span><span class="token punctuation">(</span>T <span class="token operator">*</span> <span class="token keyword">const</span> head<span class="token punctuation">,</span> T1 low<span class="token punctuation">,</span> T1 high<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token function">T1</span><span class="token punctuation">(</span>T <span class="token operator">*</span> <span class="token keyword">const</span><span class="token punctuation">,</span> T1 <span class="token punctuation">,</span> T1 <span class="token punctuation">)</span><span class="token operator">></span> split_func<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//int bubble_sort(T * const head, const T1 &amp;len, void (*swap_func)(T&amp;,T&amp;) = nullptr)&#123;</span>

	<span class="token comment">//split must init for type deduction</span>
	<span class="token keyword">auto</span> split <span class="token operator">=</span> low<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;</span> high<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		split <span class="token operator">=</span>  <span class="token function">split_func</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> low<span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//split into two arrary and get split val </span>
		<span class="token function">quick_sort</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> low<span class="token punctuation">,</span> split<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> split_func<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//deal &lt; split </span>
		<span class="token function">quick_sort</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> split<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">,</span> split_func<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//deal > split </span>
		
	<span class="token punctuation">&#125;</span>
		
	
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">long</span> <span class="token keyword">int</span> <span class="token function">split_func_imp</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">int</span> <span class="token operator">*</span> <span class="token keyword">const</span> head<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	
	<span class="token keyword">auto</span> split_val <span class="token operator">=</span> head<span class="token punctuation">[</span>low<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> low <span class="token operator">&lt;</span> high <span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		
		<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> low <span class="token operator">&lt;</span> high <span class="token operator">&amp;&amp;</span> head<span class="token punctuation">[</span>high<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> split_val <span class="token punctuation">;</span> <span class="token punctuation">)</span>
			high<span class="token operator">--</span><span class="token punctuation">;</span>
		head<span class="token punctuation">[</span>low<span class="token punctuation">]</span> <span class="token operator">=</span> head<span class="token punctuation">[</span>high<span class="token punctuation">]</span><span class="token punctuation">;</span>
		
		<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> low <span class="token operator">&lt;</span> high <span class="token operator">&amp;&amp;</span> head<span class="token punctuation">[</span>low<span class="token punctuation">]</span> <span class="token operator">>=</span> split_val <span class="token punctuation">;</span> <span class="token punctuation">)</span>
			low<span class="token operator">++</span><span class="token punctuation">;</span>
		head<span class="token punctuation">[</span>high<span class="token punctuation">]</span> <span class="token operator">=</span> head<span class="token punctuation">[</span>low<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	head<span class="token punctuation">[</span>low<span class="token punctuation">]</span> <span class="token operator">=</span> split_val<span class="token punctuation">;</span>
	<span class="token keyword">return</span> low<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DATA_LEN</span> <span class="token expression"><span class="token number">100000</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argv<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argc<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	
	<span class="token keyword">long</span> <span class="token operator">*</span> buffer<span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>filebuf <span class="token operator">*</span>pbuf<span class="token punctuation">;</span>  
	std<span class="token double-colon punctuation">::</span>ifstream in<span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>ofstream out<span class="token punctuation">;</span>
	in<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"data.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assert</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span>DATA_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

	std<span class="token double-colon punctuation">::</span>string data<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> idx <span class="token operator">&lt;</span> DATA_LEN<span class="token punctuation">;</span> idx<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			
		<span class="token function">getline</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token operator">*</span><span class="token punctuation">(</span>buffer<span class="token operator">+</span>idx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">atol</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> low <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> high <span class="token operator">=</span> DATA_LEN<span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">long</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">int</span> <span class="token operator">*</span> <span class="token keyword">const</span><span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">int</span> <span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">int</span> <span class="token punctuation">)</span><span class="token operator">></span> func <span class="token operator">=</span> split_func_imp<span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>time_point<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>high_resolution_clock<span class="token operator">></span> p0 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>high_resolution_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">quick_sort</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> low<span class="token punctuation">,</span> high<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>time_point<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>high_resolution_clock<span class="token operator">></span> p1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>high_resolution_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"stitch high_resolution_clock time:"</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">duration_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>microseconds<span class="token operator">></span></span></span><span class="token punctuation">(</span>p1 <span class="token operator">-</span> p0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ms"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    	
	out<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"quick_sort.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assert</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">for</span> <span class="token punctuation">(</span>idx <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> idx <span class="token operator">&lt;</span> DATA_LEN<span class="token punctuation">;</span> idx<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			
		out<span class="token operator">&lt;&lt;</span><span class="token operator">*</span><span class="token punctuation">(</span>buffer<span class="token operator">+</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
		out<span class="token operator">&lt;&lt;</span><span class="token string">"\n"</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
  	<span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>buffer<span class="token punctuation">;</span>  
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://e-x.top/2018/04/04/blog_idx_059/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sky's Blogs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Sky's Blogs">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/04/04/blog_idx_059/" class="post-title-link" itemprop="url">关于C++ 多态实现技术的深度解析（vfptr,vftable）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-04-04 17:05:21" itemprop="dateCreated datePublished" datetime="2018-04-04T17:05:21+08:00">2018-04-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-18 19:06:02" itemprop="dateModified" datetime="2024-05-18T19:06:02+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C-CPP/" itemprop="url" rel="index"><span itemprop="name">C&CPP</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <script src="\assets\js\APlayer.min.js"> </script><!--
 * @Description: 
 * @Author: Sky
 * @Date: 2020-08-24 16:37:34
 * @LastEditors: Sky sky@sky-home.com
 * @LastEditTime: 2022-10-23 18:56:52
 * @Github: https://github.com/flyinskyin2013/
-->
<p><font color="red" size="7">PS：要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 这个只是基于《我自己》的理解，</font><br/><font color="red" size="7">如果和你的原则及想法相冲突，请谅解，勿喷。</font><br/></p>
<!-- ###### 前置说明
&emsp;&emsp;本文作为本人csdn blog的主站的备份。（BlogID=059） 
&emsp;&emsp;本文发布于 2018-04-04 17:05:21，现用MarkDown+图床做备份更新。blog原图已丢失，使用csdn所存的图进行更新。（BlogID=059） 
-->
<h6 id="环境说明">环境说明</h6>
<p>  无</p>
<h3 id="前言">前言</h3>
<hr>
<p>  关于C<ins>的多态，我就不多说了，我理解的一句话就是：一个接口，多种实现（简称：一对多）。在C</ins>里面，多态的最重要的实现方法为继承，简单来说：就是基类提供接口，子类可以实现基类的接口，不同的子类就构成了基类接口的不同的实现。以上就是C<ins>课本上或者C</ins>原理上的常见的知识。</p>
<p>  而今天这里所说明的是多态是怎么实现的，以及实现的详细方法。我个人认为：只有了解了这些东西后，我们才不会在多态中迷失自己的方向，导致代码稀烂。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="c-多态">c++ 多态</h3>
<hr>
<br/>
<br/>
<h5 id="多态的实现">多态的实现</h5>
<p>  多态的实现是通过一个指针数组实现的。此指针数组的一般声明如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//虚函数表</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span> vfptr<span class="token punctuation">;</span><span class="token comment">//此ptr指向一个void * 的数组</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>  说明: vfptr 变量的声明是C++编译器根据：当一个带有虚函数的类定义了一个实例时，编译器会自动在此类的前4bytes（32bit 系统）添加vfptr变量来实现多态。同时编译器会生成一个void *数组来存放实际接口方法地址（其实这里就已经实现了多态，也就是说：这里就已经定义好了这个实例可以调用哪些实际接口方法，例如是来至于基类还是子类等等），也就是虚函数表（vftable），此表是放在生成的可执行文件的数据段。</p>
<p>  总结：这里有一些基本的习惯。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>vfptr放在一个类的起始相关地址。</p>
</li>
<li class="lvl-2">
<p>vftable中的方法按照继承顺序、接口声明顺序赋值。</p>
</li>
</ul>
<p>  以上都是自己瞎扯的原理，看不懂也没有啥问题，毕竟我的语文水平不高，语言组织能力不行，直接跳过查看下面的实例分析。</p>
<br/>
<br/>
<h5 id="多态的实现原理解析实例">多态的实现原理解析实例</h5>
<pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">class Base
&#123;
public:
	Base() &#123;&#125;
	~Base() &#123;&#125;
	virtual void base1(void) &#x3D; 0;
	virtual void base2(void) &#123;&#125;;
	virtual void base3(void) &#123;&#125;;
	int base_a &#x3D; 0;
private:

&#125;;
class Base1
&#123;
public:
	Base1() &#123;&#125;
	~Base1() &#123;&#125;
	virtual void base2(void) &#123;&#125;;
	virtual void base3(void) &#123;&#125;;
	int base_a &#x3D; 0;
private:

&#125;;

class Derive:public Base
&#123;
public:
	Derive() &#123;&#125;
	~Derive() &#123;&#125;
	virtual void base1(void) &#123;&#125;
	virtual void base2(void) &#123;&#125;
	int derive_a &#x3D; 1;
private:

&#125;;
class Derive1 :public Base
&#123;
public:
	Derive1() &#123;&#125;
	~Derive1() &#123;&#125;
	virtual void base1(void) &#123;&#125;
	virtual void base2(void) &#123;&#125;
	virtual void derive1(void) &#123;&#125;
	virtual void derive2(void) &#123;&#125;
	int derive_a &#x3D; 2;
private:

&#125;;

class Derive2:public Derive1
&#123;
public:
	Derive2() &#123;&#125;
	~Derive2() &#123;&#125;
	virtual void derive1(void) &#123;&#125;

private:

&#125;;

int main()
&#123;
	Base1 b1;
	Derive d1;
	Derive1 dd1;
	Derive2 ddd1;
    return 0;
&#125;

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<br/>
<br/>
<h5 id="20200306-动态绑定的补充">20200306 动态绑定的补充</h5>
<p><font color = red size = 4 > 关于派生对象地址赋值给基类指针 并使用基类指针调用派生类函数。源码如下：</font></p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_059/derive.png" alt="rep_img"/></center>
    </div>
</div>    
<p><font color = red size = 4 >(20200326补充END)</font></p>
<p>  以下是vs2015的调试分析截图：（若只想了解一下vfptr和vftable是个什么样子，只看此图并结合代码分析足以）</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_059/dbg.png" alt="rep_img"/></center>
    </div>
</div>    
<p><font color = red  >友情提示：此图中关于ddd1的vfptr和我们想要的结果是不同的，原因和调试器相关，具体关于ddd1哪里有问题，若有需求，请看以下分析。</font></p>
<br/>
<br/>
<h5 id="多态的实现原理解析实例（进阶版）">多态的实现原理解析实例（进阶版）</h5>
<p>  同上一份代码，我们深入到汇编里面，就可以发现一些我们不知道的细节，关于这些汇编中的其他内容部分，若想了解，参考此文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011728480/article/details/79092194%E3%80%82">https://blog.csdn.net/u011728480/article/details/79092194。</a></p>
<p>  这里我们只分析变量ddd1的生成过程。</p>
<p>  用ida载入我们生成的exe文件。找到main函数中ddd1初始化入口如下：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_059/ida.png" alt="rep_img"/></center>
    </div>
</div>   
<br/>
<br/>
<h5 id="20200306-动态绑定的补充-2">20200306 动态绑定的补充</h5>
<p><font color = red size = 4 >关于派生对象地址赋值给基类指针 并使用基类指针调用派生类函数。反汇编如下：</font></p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_059/ida1.png" alt="rep_img"/></center>
    </div>
</div>  
<p><font color = red size = 4 >ddd1对象的vfptr如下：</font></p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_059/ida2.png" alt="rep_img"/></center>
    </div>
</div> 
<p><font color = red size = 4 >可以发现动态绑定的时候，基类指针的vfptr已经指向了ddd1对象的vfptr。</font><br>
<font color = red size = 4 >(20200326补充END)</font></p>
<p>  这里我们跳转到call后面的地址查看Derive2的构造函数，先调用Derive1的构造函数，再给vfptr赋值。下图是构造函数汇编</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_059/ida3.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  下图是vfptr的赋值内容，也就是vftable是什么样子的</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_059/ida4.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  这里可以看到，其实此实例调用的是哪些方法（也就实现了多态），早已经在编译时就确定了，只是这里才赋值而已，所以可以说是动态绑定或者静态绑定。</p>
<p>  下图为Derive1构造函数以及vftable值：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_059/ida5.png" alt="rep_img"/></center>
    </div>
</div> 
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_059/ida6.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  下图为Base构造函数以及vftable的值：</p>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_059/ida7.png" alt="rep_img"/></center>
    </div>
</div> 
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/blog_idx_059/ida8.png" alt="rep_img"/></center>
    </div>
</div> 
<p>  以上总结：我们可以发现vfptr经过了多次赋值的，不同的时间段，vfptr值不一样，所以在构造实例的时候，不同时段调用同一个接口，会有不同的方法。</p>
<p><font color = red >同时也可以得出一个结论，每个接口的实现类都有一个虚函数表，包括接口类本身，这些虚函数表在编译时就确定了，只是vfptr赋值的时候，是在程序运行时确定的。</font></p>
<p>  根据以上的分析，可以解决许多我们关于多态的疑问。</p>
<br/>
<br/>
<br/>
<br/>
<h3 id="后记">后记</h3>
<hr>
<p>  无</p>
<h3 id="参考文献">参考文献</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>无</p>
</li>
</ul>
<br/>
<br/>
<div style="margin:50px auto;">
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <hr/>
        <center><font color = #91e0b0 size = 5>打赏、订阅、收藏、丢香蕉、硬币，请关注公众号（攻城狮的搬砖之路）</font></center>
    </div>
</div>
<div style="text-align:center">
    <div style="margin:0 auto;">
        <center><img src="https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg" alt="qrc_img"/></center>
    </div>
</div>
<!-- ![alt 公众号图片](https://flyinskyin2013.github.io/ImageBed0/blogs/qrcode_for_wx_official_account.jpg "公众号图片") -->
<p><font color="red" size="7">PS: 请尊重原创，不喜勿喷。</font><br/><br>
<font color="red" size="7">PS: 要转载请注明出处，本人版权所有。</font><br/><br>
<font color="red" size="7">PS: 有问题请留言，看到后我会第一时间回复。</font><br/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/NO_EXSIT.XXXXXXX/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/NO_EXSIT.XXXXXXX/">1</a><span class="space">&hellip;</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/NO_EXSIT.XXXXXXX/page/14/">14</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/NO_EXSIT.XXXXXXX/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Sky</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">286k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">17:19</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":250,"hOffset":50,"vOffset":5},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
</html>
